---
title: "Circumpolar peatland-dominated basin Mann-Kendall analyses"
output: html_notebook
---
---
title: "MannKendall_v3"
author: "Mikhail Mack"
date: "21/08/2019"
output: html_document
---

```{r setup, include=FALSE, cache = FALSE}
require("knitr")
## Set your working directory "C:/.../SupplementaryInformation/R_CSVs"
opts_knit$set(root.dir = "C:/Users/mackm/Desktop/Working Files/R/SupplementaryInformation/R_CSVs") ### From My Computer
```


### Needed Packages
```{r}
library(raster)     ## GPCC data manipulations 
library(ncdf4)      ## Open GPCC NCDF 
library(Kendall)    ## Mann-Kendall statistic
library(modifiedmk) ## Modified Mann-Kendall statistic
library(mblm)       ## Theil-Sens slope estimators
library(tidyverse)  ## Data Wrangingly
library(dplyr)      ## Data Wrangingly
library(lubridate)  ## Data Wrangingly
```


### Load CSV files
```{r}
A<-read.csv("AnglingS.csv")
B<-read.csv("BirchS.csv")
D<-read.csv("BlackstoneS.csv")
FF<-read.csv("EtnaS.csv")
H<-read.csv("FlatS.csv")
K<-read.csv("GrotsjonS.csv")
O<-read.csv("JeanMarieS.csv")
S<-read.csv("LandbruS.csv")
#TT<-read.csv("LismonojaS.csv")
V<-read.csv("MartinS.csv")
Y<-read.csv("OverflowingS.csv")
AB<-read.csv("PontaxS.csv")
AD<-read.csv("ScottyS.csv")
AEE<-read.csv("ShamattawaS.csv")
AG<-read.csv("TanaS.csv")
AH<-read.csv("TaylorS.csv")
AI<-read.csv("TroutS.csv")
AJ<-read.csv("VaehaeaskanjokiS.csv")
AK<-read.csv("WeirS.csv")
AL<-read.csv("RiskiniS.csv")
AM<-read.csv("BolcharyS.csv")
AN<-read.csv("UrengoyS.csv")
AP<-read.csv("YuilskS.csv")
AQ<-read.csv("SlateS.csv")
BC <-read.csv("KegS.csv") #Keg River
BD <-read.csv("HayS.csv") #Hay River
BED <- read.csv("PoluyS.csv")
BQ <- read.csv("BerezovkaS.csv")
BG <- read.csv("MalyyYuganS.csv")
BH <- read.csv("NazymS.csv")
BJ <- read.csv("VandrasS.csv")
BK <- read.csv("AmnyaS.csv")
BL <- read.csv("SevernayaS.csv")
BM <- read.csv("ShomaYaS.csv")
BN<- read.csv("UtsjokiS.csv")
BO <- read.csv("TurukhanS.csv")
BP<- read.csv("SovetskayaS.csv")


## Blank CSV for results
TREND2<-read.csv("TrendsBase.csv")

## Gridded Precipitation Data
# Locate GPCC .nc file location "C:/.../SupplementaryInformation/R_CSVs"
fname<-"C:/Users/mackm/Desktop/Working Files/R/SupplementaryInformation/R_CSVs/precip.mon.total.v2018.nc"
precip.mon.b2<-brick(fname)
GMP2<-precip.mon.b2
DateTemp<-read.csv("Date_Template.csv")
DateTemp$Date<-as.Date(DateTemp$Date, "%Y-%m-%d")
```
###########################################################################
########################################################################
### Main Calculations
##############################################################################
#################################################################################
### Birch Results, csv 'B' ID 1
```{r}
### Summarise by Month
B$StreamflowDay_m3<-B$Streamflow*(60*60*24)
B.MON <- B %>%
   group_by(Year, Month) %>%
   summarise(Month_Streamflow_m3 = sum(StreamflowDay_m3), Month_Precip_mm = sum(Precip))
B.MON$Streamflow_Km<-B.MON$Month_Streamflow_m3/1000000000 # monthly runoff volume km^3
B.MON$Streamflow_mm<-(B.MON$Streamflow_Km/542)*1000000 ## monthly runoff depth mm

## Precipitation Data
BT<-GMP2[[1006:1512]] #Birch Time Series
BE<-extent(238,238.5,61,61.5) #Birch Spatial Extent
BPC<-crop(BT,BE) #Birch Crop
B.Mon.Precip.<-extract(BPC,BE, method="bilinear", fun = mean)
BMP<-as.data.frame(colMeans(B.Mon.Precip.)) #Birch
BSub<-DateTemp[DateTemp$Date >= as.Date("1974-10-01") & DateTemp$Date <=
                    as.Date("2016-12-01"), ] ##Birch
BPp<- cbind(BMP,BSub) ## Birch Precipitation Time Series

B.MONT<- B.MON
B.MONT$GriddedPrecip_mm<- BPp$`colMeans(B.Mon.Precip.)` ## Augment Gridded Time Series to Birch Runoff Time Series
B.MONT

B.MT <-B.MONT[-c(505,506,507),] # Trim to last water year
B.MT

## Water Year Sequencing
B.MT$Water_Year_Month <- rep(seq(1:12),42) #1975 to 2016 is 42 years
B.MT$Water_Year_Year <- rep(1:42, each =12)
B.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 B.WY <- B.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
B.WY
```
##############
```{r}
## Monthly Columns
## Oct
 B.OCT <- B.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 B.NOV <- B.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 B.DEC <- B.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 B.JAN <- B.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 B.FEB <- B.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 B.MAR <- B.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 B.APL <- B.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 B.MAY <- B.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 B.JUN <- B.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 B.JUL <- B.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 B.AUG <- B.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 B.SEP <- B.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
B.ALL <- cbind(B.WY, B.OCT[,-1], B.NOV[,-1], B.DEC[,-1], B.JAN[,-1], B.FEB[,-1], B.MAR[,-1], B.APL[,-1],B.MAY[,-1], B.JUN[,-1], B.JUL[,-1], B.AUG[,-1], B.SEP[,-1])
```
####################
```{r}
### Monthly Runoff Ratios
B.ALL$AN_RR <- B.ALL$AN_RO_mm/B.ALL$AN_PCP_mm
B.ALL$OCT_RR <- B.ALL$Oct_RO_mm/B.ALL$Oct_PCP_mm
B.ALL$NOV_RR <- B.ALL$Nov_RO_mm/B.ALL$Nov_PCP_mm
B.ALL$DEC_RR <- B.ALL$Dec_RO_mm/B.ALL$Dec_PCP_mm
B.ALL$JAN_RR <- B.ALL$Jan_RO_mm/B.ALL$Jan_PCP_mm
B.ALL$FEB_RR <- B.ALL$Feb_RO_mm/B.ALL$Feb_PCP_mm
B.ALL$MAR_RR <- B.ALL$Mar_RO_mm/B.ALL$Mar_PCP_mm
B.ALL$APL_RR <- B.ALL$Apl_RO_mm/B.ALL$Apl_PCP_mm
B.ALL$MAY_RR <- B.ALL$May_RO_mm/B.ALL$May_PCP_mm
B.ALL$JUN_RR <- B.ALL$Jun_RO_mm/B.ALL$Jun_PCP_mm
B.ALL$JUL_RR <- B.ALL$Jul_RO_mm/B.ALL$Jul_PCP_mm
B.ALL$AUG_RR <- B.ALL$Aug_RO_mm/B.ALL$Aug_PCP_mm
B.ALL$SEP_RR <- B.ALL$Sep_RO_mm/B.ALL$Sep_PCP_mm
B.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(B.ALL[,-1],2, mean))
CSD <- rbind(apply(B.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
B.ALL[nrow(B.ALL)+ 1,] = CML
B.ALL[nrow(B.ALL)+ 1,] = CSDL
B.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(B.ALL[1:42,2:40],2, MannKendall)
```
##########################################
```{r}
## Extract Needed Mann-Kendall Values
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
B.TS <-B.ALL[1:42,1:40]
B.TSN <- as.data.frame(apply(B.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(B.TSN, class)   
B.TSN
```
############################################
```{r}
### Caclulate Theil-Sens Slopes
BM1 <- mblm(AN_RO_mm~ Water_Year_Year, B.TSN)
BM2 <- mblm(AN_PCP_mm~ Water_Year_Year, B.TSN)
BM3 <- mblm(Oct_RO_mm~ Water_Year_Year, B.TSN)
BM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, B.TSN)
BM5 <- mblm(Nov_RO_mm~ Water_Year_Year, B.TSN)
BM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, B.TSN)
BM7 <- mblm(Dec_RO_mm~ Water_Year_Year, B.TSN)
BM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, B.TSN)
BM9 <- mblm(Jan_RO_mm~ Water_Year_Year, B.TSN)
BM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, B.TSN)
BM11 <- mblm(Feb_RO_mm~ Water_Year_Year, B.TSN)
BM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, B.TSN)
BM13 <- mblm(Mar_RO_mm~ Water_Year_Year, B.TSN)
BM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, B.TSN)
BM15 <- mblm(Apl_RO_mm~ Water_Year_Year, B.TSN)
BM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, B.TSN)
BM17 <- mblm(May_RO_mm~ Water_Year_Year, B.TSN)
BM18 <- mblm(May_PCP_mm~ Water_Year_Year, B.TSN)
BM19 <- mblm(Jun_RO_mm~ Water_Year_Year, B.TSN)
BM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, B.TSN)
BM21 <- mblm(Jul_RO_mm~ Water_Year_Year, B.TSN)
BM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, B.TSN)
BM23 <- mblm(Aug_RO_mm~ Water_Year_Year, B.TSN)
BM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, B.TSN)
BM25 <- mblm(Sep_RO_mm~ Water_Year_Year, B.TSN)
BM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, B.TSN)
BM27 <- mblm(AN_RR~ Water_Year_Year, B.TSN)
BM28 <- mblm(OCT_RR~ Water_Year_Year, B.TSN)
BM29 <- mblm(NOV_RR~ Water_Year_Year, B.TSN)
BM30 <- mblm(DEC_RR~ Water_Year_Year, B.TSN)
BM31 <- mblm(JAN_RR~ Water_Year_Year, B.TSN)
BM32 <- mblm(FEB_RR~ Water_Year_Year, B.TSN)
BM33 <- mblm(MAR_RR~ Water_Year_Year, B.TSN)
BM34 <- mblm(APL_RR~ Water_Year_Year, B.TSN)
BM35 <- mblm(MAY_RR~ Water_Year_Year, B.TSN)
BM36 <- mblm(JUN_RR~ Water_Year_Year, B.TSN)
BM37 <- mblm(JUL_RR~ Water_Year_Year, B.TSN)
BM38 <- mblm(AUG_RR~ Water_Year_Year, B.TSN)
BM39 <- mblm(SEP_RR~ Water_Year_Year, B.TSN)
```
####################################
```{r}
### Extract and save slopes and residuals from Theil-Sens Slopes
TSR<- cbind(BM1$coefficients, BM2$coefficients, BM3$coefficients, BM4$coefficients, BM5$coefficients, BM6$coefficients,BM7$coefficients, BM8$coefficients, BM9$coefficients,BM10$coefficients, BM11$coefficients, BM12$coefficients,BM13$coefficients, BM14$coefficients, BM15$coefficients,BM16$coefficients, BM17$coefficients, BM18$coefficients,BM19$coefficients, BM20$coefficients, BM21$coefficients,BM22$coefficients, BM23$coefficients, BM4$coefficients,BM25$coefficients, BM26$coefficients, BM27$coefficients,BM28$coefficients, BM29$coefficients, BM30$coefficients,BM31$coefficients, BM32$coefficients, BM33$coefficients,BM34$coefficients, BM35$coefficients, BM36$coefficients,BM37$coefficients, BM38$coefficients, BM39$coefficients)
RES <- cbind(BM1$residuals, BM2$residuals, BM3$residuals, BM4$residuals, BM5$residuals, BM6$residuals,BM7$residuals, BM8$residuals, BM9$residuals,BM10$residuals, BM11$residuals, BM12$residuals,BM13$residuals, BM14$residuals, BM15$residuals,BM16$residuals, BM17$residuals, BM18$residuals,BM19$residuals, BM20$residuals, BM21$residuals,BM22$residuals, BM23$residuals, BM4$residuals,BM25$residuals, BM26$residuals, BM27$residuals,BM28$residuals, BM29$residuals, BM30$residuals,BM31$residuals, BM32$residuals, BM33$residuals,BM34$residuals, BM35$residuals, BM36$residuals,BM37$residuals, BM38$residuals, BM39$residuals)
```
####################################
```{r}
# Calcualte Box Pierce Test for serial correlation on all residuals 
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Create Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil-Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and Theil-Sens
B.ALL[nrow(B.ALL)+ 1,] = MKTR
B.ALL[nrow(B.ALL)+ 1,] = MKPR
B.ALL[nrow(B.ALL)+ 1,] = TSRR
B.ALL[nrow(B.ALL)+ 1,] = BTDF
B.ALL
```
######################
```{r}
## Calculate Modified MK Variance Corrrection Approach for ALL. Also recalculates Theil-Sens
MMKC <- B.ALL[1:42,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
## Extract needed outputs for each column
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
## Add Modified MK results to main matrix
B.ALL[nrow(B.ALL)+ 1,] = MMKPR
B.ALL[nrow(B.ALL)+ 1,] = MMKTR
B.ALL[nrow(B.ALL)+ 1,] = MMKSR
B.ALL
```
####################################################################
```{r}
## Force rows to be numeric
B.NUM <- as.data.frame(apply(B.ALL[1:51,2:40], 2, as.numeric))
str(B.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(B.NUM[48,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(B.NUM[47,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(B.NUM[51,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(B.NUM[46,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(B.NUM[49,], use.names = FALSE)) ## Original MMK p-vlaue, V5

### Query for Org. MK or Modified MK based on Box-Pierce Test of Theil-Sens Residuals
FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
#############################################################
```{r}
### Final Slope and P-value Selection for 1970-2016
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##########################################################
```{r}
## Add final results to basin matrix
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
B.ALL[nrow(B.ALL)+ 1,] = FSR1
B.ALL[nrow(B.ALL)+ 1,] = FSR2
B.ALL
```
#######################################################
```{r}
#SAVE 1970 Results as 2:40 matrix
BFM <-B.ALL[c(52,53),-1]
BF <- as.matrix(apply(BFM, 2, as.numeric))
BF
```
###########################################################
```{r}
### Water Year 19 = 1990 onwards
```
###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(B.ALL[17:42,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
B.TS2 <-B.ALL[17:42,1:40] ## 1990 Subset
B.TSN2 <- as.data.frame(apply(B.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(B.TSN2, class)   
B.TSN2
```
############################################
```{r}
BM1 <- mblm(AN_RO_mm~ Water_Year_Year, B.TSN2)
BM2 <- mblm(AN_PCP_mm~ Water_Year_Year, B.TSN2)
BM3 <- mblm(Oct_RO_mm~ Water_Year_Year, B.TSN2)
BM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, B.TSN2)
BM5 <- mblm(Nov_RO_mm~ Water_Year_Year, B.TSN2)
BM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, B.TSN2)
BM7 <- mblm(Dec_RO_mm~ Water_Year_Year, B.TSN2)
BM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, B.TSN2)
BM9 <- mblm(Jan_RO_mm~ Water_Year_Year, B.TSN2)
BM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, B.TSN2)
BM11 <- mblm(Feb_RO_mm~ Water_Year_Year, B.TSN2)
BM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, B.TSN2)
BM13 <- mblm(Mar_RO_mm~ Water_Year_Year, B.TSN2)
BM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, B.TSN2)
BM15 <- mblm(Apl_RO_mm~ Water_Year_Year, B.TSN2)
BM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, B.TSN2)
BM17 <- mblm(May_RO_mm~ Water_Year_Year, B.TSN2)
BM18 <- mblm(May_PCP_mm~ Water_Year_Year, B.TSN2)
BM19 <- mblm(Jun_RO_mm~ Water_Year_Year, B.TSN2)
BM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, B.TSN2)
BM21 <- mblm(Jul_RO_mm~ Water_Year_Year, B.TSN2)
BM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, B.TSN2)
BM23 <- mblm(Aug_RO_mm~ Water_Year_Year, B.TSN2)
BM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, B.TSN2)
BM25 <- mblm(Sep_RO_mm~ Water_Year_Year, B.TSN2)
BM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, B.TSN2)
BM27 <- mblm(AN_RR~ Water_Year_Year, B.TSN2)
BM28 <- mblm(OCT_RR~ Water_Year_Year, B.TSN2)
BM29 <- mblm(NOV_RR~ Water_Year_Year, B.TSN2)
BM30 <- mblm(DEC_RR~ Water_Year_Year, B.TSN2)
BM31 <- mblm(JAN_RR~ Water_Year_Year, B.TSN2)
BM32 <- mblm(FEB_RR~ Water_Year_Year, B.TSN2)
BM33 <- mblm(MAR_RR~ Water_Year_Year, B.TSN2)
BM34 <- mblm(APL_RR~ Water_Year_Year, B.TSN2)
BM35 <- mblm(MAY_RR~ Water_Year_Year, B.TSN2)
BM36 <- mblm(JUN_RR~ Water_Year_Year, B.TSN2)
BM37 <- mblm(JUL_RR~ Water_Year_Year, B.TSN2)
BM38 <- mblm(AUG_RR~ Water_Year_Year, B.TSN2)
BM39 <- mblm(SEP_RR~ Water_Year_Year, B.TSN2)
```
####################################
```{r}
TSR2<- cbind(BM1$coefficients, BM2$coefficients, BM3$coefficients, BM4$coefficients, BM5$coefficients, BM6$coefficients,BM7$coefficients, BM8$coefficients, BM9$coefficients,BM10$coefficients, BM11$coefficients, BM12$coefficients,BM13$coefficients, BM14$coefficients, BM15$coefficients,BM16$coefficients, BM17$coefficients, BM18$coefficients,BM19$coefficients, BM20$coefficients, BM21$coefficients,BM22$coefficients, BM23$coefficients, BM4$coefficients,BM25$coefficients, BM26$coefficients, BM27$coefficients,BM28$coefficients, BM29$coefficients, BM30$coefficients,BM31$coefficients, BM32$coefficients, BM33$coefficients,BM34$coefficients, BM35$coefficients, BM36$coefficients,BM37$coefficients, BM38$coefficients, BM39$coefficients)
RES2 <- cbind(BM1$residuals, BM2$residuals, BM3$residuals, BM4$residuals, BM5$residuals, BM6$residuals,BM7$residuals, BM8$residuals, BM9$residuals,BM10$residuals, BM11$residuals, BM12$residuals,BM13$residuals, BM14$residuals, BM15$residuals,BM16$residuals, BM17$residuals, BM18$residuals,BM19$residuals, BM20$residuals, BM21$residuals,BM22$residuals, BM23$residuals, BM4$residuals,BM25$residuals, BM26$residuals, BM27$residuals,BM28$residuals, BM29$residuals, BM30$residuals,BM31$residuals, BM32$residuals, BM33$residuals,BM34$residuals, BM35$residuals, BM36$residuals,BM37$residuals, BM38$residuals, BM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
B.ALL[nrow(B.ALL)+ 1,] = MKTR2
B.ALL[nrow(B.ALL)+ 1,] = MKPR2
B.ALL[nrow(B.ALL)+ 1,] = TSRR2
B.ALL[nrow(B.ALL)+ 1,] = BTDF2
B.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- B.ALL[17:42,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
B.ALL[nrow(B.ALL)+ 1,] = MMKPR2
B.ALL[nrow(B.ALL)+ 1,] = MMKTR2
B.ALL[nrow(B.ALL)+ 1,] = MMKSR2
B.ALL
```
################################################################
```{r}
B.NUM2 <- as.data.frame(apply(B.ALL[1:60,2:40], 2, as.numeric))
str(B.NUM2)
```
#########################################
```{r}
E1 <- as.matrix(unlist(B.NUM2[57,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(B.NUM2[56,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(B.NUM2[60,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(B.NUM2[55,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(B.NUM2[58,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
############################################################################
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
################################################################################
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
B.ALL[nrow(B.ALL)+ 1,] = FSR12
B.ALL[nrow(B.ALL)+ 1,] = FSR22
B.ALL
```
#################################################################################
```{r}
B.ALL
```
##############################################################################
```{r}
#SAVE 1990 Results as 2:40 matrix
BFM2 <-B.ALL[c(61,62),-1]
BF2 <- as.matrix(apply(BFM2, 2, as.numeric))
BF2
```
###################################################################
############################################################################
### Blackstone Results, csv 'D' ID 2
```{r}
### Summarise by Month
D$StreamflowDay_m3<-D$Streamflow*(60*60*24)
D.MON <- D %>%
   group_by(Year, Month) %>%
   summarise(Month_Streamflow_m3 = sum(StreamflowDay_m3), Month_Precip_mm = sum(Precip))
D.MON$Streamflow_Km<-D.MON$Month_Streamflow_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
D.MON$Streamflow_mm<-(D.MON$Streamflow_Km/1910)*1000000 ## monthly runoff depth mm

# Precipitation
DT<-GMP2[[1210:1509]] #Blackstone
DE<-extent(237,239,60,61.5) #Blackstone Extent
DPC<-crop(DT,DE) #Blackstone Crop
D.Mon.Precip.<-extract(DPC,DE, method="bilinear", fun = mean)
DMP<-as.data.frame(colMeans(D.Mon.Precip.)) #Blackstone
DSub<-DateTemp[DateTemp$Date >= as.Date("1991-10-01") & DateTemp$Date <=
                    as.Date("2016-09-01"), ] # Blackstone
DPp<- cbind(DMP,DSub) ## Blackstone
D.MONT<- D.MON[-c(301,302,303,304,305,306,307,308,309,310,311,312,313,314,315),]
D.MONT$GriddedPrecip_mm<-DPp$`colMeans(D.Mon.Precip.)`
```
##############################################################################
```{r}
## Water Year Sequencing
D.MT<- D.MONT
D.MT$Water_Year_Month <- rep(seq(1:12),25) #1991 to 2016 is 43 years
D.MT$Water_Year_Year <- rep(1:25, each =12)
D.MT
```
###############################################################
```{r}
## Subsets for MK analysis
## Water Years 
 D.WY <- D.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
D.WY
```
##############################################################
```{r}
## Monthly Columns
## Oct
 D.OCT <- D.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 D.NOV <- D.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 D.DEC <- D.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 D.JAN <- D.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 D.FEB <- D.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 D.MAR <- D.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 D.APL <- D.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 D.MAY <- D.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 D.JUN <- D.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 D.JUL <- D.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 D.AUG <- D.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 D.SEP <- D.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
D.ALL <- cbind(D.WY, D.OCT[,-1], D.NOV[,-1], D.DEC[,-1], D.JAN[,-1], D.FEB[,-1], D.MAR[,-1], D.APL[,-1],D.MAY[,-1], D.JUN[,-1], D.JUL[,-1], D.AUG[,-1], D.SEP[,-1])
```
####################
```{r}
D.ALL$AN_RR <- D.ALL$AN_RO_mm/D.ALL$AN_PCP_mm
D.ALL$OCT_RR <- D.ALL$Oct_RO_mm/D.ALL$Oct_PCP_mm
D.ALL$NOV_RR <- D.ALL$Nov_RO_mm/D.ALL$Nov_PCP_mm
D.ALL$DEC_RR <- D.ALL$Dec_RO_mm/D.ALL$Dec_PCP_mm
D.ALL$JAN_RR <- D.ALL$Jan_RO_mm/D.ALL$Jan_PCP_mm
D.ALL$FEB_RR <- D.ALL$Feb_RO_mm/D.ALL$Feb_PCP_mm
D.ALL$MAR_RR <- D.ALL$Mar_RO_mm/D.ALL$Mar_PCP_mm
D.ALL$APL_RR <- D.ALL$Apl_RO_mm/D.ALL$Apl_PCP_mm
D.ALL$MAY_RR <- D.ALL$May_RO_mm/D.ALL$May_PCP_mm
D.ALL$JUN_RR <- D.ALL$Jun_RO_mm/D.ALL$Jun_PCP_mm
D.ALL$JUL_RR <- D.ALL$Jul_RO_mm/D.ALL$Jul_PCP_mm
D.ALL$AUG_RR <- D.ALL$Aug_RO_mm/D.ALL$Aug_PCP_mm
D.ALL$SEP_RR <- D.ALL$Sep_RO_mm/D.ALL$Sep_PCP_mm
D.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(D.ALL[,-1],2, mean))
CSD <- rbind(apply(D.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
D.ALL[nrow(D.ALL)+ 1,] = CML
D.ALL[nrow(D.ALL)+ 1,] = CSDL
D.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(D.ALL[1:25,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
D.TS <-D.ALL[1:25,1:40]
D.TSN <- as.data.frame(apply(D.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(D.TSN, class)   
D.TSN
```
############################################
```{r}
DM1 <- mblm(AN_RO_mm~ Water_Year_Year, D.TSN)
DM2 <- mblm(AN_PCP_mm~ Water_Year_Year, D.TSN)
DM3 <- mblm(Oct_RO_mm~ Water_Year_Year, D.TSN)
DM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, D.TSN)
DM5 <- mblm(Nov_RO_mm~ Water_Year_Year, D.TSN)
DM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, D.TSN)
DM7 <- mblm(Dec_RO_mm~ Water_Year_Year, D.TSN)
DM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, D.TSN)
DM9 <- mblm(Jan_RO_mm~ Water_Year_Year, D.TSN)
DM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, D.TSN)
DM11 <- mblm(Feb_RO_mm~ Water_Year_Year, D.TSN)
DM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, D.TSN)
DM13 <- mblm(Mar_RO_mm~ Water_Year_Year, D.TSN)
DM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, D.TSN)
DM15 <- mblm(Apl_RO_mm~ Water_Year_Year, D.TSN)
DM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, D.TSN)
DM17 <- mblm(May_RO_mm~ Water_Year_Year, D.TSN)
DM18 <- mblm(May_PCP_mm~ Water_Year_Year, D.TSN)
DM19 <- mblm(Jun_RO_mm~ Water_Year_Year, D.TSN)
DM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, D.TSN)
DM21 <- mblm(Jul_RO_mm~ Water_Year_Year, D.TSN)
DM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, D.TSN)
DM23 <- mblm(Aug_RO_mm~ Water_Year_Year, D.TSN)
DM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, D.TSN)
DM25 <- mblm(Sep_RO_mm~ Water_Year_Year, D.TSN)
DM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, D.TSN)
DM27 <- mblm(AN_RR~ Water_Year_Year, D.TSN)
DM28 <- mblm(OCT_RR~ Water_Year_Year, D.TSN)
DM29 <- mblm(NOV_RR~ Water_Year_Year, D.TSN)
DM30 <- mblm(DEC_RR~ Water_Year_Year, D.TSN)
DM31 <- mblm(JAN_RR~ Water_Year_Year, D.TSN)
DM32 <- mblm(FEB_RR~ Water_Year_Year, D.TSN)
DM33 <- mblm(MAR_RR~ Water_Year_Year, D.TSN)
DM34 <- mblm(APL_RR~ Water_Year_Year, D.TSN)
DM35 <- mblm(MAY_RR~ Water_Year_Year, D.TSN)
DM36 <- mblm(JUN_RR~ Water_Year_Year, D.TSN)
DM37 <- mblm(JUL_RR~ Water_Year_Year, D.TSN)
DM38 <- mblm(AUG_RR~ Water_Year_Year, D.TSN)
DM39 <- mblm(SEP_RR~ Water_Year_Year, D.TSN)
```
####################################
```{r}
TSR<- cbind(DM1$coefficients, DM2$coefficients, DM3$coefficients, DM4$coefficients, DM5$coefficients, DM6$coefficients,DM7$coefficients, DM8$coefficients, DM9$coefficients,DM10$coefficients, DM11$coefficients, DM12$coefficients,DM13$coefficients, DM14$coefficients, DM15$coefficients,DM16$coefficients, DM17$coefficients, DM18$coefficients,DM19$coefficients, DM20$coefficients, DM21$coefficients,DM22$coefficients, DM23$coefficients, DM4$coefficients,DM25$coefficients, DM26$coefficients, DM27$coefficients,DM28$coefficients, DM29$coefficients, DM30$coefficients,DM31$coefficients, DM32$coefficients, DM33$coefficients,DM34$coefficients, DM35$coefficients, DM36$coefficients,DM37$coefficients, DM38$coefficients, DM39$coefficients)
RES <- cbind(DM1$residuals, DM2$residuals, DM3$residuals, DM4$residuals, DM5$residuals, DM6$residuals,DM7$residuals, DM8$residuals, DM9$residuals,DM10$residuals, DM11$residuals, DM12$residuals,DM13$residuals, DM14$residuals, DM15$residuals,DM16$residuals, DM17$residuals, DM18$residuals,DM19$residuals, DM20$residuals, DM21$residuals,DM22$residuals, DM23$residuals, DM4$residuals,DM25$residuals, DM26$residuals, DM27$residuals,DM28$residuals, DM29$residuals, DM30$residuals,DM31$residuals, DM32$residuals, DM33$residuals,DM34$residuals, DM35$residuals, DM36$residuals,DM37$residuals, DM38$residuals, DM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
D.ALL[nrow(D.ALL)+ 1,] = MKTR
D.ALL[nrow(D.ALL)+ 1,] = MKPR
D.ALL[nrow(D.ALL)+ 1,] = TSRR
D.ALL[nrow(D.ALL)+ 1,] = BTDF
D.ALL
```
#################################################################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- D.ALL[1:25,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
###########################################################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
##############################################################
```{r}
D.ALL[nrow(D.ALL)+ 1,] = MMKPR
D.ALL[nrow(D.ALL)+ 1,] = MMKTR
D.ALL[nrow(D.ALL)+ 1,] = MMKSR
D.ALL
```
#########################################################
```{r}
D.NUM <- as.data.frame(apply(D.ALL[1:34,2:40], 2, as.numeric))
str(D.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(D.NUM[31,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(D.NUM[30,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(D.NUM[34,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(D.NUM[29,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(D.NUM[32,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
#####################################################
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
######################################################
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
D.ALL[nrow(D.ALL)+ 1,] = FSR1
D.ALL[nrow(D.ALL)+ 1,] = FSR2
D.ALL
```
###########
```{r}
#SAVE 1990 Results as 2:40 matrix
DFM <-D.ALL[c(35,36),-1]
DF <- as.matrix(apply(AIFM, 2, as.numeric))
DF
```
###########################################################
##########################################################
### Hay Results, csv 'BD' ID 3
```{r}
### Summarise by Month
BD$Days <- days_in_month(BD$Month)
BD$StreamflowMon_m3<- BD$Streamflow*(60*60*24)*BD$Days
BD.MON <- BD 
BD.MON$Streamflow_Km<-BD.MON$StreamflowMon_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
BD.MON$Streamflow_mm<-(BD.MON$Streamflow_Km/36900)*1000000 ## monthly runoff depth mm
#BD.MON

#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
BD.MONT <- BD.MON [-c(1,2,3,4,5,6,7,8,9,502),]
BD.MONT
```
##############################################################################
```{r}
BDT <- GMP2[[1018:1509]] ## Hay
BDE <- extent(238,244,58,60) #Hay
BDPC <- crop(BDT, BDE) #Hay
BD.Mon.Precip.<-extract(BDPC,BDE, method="bilinear", fun = mean)
BDMP<-as.data.frame(colMeans(BD.Mon.Precip.)) #Hay
BDSub<-DateTemp[DateTemp$Date >= as.Date("1975-10-01") & DateTemp$Date <=
                    as.Date("2016-09-01"), ] ##Hay
BDPp<- cbind(BDMP,BDSub) ## Hay
```
###############################################################
```{r}
BD.MONT$GriddedPrecip_mm<-BDPp$`colMeans(BD.Mon.Precip.)`
BD.MONT
```
############################################################
```{r}
## Water Year Sequencing
BD.MT<- BD.MONT
BD.MT$Water_Year_Month <- rep(seq(1:12),41) #1975 to 2016 is 43 years
BD.MT$Water_Year_Year <- rep(1:41, each =12)
BD.MT
```
############################################################
```{r}
## Subsets for MK analysis
## Water Years 
 BD.WY <- BD.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm, na.rm = TRUE), AN_PCP_mm = sum(GriddedPrecip_mm))
BD.WY
```
##############
```{r}
## Monthly Columns
## Oct
 BD.OCT <- BD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = 0, Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 BD.NOV <-  BD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = 0, Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 BD.DEC <- BD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = 0, Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 BD.JAN <- BD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = 0, Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 BD.FEB <- BD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(GriddedPrecip_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 BD.MAR <- BD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 BD.APL <- BD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 BD.MAY <- BD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 BD.JUN <- BD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 BD.JUL <- BD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 BD.AUG <- BD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 BD.SEP <- BD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
BD.ALL <- cbind(BD.WY, BD.OCT[,-1], BD.NOV[,-1], BD.DEC[,-1], BD.JAN[,-1], BD.FEB[,-1], BD.MAR[,-1], BD.APL[,-1],BD.MAY[,-1], BD.JUN[,-1], BD.JUL[,-1], BD.AUG[,-1], BD.SEP[,-1])
```
#######################################################
```{r}
BD.ALL$AN_RR <- BD.ALL$AN_RO_mm/BD.ALL$AN_PCP_mm
BD.ALL$OCT_RR <- BD.ALL$Oct_RO_mm/BD.ALL$Oct_PCP_mm
BD.ALL$NOV_RR <- 0 #BD.ALL$Nov_RO_mm/BD.ALL$Nov_PCP_mm
BD.ALL$DEC_RR <- 0 #BD.ALL$Dec_RO_mm/BD.ALL$Dec_PCP_mm
BD.ALL$JAN_RR <- 0 #BD.ALL$Jan_RO_mm/BD.ALL$Jan_PCP_mm
BD.ALL$FEB_RR <- 0 #BD.ALL$Feb_RO_mm/BD.ALL$Feb_PCP_mm
BD.ALL$MAR_RR <- BD.ALL$Mar_RO_mm/BD.ALL$Mar_PCP_mm
BD.ALL$APL_RR <- BD.ALL$Apl_RO_mm/BD.ALL$Apl_PCP_mm
BD.ALL$MAY_RR <- BD.ALL$May_RO_mm/BD.ALL$May_PCP_mm
BD.ALL$JUN_RR <- BD.ALL$Jun_RO_mm/BD.ALL$Jun_PCP_mm
BD.ALL$JUL_RR <- BD.ALL$Jul_RO_mm/BD.ALL$Jul_PCP_mm
BD.ALL$AUG_RR <- BD.ALL$Aug_RO_mm/BD.ALL$Aug_PCP_mm
BD.ALL$SEP_RR <- BD.ALL$Sep_RO_mm/BD.ALL$Sep_PCP_mm
BD.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(BD.ALL[,-1],2, mean))
CSD <- rbind(apply(BD.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
BD.ALL[nrow(BD.ALL)+ 1,] = CML
BD.ALL[nrow(BD.ALL)+ 1,] = CSDL
BD.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(BD.ALL[1:41,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
BD.TS <-BD.ALL[1:41,1:40]
BD.TSN <- as.data.frame(apply(BD.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(BD.TSN, class)   
BD.TSN
```
############################################
```{r}
BDM1 <- mblm(AN_RO_mm~ Water_Year_Year, BD.TSN)
BDM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BD.TSN)
BDM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BD.TSN)
BDM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BD.TSN)
BDM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BD.TSN)
BDM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BD.TSN)
BDM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BD.TSN)
BDM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BD.TSN)
BDM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BD.TSN)
BDM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BD.TSN)
BDM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BD.TSN)
BDM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BD.TSN)
BDM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BD.TSN)
BDM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BD.TSN)
BDM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BD.TSN)
BDM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BD.TSN)
BDM17 <- mblm(May_RO_mm~ Water_Year_Year, BD.TSN)
BDM18 <- mblm(May_PCP_mm~ Water_Year_Year, BD.TSN)
BDM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BD.TSN)
BDM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BD.TSN)
BDM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BD.TSN)
BDM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BD.TSN)
BDM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BD.TSN)
BDM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BD.TSN)
BDM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BD.TSN)
BDM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BD.TSN)
BDM27 <- mblm(AN_RR~ Water_Year_Year, BD.TSN)
BDM28 <- mblm(OCT_RR~ Water_Year_Year, BD.TSN)
BDM29 <- mblm(NOV_RR~ Water_Year_Year, BD.TSN)
BDM30 <- mblm(DEC_RR~ Water_Year_Year, BD.TSN)
BDM31 <- mblm(JAN_RR~ Water_Year_Year, BD.TSN)
BDM32 <- mblm(FEB_RR~ Water_Year_Year, BD.TSN)
BDM33 <- mblm(MAR_RR~ Water_Year_Year, BD.TSN)
BDM34 <- mblm(APL_RR~ Water_Year_Year, BD.TSN)
BDM35 <- mblm(MAY_RR~ Water_Year_Year, BD.TSN)
BDM36 <- mblm(JUN_RR~ Water_Year_Year, BD.TSN)
BDM37 <- mblm(JUL_RR~ Water_Year_Year, BD.TSN)
BDM38 <- mblm(AUG_RR~ Water_Year_Year, BD.TSN)
BDM39 <- mblm(SEP_RR~ Water_Year_Year, BD.TSN)
```
####################################
```{r}
TSR<- cbind(BDM1$coefficients, BDM2$coefficients, BDM3$coefficients, BDM4$coefficients, BDM5$coefficients, BDM6$coefficients,BDM7$coefficients, BDM8$coefficients, BDM9$coefficients,BDM10$coefficients, BDM11$coefficients, BDM12$coefficients,BDM13$coefficients, BDM14$coefficients, BDM15$coefficients,BDM16$coefficients, BDM17$coefficients, BDM18$coefficients,BDM19$coefficients, BDM20$coefficients, BDM21$coefficients,BDM22$coefficients, BDM23$coefficients, BDM4$coefficients,BDM25$coefficients, BDM26$coefficients, BDM27$coefficients,BDM28$coefficients, BDM29$coefficients, BDM30$coefficients,BDM31$coefficients, BDM32$coefficients, BDM33$coefficients,BDM34$coefficients, BDM35$coefficients, BDM36$coefficients,BDM37$coefficients, BDM38$coefficients, BDM39$coefficients)
RES <- cbind(BDM1$residuals, BDM2$residuals, BDM3$residuals, BDM4$residuals, BDM5$residuals, BDM6$residuals,BDM7$residuals, BDM8$residuals, BDM9$residuals,BDM10$residuals, BDM11$residuals, BDM12$residuals,BDM13$residuals, BDM14$residuals, BDM15$residuals,BDM16$residuals, BDM17$residuals, BDM18$residuals,BDM19$residuals, BDM20$residuals, BDM21$residuals,BDM22$residuals, BDM23$residuals, BDM4$residuals,BDM25$residuals, BDM26$residuals, BDM27$residuals,BDM28$residuals, BDM29$residuals, BDM30$residuals,BDM31$residuals, BDM32$residuals, BDM33$residuals,BDM34$residuals, BDM35$residuals, BDM36$residuals,BDM37$residuals, BDM38$residuals, BDM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BD.ALL[nrow(BD.ALL)+ 1,] = MKTR
BD.ALL[nrow(BD.ALL)+ 1,] = MKPR
BD.ALL[nrow(BD.ALL)+ 1,] = TSRR
BD.ALL[nrow(BD.ALL)+ 1,] = BTDF
BD.ALL
```
#################################################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- BD.ALL[1:41,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
#############################################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
######################################
```{r}
BD.ALL[nrow(BD.ALL)+ 1,] = MMKPR
BD.ALL[nrow(BD.ALL)+ 1,] = MMKTR
BD.ALL[nrow(BD.ALL)+ 1,] = MMKSR
BD.ALL
```
#######################################
```{r}
BD.NUM <- as.data.frame(apply(BD.ALL[1:50,2:40], 2, as.numeric))
str(BD.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(BD.NUM[47,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(BD.NUM[46,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(BD.NUM[50,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(BD.NUM[45,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(BD.NUM[48,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
BD.ALL[nrow(BD.ALL)+ 1,] = FSR1
BD.ALL[nrow(BD.ALL)+ 1,] = FSR2
BD.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
BDFM <-BD.ALL[c(51,52),-1]
BDF <- as.matrix(apply(BDFM, 2, as.numeric))
BDF
```
###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(BD.ALL[16:41,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
BD.TS2 <-BD.ALL[16:41,1:40] ## 1990 Subset
BD.TSN2 <- as.data.frame(apply(BD.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(BD.TSN2, class)   
BD.TSN2
```
############################################
```{r}
BDM1 <- mblm(AN_RO_mm~ Water_Year_Year, BD.TSN2)
BDM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BD.TSN2)
BDM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BD.TSN2)
BDM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BD.TSN2)
BDM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BD.TSN2)
BDM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BD.TSN2)
BDM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BD.TSN2)
BDM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BD.TSN2)
BDM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BD.TSN2)
BDM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BD.TSN2)
BDM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BD.TSN2)
BDM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BD.TSN2)
BDM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BD.TSN2)
BDM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BD.TSN2)
BDM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BD.TSN2)
BDM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BD.TSN2)
BDM17 <- mblm(May_RO_mm~ Water_Year_Year, BD.TSN2)
BDM18 <- mblm(May_PCP_mm~ Water_Year_Year, BD.TSN2)
BDM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BD.TSN2)
BDM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BD.TSN2)
BDM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BD.TSN2)
BDM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BD.TSN2)
BDM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BD.TSN2)
BDM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BD.TSN2)
BDM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BD.TSN2)
BDM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BD.TSN2)
BDM27 <- mblm(AN_RR~ Water_Year_Year, BD.TSN2)
BDM28 <- mblm(OCT_RR~ Water_Year_Year, BD.TSN2)
BDM29 <- mblm(NOV_RR~ Water_Year_Year, BD.TSN2)
BDM30 <- mblm(DEC_RR~ Water_Year_Year, BD.TSN2)
BDM31 <- mblm(JAN_RR~ Water_Year_Year, BD.TSN2)
BDM32 <- mblm(FEB_RR~ Water_Year_Year, BD.TSN2)
BDM33 <- mblm(MAR_RR~ Water_Year_Year, BD.TSN2)
BDM34 <- mblm(APL_RR~ Water_Year_Year, BD.TSN2)
BDM35 <- mblm(MAY_RR~ Water_Year_Year, BD.TSN2)
BDM36 <- mblm(JUN_RR~ Water_Year_Year, BD.TSN2)
BDM37 <- mblm(JUL_RR~ Water_Year_Year, BD.TSN2)
BDM38 <- mblm(AUG_RR~ Water_Year_Year, BD.TSN2)
BDM39 <- mblm(SEP_RR~ Water_Year_Year, BD.TSN2)
```
####################################
```{r}
TSR2<- cbind(BDM1$coefficients, BDM2$coefficients, BDM3$coefficients, BDM4$coefficients, BDM5$coefficients, BDM6$coefficients,BDM7$coefficients, BDM8$coefficients, BDM9$coefficients,BDM10$coefficients, BDM11$coefficients, BDM12$coefficients,BDM13$coefficients, BDM14$coefficients, BDM15$coefficients,BDM16$coefficients, BDM17$coefficients, BDM18$coefficients,BDM19$coefficients, BDM20$coefficients, BDM21$coefficients,BDM22$coefficients, BDM23$coefficients, BDM4$coefficients,BDM25$coefficients, BDM26$coefficients, BDM27$coefficients,BDM28$coefficients, BDM29$coefficients, BDM30$coefficients,BDM31$coefficients, BDM32$coefficients, BDM33$coefficients,BDM34$coefficients, BDM35$coefficients, BDM36$coefficients,BDM37$coefficients, BDM38$coefficients, BDM39$coefficients)
RES2 <- cbind(BDM1$residuals, BDM2$residuals, BDM3$residuals, BDM4$residuals, BDM5$residuals, BDM6$residuals,BDM7$residuals, BDM8$residuals, BDM9$residuals,BDM10$residuals, BDM11$residuals, BDM12$residuals,BDM13$residuals, BDM14$residuals, BDM15$residuals,BDM16$residuals, BDM17$residuals, BDM18$residuals,BDM19$residuals, BDM20$residuals, BDM21$residuals,BDM22$residuals, BDM23$residuals, BDM4$residuals,BDM25$residuals, BDM26$residuals, BDM27$residuals,BDM28$residuals, BDM29$residuals, BDM30$residuals,BDM31$residuals, BDM32$residuals, BDM33$residuals,BDM34$residuals, BDM35$residuals, BDM36$residuals,BDM37$residuals, BDM38$residuals, BDM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BD.ALL[nrow(BD.ALL)+ 1,] = MKTR2
BD.ALL[nrow(BD.ALL)+ 1,] = MKPR2
BD.ALL[nrow(BD.ALL)+ 1,] = TSRR2
BD.ALL[nrow(BD.ALL)+ 1,] = BTDF2
BD.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- BD.ALL[16:41,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
BD.ALL[nrow(BD.ALL)+ 1,] = MMKPR2
BD.ALL[nrow(BD.ALL)+ 1,] = MMKTR2
BD.ALL[nrow(BD.ALL)+ 1,] = MMKSR2
BD.ALL
```

```{r}
BD.ALL
```

```{r}
BD.NUM2 <- as.data.frame(apply(BD.ALL[1:59,2:40], 2, as.numeric))
str(BD.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(BD.NUM2[56,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(BD.NUM2[55,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(BD.NUM2[59,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(BD.NUM2[54,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(BD.NUM2[57,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
BD.ALL[nrow(BD.ALL)+ 1,] = FSR12
BD.ALL[nrow(BD.ALL)+ 1,] = FSR22
BD.ALL
```

```{r}
BD.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
BDFM2 <-BD.ALL[c(60,61),-1]
BDF2 <- as.matrix(apply(BDFM2, 2, as.numeric))
BDF2
```

### Jean Marie Results, csv 'O' ID 4
```{r}
### Summarise by Month
O$StreamflowDay_m3<-O$Streamflow*(60*60*24)
O.MON <- O %>%
   group_by(Year, Month) %>%
   summarise(Month_Streamflow_m3 = sum(StreamflowDay_m3), Month_Precip_mm = sum(Precip))
O.MON$Streamflow_Km<-O.MON$Month_Streamflow_m3/1000000000 # monthly runoff volume km^3
#### FILL IN CATHCMENT AREA BEFORE MOVINGON!!!!!!!!!!!!!######################################
O.MON$Streamflow_mm<-(O.MON$Streamflow_Km/1310)*1000000 ## monthly runoff depth mm
#O.MON
#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
O.MONT<- O.MON[-c(1,2,3,4),]
O.MONT
```

```{r}
OT<-GMP2[[982:1500]] #Jean Marie
OE<-extent(237,240,61.5,62) #Jean Marie Extent
OPC<-crop(OT,OE) #Jean Marie Crop
O.Mon.Precip.<-extract(OPC,OE, method="bilinear", fun = mean)
OMP<-as.data.frame(colMeans(O.Mon.Precip.)) # Jean Marie
OSub<-DateTemp[DateTemp$Date >= as.Date("1972-10-01") & DateTemp$Date <=
                    as.Date("2015-12-01"), ] ##Jean Marie
OPp<- cbind(OMP,OSub) ## Jean Marie
O.MONT$GriddedPrecip_mm<- OPp$`colMeans(O.Mon.Precip.)`
```

```{r}
O.MONT
```

```{r}
O.MT <-O.MONT[-c(517,518,519),] #TRIM to Last Water Year
O.MT
```

```{r}
2015-1972
```

##############
```{r}
## Water Year Sequencing
O.MT$Water_Year_Month <- rep(seq(1:12),43) #1972 to 2015 is 43 years
O.MT$Water_Year_Year <- rep(1:43, each =12)
O.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 O.WY <- O.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
O.WY
```
##############
```{r}
## Monthly Columns
## Oct
 O.OCT <- O.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 O.NOV <- O.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 O.DEC <- O.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 O.JAN <- O.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 O.FEB <- O.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 O.MAR <- O.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 O.APL <- O.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 O.MAY <- O.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 O.JUN <- O.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 O.JUL <- O.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 O.AUG <- O.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 O.SEP <- O.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
O.ALL <- cbind(O.WY, O.OCT[,-1], O.NOV[,-1], O.DEC[,-1], O.JAN[,-1], O.FEB[,-1], O.MAR[,-1], O.APL[,-1],O.MAY[,-1], O.JUN[,-1], O.JUL[,-1], O.AUG[,-1], O.SEP[,-1])
```
####################
```{r}
O.ALL$AN_RR <- O.ALL$AN_RO_mm/O.ALL$AN_PCP_mm
O.ALL$OCT_RR <- O.ALL$Oct_RO_mm/O.ALL$Oct_PCP_mm
O.ALL$NOV_RR <- O.ALL$Nov_RO_mm/O.ALL$Nov_PCP_mm
O.ALL$DEC_RR <- O.ALL$Dec_RO_mm/O.ALL$Dec_PCP_mm
O.ALL$JAN_RR <- O.ALL$Jan_RO_mm/O.ALL$Jan_PCP_mm
O.ALL$FEB_RR <- O.ALL$Feb_RO_mm/O.ALL$Feb_PCP_mm
O.ALL$MAR_RR <- O.ALL$Mar_RO_mm/O.ALL$Mar_PCP_mm
O.ALL$APL_RR <- O.ALL$Apl_RO_mm/O.ALL$Apl_PCP_mm
O.ALL$MAY_RR <- O.ALL$May_RO_mm/O.ALL$May_PCP_mm
O.ALL$JUN_RR <- O.ALL$Jun_RO_mm/O.ALL$Jun_PCP_mm
O.ALL$JUL_RR <- O.ALL$Jul_RO_mm/O.ALL$Jul_PCP_mm
O.ALL$AUG_RR <- O.ALL$Aug_RO_mm/O.ALL$Aug_PCP_mm
O.ALL$SEP_RR <- O.ALL$Sep_RO_mm/O.ALL$Sep_PCP_mm
O.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(O.ALL[,-1],2, mean))
CSD <- rbind(apply(O.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
O.ALL[nrow(O.ALL)+ 1,] = CML
O.ALL[nrow(O.ALL)+ 1,] = CSDL
O.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(O.ALL[1:43,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
O.TS <-O.ALL[1:43,1:40]
O.TSN <- as.data.frame(apply(O.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(O.TSN, class)   
O.TSN
```
############################################
```{r}
OM1 <- mblm(AN_RO_mm~ Water_Year_Year, O.TSN)
OM2 <- mblm(AN_PCP_mm~ Water_Year_Year, O.TSN)
OM3 <- mblm(Oct_RO_mm~ Water_Year_Year, O.TSN)
OM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, O.TSN)
OM5 <- mblm(Nov_RO_mm~ Water_Year_Year, O.TSN)
OM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, O.TSN)
OM7 <- mblm(Dec_RO_mm~ Water_Year_Year, O.TSN)
OM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, O.TSN)
OM9 <- mblm(Jan_RO_mm~ Water_Year_Year, O.TSN)
OM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, O.TSN)
OM11 <- mblm(Feb_RO_mm~ Water_Year_Year, O.TSN)
OM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, O.TSN)
OM13 <- mblm(Mar_RO_mm~ Water_Year_Year, O.TSN)
OM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, O.TSN)
OM15 <- mblm(Apl_RO_mm~ Water_Year_Year, O.TSN)
OM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, O.TSN)
OM17 <- mblm(May_RO_mm~ Water_Year_Year, O.TSN)
OM18 <- mblm(May_PCP_mm~ Water_Year_Year, O.TSN)
OM19 <- mblm(Jun_RO_mm~ Water_Year_Year, O.TSN)
OM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, O.TSN)
OM21 <- mblm(Jul_RO_mm~ Water_Year_Year, O.TSN)
OM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, O.TSN)
OM23 <- mblm(Aug_RO_mm~ Water_Year_Year, O.TSN)
OM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, O.TSN)
OM25 <- mblm(Sep_RO_mm~ Water_Year_Year, O.TSN)
OM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, O.TSN)
OM27 <- mblm(AN_RR~ Water_Year_Year, O.TSN)
OM28 <- mblm(OCT_RR~ Water_Year_Year, O.TSN)
OM29 <- mblm(NOV_RR~ Water_Year_Year, O.TSN)
OM30 <- mblm(DEC_RR~ Water_Year_Year, O.TSN)
OM31 <- mblm(JAN_RR~ Water_Year_Year, O.TSN)
OM32 <- mblm(FEB_RR~ Water_Year_Year, O.TSN)
OM33 <- mblm(MAR_RR~ Water_Year_Year, O.TSN)
OM34 <- mblm(APL_RR~ Water_Year_Year, O.TSN)
OM35 <- mblm(MAY_RR~ Water_Year_Year, O.TSN)
OM36 <- mblm(JUN_RR~ Water_Year_Year, O.TSN)
OM37 <- mblm(JUL_RR~ Water_Year_Year, O.TSN)
OM38 <- mblm(AUG_RR~ Water_Year_Year, O.TSN)
OM39 <- mblm(SEP_RR~ Water_Year_Year, O.TSN)
```
####################################
```{r}
TSR<- cbind(OM1$coefficients, OM2$coefficients, OM3$coefficients, OM4$coefficients, OM5$coefficients, OM6$coefficients,OM7$coefficients, OM8$coefficients, OM9$coefficients,OM10$coefficients, OM11$coefficients, OM12$coefficients,OM13$coefficients, OM14$coefficients, OM15$coefficients,OM16$coefficients, OM17$coefficients, OM18$coefficients,OM19$coefficients, OM20$coefficients, OM21$coefficients,OM22$coefficients, OM23$coefficients, OM4$coefficients,OM25$coefficients, OM26$coefficients, OM27$coefficients,OM28$coefficients, OM29$coefficients, OM30$coefficients,OM31$coefficients, OM32$coefficients, OM33$coefficients,OM34$coefficients, OM35$coefficients, OM36$coefficients,OM37$coefficients, OM38$coefficients, OM39$coefficients)
RES <- cbind(OM1$residuals, OM2$residuals, OM3$residuals, OM4$residuals, OM5$residuals, OM6$residuals,OM7$residuals, OM8$residuals, OM9$residuals,OM10$residuals, OM11$residuals, OM12$residuals,OM13$residuals, OM14$residuals, OM15$residuals,OM16$residuals, OM17$residuals, OM18$residuals,OM19$residuals, OM20$residuals, OM21$residuals,OM22$residuals, OM23$residuals, OM4$residuals,OM25$residuals, OM26$residuals, OM27$residuals,OM28$residuals, OM29$residuals, OM30$residuals,OM31$residuals, OM32$residuals, OM33$residuals,OM34$residuals, OM35$residuals, OM36$residuals,OM37$residuals, OM38$residuals, OM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
O.ALL[nrow(O.ALL)+ 1,] = MKTR
O.ALL[nrow(O.ALL)+ 1,] = MKPR
O.ALL[nrow(O.ALL)+ 1,] = TSRR
O.ALL[nrow(O.ALL)+ 1,] = BTDF
O.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- O.ALL[1:43,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
O.ALL[nrow(O.ALL)+ 1,] = MMKPR
O.ALL[nrow(O.ALL)+ 1,] = MMKTR
O.ALL[nrow(O.ALL)+ 1,] = MMKSR
O.ALL
```

```{r}
O.NUM <- as.data.frame(apply(O.ALL[1:52,2:40], 2, as.numeric))
str(O.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(O.NUM[49,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(O.NUM[48,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(O.NUM[52,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(O.NUM[47,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(O.NUM[50,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
O.ALL[nrow(O.ALL)+ 1,] = FSR1
O.ALL[nrow(O.ALL)+ 1,] = FSR2
O.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
OFM <-O.ALL[c(53,54),-1]
OF <- as.matrix(apply(OFM, 2, as.numeric))
OF
```
###########################################################
```{r}
### Water Year 19 = 1990 onwards
```
###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(H.ALL[18:43,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
O.TS2 <-O.ALL[18:43,1:40] ## 1990 Subset
O.TSN2 <- as.data.frame(apply(O.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(O.TSN2, class)   
O.TSN2
```
############################################
```{r}
OM1 <- mblm(AN_RO_mm~ Water_Year_Year, O.TSN2)
OM2 <- mblm(AN_PCP_mm~ Water_Year_Year, O.TSN2)
OM3 <- mblm(Oct_RO_mm~ Water_Year_Year, O.TSN2)
OM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, O.TSN2)
OM5 <- mblm(Nov_RO_mm~ Water_Year_Year, O.TSN2)
OM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, O.TSN2)
OM7 <- mblm(Dec_RO_mm~ Water_Year_Year, O.TSN2)
OM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, O.TSN2)
OM9 <- mblm(Jan_RO_mm~ Water_Year_Year, O.TSN2)
OM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, O.TSN2)
OM11 <- mblm(Feb_RO_mm~ Water_Year_Year, O.TSN2)
OM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, O.TSN2)
OM13 <- mblm(Mar_RO_mm~ Water_Year_Year, O.TSN2)
OM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, O.TSN2)
OM15 <- mblm(Apl_RO_mm~ Water_Year_Year, O.TSN2)
OM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, O.TSN2)
OM17 <- mblm(May_RO_mm~ Water_Year_Year, O.TSN2)
OM18 <- mblm(May_PCP_mm~ Water_Year_Year, O.TSN2)
OM19 <- mblm(Jun_RO_mm~ Water_Year_Year, O.TSN2)
OM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, O.TSN2)
OM21 <- mblm(Jul_RO_mm~ Water_Year_Year, O.TSN2)
OM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, O.TSN2)
OM23 <- mblm(Aug_RO_mm~ Water_Year_Year, O.TSN2)
OM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, O.TSN2)
OM25 <- mblm(Sep_RO_mm~ Water_Year_Year, O.TSN2)
OM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, O.TSN2)
OM27 <- mblm(AN_RR~ Water_Year_Year, O.TSN2)
OM28 <- mblm(OCT_RR~ Water_Year_Year, O.TSN2)
OM29 <- mblm(NOV_RR~ Water_Year_Year, O.TSN2)
OM30 <- mblm(DEC_RR~ Water_Year_Year, O.TSN2)
OM31 <- mblm(JAN_RR~ Water_Year_Year, O.TSN2)
OM32 <- mblm(FEB_RR~ Water_Year_Year, O.TSN2)
OM33 <- mblm(MAR_RR~ Water_Year_Year, O.TSN2)
OM34 <- mblm(APL_RR~ Water_Year_Year, O.TSN2)
OM35 <- mblm(MAY_RR~ Water_Year_Year, O.TSN2)
OM36 <- mblm(JUN_RR~ Water_Year_Year, O.TSN2)
OM37 <- mblm(JUL_RR~ Water_Year_Year, O.TSN2)
OM38 <- mblm(AUG_RR~ Water_Year_Year, O.TSN2)
OM39 <- mblm(SEP_RR~ Water_Year_Year, O.TSN2)
```
####################################
```{r}
TSR2<- cbind(OM1$coefficients, OM2$coefficients, OM3$coefficients, OM4$coefficients, OM5$coefficients, OM6$coefficients,OM7$coefficients, OM8$coefficients, OM9$coefficients,OM10$coefficients, OM11$coefficients, OM12$coefficients,OM13$coefficients, OM14$coefficients, OM15$coefficients,OM16$coefficients, OM17$coefficients, OM18$coefficients,OM19$coefficients, OM20$coefficients, OM21$coefficients,OM22$coefficients, OM23$coefficients, OM4$coefficients,OM25$coefficients, OM26$coefficients, OM27$coefficients,OM28$coefficients, OM29$coefficients, OM30$coefficients,OM31$coefficients, OM32$coefficients, OM33$coefficients,OM34$coefficients, OM35$coefficients, OM36$coefficients,OM37$coefficients, OM38$coefficients, OM39$coefficients)
RES2 <- cbind(OM1$residuals, OM2$residuals, OM3$residuals, OM4$residuals, OM5$residuals, OM6$residuals,OM7$residuals, OM8$residuals, OM9$residuals,OM10$residuals, OM11$residuals, OM12$residuals,OM13$residuals, OM14$residuals, OM15$residuals,OM16$residuals, OM17$residuals, OM18$residuals,OM19$residuals, OM20$residuals, OM21$residuals,OM22$residuals, OM23$residuals, OM4$residuals,OM25$residuals, OM26$residuals, OM27$residuals,OM28$residuals, OM29$residuals, OM30$residuals,OM31$residuals, OM32$residuals, OM33$residuals,OM34$residuals, OM35$residuals, OM36$residuals,OM37$residuals, OM38$residuals, OM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
O.ALL[nrow(O.ALL)+ 1,] = MKTR2
O.ALL[nrow(O.ALL)+ 1,] = MKPR2
O.ALL[nrow(O.ALL)+ 1,] = TSRR2
O.ALL[nrow(O.ALL)+ 1,] = BTDF2
O.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- O.ALL[18:43,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
O.ALL[nrow(O.ALL)+ 1,] = MMKPR2
O.ALL[nrow(O.ALL)+ 1,] = MMKTR2
O.ALL[nrow(O.ALL)+ 1,] = MMKSR2
O.ALL
```

```{r}
O.ALL
```

```{r}
O.NUM2 <- as.data.frame(apply(O.ALL[1:61,2:40], 2, as.numeric))
str(O.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(O.NUM2[58,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(O.NUM2[57,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(O.NUM2[61,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(O.NUM2[56,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(O.NUM2[59,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
O.ALL[nrow(O.ALL)+ 1,] = FSR12
O.ALL[nrow(O.ALL)+ 1,] = FSR22
O.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
OFM2 <-O.ALL[c(62,63),-1]
OF2 <- as.matrix(apply(OFM2, 2, as.numeric))
OF2
```

### Keg Results, csv 'BC' ID 5
```{r}
### Summarise by Month
BC$Days <- days_in_month(BC$Month)
BC$StreamflowMon_m3<- BC$Streamflow*(60*60*24)*BC$Days
BC.MON <- BC 
BC.MON$Streamflow_Km<-BC.MON$StreamflowMon_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
BC.MON$Streamflow_mm<-(BC.MON$Streamflow_Km/649)*1000000 ## monthly runoff depth mm
BC.MON
```


```{r}

#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
BC.MONT <- BC.MON[-c(1,2,531,532,533,534,535,536,537,538,539,540,541,542,543,544,545,546,547,
                     548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564,
                     565,566,567,568,569),]
BC.MONT
```


```{r}
BCT <- GMP2[[970:1497]] ## Keg
BCE <- extent(242,243,57.5,58) #Keg
BCPC <- crop(BCT, BCE) #Keg
BC.Mon.Precip.<-extract(BCPC,BCE, method="bilinear", fun = mean)
BCMP<-as.data.frame(colMeans(BC.Mon.Precip.)) #Keg
BCSub<-DateTemp[DateTemp$Date >= as.Date("1971-10-01") & DateTemp$Date <=
                    as.Date("2015-09-01"), ] ##Keg
BCPp<- cbind(BCMP,BCSub) ## Keg
```

```{r}
BC.MONT$GriddedPrecip_mm<- BCMP$`colMeans(BC.Mon.Precip.)`
BC.MONT
```

```{r}
BC.MONT[c(2,3,4,5,14,15,16,17,26,27,28,29,38,39,40,41,50,51,52,53,62,63,64,65,74,75,76,78,86,87,89,90),9] <- 0
BC.MONT
```

##############
```{r}
## Water Year Sequencing
BC.MT<- BC.MONT
BC.MT$Water_Year_Month <- rep(seq(1:12),44) #1971 to 2015 is 43 years
BC.MT$Water_Year_Year <- rep(1:44, each =12)
BC.MT
```

```{r}
BC.MT
```

#############
```{r}
## Subsets for MK analysis
## Water Years 
 BC.WY <- BC.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm, na.rm = TRUE), AN_PCP_mm = sum(GriddedPrecip_mm))
BC.WY
```
##############
```{r}
## Monthly Columns
## Oct
 BC.OCT <- BC.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 BC.NOV <- BC.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(0), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 BC.DEC <- BC.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(0), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 BC.JAN <- BC.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(0), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 BC.FEB <- BC.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(0), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 BC.MAR <- BC.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 BC.APL <- BC.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 BC.MAY <- BC.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 BC.JUN <- BC.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 BC.JUL <- BC.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 BC.AUG <- BC.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 BC.SEP <- BC.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
BC.ALL <- cbind(BC.WY, BC.OCT[,-1], BC.NOV[,-1], BC.DEC[,-1], BC.JAN[,-1], BC.FEB[,-1], BC.MAR[,-1], BC.APL[,-1],BC.MAY[,-1], BC.JUN[,-1], BC.JUL[,-1], BC.AUG[,-1], BC.SEP[,-1])
```
####################
```{r}
BC.ALL$AN_RR <- BC.ALL$AN_RO_mm/BC.ALL$AN_PCP_mm
BC.ALL$OCT_RR <- BC.ALL$Oct_RO_mm/BC.ALL$Oct_PCP_mm
BC.ALL$NOV_RR <- 0 #BC.ALL$Nov_RO_mm/BC.ALL$Nov_PCP_mm
BC.ALL$DEC_RR <- 0 #BC.ALL$Dec_RO_mm/BC.ALL$Dec_PCP_mm
BC.ALL$JAN_RR <- 0 #BC.ALL$Jan_RO_mm/BC.ALL$Jan_PCP_mm
BC.ALL$FEB_RR <- 0 #BC.ALL$Feb_RO_mm/BC.ALL$Feb_PCP_mm
BC.ALL$MAR_RR <- BC.ALL$Mar_RO_mm/BC.ALL$Mar_PCP_mm
BC.ALL$APL_RR <- BC.ALL$Apl_RO_mm/BC.ALL$Apl_PCP_mm
BC.ALL$MAY_RR <- BC.ALL$May_RO_mm/BC.ALL$May_PCP_mm
BC.ALL$JUN_RR <- BC.ALL$Jun_RO_mm/BC.ALL$Jun_PCP_mm
BC.ALL$JUL_RR <- BC.ALL$Jul_RO_mm/BC.ALL$Jul_PCP_mm
BC.ALL$AUG_RR <- BC.ALL$Aug_RO_mm/BC.ALL$Aug_PCP_mm
BC.ALL$SEP_RR <- BC.ALL$Sep_RO_mm/BC.ALL$Sep_PCP_mm
BC.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(BC.ALL[,-1],2, mean))
CSD <- rbind(apply(BC.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
BC.ALL[nrow(BC.ALL)+ 1,] = CML
BC.ALL[nrow(BC.ALL)+ 1,] = CSDL
BC.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(BC.ALL[1:44,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
BC.TS <-BC.ALL[1:44,1:40]
BC.TSN <- as.data.frame(apply(BC.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(BC.TSN, class)   
BC.TSN
```
############################################
```{r}
BCM1 <- mblm(AN_RO_mm~ Water_Year_Year, BC.TSN)
BCM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BC.TSN)
BCM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BC.TSN)
BCM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BC.TSN)
BCM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BC.TSN)
BCM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BC.TSN)
BCM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BC.TSN)
BCM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BC.TSN)
BCM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BC.TSN)
BCM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BC.TSN)
BCM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BC.TSN)
BCM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BC.TSN)
BCM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BC.TSN)
BCM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BC.TSN)
BCM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BC.TSN)
BCM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BC.TSN)
BCM17 <- mblm(May_RO_mm~ Water_Year_Year, BC.TSN)
BCM18 <- mblm(May_PCP_mm~ Water_Year_Year, BC.TSN)
BCM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BC.TSN)
BCM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BC.TSN)
BCM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BC.TSN)
BCM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BC.TSN)
BCM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BC.TSN)
BCM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BC.TSN)
BCM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BC.TSN)
BCM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BC.TSN)
BCM27 <- mblm(AN_RR~ Water_Year_Year, BC.TSN)
BCM28 <- mblm(OCT_RR~ Water_Year_Year, BC.TSN)
BCM29 <- mblm(NOV_RR~ Water_Year_Year, BC.TSN)
BCM30 <- mblm(DEC_RR~ Water_Year_Year, BC.TSN)
BCM31 <- mblm(JAN_RR~ Water_Year_Year, BC.TSN)
BCM32 <- mblm(FEB_RR~ Water_Year_Year, BC.TSN)
BCM33 <- mblm(MAR_RR~ Water_Year_Year, BC.TSN)
BCM34 <- mblm(APL_RR~ Water_Year_Year, BC.TSN)
BCM35 <- mblm(MAY_RR~ Water_Year_Year, BC.TSN)
BCM36 <- mblm(JUN_RR~ Water_Year_Year, BC.TSN)
BCM37 <- mblm(JUL_RR~ Water_Year_Year, BC.TSN)
BCM38 <- mblm(AUG_RR~ Water_Year_Year, BC.TSN)
BCM39 <- mblm(SEP_RR~ Water_Year_Year, BC.TSN)
```
####################################
```{r}
TSR<- cbind(BCM1$coefficients, BCM2$coefficients, BCM3$coefficients, BCM4$coefficients, BCM5$coefficients, BCM6$coefficients,BCM7$coefficients, BCM8$coefficients, BCM9$coefficients,BCM10$coefficients, BCM11$coefficients, BCM12$coefficients,BCM13$coefficients, BCM14$coefficients, BCM15$coefficients,BCM16$coefficients, BCM17$coefficients, BCM18$coefficients,BCM19$coefficients, BCM20$coefficients, BCM21$coefficients,BCM22$coefficients, BCM23$coefficients, BCM4$coefficients,BCM25$coefficients, BCM26$coefficients, BCM27$coefficients,BCM28$coefficients, BCM29$coefficients, BCM30$coefficients,BCM31$coefficients, BCM32$coefficients, BCM33$coefficients,BCM34$coefficients, BCM35$coefficients, BCM36$coefficients,BCM37$coefficients, BCM38$coefficients, BCM39$coefficients)
RES <- cbind(BCM1$residuals, BCM2$residuals, BCM3$residuals, BCM4$residuals, BCM5$residuals, BCM6$residuals,BCM7$residuals, BCM8$residuals, BCM9$residuals,BCM10$residuals, BCM11$residuals, BCM12$residuals,BCM13$residuals, BCM14$residuals, BCM15$residuals,BCM16$residuals, BCM17$residuals, BCM18$residuals,BCM19$residuals, BCM20$residuals, BCM21$residuals,BCM22$residuals, BCM23$residuals, BCM4$residuals,BCM25$residuals, BCM26$residuals, BCM27$residuals,BCM28$residuals, BCM29$residuals, BCM30$residuals,BCM31$residuals, BCM32$residuals, BCM33$residuals,BCM34$residuals, BCM35$residuals, BCM36$residuals,BCM37$residuals, BCM38$residuals, BCM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BC.ALL[nrow(BC.ALL)+ 1,] = MKTR
BC.ALL[nrow(BC.ALL)+ 1,] = MKPR
BC.ALL[nrow(BC.ALL)+ 1,] = TSRR
BC.ALL[nrow(BC.ALL)+ 1,] = BTDF
BC.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- BC.ALL[1:44,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
BC.ALL[nrow(BC.ALL)+ 1,] = MMKPR
BC.ALL[nrow(BC.ALL)+ 1,] = MMKTR
BC.ALL[nrow(BC.ALL)+ 1,] = MMKSR
BC.ALL
```

```{r}
BC.NUM <- as.data.frame(apply(BC.ALL[1:53,2:40], 2, as.numeric))
str(BC.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(BC.NUM[50,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(BC.NUM[49,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(BC.NUM[53,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(BC.NUM[48,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(BC.NUM[51,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
BC.ALL[nrow(BC.ALL)+ 1,] = FSR1
BC.ALL[nrow(BC.ALL)+ 1,] = FSR2
BC.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
BCFM <-BC.ALL[c(54,55),-1]
BCF <- as.matrix(apply(BCFM, 2, as.numeric))
BCF
```
###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(BC.ALL[19:44,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
BC.TS2 <-BC.ALL[19:44,1:40] ## 1990 Subset
BC.TSN2 <- as.data.frame(apply(BC.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(BC.TSN2, class)   
BC.TSN2
```
############################################
```{r}
BCM1 <- mblm(AN_RO_mm~ Water_Year_Year, BC.TSN2)
BCM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BC.TSN2)
BCM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BC.TSN2)
BCM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BC.TSN2)
BCM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BC.TSN2)
BCM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BC.TSN2)
BCM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BC.TSN2)
BCM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BC.TSN2)
BCM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BC.TSN2)
BCM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BC.TSN2)
BCM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BC.TSN2)
BCM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BC.TSN2)
BCM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BC.TSN2)
BCM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BC.TSN2)
BCM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BC.TSN2)
BCM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BC.TSN2)
BCM17 <- mblm(May_RO_mm~ Water_Year_Year, BC.TSN2)
BCM18 <- mblm(May_PCP_mm~ Water_Year_Year, BC.TSN2)
BCM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BC.TSN2)
BCM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BC.TSN2)
BCM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BC.TSN2)
BCM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BC.TSN2)
BCM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BC.TSN2)
BCM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BC.TSN2)
BCM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BC.TSN2)
BCM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BC.TSN2)
BCM27 <- mblm(AN_RR~ Water_Year_Year, BC.TSN2)
BCM28 <- mblm(OCT_RR~ Water_Year_Year, BC.TSN2)
BCM29 <- mblm(NOV_RR~ Water_Year_Year, BC.TSN2)
BCM30 <- mblm(DEC_RR~ Water_Year_Year, BC.TSN2)
BCM31 <- mblm(JAN_RR~ Water_Year_Year, BC.TSN2)
BCM32 <- mblm(FEB_RR~ Water_Year_Year, BC.TSN2)
BCM33 <- mblm(MAR_RR~ Water_Year_Year, BC.TSN2)
BCM34 <- mblm(APL_RR~ Water_Year_Year, BC.TSN2)
BCM35 <- mblm(MAY_RR~ Water_Year_Year, BC.TSN2)
BCM36 <- mblm(JUN_RR~ Water_Year_Year, BC.TSN2)
BCM37 <- mblm(JUL_RR~ Water_Year_Year, BC.TSN2)
BCM38 <- mblm(AUG_RR~ Water_Year_Year, BC.TSN2)
BCM39 <- mblm(SEP_RR~ Water_Year_Year, BC.TSN2)
```
####################################
```{r}
TSR2<- cbind(BCM1$coefficients, BCM2$coefficients, BCM3$coefficients, BCM4$coefficients, BCM5$coefficients, BCM6$coefficients,BCM7$coefficients, BCM8$coefficients, BCM9$coefficients,BCM10$coefficients, BCM11$coefficients, BCM12$coefficients,BCM13$coefficients, BCM14$coefficients, BCM15$coefficients,BCM16$coefficients, BCM17$coefficients, BCM18$coefficients,BCM19$coefficients, BCM20$coefficients, BCM21$coefficients,BCM22$coefficients, BCM23$coefficients, BCM4$coefficients,BCM25$coefficients, BCM26$coefficients, BCM27$coefficients,BCM28$coefficients, BCM29$coefficients, BCM30$coefficients,BCM31$coefficients, BCM32$coefficients, BCM33$coefficients,BCM34$coefficients, BCM35$coefficients, BCM36$coefficients,BCM37$coefficients, BCM38$coefficients, BCM39$coefficients)
RES2 <- cbind(BCM1$residuals, BCM2$residuals, BCM3$residuals, BCM4$residuals, BCM5$residuals, BCM6$residuals,BCM7$residuals, BCM8$residuals, BCM9$residuals,BCM10$residuals, BCM11$residuals, BCM12$residuals,BCM13$residuals, BCM14$residuals, BCM15$residuals,BCM16$residuals, BCM17$residuals, BCM18$residuals,BCM19$residuals, BCM20$residuals, BCM21$residuals,BCM22$residuals, BCM23$residuals, BCM4$residuals,BCM25$residuals, BCM26$residuals, BCM27$residuals,BCM28$residuals, BCM29$residuals, BCM30$residuals,BCM31$residuals, BCM32$residuals, BCM33$residuals,BCM34$residuals, BCM35$residuals, BCM36$residuals,BCM37$residuals, BCM38$residuals, BCM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BC.ALL[nrow(BC.ALL)+ 1,] = MKTR2
BC.ALL[nrow(BC.ALL)+ 1,] = MKPR2
BC.ALL[nrow(BC.ALL)+ 1,] = TSRR2
BC.ALL[nrow(BC.ALL)+ 1,] = BTDF2
BC.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- BC.ALL[19:44,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
BC.ALL[nrow(BC.ALL)+ 1,] = MMKPR2
BC.ALL[nrow(BC.ALL)+ 1,] = MMKTR2
BC.ALL[nrow(BC.ALL)+ 1,] = MMKSR2
BC.ALL
```

```{r}
BC.ALL
```

```{r}
BC.NUM2 <- as.data.frame(apply(BC.ALL[1:65,2:40], 2, as.numeric))
str(BC.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(BC.NUM2[59,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(BC.NUM2[58,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(BC.NUM2[62,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(BC.NUM2[57,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(BC.NUM2[60,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
BC.ALL[nrow(BC.ALL)+ 1,] = FSR12
BC.ALL[nrow(BC.ALL)+ 1,] = FSR22
BC.ALL
```

```{r}
BC.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
BCFM2 <-BC.ALL[c(63,64),-1]
BCF2 <- as.matrix(apply(BCFM2, 2, as.numeric))
BCF2
```


### Martin Results, csv 'V' ID 6
```{r}
### Summarise by Month
V$StreamflowDay_m3<-V$Streamflow*(60*60*24)
V.MON <- V %>%
   group_by(Year, Month) %>%
   summarise(Streamflow_m3 = sum(StreamflowDay_m3), Stat_Precip_mm = sum(Precip))
V.MON$Streamflow_Km<-V.MON$Streamflow_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!########################################
V.MON$Streamflow_mm<-(V.MON$Streamflow_Km/2050)*1000000 ## monthly runoff depth mm
V.MON
```
###############
```{r}
###  Add Gridded Precip Data
VT<-GMP2[[982:1512]] #Martin
VE<-extent(237,238,61.5,62) #Martin Extent
VPC<-crop(VT,VE) #Martin Crop
V.Mon.Precip.<-extract(VPC,VE, method="bilinear", fun = "mean")
VMP<-as.data.frame(colMeans(V.Mon.Precip.)) #Martin
VSub<-DateTemp[DateTemp$Date >= as.Date("1972-10-01") & DateTemp$Date <=
                    as.Date("2016-12-01"), ] ##Martin
VPp<- cbind(VMP,VSub) ## Martin

#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
V.MONT<- V.MON[-c(532,533,534,535,536,537,538,539,540,541,542,543),]
V.MONT
V.MONT$GriddedPrecip_mm<-VPp$`colMeans(V.Mon.Precip.)`
V.MONT
```

```{r}
V.MONTT <- V.MONT[-c(529,530,531),]
V.MT <-V.MONTT[,-c(3,4,5)]
V.MT
```
##############
```{r}
## Water Year Sequencing
V.MT$Water_Year_Month <- rep(seq(1:12),44)
V.MT$Water_Year_Year <- rep(1:44, each =12)
V.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 V.WY <- V.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
V.WY
```
##############
```{r}
## Monthly Columns
## Oct
 V.OCT <- V.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 V.NOV <- V.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 V.DEC <- V.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 V.JAN <- V.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 V.FEB <- V.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 V.MAR <- V.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 V.APL <- V.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 V.MAY <- V.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 V.JUN <- V.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 V.JUL <- V.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 V.AUG <- V.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 V.SEP <- V.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
V.ALL <- cbind(V.WY, V.OCT[,-1], V.NOV[,-1], V.DEC[,-1], V.JAN[,-1], V.FEB[,-1], V.MAR[,-1], V.APL[,-1],V.MAY[,-1], V.JUN[,-1], V.JUL[,-1], V.AUG[,-1], V.SEP[,-1])
```
####################
```{r}
V.ALL$AN_RR <- V.ALL$AN_RO_mm/V.ALL$AN_PCP_mm
V.ALL$OCT_RR <- V.ALL$Oct_RO_mm/V.ALL$Oct_PCP_mm
V.ALL$NOV_RR <- V.ALL$Nov_RO_mm/V.ALL$Nov_PCP_mm
V.ALL$DEC_RR <- V.ALL$Dec_RO_mm/V.ALL$Dec_PCP_mm
V.ALL$JAN_RR <- V.ALL$Jan_RO_mm/V.ALL$Jan_PCP_mm
V.ALL$FEB_RR <- V.ALL$Feb_RO_mm/V.ALL$Feb_PCP_mm
V.ALL$MAR_RR <- V.ALL$Mar_RO_mm/V.ALL$Mar_PCP_mm
V.ALL$APL_RR <- V.ALL$Apl_RO_mm/V.ALL$Apl_PCP_mm
V.ALL$MAY_RR <- V.ALL$May_RO_mm/V.ALL$May_PCP_mm
V.ALL$JUN_RR <- V.ALL$Jun_RO_mm/V.ALL$Jun_PCP_mm
V.ALL$JUL_RR <- V.ALL$Jul_RO_mm/V.ALL$Jul_PCP_mm
V.ALL$AUG_RR <- V.ALL$Aug_RO_mm/V.ALL$Aug_PCP_mm
V.ALL$SEP_RR <- V.ALL$Sep_RO_mm/V.ALL$Sep_PCP_mm
#V.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(V.ALL[,-1],2, mean))
CSD <- rbind(apply(V.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
V.ALL[nrow(V.ALL)+ 1,] = CML
V.ALL[nrow(V.ALL)+ 1,] = CSDL
V.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(V.ALL[1:44,2:40],2, MannKendall)
```
##########################################
```{r}
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
V.TS <-V.ALL[1:44,1:40]
V.TSN <- as.data.frame(apply(V.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(V.TSN, class)   
V.TSN
```
############################################
```{r}
VM1 <- mblm(AN_RO_mm~ Water_Year_Year, V.TSN)
VM2 <- mblm(AN_PCP_mm~ Water_Year_Year, V.TSN)
VM3 <- mblm(Oct_RO_mm~ Water_Year_Year, V.TSN)
VM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, V.TSN)
VM5 <- mblm(Nov_RO_mm~ Water_Year_Year, V.TSN)
VM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, V.TSN)
VM7 <- mblm(Dec_RO_mm~ Water_Year_Year, V.TSN)
VM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, V.TSN)
VM9 <- mblm(Jan_RO_mm~ Water_Year_Year, V.TSN)
VM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, V.TSN)
VM11 <- mblm(Feb_RO_mm~ Water_Year_Year, V.TSN)
VM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, V.TSN)
VM13 <- mblm(Mar_RO_mm~ Water_Year_Year, V.TSN)
VM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, V.TSN)
VM15 <- mblm(Apl_RO_mm~ Water_Year_Year, V.TSN)
VM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, V.TSN)
VM17 <- mblm(May_RO_mm~ Water_Year_Year, V.TSN)
VM18 <- mblm(May_PCP_mm~ Water_Year_Year, V.TSN)
VM19 <- mblm(Jun_RO_mm~ Water_Year_Year, V.TSN)
VM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, V.TSN)
VM21 <- mblm(Jul_RO_mm~ Water_Year_Year, V.TSN)
VM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, V.TSN)
VM23 <- mblm(Aug_RO_mm~ Water_Year_Year, V.TSN)
VM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, V.TSN)
VM25 <- mblm(Sep_RO_mm~ Water_Year_Year, V.TSN)
VM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, V.TSN)
VM27 <- mblm(AN_RR~ Water_Year_Year, V.TSN)
VM28 <- mblm(OCT_RR~ Water_Year_Year, V.TSN)
VM29 <- mblm(NOV_RR~ Water_Year_Year, V.TSN)
VM30 <- mblm(DEC_RR~ Water_Year_Year, V.TSN)
VM31 <- mblm(JAN_RR~ Water_Year_Year, V.TSN)
VM32 <- mblm(FEB_RR~ Water_Year_Year, V.TSN)
VM33 <- mblm(MAR_RR~ Water_Year_Year, V.TSN)
VM34 <- mblm(APL_RR~ Water_Year_Year, V.TSN)
VM35 <- mblm(MAY_RR~ Water_Year_Year, V.TSN)
VM36 <- mblm(JUN_RR~ Water_Year_Year, V.TSN)
VM37 <- mblm(JUL_RR~ Water_Year_Year, V.TSN)
VM38 <- mblm(AUG_RR~ Water_Year_Year, V.TSN)
VM39 <- mblm(SEP_RR~ Water_Year_Year, V.TSN)
```
####################################
```{r}
TSR<- cbind(VM1$coefficients, VM2$coefficients, VM3$coefficients, VM4$coefficients, VM5$coefficients, VM6$coefficients,VM7$coefficients, VM8$coefficients, VM9$coefficients,VM10$coefficients, VM11$coefficients, VM12$coefficients,VM13$coefficients, VM14$coefficients, VM15$coefficients,VM16$coefficients, VM17$coefficients, VM18$coefficients,VM19$coefficients, VM20$coefficients, VM21$coefficients,VM22$coefficients, VM23$coefficients, VM4$coefficients,VM25$coefficients, VM26$coefficients, VM27$coefficients,VM28$coefficients, VM29$coefficients, VM30$coefficients,VM31$coefficients, VM32$coefficients, VM33$coefficients,VM34$coefficients, VM35$coefficients, VM36$coefficients,VM37$coefficients, VM38$coefficients, VM39$coefficients)
RES <- cbind(VM1$residuals, VM2$residuals, VM3$residuals, VM4$residuals, VM5$residuals, VM6$residuals,VM7$residuals, VM8$residuals, VM9$residuals,VM10$residuals, VM11$residuals, VM12$residuals,VM13$residuals, VM14$residuals, VM15$residuals,VM16$residuals, VM17$residuals, VM18$residuals,VM19$residuals, VM20$residuals, VM21$residuals,VM22$residuals, VM23$residuals, VM4$residuals,VM25$residuals, VM26$residuals, VM27$residuals,VM28$residuals, VM29$residuals, VM30$residuals,VM31$residuals, VM32$residuals, VM33$residuals,VM34$residuals, VM35$residuals, VM36$residuals,VM37$residuals, VM38$residuals, VM39$residuals)
```
####################################
```{r}
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
V.ALL[nrow(V.ALL)+ 1,] = MKTR
V.ALL[nrow(V.ALL)+ 1,] = MKPR
V.ALL[nrow(V.ALL)+ 1,] = TSRR
V.ALL[nrow(V.ALL)+ 1,] = BTDF
V.ALL
```
######################
```{r}
V.ALL[1:44,2:40]
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- V.ALL[1:44,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
V.ALL[nrow(V.ALL)+ 1,] = MMKPR
V.ALL[nrow(V.ALL)+ 1,] = MMKTR
V.ALL[nrow(V.ALL)+ 1,] = MMKSR
V.ALL
```

```{r}
V.NUM <- as.data.frame(apply(V.ALL[1:53,2:40], 2, as.numeric))
str(V.NUM)
```
#########################################3
```{r}
E1<- as.matrix(unlist(V.NUM[50,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(V.NUM[49,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(V.NUM[53,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(V.NUM[48,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(V.NUM[51,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
V.ALL[nrow(V.ALL)+ 1,] = FSR1
V.ALL[nrow(V.ALL)+ 1,] = FSR2
V.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
VFM <-V.ALL[c(54,55),-1]
VF <- as.matrix(apply(VFM, 2, as.numeric))
VF
```
###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(V.ALL[19:44,2:40],2, MannKendall) ## 1900 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
V.TS2 <-V.ALL[19:44,1:40] ## 1900 Subset
V.TSN2 <- as.data.frame(apply(V.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(V.TSN2, class)   
V.TSN2
```
############################################
```{r}
VM1 <- mblm(AN_RO_mm~ Water_Year_Year, V.TSN2)
VM2 <- mblm(AN_PCP_mm~ Water_Year_Year, V.TSN2)
VM3 <- mblm(Oct_RO_mm~ Water_Year_Year, V.TSN2)
VM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, V.TSN2)
VM5 <- mblm(Nov_RO_mm~ Water_Year_Year, V.TSN2)
VM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, V.TSN2)
VM7 <- mblm(Dec_RO_mm~ Water_Year_Year, V.TSN2)
VM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, V.TSN2)
VM9 <- mblm(Jan_RO_mm~ Water_Year_Year, V.TSN2)
VM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, V.TSN2)
VM11 <- mblm(Feb_RO_mm~ Water_Year_Year, V.TSN2)
VM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, V.TSN2)
VM13 <- mblm(Mar_RO_mm~ Water_Year_Year, V.TSN2)
VM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, V.TSN2)
VM15 <- mblm(Apl_RO_mm~ Water_Year_Year, V.TSN2)
VM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, V.TSN2)
VM17 <- mblm(May_RO_mm~ Water_Year_Year, V.TSN2)
VM18 <- mblm(May_PCP_mm~ Water_Year_Year, V.TSN2)
VM19 <- mblm(Jun_RO_mm~ Water_Year_Year, V.TSN2)
VM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, V.TSN2)
VM21 <- mblm(Jul_RO_mm~ Water_Year_Year, V.TSN2)
VM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, V.TSN2)
VM23 <- mblm(Aug_RO_mm~ Water_Year_Year, V.TSN2)
VM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, V.TSN2)
VM25 <- mblm(Sep_RO_mm~ Water_Year_Year, V.TSN2)
VM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, V.TSN2)
VM27 <- mblm(AN_RR~ Water_Year_Year, V.TSN2)
VM28 <- mblm(OCT_RR~ Water_Year_Year, V.TSN2)
VM29 <- mblm(NOV_RR~ Water_Year_Year, V.TSN2)
VM30 <- mblm(DEC_RR~ Water_Year_Year, V.TSN2)
VM31 <- mblm(JAN_RR~ Water_Year_Year, V.TSN2)
VM32 <- mblm(FEB_RR~ Water_Year_Year, V.TSN2)
VM33 <- mblm(MAR_RR~ Water_Year_Year, V.TSN2)
VM34 <- mblm(APL_RR~ Water_Year_Year, V.TSN2)
VM35 <- mblm(MAY_RR~ Water_Year_Year, V.TSN2)
VM36 <- mblm(JUN_RR~ Water_Year_Year, V.TSN2)
VM37 <- mblm(JUL_RR~ Water_Year_Year, V.TSN2)
VM38 <- mblm(AUG_RR~ Water_Year_Year, V.TSN2)
VM39 <- mblm(SEP_RR~ Water_Year_Year, V.TSN2)
```
####################################
```{r}
TSR2<- cbind(VM1$coefficients, VM2$coefficients, VM3$coefficients, VM4$coefficients, VM5$coefficients, VM6$coefficients,VM7$coefficients, VM8$coefficients, VM9$coefficients,VM10$coefficients, VM11$coefficients, VM12$coefficients,VM13$coefficients, VM14$coefficients, VM15$coefficients,VM16$coefficients, VM17$coefficients, VM18$coefficients,VM19$coefficients, VM20$coefficients, VM21$coefficients,VM22$coefficients, VM23$coefficients, VM4$coefficients,VM25$coefficients, VM26$coefficients, VM27$coefficients,VM28$coefficients, VM29$coefficients, VM30$coefficients,VM31$coefficients, VM32$coefficients, VM33$coefficients,VM34$coefficients, VM35$coefficients, VM36$coefficients,VM37$coefficients, VM38$coefficients, VM39$coefficients)
RES2 <- cbind(VM1$residuals, VM2$residuals, VM3$residuals, VM4$residuals, VM5$residuals, VM6$residuals,VM7$residuals, VM8$residuals, VM9$residuals,VM10$residuals, VM11$residuals, VM12$residuals,VM13$residuals, VM14$residuals, VM15$residuals,VM16$residuals, VM17$residuals, VM18$residuals,VM19$residuals, VM20$residuals, VM21$residuals,VM22$residuals, VM23$residuals, VM4$residuals,VM25$residuals, VM26$residuals, VM27$residuals,VM28$residuals, VM29$residuals, VM30$residuals,VM31$residuals, VM32$residuals, VM33$residuals,VM34$residuals, VM35$residuals, VM36$residuals,VM37$residuals, VM38$residuals, VM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
V.ALL[nrow(V.ALL)+ 1,] = MKTR2
V.ALL[nrow(V.ALL)+ 1,] = MKPR2
V.ALL[nrow(V.ALL)+ 1,] = TSRR2
V.ALL[nrow(V.ALL)+ 1,] = BTDF2
V.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- V.ALL[19:44,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
V.ALL[nrow(V.ALL)+ 1,] = MMKPR2
V.ALL[nrow(V.ALL)+ 1,] = MMKTR2
V.ALL[nrow(V.ALL)+ 1,] = MMKSR2
V.ALL
```

```{r}
V.ALL
```

```{r}
V.NUM2 <- as.data.frame(apply(V.ALL[1:62,2:40], 2, as.numeric))
str(V.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(V.NUM2[59,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(V.NUM2[58,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(V.NUM2[62,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(V.NUM2[57,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(V.NUM2[60,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
V.ALL[nrow(V.ALL)+ 1,] = FSR12
V.ALL[nrow(V.ALL)+ 1,] = FSR22
V.ALL
```
###########
```{r}
#SAVE 1990 Results as 2:40 matrix
VFM2 <-V.ALL[c(63,64),-1]
VF2 <- as.matrix(apply(VFM2, 2, as.numeric))
VF2
```


### Scotty Results, csv 'AD' ID 7
```{r}
### Summarise by Month
AD$StreamflowDay_m3<-AD$Streamflow*(60*60*24)
AD.MON <- AD %>%
   group_by(Year, Month) %>%
   summarise(Month_Streamflow_m3 = sum(StreamflowDay_m3), Month_Precip_mm = sum(Precip))
AD.MON$Streamflow_Km<-AD.MON$Month_Streamflow_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
AD.MON$Streamflow_mm<-(AD.MON$Streamflow_Km/152)*1000000 ## monthly runoff depth mm
AD.MON
```

```{r}
AD.MON
```

```{r}
#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
AD.MONT<- AD.MON [-c(1,2,3,4,5,6,7,8,9),]
AD.MONT
```

````{r}
ADT<-GMP2[[1258:1512]] #Scotty
ADE<-extent(238.5,239,60,61.5) #Scotty Extent
ADPC<-crop(ADT,ADE) #Scotty Crop
AD.Mon.Precip.<-extract(ADPC,ADE, method="bilinear", fun = mean)
ADMP<-as.data.frame(colMeans(AD.Mon.Precip.)) #Scotty
ADSub<-DateTemp[DateTemp$Date >= as.Date("1995-10-01") & DateTemp$Date <=
                    as.Date("2016-12-01"), ] ##Scotty
ADPp<- cbind(ADMP,ADSub) ## Scotty
AD.MONT$GriddedPrecip_mm<- ADPp$`colMeans(AD.Mon.Precip.)`
```

```{r}
AD.MONT
```

```{r}
AD.MT <-AD.MONT[-c(253,254,255),] #TRIM to Last Water Year
AD.MT
```
##############
```{r}
## Water Year Sequencing
AD.MT$Water_Year_Month <- rep(seq(1:12),21) #1972 to 2015 is 43 years
AD.MT$Water_Year_Year <- rep(1:21, each =12)
AD.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 AD.WY <- AD.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
AD.WY
```
##############
```{r}
## Monthly Columns
## Oct
 AD.OCT <- AD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 AD.NOV <- AD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 AD.DEC <- AD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 AD.JAN <- AD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 AD.FEB <- AD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 AD.MAR <- AD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 AD.APL <- AD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 AD.MAY <- AD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 AD.JUN <- AD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 AD.JUL <- AD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 AD.AUG <- AD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 AD.SEP <- AD.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
AD.ALL <- cbind(AD.WY, AD.OCT[,-1], AD.NOV[,-1], AD.DEC[,-1], AD.JAN[,-1], AD.FEB[,-1], AD.MAR[,-1], AD.APL[,-1],AD.MAY[,-1], AD.JUN[,-1], AD.JUL[,-1], AD.AUG[,-1], AD.SEP[,-1])
```
####################
```{r}
AD.ALL$AN_RR <- AD.ALL$AN_RO_mm/AD.ALL$AN_PCP_mm
AD.ALL$OCT_RR <- AD.ALL$Oct_RO_mm/AD.ALL$Oct_PCP_mm
AD.ALL$NOV_RR <- AD.ALL$Nov_RO_mm/AD.ALL$Nov_PCP_mm
AD.ALL$DEC_RR <- AD.ALL$Dec_RO_mm/AD.ALL$Dec_PCP_mm
AD.ALL$JAN_RR <- AD.ALL$Jan_RO_mm/AD.ALL$Jan_PCP_mm
AD.ALL$FEB_RR <- AD.ALL$Feb_RO_mm/AD.ALL$Feb_PCP_mm
AD.ALL$MAR_RR <- AD.ALL$Mar_RO_mm/AD.ALL$Mar_PCP_mm
AD.ALL$APL_RR <- AD.ALL$Apl_RO_mm/AD.ALL$Apl_PCP_mm
AD.ALL$MAY_RR <- AD.ALL$May_RO_mm/AD.ALL$May_PCP_mm
AD.ALL$JUN_RR <- AD.ALL$Jun_RO_mm/AD.ALL$Jun_PCP_mm
AD.ALL$JUL_RR <- AD.ALL$Jul_RO_mm/AD.ALL$Jul_PCP_mm
AD.ALL$AUG_RR <- AD.ALL$Aug_RO_mm/AD.ALL$Aug_PCP_mm
AD.ALL$SEP_RR <- AD.ALL$Sep_RO_mm/AD.ALL$Sep_PCP_mm
AD.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(AD.ALL[,-1],2, mean))
CSD <- rbind(apply(AD.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
AD.ALL[nrow(AD.ALL)+ 1,] = CML
AD.ALL[nrow(AD.ALL)+ 1,] = CSDL
AD.ALL
```

```{r}
AD.ALL
```

#######################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO <- apply(AD.ALL[1:21,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
AD.TS <-AD.ALL[1:21,1:40]
AD.TSN <- as.data.frame(apply(AD.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(AD.TSN, class)   
AD.TSN
```
############################################
```{r}
ADM1 <- mblm(AN_RO_mm~ Water_Year_Year, AD.TSN)
ADM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AD.TSN)
ADM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AD.TSN)
ADM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AD.TSN)
ADM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AD.TSN)
ADM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AD.TSN)
ADM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AD.TSN)
ADM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AD.TSN)
ADM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AD.TSN)
ADM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AD.TSN)
ADM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AD.TSN)
ADM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AD.TSN)
ADM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AD.TSN)
ADM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AD.TSN)
ADM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AD.TSN)
ADM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AD.TSN)
ADM17 <- mblm(May_RO_mm~ Water_Year_Year, AD.TSN)
ADM18 <- mblm(May_PCP_mm~ Water_Year_Year, AD.TSN)
ADM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AD.TSN)
ADM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AD.TSN)
ADM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AD.TSN)
ADM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AD.TSN)
ADM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AD.TSN)
ADM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AD.TSN)
ADM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AD.TSN)
ADM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AD.TSN)
ADM27 <- mblm(AN_RR~ Water_Year_Year, AD.TSN)
ADM28 <- mblm(OCT_RR~ Water_Year_Year, AD.TSN)
ADM29 <- mblm(NOV_RR~ Water_Year_Year, AD.TSN)
ADM30 <- mblm(DEC_RR~ Water_Year_Year, AD.TSN)
ADM31 <- mblm(JAN_RR~ Water_Year_Year, AD.TSN)
ADM32 <- mblm(FEB_RR~ Water_Year_Year, AD.TSN)
ADM33 <- mblm(MAR_RR~ Water_Year_Year, AD.TSN)
ADM34 <- mblm(APL_RR~ Water_Year_Year, AD.TSN)
ADM35 <- mblm(MAY_RR~ Water_Year_Year, AD.TSN)
ADM36 <- mblm(JUN_RR~ Water_Year_Year, AD.TSN)
ADM37 <- mblm(JUL_RR~ Water_Year_Year, AD.TSN)
ADM38 <- mblm(AUG_RR~ Water_Year_Year, AD.TSN)
ADM39 <- mblm(SEP_RR~ Water_Year_Year, AD.TSN)
```
####################################
```{r}
TSR<- cbind(ADM1$coefficients, ADM2$coefficients, ADM3$coefficients, ADM4$coefficients, ADM5$coefficients, ADM6$coefficients,ADM7$coefficients, ADM8$coefficients, ADM9$coefficients,ADM10$coefficients, ADM11$coefficients, ADM12$coefficients,ADM13$coefficients, ADM14$coefficients, ADM15$coefficients,ADM16$coefficients, ADM17$coefficients, ADM18$coefficients,ADM19$coefficients, ADM20$coefficients, ADM21$coefficients,ADM22$coefficients, ADM23$coefficients, ADM4$coefficients,ADM25$coefficients, ADM26$coefficients, ADM27$coefficients,ADM28$coefficients, ADM29$coefficients, ADM30$coefficients,ADM31$coefficients, ADM32$coefficients, ADM33$coefficients,ADM34$coefficients, ADM35$coefficients, ADM36$coefficients,ADM37$coefficients, ADM38$coefficients, ADM39$coefficients)
RES <- cbind(ADM1$residuals, ADM2$residuals, ADM3$residuals, ADM4$residuals, ADM5$residuals, ADM6$residuals,ADM7$residuals, ADM8$residuals, ADM9$residuals,ADM10$residuals, ADM11$residuals, ADM12$residuals,ADM13$residuals, ADM14$residuals, ADM15$residuals,ADM16$residuals, ADM17$residuals, ADM18$residuals,ADM19$residuals, ADM20$residuals, ADM21$residuals,ADM22$residuals, ADM23$residuals, ADM4$residuals,ADM25$residuals, ADM26$residuals, ADM27$residuals,ADM28$residuals, ADM29$residuals, ADM30$residuals,ADM31$residuals, ADM32$residuals, ADM33$residuals,ADM34$residuals, ADM35$residuals, ADM36$residuals,ADM37$residuals, ADM38$residuals, ADM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AD.ALL[nrow(AD.ALL)+ 1,] = MKTR
AD.ALL[nrow(AD.ALL)+ 1,] = MKPR
AD.ALL[nrow(AD.ALL)+ 1,] = TSRR
AD.ALL[nrow(AD.ALL)+ 1,] = BTDF
AD.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- AD.ALL[1:21,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
AD.ALL[nrow(AD.ALL)+ 1,] = MMKPR
AD.ALL[nrow(AD.ALL)+ 1,] = MMKTR
AD.ALL[nrow(AD.ALL)+ 1,] = MMKSR
AD.ALL
```

```{r}
AD.ALL
```

```{r}
AD.NUM <- as.data.frame(apply(AD.ALL[1:30,2:40], 2, as.numeric))
str(AD.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(AD.NUM[27,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(AD.NUM[26,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(AD.NUM[30,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(AD.NUM[25,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(AD.NUM[28,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
AD.ALL[nrow(AD.ALL)+ 1,] = FSR1
AD.ALL[nrow(AD.ALL)+ 1,] = FSR2
AD.ALL
```
###########
```{r}
#SAVE 1990 Results as 2:40 matrix
ADFM <-AD.ALL[c(31,32),-1]
ADF <- as.matrix(apply(ADFM, 2, as.numeric))
ADF
```
###########################################################


### Trout Results, csv 'AI' ID 8
```{r}
### Summarise by Month
AI$StreamflowDay_m3<-AI$Streamflow*(60*60*24)
AI.MON <- AI %>%
   group_by(Year, Month) %>%
   summarise(Month_Streamflow_m3 = sum(StreamflowDay_m3), Month_Precip_mm = sum(Precip))
AI.MON$Streamflow_Km<-AI.MON$Month_Streamflow_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
AI.MON$Streamflow_mm<-(AI.MON$Streamflow_Km/9270)*1000000 ## monthly runoff depth mm

#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
AI.MONT<- AI.MON [-c(1,2,3),]
AI.MONT
```

```{r}
AIT<-GMP2[[946:1512]] #Trout
AIE<-extent(238.5,241,60,61.5) #Trout Extent
AIPC<-crop(AIT,AIE) #Trout Crop
AI.Mon.Precip.<-extract(AIPC,AIE, method="bilinear", fun = mean)
AIMP<-as.data.frame(colMeans(AI.Mon.Precip.)) #Trout
AISub<-DateTemp[DateTemp$Date >= as.Date("1969-10-01") & DateTemp$Date <=
                    as.Date("2016-12-01"), ] ##Trout
AIPp<- cbind(AIMP,AISub) ## Trout
```

```{r}
AI.MONT$GriddedPrecip_mm<- AIPp$`colMeans(AI.Mon.Precip.)`
AI.MONT
```

##############
```{r}
## Water Year Sequencing
AI.MT<- AI.MONT[-c(565,566,567),]
AI.MT$Water_Year_Month <- rep(seq(1:12),47) #1975 to 2016 is 43 years
AI.MT$Water_Year_Year <- rep(1:47, each =12)
AI.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 AI.WY <- AI.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
AI.WY
```
##############
```{r}
## Monthly Columns
## Oct
 AI.OCT <- AI.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 AI.NOV <- AI.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 AI.DEC <- AI.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 AI.JAN <- AI.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 AI.FEB <- AI.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 AI.MAR <- AI.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 AI.APL <- AI.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 AI.MAY <- AI.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 AI.JUN <- AI.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 AI.JUL <- AI.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 AI.AUG <- AI.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 AI.SEP <- AI.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
AI.ALL <- cbind(AI.WY, AI.OCT[,-1], AI.NOV[,-1], AI.DEC[,-1], AI.JAN[,-1], AI.FEB[,-1], AI.MAR[,-1], AI.APL[,-1],AI.MAY[,-1], AI.JUN[,-1], AI.JUL[,-1], AI.AUG[,-1], AI.SEP[,-1])
```
####################
```{r}
AI.ALL$AN_RR <- AI.ALL$AN_RO_mm/AI.ALL$AN_PCP_mm
AI.ALL$OCT_RR <- AI.ALL$Oct_RO_mm/AI.ALL$Oct_PCP_mm
AI.ALL$NOV_RR <- AI.ALL$Nov_RO_mm/AI.ALL$Nov_PCP_mm
AI.ALL$DEC_RR <- AI.ALL$Dec_RO_mm/AI.ALL$Dec_PCP_mm
AI.ALL$JAN_RR <- AI.ALL$Jan_RO_mm/AI.ALL$Jan_PCP_mm
AI.ALL$FEB_RR <- AI.ALL$Feb_RO_mm/AI.ALL$Feb_PCP_mm
AI.ALL$MAR_RR <- AI.ALL$Mar_RO_mm/AI.ALL$Mar_PCP_mm
AI.ALL$APL_RR <- AI.ALL$Apl_RO_mm/AI.ALL$Apl_PCP_mm
AI.ALL$MAY_RR <- AI.ALL$May_RO_mm/AI.ALL$May_PCP_mm
AI.ALL$JUN_RR <- AI.ALL$Jun_RO_mm/AI.ALL$Jun_PCP_mm
AI.ALL$JUL_RR <- AI.ALL$Jul_RO_mm/AI.ALL$Jul_PCP_mm
AI.ALL$AUG_RR <- AI.ALL$Aug_RO_mm/AI.ALL$Aug_PCP_mm
AI.ALL$SEP_RR <- AI.ALL$Sep_RO_mm/AI.ALL$Sep_PCP_mm
AI.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(AI.ALL[,-1],2, mean))
CSD <- rbind(apply(AI.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
AI.ALL[nrow(AI.ALL)+ 1,] = CML
AI.ALL[nrow(AI.ALL)+ 1,] = CSDL
AI.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(AI.ALL[1:47,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
AI.TS <-AI.ALL[1:47,1:40]
AI.TSN <- as.data.frame(apply(AI.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(AI.TSN, class)   
AI.TSN
```
############################################
```{r}
AIM1 <- mblm(AN_RO_mm~ Water_Year_Year, AI.TSN)
AIM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AI.TSN)
AIM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AI.TSN)
AIM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AI.TSN)
AIM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AI.TSN)
AIM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AI.TSN)
AIM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AI.TSN)
AIM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AI.TSN)
AIM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AI.TSN)
AIM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AI.TSN)
AIM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AI.TSN)
AIM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AI.TSN)
AIM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AI.TSN)
AIM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AI.TSN)
AIM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AI.TSN)
AIM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AI.TSN)
AIM17 <- mblm(May_RO_mm~ Water_Year_Year, AI.TSN)
AIM18 <- mblm(May_PCP_mm~ Water_Year_Year, AI.TSN)
AIM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AI.TSN)
AIM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AI.TSN)
AIM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AI.TSN)
AIM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AI.TSN)
AIM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AI.TSN)
AIM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AI.TSN)
AIM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AI.TSN)
AIM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AI.TSN)
AIM27 <- mblm(AN_RR~ Water_Year_Year, AI.TSN)
AIM28 <- mblm(OCT_RR~ Water_Year_Year, AI.TSN)
AIM29 <- mblm(NOV_RR~ Water_Year_Year, AI.TSN)
AIM30 <- mblm(DEC_RR~ Water_Year_Year, AI.TSN)
AIM31 <- mblm(JAN_RR~ Water_Year_Year, AI.TSN)
AIM32 <- mblm(FEB_RR~ Water_Year_Year, AI.TSN)
AIM33 <- mblm(MAR_RR~ Water_Year_Year, AI.TSN)
AIM34 <- mblm(APL_RR~ Water_Year_Year, AI.TSN)
AIM35 <- mblm(MAY_RR~ Water_Year_Year, AI.TSN)
AIM36 <- mblm(JUN_RR~ Water_Year_Year, AI.TSN)
AIM37 <- mblm(JUL_RR~ Water_Year_Year, AI.TSN)
AIM38 <- mblm(AUG_RR~ Water_Year_Year, AI.TSN)
AIM39 <- mblm(SEP_RR~ Water_Year_Year, AI.TSN)
```
####################################
```{r}
TSR<- cbind(AIM1$coefficients, AIM2$coefficients, AIM3$coefficients, AIM4$coefficients, AIM5$coefficients, AIM6$coefficients,AIM7$coefficients, AIM8$coefficients, AIM9$coefficients,AIM10$coefficients, AIM11$coefficients, AIM12$coefficients,AIM13$coefficients, AIM14$coefficients, AIM15$coefficients,AIM16$coefficients, AIM17$coefficients, AIM18$coefficients,AIM19$coefficients, AIM20$coefficients, AIM21$coefficients,AIM22$coefficients, AIM23$coefficients, AIM4$coefficients,AIM25$coefficients, AIM26$coefficients, AIM27$coefficients,AIM28$coefficients, AIM29$coefficients, AIM30$coefficients,AIM31$coefficients, AIM32$coefficients, AIM33$coefficients,AIM34$coefficients, AIM35$coefficients, AIM36$coefficients,AIM37$coefficients, AIM38$coefficients, AIM39$coefficients)
RES <- cbind(AIM1$residuals, AIM2$residuals, AIM3$residuals, AIM4$residuals, AIM5$residuals, AIM6$residuals,AIM7$residuals, AIM8$residuals, AIM9$residuals,AIM10$residuals, AIM11$residuals, AIM12$residuals,AIM13$residuals, AIM14$residuals, AIM15$residuals,AIM16$residuals, AIM17$residuals, AIM18$residuals,AIM19$residuals, AIM20$residuals, AIM21$residuals,AIM22$residuals, AIM23$residuals, AIM4$residuals,AIM25$residuals, AIM26$residuals, AIM27$residuals,AIM28$residuals, AIM29$residuals, AIM30$residuals,AIM31$residuals, AIM32$residuals, AIM33$residuals,AIM34$residuals, AIM35$residuals, AIM36$residuals,AIM37$residuals, AIM38$residuals, AIM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AI.ALL[nrow(AI.ALL)+ 1,] = MKTR
AI.ALL[nrow(AI.ALL)+ 1,] = MKPR
AI.ALL[nrow(AI.ALL)+ 1,] = TSRR
AI.ALL[nrow(AI.ALL)+ 1,] = BTDF
AI.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- AI.ALL[1:47,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
AI.ALL[nrow(AI.ALL)+ 1,] = MMKPR
AI.ALL[nrow(AI.ALL)+ 1,] = MMKTR
AI.ALL[nrow(AI.ALL)+ 1,] = MMKSR
AI.ALL
```

```{r}
AI.NUM <- as.data.frame(apply(AI.ALL[1:56,2:40], 2, as.numeric))
str(AI.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(AI.NUM[53,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(AI.NUM[52,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(AI.NUM[56,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(AI.NUM[51,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(AI.NUM[54,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
AI.ALL[nrow(AI.ALL)+ 1,] = FSR1
AI.ALL[nrow(AI.ALL)+ 1,] = FSR2
AI.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
AIFM <-AI.ALL[c(57,58),-1]
AIF <- as.matrix(apply(AIFM, 2, as.numeric))
AIF
```
####################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(AI.ALL[21:47,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
AI.TS2 <-AI.ALL[21:47,1:40] ## 1990 Subset
AI.TSN2 <- as.data.frame(apply(AI.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(AI.TSN2, class)   
AI.TSN2
```
############################################
```{r}
AIM1 <- mblm(AN_RO_mm~ Water_Year_Year, AI.TSN2)
AIM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AI.TSN2)
AIM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AI.TSN2)
AIM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AI.TSN2)
AIM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AI.TSN2)
AIM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AI.TSN2)
AIM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AI.TSN2)
AIM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AI.TSN2)
AIM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AI.TSN2)
AIM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AI.TSN2)
AIM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AI.TSN2)
AIM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AI.TSN2)
AIM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AI.TSN2)
AIM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AI.TSN2)
AIM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AI.TSN2)
AIM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AI.TSN2)
AIM17 <- mblm(May_RO_mm~ Water_Year_Year, AI.TSN2)
AIM18 <- mblm(May_PCP_mm~ Water_Year_Year, AI.TSN2)
AIM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AI.TSN2)
AIM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AI.TSN2)
AIM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AI.TSN2)
AIM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AI.TSN2)
AIM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AI.TSN2)
AIM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AI.TSN2)
AIM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AI.TSN2)
AIM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AI.TSN2)
AIM27 <- mblm(AN_RR~ Water_Year_Year, AI.TSN2)
AIM28 <- mblm(OCT_RR~ Water_Year_Year, AI.TSN2)
AIM29 <- mblm(NOV_RR~ Water_Year_Year, AI.TSN2)
AIM30 <- mblm(DEC_RR~ Water_Year_Year, AI.TSN2)
AIM31 <- mblm(JAN_RR~ Water_Year_Year, AI.TSN2)
AIM32 <- mblm(FEB_RR~ Water_Year_Year, AI.TSN2)
AIM33 <- mblm(MAR_RR~ Water_Year_Year, AI.TSN2)
AIM34 <- mblm(APL_RR~ Water_Year_Year, AI.TSN2)
AIM35 <- mblm(MAY_RR~ Water_Year_Year, AI.TSN2)
AIM36 <- mblm(JUN_RR~ Water_Year_Year, AI.TSN2)
AIM37 <- mblm(JUL_RR~ Water_Year_Year, AI.TSN2)
AIM38 <- mblm(AUG_RR~ Water_Year_Year, AI.TSN2)
AIM39 <- mblm(SEP_RR~ Water_Year_Year, AI.TSN2)
```
####################################
```{r}
TSR2<- cbind(AIM1$coefficients, AIM2$coefficients, AIM3$coefficients, AIM4$coefficients, AIM5$coefficients, AIM6$coefficients,AIM7$coefficients, AIM8$coefficients, AIM9$coefficients,AIM10$coefficients, AIM11$coefficients, AIM12$coefficients,AIM13$coefficients, AIM14$coefficients, AIM15$coefficients,AIM16$coefficients, AIM17$coefficients, AIM18$coefficients,AIM19$coefficients, AIM20$coefficients, AIM21$coefficients,AIM22$coefficients, AIM23$coefficients, AIM4$coefficients,AIM25$coefficients, AIM26$coefficients, AIM27$coefficients,AIM28$coefficients, AIM29$coefficients, AIM30$coefficients,AIM31$coefficients, AIM32$coefficients, AIM33$coefficients,AIM34$coefficients, AIM35$coefficients, AIM36$coefficients,AIM37$coefficients, AIM38$coefficients, AIM39$coefficients)
RES2 <- cbind(AIM1$residuals, AIM2$residuals, AIM3$residuals, AIM4$residuals, AIM5$residuals, AIM6$residuals,AIM7$residuals, AIM8$residuals, AIM9$residuals,AIM10$residuals, AIM11$residuals, AIM12$residuals,AIM13$residuals, AIM14$residuals, AIM15$residuals,AIM16$residuals, AIM17$residuals, AIM18$residuals,AIM19$residuals, AIM20$residuals, AIM21$residuals,AIM22$residuals, AIM23$residuals, AIM4$residuals,AIM25$residuals, AIM26$residuals, AIM27$residuals,AIM28$residuals, AIM29$residuals, AIM30$residuals,AIM31$residuals, AIM32$residuals, AIM33$residuals,AIM34$residuals, AIM35$residuals, AIM36$residuals,AIM37$residuals, AIM38$residuals, AIM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AI.ALL[nrow(AI.ALL)+ 1,] = MKTR2
AI.ALL[nrow(AI.ALL)+ 1,] = MKPR2
AI.ALL[nrow(AI.ALL)+ 1,] = TSRR2
AI.ALL[nrow(AI.ALL)+ 1,] = BTDF2
AI.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- AI.ALL[21:46,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
AI.ALL[nrow(AI.ALL)+ 1,] = MMKPR2
AI.ALL[nrow(AI.ALL)+ 1,] = MMKTR2
AI.ALL[nrow(AI.ALL)+ 1,] = MMKSR2
AI.ALL
```

```{r}
AI.ALL
```

```{r}
AI.NUM2 <- as.data.frame(apply(AI.ALL[1:65,2:40], 2, as.numeric))
str(AI.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(AI.NUM2[62,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(AI.NUM2[61,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(AI.NUM2[65,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(AI.NUM2[60,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(AI.NUM2[63,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
AI.ALL[nrow(AI.ALL)+ 1,] = FSR12
AI.ALL[nrow(AI.ALL)+ 1,] = FSR22
AI.ALL
```

```{r}
AI.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
AIFM2 <-AI.ALL[c(66,67),-1]
AIF2 <- as.matrix(apply(AIFM2, 2, as.numeric))
AIF2
```

### Angling Results, csv 'A' ID 9
```{r}
### Summarise by Month
A$StreamflowDay_m3<-A$Streamflow*(60*60*24)
A.MON <- A %>%
   group_by(Year, Month) %>%
   summarise(Month_Streamflow_m3 = sum(StreamflowDay_m3), Month_Precip_mm = sum(Precip))
A.MON$Streamflow_Km<-A.MON$Month_Streamflow_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
A.MON$Streamflow_mm<-(A.MON$Streamflow_Km/1560)*1000000 ## monthly runoff depth mm
#A.MO
#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
A.MONT<- A.MON[-c(1,2,3,4,5,6,7,8,9,454,455,456),]
A.MONT
```

```{r}

AT<-GMP2[[1066:1509]] #Angling
AE<-extent(266,266.5,56,57) #Angling Extent
APC<-crop(AT,AE) #Angling Crop
A.Mon.Precip.<-extract(APC,AE, method="bilinear", fun = mean)
AMP<-as.data.frame(colMeans(A.Mon.Precip.)) #Angling
ASub<-DateTemp[DateTemp$Date >= as.Date("1979-10-01") & DateTemp$Date <=
                    as.Date("2016-09-01"), ] ##Anlging
APp<- cbind(AMP,ASub) ## Angling (filter out winter months)
```

```{r}
A.MONT$GriddedPrecip_mm<- AMP$`colMeans(A.Mon.Precip.)`
A.MONT
```

##############
```{r}
## Water Year Sequencing
A.MT<- A.MONT
A.MT$Water_Year_Month <- rep(seq(1:12),37) #1975 to 2016 is 43 years
A.MT$Water_Year_Year <- rep(1:37, each =12)
A.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 A.WY <- A.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
A.WY
```
##############
```{r}
## Monthly Columns
## Oct
 A.OCT <- A.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 A.NOV <- A.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 A.DEC <- A.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 A.JAN <- A.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 A.FEB <- A.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 A.MAR <- A.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 A.APL <- A.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 A.MAY <- A.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 A.JUN <- A.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 A.JUL <- A.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 A.AUG <- A.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 A.SEP <- A.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
A.ALL <- cbind(A.WY, A.OCT[,-1], A.NOV[,-1], A.DEC[,-1], A.JAN[,-1], A.FEB[,-1], A.MAR[,-1], A.APL[,-1],A.MAY[,-1], A.JUN[,-1], A.JUL[,-1], A.AUG[,-1], A.SEP[,-1])
```
####################
```{r}
A.ALL$AN_RR <- A.ALL$AN_RO_mm/A.ALL$AN_PCP_mm
A.ALL$OCT_RR <- A.ALL$Oct_RO_mm/A.ALL$Oct_PCP_mm
A.ALL$NOV_RR <- A.ALL$Nov_RO_mm/A.ALL$Nov_PCP_mm
A.ALL$DEC_RR <- A.ALL$Dec_RO_mm/A.ALL$Dec_PCP_mm
A.ALL$JAN_RR <- A.ALL$Jan_RO_mm/A.ALL$Jan_PCP_mm
A.ALL$FEB_RR <- A.ALL$Feb_RO_mm/A.ALL$Feb_PCP_mm
A.ALL$MAR_RR <- A.ALL$Mar_RO_mm/A.ALL$Mar_PCP_mm
A.ALL$APL_RR <- A.ALL$Apl_RO_mm/A.ALL$Apl_PCP_mm
A.ALL$MAY_RR <- A.ALL$May_RO_mm/A.ALL$May_PCP_mm
A.ALL$JUN_RR <- A.ALL$Jun_RO_mm/A.ALL$Jun_PCP_mm
A.ALL$JUL_RR <- A.ALL$Jul_RO_mm/A.ALL$Jul_PCP_mm
A.ALL$AUG_RR <- A.ALL$Aug_RO_mm/A.ALL$Aug_PCP_mm
A.ALL$SEP_RR <- A.ALL$Sep_RO_mm/A.ALL$Sep_PCP_mm
A.ALL[8,30] <- 0
A.ALL[2,36] <- 0

A.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(A.ALL[,-1],2, mean))
CSD <- rbind(apply(A.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
A.ALL[nrow(A.ALL)+ 1,] = CML
A.ALL[nrow(A.ALL)+ 1,] = CSDL
A.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(A.ALL[1:37,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
A.TS <-A.ALL[1:37,1:40]
A.TSN <- as.data.frame(apply(A.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(A.TSN, class)   
A.TSN
```
############################################
```{r}
AM1 <- mblm(AN_RO_mm~ Water_Year_Year, A.TSN)
AM2 <- mblm(AN_PCP_mm~ Water_Year_Year, A.TSN)
AM3 <- mblm(Oct_RO_mm~ Water_Year_Year, A.TSN)
AM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, A.TSN)
AM5 <- mblm(Nov_RO_mm~ Water_Year_Year, A.TSN)
AM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, A.TSN)
AM7 <- mblm(Dec_RO_mm~ Water_Year_Year, A.TSN)
AM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, A.TSN)
AM9 <- mblm(Jan_RO_mm~ Water_Year_Year, A.TSN)
AM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, A.TSN)
AM11 <- mblm(Feb_RO_mm~ Water_Year_Year, A.TSN)
AM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, A.TSN)
AM13 <- mblm(Mar_RO_mm~ Water_Year_Year, A.TSN)
AM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, A.TSN)
AM15 <- mblm(Apl_RO_mm~ Water_Year_Year, A.TSN)
AM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, A.TSN)
AM17 <- mblm(May_RO_mm~ Water_Year_Year, A.TSN)
AM18 <- mblm(May_PCP_mm~ Water_Year_Year, A.TSN)
AM19 <- mblm(Jun_RO_mm~ Water_Year_Year, A.TSN)
AM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, A.TSN)
AM21 <- mblm(Jul_RO_mm~ Water_Year_Year, A.TSN)
AM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, A.TSN)
AM23 <- mblm(Aug_RO_mm~ Water_Year_Year, A.TSN)
AM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, A.TSN)
AM25 <- mblm(Sep_RO_mm~ Water_Year_Year, A.TSN)
AM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, A.TSN)
AM27 <- mblm(AN_RR~ Water_Year_Year, A.TSN)
AM28 <- mblm(OCT_RR~ Water_Year_Year, A.TSN)
AM29 <- mblm(NOV_RR~ Water_Year_Year, A.TSN)
AM30 <- mblm(DEC_RR~ Water_Year_Year, A.TSN)
AM31 <- mblm(JAN_RR~ Water_Year_Year, A.TSN)
AM32 <- mblm(FEB_RR~ Water_Year_Year, A.TSN)
AM33 <- mblm(MAR_RR~ Water_Year_Year, A.TSN)
AM34 <- mblm(APL_RR~ Water_Year_Year, A.TSN)
AM35 <- mblm(MAY_RR~ Water_Year_Year, A.TSN)
AM36 <- mblm(JUN_RR~ Water_Year_Year, A.TSN)
AM37 <- mblm(JUL_RR~ Water_Year_Year, A.TSN)
AM38 <- mblm(AUG_RR~ Water_Year_Year, A.TSN)
AM39 <- mblm(SEP_RR~ Water_Year_Year, A.TSN)
```
####################################
```{r}
TSR<- cbind(AM1$coefficients, AM2$coefficients, AM3$coefficients, AM4$coefficients, AM5$coefficients, AM6$coefficients,AM7$coefficients, AM8$coefficients, AM9$coefficients,AM10$coefficients, AM11$coefficients, AM12$coefficients,AM13$coefficients, AM14$coefficients, AM15$coefficients,AM16$coefficients, AM17$coefficients, AM18$coefficients,AM19$coefficients, AM20$coefficients, AM21$coefficients,AM22$coefficients, AM23$coefficients, AM4$coefficients,AM25$coefficients, AM26$coefficients, AM27$coefficients,AM28$coefficients, AM29$coefficients, AM30$coefficients,AM31$coefficients, AM32$coefficients, AM33$coefficients,AM34$coefficients, AM35$coefficients, AM36$coefficients,AM37$coefficients, AM38$coefficients, AM39$coefficients)
RES <- cbind(AM1$residuals, AM2$residuals, AM3$residuals, AM4$residuals, AM5$residuals, AM6$residuals,AM7$residuals, AM8$residuals, AM9$residuals,AM10$residuals, AM11$residuals, AM12$residuals,AM13$residuals, AM14$residuals, AM15$residuals,AM16$residuals, AM17$residuals, AM18$residuals,AM19$residuals, AM20$residuals, AM21$residuals,AM22$residuals, AM23$residuals, AM4$residuals,AM25$residuals, AM26$residuals, AM27$residuals,AM28$residuals, AM29$residuals, AM30$residuals,AM31$residuals, AM32$residuals, AM33$residuals,AM34$residuals, AM35$residuals, AM36$residuals,AM37$residuals, AM38$residuals, AM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
A.ALL[nrow(A.ALL)+ 1,] = MKTR
A.ALL[nrow(A.ALL)+ 1,] = MKPR
A.ALL[nrow(A.ALL)+ 1,] = TSRR
A.ALL[nrow(A.ALL)+ 1,] = BTDF
A.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- A.ALL[1:43,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
A.ALL[nrow(A.ALL)+ 1,] = MMKPR
A.ALL[nrow(A.ALL)+ 1,] = MMKTR
A.ALL[nrow(A.ALL)+ 1,] = MMKSR
A.ALL
```

```{r}
A.NUM <- as.data.frame(apply(A.ALL[1:46,2:40], 2, as.numeric))
str(A.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(A.NUM[43,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(A.NUM[42,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(A.NUM[46,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(A.NUM[41,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(A.NUM[46,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
A.ALL[nrow(A.ALL)+ 1,] = FSR1
A.ALL[nrow(A.ALL)+ 1,] = FSR2
A.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
AFM <-A.ALL[c(47,48),-1]
AF <- as.matrix(apply(AFM, 2, as.numeric))
AF
```
###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(A.ALL[11:37,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
A.TS2 <-A.ALL[11:37,1:40] ## 1990 Subset
A.TSN2 <- as.data.frame(apply(A.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(A.TSN2, class)   
A.TSN2
```
############################################
```{r}
AM1 <- mblm(AN_RO_mm~ Water_Year_Year, A.TSN2)
AM2 <- mblm(AN_PCP_mm~ Water_Year_Year, A.TSN2)
AM3 <- mblm(Oct_RO_mm~ Water_Year_Year, A.TSN2)
AM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, A.TSN2)
AM5 <- mblm(Nov_RO_mm~ Water_Year_Year, A.TSN2)
AM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, A.TSN2)
AM7 <- mblm(Dec_RO_mm~ Water_Year_Year, A.TSN2)
AM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, A.TSN2)
AM9 <- mblm(Jan_RO_mm~ Water_Year_Year, A.TSN2)
AM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, A.TSN2)
AM11 <- mblm(Feb_RO_mm~ Water_Year_Year, A.TSN2)
AM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, A.TSN2)
AM13 <- mblm(Mar_RO_mm~ Water_Year_Year, A.TSN2)
AM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, A.TSN2)
AM15 <- mblm(Apl_RO_mm~ Water_Year_Year, A.TSN2)
AM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, A.TSN2)
AM17 <- mblm(May_RO_mm~ Water_Year_Year, A.TSN2)
AM18 <- mblm(May_PCP_mm~ Water_Year_Year, A.TSN2)
AM19 <- mblm(Jun_RO_mm~ Water_Year_Year, A.TSN2)
AM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, A.TSN2)
AM21 <- mblm(Jul_RO_mm~ Water_Year_Year, A.TSN2)
AM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, A.TSN2)
AM23 <- mblm(Aug_RO_mm~ Water_Year_Year, A.TSN2)
AM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, A.TSN2)
AM25 <- mblm(Sep_RO_mm~ Water_Year_Year, A.TSN2)
AM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, A.TSN2)
AM27 <- mblm(AN_RR~ Water_Year_Year, A.TSN2)
AM28 <- mblm(OCT_RR~ Water_Year_Year, A.TSN2)
AM29 <- mblm(NOV_RR~ Water_Year_Year, A.TSN2)
AM30 <- mblm(DEC_RR~ Water_Year_Year, A.TSN2)
AM31 <- mblm(JAN_RR~ Water_Year_Year, A.TSN2)
AM32 <- mblm(FEB_RR~ Water_Year_Year, A.TSN2)
AM33 <- mblm(MAR_RR~ Water_Year_Year, A.TSN2)
AM34 <- mblm(APL_RR~ Water_Year_Year, A.TSN2)
AM35 <- mblm(MAY_RR~ Water_Year_Year, A.TSN2)
AM36 <- mblm(JUN_RR~ Water_Year_Year, A.TSN2)
AM37 <- mblm(JUL_RR~ Water_Year_Year, A.TSN2)
AM38 <- mblm(AUG_RR~ Water_Year_Year, A.TSN2)
AM39 <- mblm(SEP_RR~ Water_Year_Year, A.TSN2)
```
####################################
```{r}
TSR2<- cbind(AM1$coefficients, AM2$coefficients, AM3$coefficients, AM4$coefficients, AM5$coefficients, AM6$coefficients,AM7$coefficients, AM8$coefficients, AM9$coefficients,AM10$coefficients, AM11$coefficients, AM12$coefficients,AM13$coefficients, AM14$coefficients, AM15$coefficients,AM16$coefficients, AM17$coefficients, AM18$coefficients,AM19$coefficients, AM20$coefficients, AM21$coefficients,AM22$coefficients, AM23$coefficients, AM4$coefficients,AM25$coefficients, AM26$coefficients, AM27$coefficients,AM28$coefficients, AM29$coefficients, AM30$coefficients,AM31$coefficients, AM32$coefficients, AM33$coefficients,AM34$coefficients, AM35$coefficients, AM36$coefficients,AM37$coefficients, AM38$coefficients, AM39$coefficients)
RES2 <- cbind(AM1$residuals, AM2$residuals, AM3$residuals, AM4$residuals, AM5$residuals, AM6$residuals,AM7$residuals, AM8$residuals, AM9$residuals,AM10$residuals, AM11$residuals, AM12$residuals,AM13$residuals, AM14$residuals, AM15$residuals,AM16$residuals, AM17$residuals, AM18$residuals,AM19$residuals, AM20$residuals, AM21$residuals,AM22$residuals, AM23$residuals, AM4$residuals,AM25$residuals, AM26$residuals, AM27$residuals,AM28$residuals, AM29$residuals, AM30$residuals,AM31$residuals, AM32$residuals, AM33$residuals,AM34$residuals, AM35$residuals, AM36$residuals,AM37$residuals, AM38$residuals, AM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
A.ALL[nrow(A.ALL)+ 1,] = MKTR2
A.ALL[nrow(A.ALL)+ 1,] = MKPR2
A.ALL[nrow(A.ALL)+ 1,] = TSRR2
A.ALL[nrow(A.ALL)+ 1,] = BTDF2
A.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- A.ALL[13:37,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
A.ALL[nrow(A.ALL)+ 1,] = MMKPR2
A.ALL[nrow(A.ALL)+ 1,] = MMKTR2
A.ALL[nrow(A.ALL)+ 1,] = MMKSR2
A.ALL
```

```{r}
A.ALL
```

```{r}
A.NUM2 <- as.data.frame(apply(A.ALL[1:55,2:40], 2, as.numeric))
str(A.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(A.NUM2[52,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(A.NUM2[51,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(A.NUM2[55,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(A.NUM2[50,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(A.NUM2[53,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
A.ALL[nrow(A.ALL)+ 1,] = FSR12
A.ALL[nrow(A.ALL)+ 1,] = FSR22
A.ALL
```

```{r}
A.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
AFM2 <-A.ALL[c(56,57),-1]
AF2 <- as.matrix(apply(AFM2, 2, as.numeric))
AF2
```

### Pontax Results, csv 'AB' ID 10
```{r}
### Summarise by Month
AB$StreamflowDay_m3<-AB$Streamflow*(60*60*24)
AB.MON <- AB %>%
   group_by(Year, Month) %>%
   summarise(Month_Streamflow_m3 = sum(StreamflowDay_m3), Month_Precip_mm = sum(Precip))
AB.MON$Streamflow_Km<-AB.MON$Month_Streamflow_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
AB.MON$Streamflow_mm<-(AB.MON$Streamflow_Km/8133)*1000000 ## monthly runoff depth mm
#AB.MON
#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
AB.MONT<- AB.MON[-c(1,2,3,4,5,450,451,452,453,454,455,456,457),]
AB.MONT
```

```{r}
ABT<-GMP2[[1018:1461]] #Pontax
ABE<-extent(282,283.5,50.5,51.5) #Pontax Extent
ABPC<-crop(ABT,ABE) #Pontax Crop
AB.Mon.Precip.<-extract(ABPC,ABE, method="bilinear", fun = mean)
ABMP<-as.data.frame(colMeans(AB.Mon.Precip.)) #Pontax
ABSub<-DateTemp[DateTemp$Date >= as.Date("1975-10-01") & DateTemp$Date <=
                    as.Date("2012-09-01"), ] ## Pontax
ABPp<- cbind(ABMP,ABSub) ## Pontax
```

```{r}
AB.MONT$GriddedPrecip_mm<- ABMP$`colMeans(AB.Mon.Precip.)`
```

##############
```{r}
## Water Year Sequencing
AB.MT<- AB.MONT
AB.MT$Water_Year_Month <- rep(seq(1:12),37) #1975 to 2016 is 43 years
AB.MT$Water_Year_Year <- rep(1:37, each =12)
AB.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 AB.WY <- AB.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
AB.WY
```
##############
```{r}
## Monthly Columns
## Oct
 AB.OCT <- AB.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 AB.NOV <- AB.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 AB.DEC <- AB.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 AB.JAN <- AB.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 AB.FEB <- AB.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 AB.MAR <- AB.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 AB.APL <- AB.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 AB.MAY <- AB.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 AB.JUN <- AB.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 AB.JUL <- AB.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 AB.AUG <- AB.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 AB.SEP <- AB.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
AB.ALL <- cbind(AB.WY, AB.OCT[,-1], AB.NOV[,-1], AB.DEC[,-1], AB.JAN[,-1], AB.FEB[,-1], AB.MAR[,-1], AB.APL[,-1],AB.MAY[,-1], AB.JUN[,-1], AB.JUL[,-1], AB.AUG[,-1], AB.SEP[,-1])
```
####################
```{r}
AB.ALL$AN_RR <- AB.ALL$AN_RO_mm/AB.ALL$AN_PCP_mm
AB.ALL$OCT_RR <- AB.ALL$Oct_RO_mm/AB.ALL$Oct_PCP_mm
AB.ALL$NOV_RR <- AB.ALL$Nov_RO_mm/AB.ALL$Nov_PCP_mm
AB.ALL$DEC_RR <- AB.ALL$Dec_RO_mm/AB.ALL$Dec_PCP_mm
AB.ALL$JAN_RR <- AB.ALL$Jan_RO_mm/AB.ALL$Jan_PCP_mm
AB.ALL$FEB_RR <- AB.ALL$Feb_RO_mm/AB.ALL$Feb_PCP_mm
AB.ALL$MAR_RR <- AB.ALL$Mar_RO_mm/AB.ALL$Mar_PCP_mm
AB.ALL$APL_RR <- AB.ALL$Apl_RO_mm/AB.ALL$Apl_PCP_mm
AB.ALL$MAY_RR <- AB.ALL$May_RO_mm/AB.ALL$May_PCP_mm
AB.ALL$JUN_RR <- AB.ALL$Jun_RO_mm/AB.ALL$Jun_PCP_mm
AB.ALL$JUL_RR <- AB.ALL$Jul_RO_mm/AB.ALL$Jul_PCP_mm
AB.ALL$AUG_RR <- AB.ALL$Aug_RO_mm/AB.ALL$Aug_PCP_mm
AB.ALL$SEP_RR <- AB.ALL$Sep_RO_mm/AB.ALL$Sep_PCP_mm
AB.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(AB.ALL[,-1],2, mean))
CSD <- rbind(apply(AB.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
AB.ALL[nrow(AB.ALL)+ 1,] = CML
AB.ALL[nrow(AB.ALL)+ 1,] = CSDL
AB.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(AB.ALL[1:37,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
AB.TS <-AB.ALL[1:37,1:40]
AB.TSN <- as.data.frame(apply(AB.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(AB.TSN, class)   
AB.TSN
```
############################################
```{r}
ABM1 <- mblm(AN_RO_mm~ Water_Year_Year, AB.TSN)
ABM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AB.TSN)
ABM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AB.TSN)
ABM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AB.TSN)
ABM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AB.TSN)
ABM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AB.TSN)
ABM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AB.TSN)
ABM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AB.TSN)
ABM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AB.TSN)
ABM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AB.TSN)
ABM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AB.TSN)
ABM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AB.TSN)
ABM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AB.TSN)
ABM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AB.TSN)
ABM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AB.TSN)
ABM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AB.TSN)
ABM17 <- mblm(May_RO_mm~ Water_Year_Year, AB.TSN)
ABM18 <- mblm(May_PCP_mm~ Water_Year_Year, AB.TSN)
ABM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AB.TSN)
ABM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AB.TSN)
ABM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AB.TSN)
ABM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AB.TSN)
ABM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AB.TSN)
ABM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AB.TSN)
ABM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AB.TSN)
ABM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AB.TSN)
ABM27 <- mblm(AN_RR~ Water_Year_Year, AB.TSN)
ABM28 <- mblm(OCT_RR~ Water_Year_Year, AB.TSN)
ABM29 <- mblm(NOV_RR~ Water_Year_Year, AB.TSN)
ABM30 <- mblm(DEC_RR~ Water_Year_Year, AB.TSN)
ABM31 <- mblm(JAN_RR~ Water_Year_Year, AB.TSN)
ABM32 <- mblm(FEB_RR~ Water_Year_Year, AB.TSN)
ABM33 <- mblm(MAR_RR~ Water_Year_Year, AB.TSN)
ABM34 <- mblm(APL_RR~ Water_Year_Year, AB.TSN)
ABM35 <- mblm(MAY_RR~ Water_Year_Year, AB.TSN)
ABM36 <- mblm(JUN_RR~ Water_Year_Year, AB.TSN)
ABM37 <- mblm(JUL_RR~ Water_Year_Year, AB.TSN)
ABM38 <- mblm(AUG_RR~ Water_Year_Year, AB.TSN)
ABM39 <- mblm(SEP_RR~ Water_Year_Year, AB.TSN)
```
####################################
```{r}
TSR<- cbind(ABM1$coefficients, ABM2$coefficients, ABM3$coefficients, ABM4$coefficients, ABM5$coefficients, ABM6$coefficients,ABM7$coefficients, ABM8$coefficients, ABM9$coefficients,ABM10$coefficients, ABM11$coefficients, ABM12$coefficients,ABM13$coefficients, ABM14$coefficients, ABM15$coefficients,ABM16$coefficients, ABM17$coefficients, ABM18$coefficients,ABM19$coefficients, ABM20$coefficients, ABM21$coefficients,ABM22$coefficients, ABM23$coefficients, ABM4$coefficients,ABM25$coefficients, ABM26$coefficients, ABM27$coefficients,ABM28$coefficients, ABM29$coefficients, ABM30$coefficients,ABM31$coefficients, ABM32$coefficients, ABM33$coefficients,ABM34$coefficients, ABM35$coefficients, ABM36$coefficients,ABM37$coefficients, ABM38$coefficients, ABM39$coefficients)
RES <- cbind(ABM1$residuals, ABM2$residuals, ABM3$residuals, ABM4$residuals, ABM5$residuals, ABM6$residuals,ABM7$residuals, ABM8$residuals, ABM9$residuals,ABM10$residuals, ABM11$residuals, ABM12$residuals,ABM13$residuals, ABM14$residuals, ABM15$residuals,ABM16$residuals, ABM17$residuals, ABM18$residuals,ABM19$residuals, ABM20$residuals, ABM21$residuals,ABM22$residuals, ABM23$residuals, ABM4$residuals,ABM25$residuals, ABM26$residuals, ABM27$residuals,ABM28$residuals, ABM29$residuals, ABM30$residuals,ABM31$residuals, ABM32$residuals, ABM33$residuals,ABM34$residuals, ABM35$residuals, ABM36$residuals,ABM37$residuals, ABM38$residuals, ABM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AB.ALL[nrow(AB.ALL)+ 1,] = MKTR
AB.ALL[nrow(AB.ALL)+ 1,] = MKPR
AB.ALL[nrow(AB.ALL)+ 1,] = TSRR
AB.ALL[nrow(AB.ALL)+ 1,] = BTDF
AB.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- AB.ALL[1:37,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
AB.ALL[nrow(AB.ALL)+ 1,] = MMKPR
AB.ALL[nrow(AB.ALL)+ 1,] = MMKTR
AB.ALL[nrow(AB.ALL)+ 1,] = MMKSR
AB.ALL
```

```{r}
AB.NUM <- as.data.frame(apply(AB.ALL[1:46,2:40], 2, as.numeric))
str(AB.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(AB.NUM[43,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(AB.NUM[42,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(AB.NUM[46,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(AB.NUM[41,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(AB.NUM[44,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
AB.ALL[nrow(AB.ALL)+ 1,] = FSR1
AB.ALL[nrow(AB.ALL)+ 1,] = FSR2
AB.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
ABFM <-AB.ALL[c(47,48),-1]
ABF <- as.matrix(apply(ABFM, 2, as.numeric))
ABF
```
###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(AB.ALL[15:37,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
AB.TS2 <-AB.ALL[15:37,1:40] ## 1990 Subset
AB.TSN2 <- as.data.frame(apply(AB.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(AB.TSN2, class)   
AB.TSN2
```
############################################
```{r}
ABM1 <- mblm(AN_RO_mm~ Water_Year_Year, AB.TSN2)
ABM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AB.TSN2)
ABM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AB.TSN2)
ABM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AB.TSN2)
ABM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AB.TSN2)
ABM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AB.TSN2)
ABM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AB.TSN2)
ABM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AB.TSN2)
ABM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AB.TSN2)
ABM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AB.TSN2)
ABM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AB.TSN2)
ABM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AB.TSN2)
ABM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AB.TSN2)
ABM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AB.TSN2)
ABM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AB.TSN2)
ABM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AB.TSN2)
ABM17 <- mblm(May_RO_mm~ Water_Year_Year, AB.TSN2)
ABM18 <- mblm(May_PCP_mm~ Water_Year_Year, AB.TSN2)
ABM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AB.TSN2)
ABM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AB.TSN2)
ABM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AB.TSN2)
ABM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AB.TSN2)
ABM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AB.TSN2)
ABM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AB.TSN2)
ABM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AB.TSN2)
ABM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AB.TSN2)
ABM27 <- mblm(AN_RR~ Water_Year_Year, AB.TSN2)
ABM28 <- mblm(OCT_RR~ Water_Year_Year, AB.TSN2)
ABM29 <- mblm(NOV_RR~ Water_Year_Year, AB.TSN2)
ABM30 <- mblm(DEC_RR~ Water_Year_Year, AB.TSN2)
ABM31 <- mblm(JAN_RR~ Water_Year_Year, AB.TSN2)
ABM32 <- mblm(FEB_RR~ Water_Year_Year, AB.TSN2)
ABM33 <- mblm(MAR_RR~ Water_Year_Year, AB.TSN2)
ABM34 <- mblm(APL_RR~ Water_Year_Year, AB.TSN2)
ABM35 <- mblm(MAY_RR~ Water_Year_Year, AB.TSN2)
ABM36 <- mblm(JUN_RR~ Water_Year_Year, AB.TSN2)
ABM37 <- mblm(JUL_RR~ Water_Year_Year, AB.TSN2)
ABM38 <- mblm(AUG_RR~ Water_Year_Year, AB.TSN2)
ABM39 <- mblm(SEP_RR~ Water_Year_Year, AB.TSN2)
```
####################################
```{r}
TSR2<- cbind(ABM1$coefficients, ABM2$coefficients, ABM3$coefficients, ABM4$coefficients, ABM5$coefficients, ABM6$coefficients,ABM7$coefficients, ABM8$coefficients, ABM9$coefficients,ABM10$coefficients, ABM11$coefficients, ABM12$coefficients,ABM13$coefficients, ABM14$coefficients, ABM15$coefficients,ABM16$coefficients, ABM17$coefficients, ABM18$coefficients,ABM19$coefficients, ABM20$coefficients, ABM21$coefficients,ABM22$coefficients, ABM23$coefficients, ABM4$coefficients,ABM25$coefficients, ABM26$coefficients, ABM27$coefficients,ABM28$coefficients, ABM29$coefficients, ABM30$coefficients,ABM31$coefficients, ABM32$coefficients, ABM33$coefficients,ABM34$coefficients, ABM35$coefficients, ABM36$coefficients,ABM37$coefficients, ABM38$coefficients, ABM39$coefficients)
RES2 <- cbind(ABM1$residuals, ABM2$residuals, ABM3$residuals, ABM4$residuals, ABM5$residuals, ABM6$residuals,ABM7$residuals, ABM8$residuals, ABM9$residuals,ABM10$residuals, ABM11$residuals, ABM12$residuals,ABM13$residuals, ABM14$residuals, ABM15$residuals,ABM16$residuals, ABM17$residuals, ABM18$residuals,ABM19$residuals, ABM20$residuals, ABM21$residuals,ABM22$residuals, ABM23$residuals, ABM4$residuals,ABM25$residuals, ABM26$residuals, ABM27$residuals,ABM28$residuals, ABM29$residuals, ABM30$residuals,ABM31$residuals, ABM32$residuals, ABM33$residuals,ABM34$residuals, ABM35$residuals, ABM36$residuals,ABM37$residuals, ABM38$residuals, ABM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AB.ALL[nrow(AB.ALL)+ 1,] = MKTR2
AB.ALL[nrow(AB.ALL)+ 1,] = MKPR2
AB.ALL[nrow(AB.ALL)+ 1,] = TSRR2
AB.ALL[nrow(AB.ALL)+ 1,] = BTDF2
AB.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- AB.ALL[15:37,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
AB.ALL[nrow(AB.ALL)+ 1,] = MMKPR2
AB.ALL[nrow(AB.ALL)+ 1,] = MMKTR2
AB.ALL[nrow(AB.ALL)+ 1,] = MMKSR2
AB.ALL
```

```{r}
AB.ALL
```

```{r}
AB.NUM2 <- as.data.frame(apply(AB.ALL[1:55,2:40], 2, as.numeric))
str(AB.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(AB.NUM2[52,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(AB.NUM2[51,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(AB.NUM2[55,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(AB.NUM2[50,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(AB.NUM2[53,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
AB.ALL[nrow(AB.ALL)+ 1,] = FSR12
AB.ALL[nrow(AB.ALL)+ 1,] = FSR22
AB.ALL
```

```{r}
AB.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
ABFM2 <-AB.ALL[c(56,57),-1]
ABF2 <- as.matrix(apply(ABFM2, 2, as.numeric))
ABF2
```

### Shammattawa Results, csv 'AEE' ID 11
```{r}
### Summarise by Month
AEE$StreamflowDay_m3<- AEE$Streamflow*(60*60*24)
AEE.MON <- AEE %>%
   group_by(Year, Month) %>%
   summarise(Month_Streamflow_m3 = sum(StreamflowDay_m3), Month_Precip_mm = sum(Precip))
AEE.MON$Streamflow_Km<-AEE.MON$Month_Streamflow_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
AEE.MON$Streamflow_mm<-(AEE.MON$Streamflow_Km/4710)*1000000 ## monthly runoff depth mm
#AEE.MON

#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
AEE.MONT<- AEE.MON[-c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,593,594,595,596,597,598,599,600,601,602,
                      603,604,605,606,607),]
AEE.MONT
```

```{r}
AET<-GMP2[[946:1509]] #Shamattawa
AEE<-extent(273,274.5,53.5,54.5) #Shammattawa Extent
AEPC<-crop(AET,AEE) #Shammattawa Crop
AE.Mon.Precip.<-extract(AEPC,AEE, method="bilinear", fun = mean)
AEMP<-as.data.frame(colMeans(AE.Mon.Precip.)) #Shammattawa
AESub<-DateTemp[DateTemp$Date >= as.Date("1969-10-01") & DateTemp$Date <=
                    as.Date("2016-09-01"), ] ##Shamattawa
AEPp<- cbind(AEMP,AESub) ## Shamattawa
```

```{r}
AEE.MONT$GriddedPrecip_mm<- AEMP$`colMeans(AE.Mon.Precip.)`
```
##############
```{r}
## Water Year Sequencing
AEE.MT<- AEE.MONT
AEE.MT$Water_Year_Month <- rep(seq(1:12),47) #1975 to 2016 is 43 years
AEE.MT$Water_Year_Year <- rep(1:47, each =12)
AEE.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 AEE.WY <- AEE.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
AEE.WY
```
##############
```{r}
## Monthly Columns
## Oct
 AEE.OCT <- AEE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 AEE.NOV <- AEE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 AEE.DEC <- AEE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 AEE.JAN <- AEE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 AEE.FEB <- AEE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 AEE.MAR <- AEE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 AEE.APL <- AEE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 AEE.MAY <- AEE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 AEE.JUN <- AEE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 AEE.JUL <- AEE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 AEE.AUG <- AEE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 AEE.SEP <- AEE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
AEE.ALL <- cbind(AEE.WY, AEE.OCT[,-1], AEE.NOV[,-1], AEE.DEC[,-1], AEE.JAN[,-1], AEE.FEB[,-1], AEE.MAR[,-1], AEE.APL[,-1],AEE.MAY[,-1], AEE.JUN[,-1], AEE.JUL[,-1], AEE.AUG[,-1], AEE.SEP[,-1])
```
####################
```{r}
AEE.ALL$AN_RR <- AEE.ALL$AN_RO_mm/AEE.ALL$AN_PCP_mm
AEE.ALL$OCT_RR <- AEE.ALL$Oct_RO_mm/AEE.ALL$Oct_PCP_mm
AEE.ALL$NOV_RR <- AEE.ALL$Nov_RO_mm/AEE.ALL$Nov_PCP_mm
AEE.ALL$DEC_RR <- AEE.ALL$Dec_RO_mm/AEE.ALL$Dec_PCP_mm
AEE.ALL$JAN_RR <- AEE.ALL$Jan_RO_mm/AEE.ALL$Jan_PCP_mm
AEE.ALL$FEB_RR <- AEE.ALL$Feb_RO_mm/AEE.ALL$Feb_PCP_mm
AEE.ALL$MAR_RR <- AEE.ALL$Mar_RO_mm/AEE.ALL$Mar_PCP_mm
AEE.ALL$APL_RR <- AEE.ALL$Apl_RO_mm/AEE.ALL$Apl_PCP_mm
AEE.ALL$MAY_RR <- AEE.ALL$May_RO_mm/AEE.ALL$May_PCP_mm
AEE.ALL$JUN_RR <- AEE.ALL$Jun_RO_mm/AEE.ALL$Jun_PCP_mm
AEE.ALL$JUL_RR <- AEE.ALL$Jul_RO_mm/AEE.ALL$Jul_PCP_mm
AEE.ALL$AUG_RR <- AEE.ALL$Aug_RO_mm/AEE.ALL$Aug_PCP_mm
AEE.ALL$SEP_RR <- AEE.ALL$Sep_RO_mm/AEE.ALL$Sep_PCP_mm
AEE.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(AEE.ALL[,-1],2, mean))
CSD <- rbind(apply(AEE.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
AEE.ALL[nrow(AEE.ALL)+ 1,] = CML
AEE.ALL[nrow(AEE.ALL)+ 1,] = CSDL
AEE.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(AEE.ALL[1:47,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
AEE.TS <-AEE.ALL[1:47,1:40]
AEE.TSN <- as.data.frame(apply(AEE.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(AEE.TSN, class)   
AEE.TSN
```
############################################
```{r}
AEEM1 <- mblm(AN_RO_mm~ Water_Year_Year, AEE.TSN)
AEEM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AEE.TSN)
AEEM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AEE.TSN)
AEEM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AEE.TSN)
AEEM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AEE.TSN)
AEEM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AEE.TSN)
AEEM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AEE.TSN)
AEEM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AEE.TSN)
AEEM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AEE.TSN)
AEEM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AEE.TSN)
AEEM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AEE.TSN)
AEEM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AEE.TSN)
AEEM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AEE.TSN)
AEEM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AEE.TSN)
AEEM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AEE.TSN)
AEEM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AEE.TSN)
AEEM17 <- mblm(May_RO_mm~ Water_Year_Year, AEE.TSN)
AEEM18 <- mblm(May_PCP_mm~ Water_Year_Year, AEE.TSN)
AEEM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AEE.TSN)
AEEM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AEE.TSN)
AEEM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AEE.TSN)
AEEM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AEE.TSN)
AEEM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AEE.TSN)
AEEM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AEE.TSN)
AEEM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AEE.TSN)
AEEM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AEE.TSN)
AEEM27 <- mblm(AN_RR~ Water_Year_Year, AEE.TSN)
AEEM28 <- mblm(OCT_RR~ Water_Year_Year, AEE.TSN)
AEEM29 <- mblm(NOV_RR~ Water_Year_Year, AEE.TSN)
AEEM30 <- mblm(DEC_RR~ Water_Year_Year, AEE.TSN)
AEEM31 <- mblm(JAN_RR~ Water_Year_Year, AEE.TSN)
AEEM32 <- mblm(FEB_RR~ Water_Year_Year, AEE.TSN)
AEEM33 <- mblm(MAR_RR~ Water_Year_Year, AEE.TSN)
AEEM34 <- mblm(APL_RR~ Water_Year_Year, AEE.TSN)
AEEM35 <- mblm(MAY_RR~ Water_Year_Year, AEE.TSN)
AEEM36 <- mblm(JUN_RR~ Water_Year_Year, AEE.TSN)
AEEM37 <- mblm(JUL_RR~ Water_Year_Year, AEE.TSN)
AEEM38 <- mblm(AUG_RR~ Water_Year_Year, AEE.TSN)
AEEM39 <- mblm(SEP_RR~ Water_Year_Year, AEE.TSN)
```
####################################
```{r}
TSR<- cbind(AEEM1$coefficients, AEEM2$coefficients, AEEM3$coefficients, AEEM4$coefficients, AEEM5$coefficients, AEEM6$coefficients,AEEM7$coefficients, AEEM8$coefficients, AEEM9$coefficients,AEEM10$coefficients, AEEM11$coefficients, AEEM12$coefficients,AEEM13$coefficients, AEEM14$coefficients, AEEM15$coefficients,AEEM16$coefficients, AEEM17$coefficients, AEEM18$coefficients,AEEM19$coefficients, AEEM20$coefficients, AEEM21$coefficients,AEEM22$coefficients, AEEM23$coefficients, AEEM4$coefficients,AEEM25$coefficients, AEEM26$coefficients, AEEM27$coefficients,AEEM28$coefficients, AEEM29$coefficients, AEEM30$coefficients,AEEM31$coefficients, AEEM32$coefficients, AEEM33$coefficients,AEEM34$coefficients, AEEM35$coefficients, AEEM36$coefficients,AEEM37$coefficients, AEEM38$coefficients, AEEM39$coefficients)
RES <- cbind(AEEM1$residuals, AEEM2$residuals, AEEM3$residuals, AEEM4$residuals, AEEM5$residuals, AEEM6$residuals,AEEM7$residuals, AEEM8$residuals, AEEM9$residuals,AEEM10$residuals, AEEM11$residuals, AEEM12$residuals,AEEM13$residuals, AEEM14$residuals, AEEM15$residuals,AEEM16$residuals, AEEM17$residuals, AEEM18$residuals,AEEM19$residuals, AEEM20$residuals, AEEM21$residuals,AEEM22$residuals, AEEM23$residuals, AEEM4$residuals,AEEM25$residuals, AEEM26$residuals, AEEM27$residuals,AEEM28$residuals, AEEM29$residuals, AEEM30$residuals,AEEM31$residuals, AEEM32$residuals, AEEM33$residuals,AEEM34$residuals, AEEM35$residuals, AEEM36$residuals,AEEM37$residuals, AEEM38$residuals, AEEM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AEE.ALL[nrow(AEE.ALL)+ 1,] = MKTR
AEE.ALL[nrow(AEE.ALL)+ 1,] = MKPR
AEE.ALL[nrow(AEE.ALL)+ 1,] = TSRR
AEE.ALL[nrow(AEE.ALL)+ 1,] = BTDF
AEE.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- AEE.ALL[1:47,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
AEE.ALL[nrow(AEE.ALL)+ 1,] = MMKPR
AEE.ALL[nrow(AEE.ALL)+ 1,] = MMKTR
AEE.ALL[nrow(AEE.ALL)+ 1,] = MMKSR
AEE.ALL
```

```{r}
AEE.NUM <- as.data.frame(apply(AEE.ALL[1:56,2:40], 2, as.numeric))
str(AEE.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(AEE.NUM[53,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(AEE.NUM[52,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(AEE.NUM[56,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(AEE.NUM[51,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(AEE.NUM[54,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
AEE.ALL[nrow(AEE.ALL)+ 1,] = FSR1
AEE.ALL[nrow(AEE.ALL)+ 1,] = FSR2
AEE.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
AEEFM <-AEE.ALL[c(57,58),-1]
AEEF <- as.matrix(apply(AEEFM, 2, as.numeric))
AEEF
```
###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(AEE.ALL[21:47,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
AEE.TS2 <-AEE.ALL[21:47,1:40] ## 1990 Subset
AEE.TSN2 <- as.data.frame(apply(AEE.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(AEE.TSN2, class)   
AEE.TSN2
```
############################################
```{r}
AEEM1 <- mblm(AN_RO_mm~ Water_Year_Year, AEE.TSN2)
AEEM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AEE.TSN2)
AEEM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AEE.TSN2)
AEEM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AEE.TSN2)
AEEM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AEE.TSN2)
AEEM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AEE.TSN2)
AEEM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AEE.TSN2)
AEEM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AEE.TSN2)
AEEM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AEE.TSN2)
AEEM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AEE.TSN2)
AEEM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AEE.TSN2)
AEEM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AEE.TSN2)
AEEM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AEE.TSN2)
AEEM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AEE.TSN2)
AEEM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AEE.TSN2)
AEEM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AEE.TSN2)
AEEM17 <- mblm(May_RO_mm~ Water_Year_Year, AEE.TSN2)
AEEM18 <- mblm(May_PCP_mm~ Water_Year_Year, AEE.TSN2)
AEEM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AEE.TSN2)
AEEM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AEE.TSN2)
AEEM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AEE.TSN2)
AEEM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AEE.TSN2)
AEEM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AEE.TSN2)
AEEM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AEE.TSN2)
AEEM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AEE.TSN2)
AEEM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AEE.TSN2)
AEEM27 <- mblm(AN_RR~ Water_Year_Year, AEE.TSN2)
AEEM28 <- mblm(OCT_RR~ Water_Year_Year, AEE.TSN2)
AEEM29 <- mblm(NOV_RR~ Water_Year_Year, AEE.TSN2)
AEEM30 <- mblm(DEC_RR~ Water_Year_Year, AEE.TSN2)
AEEM31 <- mblm(JAN_RR~ Water_Year_Year, AEE.TSN2)
AEEM32 <- mblm(FEB_RR~ Water_Year_Year, AEE.TSN2)
AEEM33 <- mblm(MAR_RR~ Water_Year_Year, AEE.TSN2)
AEEM34 <- mblm(APL_RR~ Water_Year_Year, AEE.TSN2)
AEEM35 <- mblm(MAY_RR~ Water_Year_Year, AEE.TSN2)
AEEM36 <- mblm(JUN_RR~ Water_Year_Year, AEE.TSN2)
AEEM37 <- mblm(JUL_RR~ Water_Year_Year, AEE.TSN2)
AEEM38 <- mblm(AUG_RR~ Water_Year_Year, AEE.TSN2)
AEEM39 <- mblm(SEP_RR~ Water_Year_Year, AEE.TSN2)
```
####################################
```{r}
TSR2<- cbind(AEEM1$coefficients, AEEM2$coefficients, AEEM3$coefficients, AEEM4$coefficients, AEEM5$coefficients, AEEM6$coefficients,AEEM7$coefficients, AEEM8$coefficients, AEEM9$coefficients,AEEM10$coefficients, AEEM11$coefficients, AEEM12$coefficients,AEEM13$coefficients, AEEM14$coefficients, AEEM15$coefficients,AEEM16$coefficients, AEEM17$coefficients, AEEM18$coefficients,AEEM19$coefficients, AEEM20$coefficients, AEEM21$coefficients,AEEM22$coefficients, AEEM23$coefficients, AEEM4$coefficients,AEEM25$coefficients, AEEM26$coefficients, AEEM27$coefficients,AEEM28$coefficients, AEEM29$coefficients, AEEM30$coefficients,AEEM31$coefficients, AEEM32$coefficients, AEEM33$coefficients,AEEM34$coefficients, AEEM35$coefficients, AEEM36$coefficients,AEEM37$coefficients, AEEM38$coefficients, AEEM39$coefficients)
RES2 <- cbind(AEEM1$residuals, AEEM2$residuals, AEEM3$residuals, AEEM4$residuals, AEEM5$residuals, AEEM6$residuals,AEEM7$residuals, AEEM8$residuals, AEEM9$residuals,AEEM10$residuals, AEEM11$residuals, AEEM12$residuals,AEEM13$residuals, AEEM14$residuals, AEEM15$residuals,AEEM16$residuals, AEEM17$residuals, AEEM18$residuals,AEEM19$residuals, AEEM20$residuals, AEEM21$residuals,AEEM22$residuals, AEEM23$residuals, AEEM4$residuals,AEEM25$residuals, AEEM26$residuals, AEEM27$residuals,AEEM28$residuals, AEEM29$residuals, AEEM30$residuals,AEEM31$residuals, AEEM32$residuals, AEEM33$residuals,AEEM34$residuals, AEEM35$residuals, AEEM36$residuals,AEEM37$residuals, AEEM38$residuals, AEEM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AEE.ALL[nrow(AEE.ALL)+ 1,] = MKTR2
AEE.ALL[nrow(AEE.ALL)+ 1,] = MKPR2
AEE.ALL[nrow(AEE.ALL)+ 1,] = TSRR2
AEE.ALL[nrow(AEE.ALL)+ 1,] = BTDF2
AEE.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- AEE.ALL[21:47,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
AEE.ALL[nrow(AEE.ALL)+ 1,] = MMKPR2
AEE.ALL[nrow(AEE.ALL)+ 1,] = MMKTR2
AEE.ALL[nrow(AEE.ALL)+ 1,] = MMKSR2
AEE.ALL
```

```{r}
AEE.ALL
```

```{r}
AEE.NUM2 <- as.data.frame(apply(AEE.ALL[1:65,2:40], 2, as.numeric))
str(AEE.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(AEE.NUM2[62,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(AEE.NUM2[61,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(AEE.NUM2[65,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(AEE.NUM2[60,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(AEE.NUM2[63,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
AEE.ALL[nrow(AEE.ALL)+ 1,] = FSR12
AEE.ALL[nrow(AEE.ALL)+ 1,] = FSR22
AEE.ALL
```

```{r}
AEE.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
AEEFM2 <-AEE.ALL[c(66,67),-1]
AEEF2 <- as.matrix(apply(AEEFM2, 2, as.numeric))
AEEF2
```


### Weir Results, csv 'AK' ID 12
```{r}
### Summarise by Month
AK$StreamflowDay_m3<-AK$Streamflow*(60*60*24)
AK.MON <- AK %>%
   group_by(Year, Month) %>%
   summarise(Month_Streamflow_m3 = sum(StreamflowDay_m3), Month_Precip_mm = sum(Precip))
AK.MON$Streamflow_Km<-AK.MON$Month_Streamflow_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
AK.MON$Streamflow_mm<-(AK.MON$Streamflow_Km/2280)*1000000 ## monthly runoff depth mm
#AK.MON


#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
AK.MONT<- AK.MON[-c(1,2,3,4,5,6,7,8,9,478,479,480),]
AK.MONT
```

```{r}
AKT<-GMP2[[1042:1509]] #Weir
AKE<-extent(265.5,266.5,56.5,57) #Weir Extent
AKPC<-crop(AKT,AKE) #Weir Crop
AK.Mon.Precip.<-extract(AKPC,AKE, method="bilinear", fun = mean)
AKMP<-as.data.frame(colMeans(AK.Mon.Precip.)) #Weir
AKSub<-DateTemp[DateTemp$Date >= as.Date("1977-10-01") & DateTemp$Date <=
                    as.Date("2016-09-01"), ] ##Weir
AKPp<- cbind(AKMP,AKSub) ## Weir
```

```{r}
AK.MONT$GriddedPrecip_mm <- AKMP$`colMeans(AK.Mon.Precip.)`
AK.MONT
```

##############
```{r}
## Water Year Sequencing
AK.MT<- AK.MONT
AK.MT$Water_Year_Month <- rep(seq(1:12),39) #1977 to 2016 is 43 years
AK.MT$Water_Year_Year <- rep(1:39, each =12)
AK.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 AK.WY <- AK.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
AK.WY
```
##############
```{r}
## Monthly Columns
## Oct
 AK.OCT <- AK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 AK.NOV <- AK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 AK.DEC <- AK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 AK.JAN <- AK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 AK.FEB <- AK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 AK.MAR <- AK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 AK.APL <- AK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 AK.MAY <- AK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 AK.JUN <- AK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 AK.JUL <- AK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 AK.AUG <- AK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 AK.SEP <- AK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
AK.ALL <- cbind(AK.WY, AK.OCT[,-1], AK.NOV[,-1], AK.DEC[,-1], AK.JAN[,-1], AK.FEB[,-1], AK.MAR[,-1], AK.APL[,-1],AK.MAY[,-1], AK.JUN[,-1], AK.JUL[,-1], AK.AUG[,-1], AK.SEP[,-1])
```
####################
```{r}
AK.ALL$AN_RR <- AK.ALL$AN_RO_mm/AK.ALL$AN_PCP_mm
AK.ALL$OCT_RR <- AK.ALL$Oct_RO_mm/AK.ALL$Oct_PCP_mm
AK.ALL$NOV_RR <- AK.ALL$Nov_RO_mm/AK.ALL$Nov_PCP_mm
AK.ALL$DEC_RR <- AK.ALL$Dec_RO_mm/AK.ALL$Dec_PCP_mm
AK.ALL$JAN_RR <- AK.ALL$Jan_RO_mm/AK.ALL$Jan_PCP_mm
AK.ALL$FEB_RR <- AK.ALL$Feb_RO_mm/AK.ALL$Feb_PCP_mm
AK.ALL$MAR_RR <- AK.ALL$Mar_RO_mm/AK.ALL$Mar_PCP_mm
AK.ALL$APL_RR <- AK.ALL$Apl_RO_mm/AK.ALL$Apl_PCP_mm
AK.ALL$MAY_RR <- AK.ALL$May_RO_mm/AK.ALL$May_PCP_mm
AK.ALL$JUN_RR <- AK.ALL$Jun_RO_mm/AK.ALL$Jun_PCP_mm
AK.ALL$JUL_RR <- AK.ALL$Jul_RO_mm/AK.ALL$Jul_PCP_mm
AK.ALL$AUG_RR <- AK.ALL$Aug_RO_mm/AK.ALL$Aug_PCP_mm
AK.ALL$SEP_RR <- AK.ALL$Sep_RO_mm/AK.ALL$Sep_PCP_mm
AK.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(AK.ALL[,-1],2, mean))
CSD <- rbind(apply(AK.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
AK.ALL[nrow(AK.ALL)+ 1,] = CML
AK.ALL[nrow(AK.ALL)+ 1,] = CSDL
AK.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(AK.ALL[1:39,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
AK.TS <-AK.ALL[1:39,1:40]
AK.TSN <- as.data.frame(apply(AK.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(AK.TSN, class)   
AK.TSN
```
############################################
```{r}
AKM1 <- mblm(AN_RO_mm~ Water_Year_Year, AK.TSN)
AKM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AK.TSN)
AKM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AK.TSN)
AKM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AK.TSN)
AKM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AK.TSN)
AKM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AK.TSN)
AKM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AK.TSN)
AKM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AK.TSN)
AKM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AK.TSN)
AKM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AK.TSN)
AKM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AK.TSN)
AKM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AK.TSN)
AKM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AK.TSN)
AKM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AK.TSN)
AKM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AK.TSN)
AKM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AK.TSN)
AKM17 <- mblm(May_RO_mm~ Water_Year_Year, AK.TSN)
AKM18 <- mblm(May_PCP_mm~ Water_Year_Year, AK.TSN)
AKM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AK.TSN)
AKM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AK.TSN)
AKM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AK.TSN)
AKM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AK.TSN)
AKM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AK.TSN)
AKM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AK.TSN)
AKM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AK.TSN)
AKM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AK.TSN)
AKM27 <- mblm(AN_RR~ Water_Year_Year, AK.TSN)
AKM28 <- mblm(OCT_RR~ Water_Year_Year, AK.TSN)
AKM29 <- mblm(NOV_RR~ Water_Year_Year, AK.TSN)
AKM30 <- mblm(DEC_RR~ Water_Year_Year, AK.TSN)
AKM31 <- mblm(JAN_RR~ Water_Year_Year, AK.TSN)
AKM32 <- mblm(FEB_RR~ Water_Year_Year, AK.TSN)
AKM33 <- mblm(MAR_RR~ Water_Year_Year, AK.TSN)
AKM34 <- mblm(APL_RR~ Water_Year_Year, AK.TSN)
AKM35 <- mblm(MAY_RR~ Water_Year_Year, AK.TSN)
AKM36 <- mblm(JUN_RR~ Water_Year_Year, AK.TSN)
AKM37 <- mblm(JUL_RR~ Water_Year_Year, AK.TSN)
AKM38 <- mblm(AUG_RR~ Water_Year_Year, AK.TSN)
AKM39 <- mblm(SEP_RR~ Water_Year_Year, AK.TSN)
```
####################################
```{r}
TSR<- cbind(AKM1$coefficients, AKM2$coefficients, AKM3$coefficients, AKM4$coefficients, AKM5$coefficients, AKM6$coefficients,AKM7$coefficients, AKM8$coefficients, AKM9$coefficients,AKM10$coefficients, AKM11$coefficients, AKM12$coefficients,AKM13$coefficients, AKM14$coefficients, AKM15$coefficients,AKM16$coefficients, AKM17$coefficients, AKM18$coefficients,AKM19$coefficients, AKM20$coefficients, AKM21$coefficients,AKM22$coefficients, AKM23$coefficients, AKM4$coefficients,AKM25$coefficients, AKM26$coefficients, AKM27$coefficients,AKM28$coefficients, AKM29$coefficients, AKM30$coefficients,AKM31$coefficients, AKM32$coefficients, AKM33$coefficients,AKM34$coefficients, AKM35$coefficients, AKM36$coefficients,AKM37$coefficients, AKM38$coefficients, AKM39$coefficients)
RES <- cbind(AKM1$residuals, AKM2$residuals, AKM3$residuals, AKM4$residuals, AKM5$residuals, AKM6$residuals,AKM7$residuals, AKM8$residuals, AKM9$residuals,AKM10$residuals, AKM11$residuals, AKM12$residuals,AKM13$residuals, AKM14$residuals, AKM15$residuals,AKM16$residuals, AKM17$residuals, AKM18$residuals,AKM19$residuals, AKM20$residuals, AKM21$residuals,AKM22$residuals, AKM23$residuals, AKM4$residuals,AKM25$residuals, AKM26$residuals, AKM27$residuals,AKM28$residuals, AKM29$residuals, AKM30$residuals,AKM31$residuals, AKM32$residuals, AKM33$residuals,AKM34$residuals, AKM35$residuals, AKM36$residuals,AKM37$residuals, AKM38$residuals, AKM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AK.ALL[nrow(AK.ALL)+ 1,] = MKTR
AK.ALL[nrow(AK.ALL)+ 1,] = MKPR
AK.ALL[nrow(AK.ALL)+ 1,] = TSRR
AK.ALL[nrow(AK.ALL)+ 1,] = BTDF
AK.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- AK.ALL[1:39,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
AK.ALL[nrow(AK.ALL)+ 1,] = MMKPR
AK.ALL[nrow(AK.ALL)+ 1,] = MMKTR
AK.ALL[nrow(AK.ALL)+ 1,] = MMKSR
AK.ALL
```

```{r}
AK.NUM <- as.data.frame(apply(AK.ALL[1:48,2:40], 2, as.numeric))
str(AK.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(AK.NUM[45,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(AK.NUM[44,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(AK.NUM[48,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(AK.NUM[43,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(AK.NUM[46,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
AK.ALL[nrow(AK.ALL)+ 1,] = FSR1
AK.ALL[nrow(AK.ALL)+ 1,] = FSR2
AK.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
AKFM <-AK.ALL[c(49,50),-1]
AKF <- as.matrix(apply(AKFM, 2, as.numeric))
AKF
```
###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(AK.ALL[13:39,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
AK.TS2 <-AK.ALL[13:39,1:40] ## 1990 Subset
AK.TSN2 <- as.data.frame(apply(AK.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(AK.TSN2, class)   
AK.TSN2
```
############################################
```{r}
AKM1 <- mblm(AN_RO_mm~ Water_Year_Year, AK.TSN2)
AKM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AK.TSN2)
AKM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AK.TSN2)
AKM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AK.TSN2)
AKM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AK.TSN2)
AKM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AK.TSN2)
AKM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AK.TSN2)
AKM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AK.TSN2)
AKM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AK.TSN2)
AKM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AK.TSN2)
AKM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AK.TSN2)
AKM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AK.TSN2)
AKM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AK.TSN2)
AKM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AK.TSN2)
AKM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AK.TSN2)
AKM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AK.TSN2)
AKM17 <- mblm(May_RO_mm~ Water_Year_Year, AK.TSN2)
AKM18 <- mblm(May_PCP_mm~ Water_Year_Year, AK.TSN2)
AKM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AK.TSN2)
AKM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AK.TSN2)
AKM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AK.TSN2)
AKM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AK.TSN2)
AKM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AK.TSN2)
AKM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AK.TSN2)
AKM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AK.TSN2)
AKM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AK.TSN2)
AKM27 <- mblm(AN_RR~ Water_Year_Year, AK.TSN2)
AKM28 <- mblm(OCT_RR~ Water_Year_Year, AK.TSN2)
AKM29 <- mblm(NOV_RR~ Water_Year_Year, AK.TSN2)
AKM30 <- mblm(DEC_RR~ Water_Year_Year, AK.TSN2)
AKM31 <- mblm(JAN_RR~ Water_Year_Year, AK.TSN2)
AKM32 <- mblm(FEB_RR~ Water_Year_Year, AK.TSN2)
AKM33 <- mblm(MAR_RR~ Water_Year_Year, AK.TSN2)
AKM34 <- mblm(APL_RR~ Water_Year_Year, AK.TSN2)
AKM35 <- mblm(MAY_RR~ Water_Year_Year, AK.TSN2)
AKM36 <- mblm(JUN_RR~ Water_Year_Year, AK.TSN2)
AKM37 <- mblm(JUL_RR~ Water_Year_Year, AK.TSN2)
AKM38 <- mblm(AUG_RR~ Water_Year_Year, AK.TSN2)
AKM39 <- mblm(SEP_RR~ Water_Year_Year, AK.TSN2)
```
####################################
```{r}
TSR2<- cbind(AKM1$coefficients, AKM2$coefficients, AKM3$coefficients, AKM4$coefficients, AKM5$coefficients, AKM6$coefficients,AKM7$coefficients, AKM8$coefficients, AKM9$coefficients,AKM10$coefficients, AKM11$coefficients, AKM12$coefficients,AKM13$coefficients, AKM14$coefficients, AKM15$coefficients,AKM16$coefficients, AKM17$coefficients, AKM18$coefficients,AKM19$coefficients, AKM20$coefficients, AKM21$coefficients,AKM22$coefficients, AKM23$coefficients, AKM4$coefficients,AKM25$coefficients, AKM26$coefficients, AKM27$coefficients,AKM28$coefficients, AKM29$coefficients, AKM30$coefficients,AKM31$coefficients, AKM32$coefficients, AKM33$coefficients,AKM34$coefficients, AKM35$coefficients, AKM36$coefficients,AKM37$coefficients, AKM38$coefficients, AKM39$coefficients)
RES2 <- cbind(AKM1$residuals, AKM2$residuals, AKM3$residuals, AKM4$residuals, AKM5$residuals, AKM6$residuals,AKM7$residuals, AKM8$residuals, AKM9$residuals,AKM10$residuals, AKM11$residuals, AKM12$residuals,AKM13$residuals, AKM14$residuals, AKM15$residuals,AKM16$residuals, AKM17$residuals, AKM18$residuals,AKM19$residuals, AKM20$residuals, AKM21$residuals,AKM22$residuals, AKM23$residuals, AKM4$residuals,AKM25$residuals, AKM26$residuals, AKM27$residuals,AKM28$residuals, AKM29$residuals, AKM30$residuals,AKM31$residuals, AKM32$residuals, AKM33$residuals,AKM34$residuals, AKM35$residuals, AKM36$residuals,AKM37$residuals, AKM38$residuals, AKM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AK.ALL[nrow(AK.ALL)+ 1,] = MKTR2
AK.ALL[nrow(AK.ALL)+ 1,] = MKPR2
AK.ALL[nrow(AK.ALL)+ 1,] = TSRR2
AK.ALL[nrow(AK.ALL)+ 1,] = BTDF2
AK.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- AK.ALL[13:39,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
AK.ALL[nrow(AK.ALL)+ 1,] = MMKPR2
AK.ALL[nrow(AK.ALL)+ 1,] = MMKTR2
AK.ALL[nrow(AK.ALL)+ 1,] = MMKSR2
AK.ALL
```

```{r}
AK.ALL
```

```{r}
AK.NUM2 <- as.data.frame(apply(AK.ALL[1:57,2:40], 2, as.numeric))
str(AK.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(AK.NUM2[54,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(AK.NUM2[53,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(AK.NUM2[57,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(AK.NUM2[52,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(AK.NUM2[55,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
AK.ALL[nrow(AK.ALL)+ 1,] = FSR12
AK.ALL[nrow(AK.ALL)+ 1,] = FSR22
AK.ALL
```

```{r}
AK.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
AKFM2 <-AK.ALL[c(58,59),-1]
AKF2 <- as.matrix(apply(AKFM2, 2, as.numeric))
AKF2
```

### Taylor Results, csv 'AH' ID 13
```{r}
### Summarise by Month
AH$StreamflowDay_m3<-AH$Streamflow*(60*60*24)
AH.MON <- AH %>%
   group_by(Year, Month) %>%
   summarise(Month_Streamflow_m3 = sum(StreamflowDay_m3), Month_Precip_mm = sum(Precip))
AH.MON$Streamflow_Km<-AH.MON$Month_Streamflow_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
AH.MON$Streamflow_mm<-(AH.MON$Streamflow_Km/883)*1000000 ## monthly runoff depth mm
AH.MON
```

```{r}
#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
AH.MONT<- AH.MON [-c(529,530,531),]
AH.MONT
```

```{r}
AHT<-GMP2[[958:1485]] #Taylor
AHE<-extent(259,260,55,55.5) #Taylor Extent
AHPC<-crop(AHT,AHE) #Taylor Crop
AH.Mon.Precip.<-extract(AHPC,AHE, method="bilinear", fun = mean)
AHMP<-as.data.frame(colMeans(AH.Mon.Precip.)) #Taylor
AHSub<-DateTemp[DateTemp$Date >= as.Date("1970-10-01") & DateTemp$Date <=
                    as.Date("2014-09-01"), ] ##Talyor
AHPp<- cbind(AHMP,AHSub) ## Taylor
```

```{r}
AH.MONT$GriddedPrecip_mm<- AHMP$`colMeans(AH.Mon.Precip.)`
```

##############
```{r}
## Water Year Sequencing
AH.MT<- AH.MONT
AH.MT$Water_Year_Month <- rep(seq(1:12),44) #1975 to 2016 is 43 years
AH.MT$Water_Year_Year <- rep(1:44, each =12)
AH.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 AH.WY <- AH.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
AH.WY
```
##############
```{r}
## Monthly Columns
## Oct
 AH.OCT <- AH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 AH.NOV <- AH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 AH.DEC <- AH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 AH.JAN <- AH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 AH.FEB <- AH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 AH.MAR <- AH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 AH.APL <- AH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 AH.MAY <- AH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 AH.JUN <- AH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 AH.JUL <- AH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 AH.AUG <- AH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 AH.SEP <- AH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
AH.ALL <- cbind(AH.WY, AH.OCT[,-1], AH.NOV[,-1], AH.DEC[,-1], AH.JAN[,-1], AH.FEB[,-1], AH.MAR[,-1], AH.APL[,-1],AH.MAY[,-1], AH.JUN[,-1], AH.JUL[,-1], AH.AUG[,-1], AH.SEP[,-1])
```
####################
```{r}
AH.ALL$AN_RR <- AH.ALL$AN_RO_mm/AH.ALL$AN_PCP_mm
AH.ALL$OCT_RR <- AH.ALL$Oct_RO_mm/AH.ALL$Oct_PCP_mm
AH.ALL$NOV_RR <- AH.ALL$Nov_RO_mm/AH.ALL$Nov_PCP_mm
AH.ALL$DEC_RR <- AH.ALL$Dec_RO_mm/AH.ALL$Dec_PCP_mm
AH.ALL$JAN_RR <- AH.ALL$Jan_RO_mm/AH.ALL$Jan_PCP_mm
AH.ALL$FEB_RR <- AH.ALL$Feb_RO_mm/AH.ALL$Feb_PCP_mm
AH.ALL$MAR_RR <- AH.ALL$Mar_RO_mm/AH.ALL$Mar_PCP_mm
AH.ALL$APL_RR <- AH.ALL$Apl_RO_mm/AH.ALL$Apl_PCP_mm
AH.ALL$MAY_RR <- AH.ALL$May_RO_mm/AH.ALL$May_PCP_mm
AH.ALL$JUN_RR <- AH.ALL$Jun_RO_mm/AH.ALL$Jun_PCP_mm
AH.ALL$JUL_RR <- AH.ALL$Jul_RO_mm/AH.ALL$Jul_PCP_mm
AH.ALL$AUG_RR <- AH.ALL$Aug_RO_mm/AH.ALL$Aug_PCP_mm
AH.ALL$SEP_RR <- AH.ALL$Sep_RO_mm/AH.ALL$Sep_PCP_mm
AH.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(AH.ALL[,-1],2, mean))
CSD <- rbind(apply(AH.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
AH.ALL[nrow(AH.ALL)+ 1,] = CML
AH.ALL[nrow(AH.ALL)+ 1,] = CSDL
AH.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(AH.ALL[1:44,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
AH.TS <-AH.ALL[1:44,1:40]
AH.TSN <- as.data.frame(apply(AH.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(AH.TSN, class)   
AH.TSN
```
############################################
```{r}
AHM1 <- mblm(AN_RO_mm~ Water_Year_Year, AH.TSN)
AHM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AH.TSN)
AHM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AH.TSN)
AHM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AH.TSN)
AHM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AH.TSN)
AHM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AH.TSN)
AHM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AH.TSN)
AHM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AH.TSN)
AHM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AH.TSN)
AHM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AH.TSN)
AHM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AH.TSN)
AHM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AH.TSN)
AHM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AH.TSN)
AHM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AH.TSN)
AHM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AH.TSN)
AHM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AH.TSN)
AHM17 <- mblm(May_RO_mm~ Water_Year_Year, AH.TSN)
AHM18 <- mblm(May_PCP_mm~ Water_Year_Year, AH.TSN)
AHM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AH.TSN)
AHM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AH.TSN)
AHM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AH.TSN)
AHM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AH.TSN)
AHM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AH.TSN)
AHM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AH.TSN)
AHM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AH.TSN)
AHM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AH.TSN)
AHM27 <- mblm(AN_RR~ Water_Year_Year, AH.TSN)
AHM28 <- mblm(OCT_RR~ Water_Year_Year, AH.TSN)
AHM29 <- mblm(NOV_RR~ Water_Year_Year, AH.TSN)
AHM30 <- mblm(DEC_RR~ Water_Year_Year, AH.TSN)
AHM31 <- mblm(JAN_RR~ Water_Year_Year, AH.TSN)
AHM32 <- mblm(FEB_RR~ Water_Year_Year, AH.TSN)
AHM33 <- mblm(MAR_RR~ Water_Year_Year, AH.TSN)
AHM34 <- mblm(APL_RR~ Water_Year_Year, AH.TSN)
AHM35 <- mblm(MAY_RR~ Water_Year_Year, AH.TSN)
AHM36 <- mblm(JUN_RR~ Water_Year_Year, AH.TSN)
AHM37 <- mblm(JUL_RR~ Water_Year_Year, AH.TSN)
AHM38 <- mblm(AUG_RR~ Water_Year_Year, AH.TSN)
AHM39 <- mblm(SEP_RR~ Water_Year_Year, AH.TSN)
```
####################################
```{r}
TSR<- cbind(AHM1$coefficients, AHM2$coefficients, AHM3$coefficients, AHM4$coefficients, AHM5$coefficients, AHM6$coefficients,AHM7$coefficients, AHM8$coefficients, AHM9$coefficients,AHM10$coefficients, AHM11$coefficients, AHM12$coefficients,AHM13$coefficients, AHM14$coefficients, AHM15$coefficients,AHM16$coefficients, AHM17$coefficients, AHM18$coefficients,AHM19$coefficients, AHM20$coefficients, AHM21$coefficients,AHM22$coefficients, AHM23$coefficients, AHM4$coefficients,AHM25$coefficients, AHM26$coefficients, AHM27$coefficients,AHM28$coefficients, AHM29$coefficients, AHM30$coefficients,AHM31$coefficients, AHM32$coefficients, AHM33$coefficients,AHM34$coefficients, AHM35$coefficients, AHM36$coefficients,AHM37$coefficients, AHM38$coefficients, AHM39$coefficients)
RES <- cbind(AHM1$residuals, AHM2$residuals, AHM3$residuals, AHM4$residuals, AHM5$residuals, AHM6$residuals,AHM7$residuals, AHM8$residuals, AHM9$residuals,AHM10$residuals, AHM11$residuals, AHM12$residuals,AHM13$residuals, AHM14$residuals, AHM15$residuals,AHM16$residuals, AHM17$residuals, AHM18$residuals,AHM19$residuals, AHM20$residuals, AHM21$residuals,AHM22$residuals, AHM23$residuals, AHM4$residuals,AHM25$residuals, AHM26$residuals, AHM27$residuals,AHM28$residuals, AHM29$residuals, AHM30$residuals,AHM31$residuals, AHM32$residuals, AHM33$residuals,AHM34$residuals, AHM35$residuals, AHM36$residuals,AHM37$residuals, AHM38$residuals, AHM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AH.ALL[nrow(AH.ALL)+ 1,] = MKTR
AH.ALL[nrow(AH.ALL)+ 1,] = MKPR
AH.ALL[nrow(AH.ALL)+ 1,] = TSRR
AH.ALL[nrow(AH.ALL)+ 1,] = BTDF
AH.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- AH.ALL[1:44,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
AH.ALL[nrow(AH.ALL)+ 1,] = MMKPR
AH.ALL[nrow(AH.ALL)+ 1,] = MMKTR
AH.ALL[nrow(AH.ALL)+ 1,] = MMKSR
AH.ALL
```

```{r}
AH.NUM <- as.data.frame(apply(AH.ALL[1:53,2:40], 2, as.numeric))
str(AH.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(AH.NUM[50,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(AH.NUM[49,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(AH.NUM[53,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(AH.NUM[48,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(AH.NUM[51,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
AH.ALL[nrow(AH.ALL)+ 1,] = FSR1
AH.ALL[nrow(AH.ALL)+ 1,] = FSR2
AH.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
AHFM <-AH.ALL[c(54,55),-1]
AHF <- as.matrix(apply(AHFM, 2, as.numeric))
AHF
```
###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(AH.ALL[21:44,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
AH.TS2 <-AH.ALL[21:44,1:40] ## 1990 Subset
AH.TSN2 <- as.data.frame(apply(AH.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(AH.TSN2, class)   
AH.TSN2
```
############################################
```{r}
AHM1 <- mblm(AN_RO_mm~ Water_Year_Year, AH.TSN2)
AHM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AH.TSN2)
AHM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AH.TSN2)
AHM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AH.TSN2)
AHM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AH.TSN2)
AHM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AH.TSN2)
AHM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AH.TSN2)
AHM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AH.TSN2)
AHM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AH.TSN2)
AHM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AH.TSN2)
AHM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AH.TSN2)
AHM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AH.TSN2)
AHM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AH.TSN2)
AHM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AH.TSN2)
AHM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AH.TSN2)
AHM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AH.TSN2)
AHM17 <- mblm(May_RO_mm~ Water_Year_Year, AH.TSN2)
AHM18 <- mblm(May_PCP_mm~ Water_Year_Year, AH.TSN2)
AHM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AH.TSN2)
AHM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AH.TSN2)
AHM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AH.TSN2)
AHM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AH.TSN2)
AHM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AH.TSN2)
AHM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AH.TSN2)
AHM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AH.TSN2)
AHM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AH.TSN2)
AHM27 <- mblm(AN_RR~ Water_Year_Year, AH.TSN2)
AHM28 <- mblm(OCT_RR~ Water_Year_Year, AH.TSN2)
AHM29 <- mblm(NOV_RR~ Water_Year_Year, AH.TSN2)
AHM30 <- mblm(DEC_RR~ Water_Year_Year, AH.TSN2)
AHM31 <- mblm(JAN_RR~ Water_Year_Year, AH.TSN2)
AHM32 <- mblm(FEB_RR~ Water_Year_Year, AH.TSN2)
AHM33 <- mblm(MAR_RR~ Water_Year_Year, AH.TSN2)
AHM34 <- mblm(APL_RR~ Water_Year_Year, AH.TSN2)
AHM35 <- mblm(MAY_RR~ Water_Year_Year, AH.TSN2)
AHM36 <- mblm(JUN_RR~ Water_Year_Year, AH.TSN2)
AHM37 <- mblm(JUL_RR~ Water_Year_Year, AH.TSN2)
AHM38 <- mblm(AUG_RR~ Water_Year_Year, AH.TSN2)
AHM39 <- mblm(SEP_RR~ Water_Year_Year, AH.TSN2)
```
####################################
```{r}
TSR2<- cbind(AHM1$coefficients, AHM2$coefficients, AHM3$coefficients, AHM4$coefficients, AHM5$coefficients, AHM6$coefficients,AHM7$coefficients, AHM8$coefficients, AHM9$coefficients,AHM10$coefficients, AHM11$coefficients, AHM12$coefficients,AHM13$coefficients, AHM14$coefficients, AHM15$coefficients,AHM16$coefficients, AHM17$coefficients, AHM18$coefficients,AHM19$coefficients, AHM20$coefficients, AHM21$coefficients,AHM22$coefficients, AHM23$coefficients, AHM4$coefficients,AHM25$coefficients, AHM26$coefficients, AHM27$coefficients,AHM28$coefficients, AHM29$coefficients, AHM30$coefficients,AHM31$coefficients, AHM32$coefficients, AHM33$coefficients,AHM34$coefficients, AHM35$coefficients, AHM36$coefficients,AHM37$coefficients, AHM38$coefficients, AHM39$coefficients)
RES2 <- cbind(AHM1$residuals, AHM2$residuals, AHM3$residuals, AHM4$residuals, AHM5$residuals, AHM6$residuals,AHM7$residuals, AHM8$residuals, AHM9$residuals,AHM10$residuals, AHM11$residuals, AHM12$residuals,AHM13$residuals, AHM14$residuals, AHM15$residuals,AHM16$residuals, AHM17$residuals, AHM18$residuals,AHM19$residuals, AHM20$residuals, AHM21$residuals,AHM22$residuals, AHM23$residuals, AHM4$residuals,AHM25$residuals, AHM26$residuals, AHM27$residuals,AHM28$residuals, AHM29$residuals, AHM30$residuals,AHM31$residuals, AHM32$residuals, AHM33$residuals,AHM34$residuals, AHM35$residuals, AHM36$residuals,AHM37$residuals, AHM38$residuals, AHM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AH.ALL[nrow(AH.ALL)+ 1,] = MKTR2
AH.ALL[nrow(AH.ALL)+ 1,] = MKPR2
AH.ALL[nrow(AH.ALL)+ 1,] = TSRR2
AH.ALL[nrow(AH.ALL)+ 1,] = BTDF2
AH.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- AH.ALL[21:44,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
AH.ALL[nrow(AH.ALL)+ 1,] = MMKPR2
AH.ALL[nrow(AH.ALL)+ 1,] = MMKTR2
AH.ALL[nrow(AH.ALL)+ 1,] = MMKSR2
AH.ALL
```

```{r}
AH.ALL
```

```{r}
AH.NUM2 <- as.data.frame(apply(AH.ALL[1:62,2:40], 2, as.numeric))
str(AH.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(AH.NUM2[59,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(AH.NUM2[58,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(AH.NUM2[62,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(AH.NUM2[57,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(AH.NUM2[60,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
AH.ALL[nrow(AH.ALL)+ 1,] = FSR12
AH.ALL[nrow(AH.ALL)+ 1,] = FSR22
AH.ALL
```

```{r}
AH.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
AHFM2 <-AH.ALL[c(63,64),-1]
AHF2 <- as.matrix(apply(AHFM2, 2, as.numeric))
AHF2
```


### Overflowing Results, csv 'Y' ID 14
```{r}
### Summarise by Month
Y$StreamflowDay_m3<-Y$Streamflow*(60*60*24)
Y.MON <- Y %>%
   group_by(Year, Month) %>%
   summarise(Month_Streamflow_m3 = sum(StreamflowDay_m3), Month_Precip_mm = sum(Precip))
Y.MON$Streamflow_Km<-Y.MON$Month_Streamflow_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
Y.MON$Streamflow_mm<-(Y.MON$Streamflow_Km/3350)*1000000 ## monthly runoff depth mm
Y.MON2 <- subset(Y.MON,  Year >= 1969 & Year <= 2016)
Y.MON2
```


```{r}

#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
Y.MONT<- Y.MON2[-c(1,2,3,4,5,6,7,8,9,574,575,576),]
Y.MONT
```

```{r}
YT<-GMP2[[946:1509]] #Overflowing
YE<-extent(258.5,259,53,53.5) #Overflowing Extent
YPC<-crop(YT,YE) #Overflowing Crop
Y.Mon.Precip.<-extract(YPC,YE, method="bilinear", fun = mean)
YMP<-as.data.frame(colMeans(Y.Mon.Precip.)) #Overflowing
YSub<-DateTemp[DateTemp$Date >= as.Date("1969-10-01") & DateTemp$Date <=
                    as.Date("2016-09-01"), ] ##Overflowing
YPp<- cbind(YMP,YSub) ## Overflowing
```

```{r}
##   
Y.MONT$GriddedPrecip_mm<- YMP$`colMeans(Y.Mon.Precip.)`
Y.MONT
```

##############
```{r}
## Water Year Sequencing
Y.MT<- Y.MONT
Y.MT$Water_Year_Month <- rep(seq(1:12),47) #1975 to 2016 is 43 years
Y.MT$Water_Year_Year <- rep(1:47, each =12)
Y.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 Y.WY <- Y.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm, na.rm= TRUE), AN_PCP_mm = sum(GriddedPrecip_mm))
Y.WY
```
##############
```{r}
## Monthly Columns
## Oct
 Y.OCT <- Y.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 Y.NOV <- Y.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(0), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 Y.DEC <- Y.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(0), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 Y.JAN <- Y.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(0), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 Y.FEB <- Y.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(0), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 Y.MAR <- Y.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 Y.APL <- Y.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 Y.MAY <- Y.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 Y.JUN <- Y.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 Y.JUL <- Y.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 Y.AUG <- Y.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 Y.SEP <- Y.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
Y.ALL <- cbind(Y.WY, Y.OCT[,-1], Y.NOV[,-1], Y.DEC[,-1], Y.JAN[,-1], Y.FEB[,-1], Y.MAR[,-1], Y.APL[,-1],Y.MAY[,-1], Y.JUN[,-1], Y.JUL[,-1], Y.AUG[,-1], Y.SEP[,-1])
```
####################
```{r}
Y.ALL$AN_RR <- Y.ALL$AN_RO_mm/Y.ALL$AN_PCP_mm
Y.ALL$OCT_RR <- Y.ALL$Oct_RO_mm/Y.ALL$Oct_PCP_mm
Y.ALL$NOV_RR <- 0 # Y.ALL$Nov_RO_mm/Y.ALL$Nov_PCP_mm
Y.ALL$DEC_RR <- 0 #Y.ALL$Dec_RO_mm/Y.ALL$Dec_PCP_mm
Y.ALL$JAN_RR <- 0 #Y.ALL$Jan_RO_mm/Y.ALL$Jan_PCP_mm
Y.ALL$FEB_RR <- 0 #Y.ALL$Feb_RO_mm/Y.ALL$Feb_PCP_mm
Y.ALL$MAR_RR <- Y.ALL$Mar_RO_mm/Y.ALL$Mar_PCP_mm
Y.ALL$APL_RR <- Y.ALL$Apl_RO_mm/Y.ALL$Apl_PCP_mm
Y.ALL$MAY_RR <- Y.ALL$May_RO_mm/Y.ALL$May_PCP_mm
Y.ALL$JUN_RR <- Y.ALL$Jun_RO_mm/Y.ALL$Jun_PCP_mm
Y.ALL$JUL_RR <- Y.ALL$Jul_RO_mm/Y.ALL$Jul_PCP_mm
Y.ALL$AUG_RR <- Y.ALL$Aug_RO_mm/Y.ALL$Aug_PCP_mm
Y.ALL$SEP_RR <- Y.ALL$Sep_RO_mm/Y.ALL$Sep_PCP_mm
Y.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(Y.ALL[,-1],2, mean))
CSD <- rbind(apply(Y.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
Y.ALL[nrow(Y.ALL)+ 1,] = CML
Y.ALL[nrow(Y.ALL)+ 1,] = CSDL
Y.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(Y.ALL[1:47,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
Y.TS <-Y.ALL[1:47,1:40]
Y.TSN <- as.data.frame(apply(Y.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(Y.TSN, class)   
Y.TSN
```
############################################
```{r}
YM1 <- mblm(AN_RO_mm~ Water_Year_Year, Y.TSN)
YM2 <- mblm(AN_PCP_mm~ Water_Year_Year, Y.TSN)
YM3 <- mblm(Oct_RO_mm~ Water_Year_Year, Y.TSN)
YM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, Y.TSN)
YM5 <- mblm(Nov_RO_mm~ Water_Year_Year, Y.TSN)
YM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, Y.TSN)
YM7 <- mblm(Dec_RO_mm~ Water_Year_Year, Y.TSN)
YM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, Y.TSN)
YM9 <- mblm(Jan_RO_mm~ Water_Year_Year, Y.TSN)
YM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, Y.TSN)
YM11 <- mblm(Feb_RO_mm~ Water_Year_Year, Y.TSN)
YM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, Y.TSN)
YM13 <- mblm(Mar_RO_mm~ Water_Year_Year, Y.TSN)
YM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, Y.TSN)
YM15 <- mblm(Apl_RO_mm~ Water_Year_Year, Y.TSN)
YM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, Y.TSN)
YM17 <- mblm(May_RO_mm~ Water_Year_Year, Y.TSN)
YM18 <- mblm(May_PCP_mm~ Water_Year_Year, Y.TSN)
YM19 <- mblm(Jun_RO_mm~ Water_Year_Year, Y.TSN)
YM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, Y.TSN)
YM21 <- mblm(Jul_RO_mm~ Water_Year_Year, Y.TSN)
YM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, Y.TSN)
YM23 <- mblm(Aug_RO_mm~ Water_Year_Year, Y.TSN)
YM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, Y.TSN)
YM25 <- mblm(Sep_RO_mm~ Water_Year_Year, Y.TSN)
YM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, Y.TSN)
YM27 <- mblm(AN_RR~ Water_Year_Year, Y.TSN)
YM28 <- mblm(OCT_RR~ Water_Year_Year, Y.TSN)
YM29 <- mblm(NOV_RR~ Water_Year_Year, Y.TSN)
YM30 <- mblm(DEC_RR~ Water_Year_Year, Y.TSN)
YM31 <- mblm(JAN_RR~ Water_Year_Year, Y.TSN)
YM32 <- mblm(FEB_RR~ Water_Year_Year, Y.TSN)
YM33 <- mblm(MAR_RR~ Water_Year_Year, Y.TSN)
YM34 <- mblm(APL_RR~ Water_Year_Year, Y.TSN)
YM35 <- mblm(MAY_RR~ Water_Year_Year, Y.TSN)
YM36 <- mblm(JUN_RR~ Water_Year_Year, Y.TSN)
YM37 <- mblm(JUL_RR~ Water_Year_Year, Y.TSN)
YM38 <- mblm(AUG_RR~ Water_Year_Year, Y.TSN)
YM39 <- mblm(SEP_RR~ Water_Year_Year, Y.TSN)
```
####################################
```{r}
TSR<- cbind(YM1$coefficients, YM2$coefficients, YM3$coefficients, YM4$coefficients, YM5$coefficients, YM6$coefficients,YM7$coefficients, YM8$coefficients, YM9$coefficients,YM10$coefficients, YM11$coefficients, YM12$coefficients,YM13$coefficients, YM14$coefficients, YM15$coefficients,YM16$coefficients, YM17$coefficients, YM18$coefficients,YM19$coefficients, YM20$coefficients, YM21$coefficients,YM22$coefficients, YM23$coefficients, YM4$coefficients,YM25$coefficients, YM26$coefficients, YM27$coefficients,YM28$coefficients, YM29$coefficients, YM30$coefficients,YM31$coefficients, YM32$coefficients, YM33$coefficients,YM34$coefficients, YM35$coefficients, YM36$coefficients,YM37$coefficients, YM38$coefficients, YM39$coefficients)
RES <- cbind(YM1$residuals, YM2$residuals, YM3$residuals, YM4$residuals, YM5$residuals, YM6$residuals,YM7$residuals, YM8$residuals, YM9$residuals,YM10$residuals, YM11$residuals, YM12$residuals,YM13$residuals, YM14$residuals, YM15$residuals,YM16$residuals, YM17$residuals, YM18$residuals,YM19$residuals, YM20$residuals, YM21$residuals,YM22$residuals, YM23$residuals, YM4$residuals,YM25$residuals, YM26$residuals, YM27$residuals,YM28$residuals, YM29$residuals, YM30$residuals,YM31$residuals, YM32$residuals, YM33$residuals,YM34$residuals, YM35$residuals, YM36$residuals,YM37$residuals, YM38$residuals, YM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
Y.ALL[nrow(Y.ALL)+ 1,] = MKTR
Y.ALL[nrow(Y.ALL)+ 1,] = MKPR
Y.ALL[nrow(Y.ALL)+ 1,] = TSRR
Y.ALL[nrow(Y.ALL)+ 1,] = BTDF
Y.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- Y.ALL[1:47,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
Y.ALL[nrow(Y.ALL)+ 1,] = MMKPR
Y.ALL[nrow(Y.ALL)+ 1,] = MMKTR
Y.ALL[nrow(Y.ALL)+ 1,] = MMKSR
Y.ALL
```

```{r}
Y.NUM <- as.data.frame(apply(Y.ALL[1:56,2:40], 2, as.numeric))
str(Y.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(Y.NUM[53,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(Y.NUM[52,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(Y.NUM[56,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(Y.NUM[51,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(Y.NUM[54,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
Y.ALL[nrow(Y.ALL)+ 1,] = FSR1
Y.ALL[nrow(Y.ALL)+ 1,] = FSR2
Y.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
YFM <-Y.ALL[c(57,58),-1]
YF <- as.matrix(apply(YFM, 2, as.numeric))
YF
```

```{r}
Y.ALL
```

###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(Y.ALL[21:47,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
Y.TS2 <-Y.ALL[21:47,1:40] ## 1990 Subset
Y.TSN2 <- as.data.frame(apply(Y.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(Y.TSN2, class)   
Y.TSN2
```
############################################
```{r}
YM1 <- mblm(AN_RO_mm~ Water_Year_Year, Y.TSN2)
YM2 <- mblm(AN_PCP_mm~ Water_Year_Year, Y.TSN2)
YM3 <- mblm(Oct_RO_mm~ Water_Year_Year, Y.TSN2)
YM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, Y.TSN2)
YM5 <- mblm(Nov_RO_mm~ Water_Year_Year, Y.TSN2)
YM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, Y.TSN2)
YM7 <- mblm(Dec_RO_mm~ Water_Year_Year, Y.TSN2)
YM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, Y.TSN2)
YM9 <- mblm(Jan_RO_mm~ Water_Year_Year, Y.TSN2)
YM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, Y.TSN2)
YM11 <- mblm(Feb_RO_mm~ Water_Year_Year, Y.TSN2)
YM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, Y.TSN2)
YM13 <- mblm(Mar_RO_mm~ Water_Year_Year, Y.TSN2)
YM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, Y.TSN2)
YM15 <- mblm(Apl_RO_mm~ Water_Year_Year, Y.TSN2)
YM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, Y.TSN2)
YM17 <- mblm(May_RO_mm~ Water_Year_Year, Y.TSN2)
YM18 <- mblm(May_PCP_mm~ Water_Year_Year, Y.TSN2)
YM19 <- mblm(Jun_RO_mm~ Water_Year_Year, Y.TSN2)
YM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, Y.TSN2)
YM21 <- mblm(Jul_RO_mm~ Water_Year_Year, Y.TSN2)
YM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, Y.TSN2)
YM23 <- mblm(Aug_RO_mm~ Water_Year_Year, Y.TSN2)
YM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, Y.TSN2)
YM25 <- mblm(Sep_RO_mm~ Water_Year_Year, Y.TSN2)
YM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, Y.TSN2)
YM27 <- mblm(AN_RR~ Water_Year_Year, Y.TSN2)
YM28 <- mblm(OCT_RR~ Water_Year_Year, Y.TSN2)
YM29 <- mblm(NOV_RR~ Water_Year_Year, Y.TSN2)
YM30 <- mblm(DEC_RR~ Water_Year_Year, Y.TSN2)
YM31 <- mblm(JAN_RR~ Water_Year_Year, Y.TSN2)
YM32 <- mblm(FEB_RR~ Water_Year_Year, Y.TSN2)
YM33 <- mblm(MAR_RR~ Water_Year_Year, Y.TSN2)
YM34 <- mblm(APL_RR~ Water_Year_Year, Y.TSN2)
YM35 <- mblm(MAY_RR~ Water_Year_Year, Y.TSN2)
YM36 <- mblm(JUN_RR~ Water_Year_Year, Y.TSN2)
YM37 <- mblm(JUL_RR~ Water_Year_Year, Y.TSN2)
YM38 <- mblm(AUG_RR~ Water_Year_Year, Y.TSN2)
YM39 <- mblm(SEP_RR~ Water_Year_Year, Y.TSN2)
```
####################################
```{r}
TSR2<- cbind(YM1$coefficients, YM2$coefficients, YM3$coefficients, YM4$coefficients, YM5$coefficients, YM6$coefficients,YM7$coefficients, YM8$coefficients, YM9$coefficients,YM10$coefficients, YM11$coefficients, YM12$coefficients,YM13$coefficients, YM14$coefficients, YM15$coefficients,YM16$coefficients, YM17$coefficients, YM18$coefficients,YM19$coefficients, YM20$coefficients, YM21$coefficients,YM22$coefficients, YM23$coefficients, YM4$coefficients,YM25$coefficients, YM26$coefficients, YM27$coefficients,YM28$coefficients, YM29$coefficients, YM30$coefficients,YM31$coefficients, YM32$coefficients, YM33$coefficients,YM34$coefficients, YM35$coefficients, YM36$coefficients,YM37$coefficients, YM38$coefficients, YM39$coefficients)
RES2 <- cbind(YM1$residuals, YM2$residuals, YM3$residuals, YM4$residuals, YM5$residuals, YM6$residuals,YM7$residuals, YM8$residuals, YM9$residuals,YM10$residuals, YM11$residuals, YM12$residuals,YM13$residuals, YM14$residuals, YM15$residuals,YM16$residuals, YM17$residuals, YM18$residuals,YM19$residuals, YM20$residuals, YM21$residuals,YM22$residuals, YM23$residuals, YM4$residuals,YM25$residuals, YM26$residuals, YM27$residuals,YM28$residuals, YM29$residuals, YM30$residuals,YM31$residuals, YM32$residuals, YM33$residuals,YM34$residuals, YM35$residuals, YM36$residuals,YM37$residuals, YM38$residuals, YM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
Y.ALL[nrow(Y.ALL)+ 1,] = MKTR2
Y.ALL[nrow(Y.ALL)+ 1,] = MKPR2
Y.ALL[nrow(Y.ALL)+ 1,] = TSRR2
Y.ALL[nrow(Y.ALL)+ 1,] = BTDF2
Y.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- Y.ALL[21:47,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
Y.ALL[nrow(Y.ALL)+ 1,] = MMKPR2
Y.ALL[nrow(Y.ALL)+ 1,] = MMKTR2
Y.ALL[nrow(Y.ALL)+ 1,] = MMKSR2
Y.ALL
```

```{r}
Y.ALL
```

```{r}
Y.NUM2 <- as.data.frame(apply(Y.ALL[1:65,2:40], 2, as.numeric))
str(Y.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(Y.NUM2[62,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(Y.NUM2[61,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(Y.NUM2[65,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(Y.NUM2[60,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(Y.NUM2[63,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
Y.ALL[nrow(Y.ALL)+ 1,] = FSR12
Y.ALL[nrow(Y.ALL)+ 1,] = FSR22
Y.ALL
```

```{r}
Y.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
YFM2 <-Y.ALL[c(66,67),-1]
YF2 <- as.matrix(apply(YFM2, 2, as.numeric))
YF2
```


###Slate Results, csv 'AQ' ID 15
```{r}
### Summarise by Month
AQ$StreamflowDay_m3<- AQ$Streamflow*(60*60*24)
AQ.MON <- AQ %>%
   group_by(Year, Month) %>%
   summarise(Month_Streamflow_m3 = sum(StreamflowDay_m3), Month_Precip_mm = sum(Precip))
AQ.MON$Streamflow_Km<-AQ.MON$Month_Streamflow_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
AQ.MON$Streamflow_mm<-(AQ.MON$Streamflow_Km/189)*1000000 ## monthly runoff depth mm
AQ.MON
```

```{r}
#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
AQ.MON2<- subset(AQ.MON, Year <= 2016)
```

```{r}
AQ.MON2
```

```{r}
AQ.MONT <- AQ.MON2[-c(1,2,3,4,5,6,7,8,9,238,239,240),]
AQ.MONT
```

```{r}
AQT<-GMP2[[1282:1509]] #Slate
AQE<-extent(210,211,67,67.5) #Slate Extent
AQPC<-crop(AQT,AQE) #Slate Crop
AQ.Mon.Precip.<-extract(AQPC,AQE, method="bilinear", fun = mean)
AQMP<-as.data.frame(colMeans(AQ.Mon.Precip.)) #Slate
AQSub<-DateTemp[DateTemp$Date >= as.Date("1997-10-01") & DateTemp$Date <=
                    as.Date("2016-09-01"), ] ##Slate
AQPp<- cbind(AQMP,AQSub) ## Slate
```

```{r}
AQ.MONT$GriddedPrecip_mm<- AQMP$`colMeans(AQ.Mon.Precip.)`
```

```{r}
AQ.MONT
```

##############
```{r}
## Water Year Sequencing
AQ.MT<- AQ.MONT
AQ.MT$Water_Year_Month <- rep(seq(1:12),19) #1975 to 2016 is 43 years
AQ.MT$Water_Year_Year <- rep(1:19, each =12)
AQ.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 AQ.WY <- AQ.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
AQ.WY
```
##############
```{r}
## Monthly Columns
## Oct
 AQ.OCT <- AQ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 AQ.NOV <- AQ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 AQ.DEC <- AQ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 AQ.JAN <- AQ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 AQ.FEB <- AQ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 AQ.MAR <- AQ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 AQ.APL <- AQ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 AQ.MAY <- AQ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 AQ.JUN <- AQ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 AQ.JUL <- AQ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 AQ.AUG <- AQ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 AQ.SEP <- AQ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
AQ.ALL <- cbind(AQ.WY, AQ.OCT[,-1], AQ.NOV[,-1], AQ.DEC[,-1], AQ.JAN[,-1], AQ.FEB[,-1], AQ.MAR[,-1], AQ.APL[,-1],AQ.MAY[,-1], AQ.JUN[,-1], AQ.JUL[,-1], AQ.AUG[,-1], AQ.SEP[,-1])
```
####################
```{r}
## Gap filling
AQ.ALL$AN_RR <- AQ.ALL$AN_RO_mm/AQ.ALL$AN_PCP_mm
AQ.ALL$OCT_RR <- AQ.ALL$Oct_RO_mm/AQ.ALL$Oct_PCP_mm
AQ.ALL$NOV_RR <- AQ.ALL$Nov_RO_mm/AQ.ALL$Nov_PCP_mm
AQ.ALL$DEC_RR <- AQ.ALL$Dec_RO_mm/AQ.ALL$Dec_PCP_mm
AQ.ALL$JAN_RR <- AQ.ALL$Jan_RO_mm/AQ.ALL$Jan_PCP_mm
AQ.ALL$FEB_RR <- AQ.ALL$Feb_RO_mm/AQ.ALL$Feb_PCP_mm
AQ.ALL$MAR_RR <- AQ.ALL$Mar_RO_mm/AQ.ALL$Mar_PCP_mm
AQ.ALL$APL_RR <- AQ.ALL$Apl_RO_mm/AQ.ALL$Apl_PCP_mm
AQ.ALL$MAY_RR <- AQ.ALL$May_RO_mm/AQ.ALL$May_PCP_mm
AQ.ALL$JUN_RR <- AQ.ALL$Jun_RO_mm/AQ.ALL$Jun_PCP_mm
AQ.ALL$JUL_RR <- AQ.ALL$Jul_RO_mm/AQ.ALL$Jul_PCP_mm
AQ.ALL$AUG_RR <- AQ.ALL$Aug_RO_mm/AQ.ALL$Aug_PCP_mm
AQ.ALL$SEP_RR <- AQ.ALL$Sep_RO_mm/AQ.ALL$Sep_PCP_mm
AQ.ALL[10,30]<- 0
AQ.ALL[7,32]<- 0
AQ.ALL[10,33]<- 0
AQ.ALL[16,30]<- 0
AQ.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(AQ.ALL[,-1],2, mean))
CSD <- rbind(apply(AQ.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
AQ.ALL[nrow(AQ.ALL)+ 1,] = CML
AQ.ALL[nrow(AQ.ALL)+ 1,] = CSDL
AQ.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(AQ.ALL[1:19,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
AQ.TS <-AQ.ALL[1:19,1:40]
AQ.TSN <- as.data.frame(apply(AQ.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(AQ.TSN, class)   
AQ.TSN
```
############################################
```{r}
AQM1 <- mblm(AN_RO_mm~ Water_Year_Year, AQ.TSN)
AQM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AQ.TSN)
AQM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AQ.TSN)
AQM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AQ.TSN)
AQM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AQ.TSN)
AQM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AQ.TSN)
AQM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AQ.TSN)
AQM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AQ.TSN)
AQM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AQ.TSN)
AQM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AQ.TSN)
AQM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AQ.TSN)
AQM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AQ.TSN)
AQM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AQ.TSN)
AQM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AQ.TSN)
AQM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AQ.TSN)
AQM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AQ.TSN)
AQM17 <- mblm(May_RO_mm~ Water_Year_Year, AQ.TSN)
AQM18 <- mblm(May_PCP_mm~ Water_Year_Year, AQ.TSN)
AQM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AQ.TSN)
AQM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AQ.TSN)
AQM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AQ.TSN)
AQM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AQ.TSN)
AQM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AQ.TSN)
AQM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AQ.TSN)
AQM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AQ.TSN)
AQM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AQ.TSN)
AQM27 <- mblm(AN_RR~ Water_Year_Year, AQ.TSN)
AQM28 <- mblm(OCT_RR~ Water_Year_Year, AQ.TSN)
AQM29 <- mblm(NOV_RR~ Water_Year_Year, AQ.TSN)
AQM30 <- mblm(DEC_RR~ Water_Year_Year, AQ.TSN)
AQM31 <- mblm(JAN_RR~ Water_Year_Year, AQ.TSN)
AQM32 <- mblm(FEB_RR~ Water_Year_Year, AQ.TSN)
AQM33 <- mblm(MAR_RR~ Water_Year_Year, AQ.TSN)
AQM34 <- mblm(APL_RR~ Water_Year_Year, AQ.TSN)
AQM35 <- mblm(MAY_RR~ Water_Year_Year, AQ.TSN)
AQM36 <- mblm(JUN_RR~ Water_Year_Year, AQ.TSN)
AQM37 <- mblm(JUL_RR~ Water_Year_Year, AQ.TSN)
AQM38 <- mblm(AUG_RR~ Water_Year_Year, AQ.TSN)
AQM39 <- mblm(SEP_RR~ Water_Year_Year, AQ.TSN)
```
####################################
```{r}
TSR<- cbind(AQM1$coefficients, AQM2$coefficients, AQM3$coefficients, AQM4$coefficients, AQM5$coefficients, AQM6$coefficients,AQM7$coefficients, AQM8$coefficients, AQM9$coefficients,AQM10$coefficients, AQM11$coefficients, AQM12$coefficients,AQM13$coefficients, AQM14$coefficients, AQM15$coefficients,AQM16$coefficients, AQM17$coefficients, AQM18$coefficients,AQM19$coefficients, AQM20$coefficients, AQM21$coefficients,AQM22$coefficients, AQM23$coefficients, AQM4$coefficients,AQM25$coefficients, AQM26$coefficients, AQM27$coefficients,AQM28$coefficients, AQM29$coefficients, AQM30$coefficients,AQM31$coefficients, AQM32$coefficients, AQM33$coefficients,AQM34$coefficients, AQM35$coefficients, AQM36$coefficients,AQM37$coefficients, AQM38$coefficients, AQM39$coefficients)
RES <- cbind(AQM1$residuals, AQM2$residuals, AQM3$residuals, AQM4$residuals, AQM5$residuals, AQM6$residuals,AQM7$residuals, AQM8$residuals, AQM9$residuals,AQM10$residuals, AQM11$residuals, AQM12$residuals,AQM13$residuals, AQM14$residuals, AQM15$residuals,AQM16$residuals, AQM17$residuals, AQM18$residuals,AQM19$residuals, AQM20$residuals, AQM21$residuals,AQM22$residuals, AQM23$residuals, AQM4$residuals,AQM25$residuals, AQM26$residuals, AQM27$residuals,AQM28$residuals, AQM29$residuals, AQM30$residuals,AQM31$residuals, AQM32$residuals, AQM33$residuals,AQM34$residuals, AQM35$residuals, AQM36$residuals,AQM37$residuals, AQM38$residuals, AQM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AQ.ALL[nrow(AQ.ALL)+ 1,] = MKTR
AQ.ALL[nrow(AQ.ALL)+ 1,] = MKPR
AQ.ALL[nrow(AQ.ALL)+ 1,] = TSRR
AQ.ALL[nrow(AQ.ALL)+ 1,] = BTDF
AQ.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- AQ.ALL[1:19,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
AQ.ALL[nrow(AQ.ALL)+ 1,] = MMKPR
AQ.ALL[nrow(AQ.ALL)+ 1,] = MMKTR
AQ.ALL[nrow(AQ.ALL)+ 1,] = MMKSR
AQ.ALL
```

```{r}
AQ.NUM <- as.data.frame(apply(AQ.ALL[1:28,2:40], 2, as.numeric))
str(AQ.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(AQ.NUM[25,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(AQ.NUM[24,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(AQ.NUM[28,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(AQ.NUM[23,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(AQ.NUM[26,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
AQ.ALL[nrow(AQ.ALL)+ 1,] = FSR1
AQ.ALL[nrow(AQ.ALL)+ 1,] = FSR2
AQ.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
AQFM <-AQ.ALL[c(29,30),-1]
AQF <- as.matrix(apply(AQFM, 2, as.numeric))
AQF
```

### Etna Results, csv 'FF' ID 16
```{r}
### Summarise by Month
FF$StreamflowDay_m3<- FF$Streamflow*(60*60*24)
FF.MON <- FF %>%
   group_by(Year, Month) %>%
   summarise(Month_Streamflow_m3 = sum(StreamflowDay_m3), Month_Precip_mm = sum(Precip))
FF.MON$Streamflow_Km<-FF.MON$Month_Streamflow_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
FF.MON$Streamflow_mm<-(FF.MON$Streamflow_Km/557)*1000000 ## monthly runoff depth mm
FF.MON2 <- subset(FF.MON, Year >= 1969)
#FF.MON2

#### M DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
FF.MONT<- FF.MON2[-c(1,2,3,4,5,6,7,8,9,538,539,540,541,542,543,544,545,546),]
FF.MONT
```



```{r}

FFT<-GMP2[[946:1473]] #Etna
FFE<-extent(9.5,10,60,60.5) #Etna Extent
FFPC<-crop(FFT,FFE) #Etna Crop
FF.Mon.Precip.<-extract(FFPC,FFE, method="bilinear", fun = mean)
FFMP<-as.data.frame(colMeans(FF.Mon.Precip.)) #Etna
FFSub<-DateTemp[DateTemp$Date >= as.Date("1969-10-01") & DateTemp$Date <=
                    as.Date("2013-09-01"), ] ##Etna
FFPp<- cbind(FFMP,FFSub) ## Etna
```

```{r}
FF.MONT$GriddedPrecip_mm<- FFMP$`colMeans(FF.Mon.Precip.)`
FF.MONT
```

##############
```{r}
## Water Year Sequencing
FF.MT<- FF.MONT
FF.MT$Water_Year_Month <- rep(seq(1:12),44) #1975 to 2016 is 43 years
FF.MT$Water_Year_Year <- rep(1:44, each =12)
FF.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 FF.WY <- FF.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
FF.WY
```
##############
```{r}
## Monthly Columns
## Oct
 FF.OCT <- FF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 FF.NOV <- FF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 FF.DEC <- FF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 FF.JAN <- FF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 FF.FEB <- FF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 FF.MAR <- FF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 FF.APL <- FF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 FF.MAY <- FF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 FF.JUN <- FF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 FF.JUL <- FF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 FF.AUG <- FF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 FF.SEP <- FF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
FF.ALL <- cbind(FF.WY, FF.OCT[,-1], FF.NOV[,-1], FF.DEC[,-1], FF.JAN[,-1], FF.FEB[,-1], FF.MAR[,-1], FF.APL[,-1],FF.MAY[,-1], FF.JUN[,-1], FF.JUL[,-1], FF.AUG[,-1], FF.SEP[,-1])
```
####################
```{r}
FF.ALL$AN_RR <- FF.ALL$AN_RO_mm/FF.ALL$AN_PCP_mm
FF.ALL$OCT_RR <- FF.ALL$Oct_RO_mm/FF.ALL$Oct_PCP_mm
FF.ALL$NOV_RR <- FF.ALL$Nov_RO_mm/FF.ALL$Nov_PCP_mm
FF.ALL$DEC_RR <- FF.ALL$Dec_RO_mm/FF.ALL$Dec_PCP_mm
FF.ALL$JAN_RR <- FF.ALL$Jan_RO_mm/FF.ALL$Jan_PCP_mm
FF.ALL$FEB_RR <- FF.ALL$Feb_RO_mm/FF.ALL$Feb_PCP_mm
FF.ALL$MAR_RR <- FF.ALL$Mar_RO_mm/FF.ALL$Mar_PCP_mm
FF.ALL$APL_RR <- FF.ALL$Apl_RO_mm/FF.ALL$Apl_PCP_mm
FF.ALL$MAY_RR <- FF.ALL$May_RO_mm/FF.ALL$May_PCP_mm
FF.ALL$JUN_RR <- FF.ALL$Jun_RO_mm/FF.ALL$Jun_PCP_mm
FF.ALL$JUL_RR <- FF.ALL$Jul_RO_mm/FF.ALL$Jul_PCP_mm
FF.ALL$AUG_RR <- FF.ALL$Aug_RO_mm/FF.ALL$Aug_PCP_mm
FF.ALL$SEP_RR <- FF.ALL$Sep_RO_mm/FF.ALL$Sep_PCP_mm
FF.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(FF.ALL[,-1],2, mean))
CSD <- rbind(apply(FF.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
FF.ALL[nrow(FF.ALL)+ 1,] = CML
FF.ALL[nrow(FF.ALL)+ 1,] = CSDL
FF.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(FF.ALL[1:44,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
FF.TS <-FF.ALL[1:44,1:40]
FF.TSN <- as.data.frame(apply(FF.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(FF.TSN, class)   
FF.TSN
```
############################################
```{r}
FFM1 <- mblm(AN_RO_mm~ Water_Year_Year, FF.TSN)
FFM2 <- mblm(AN_PCP_mm~ Water_Year_Year, FF.TSN)
FFM3 <- mblm(Oct_RO_mm~ Water_Year_Year, FF.TSN)
FFM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, FF.TSN)
FFM5 <- mblm(Nov_RO_mm~ Water_Year_Year, FF.TSN)
FFM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, FF.TSN)
FFM7 <- mblm(Dec_RO_mm~ Water_Year_Year, FF.TSN)
FFM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, FF.TSN)
FFM9 <- mblm(Jan_RO_mm~ Water_Year_Year, FF.TSN)
FFM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, FF.TSN)
FFM11 <- mblm(Feb_RO_mm~ Water_Year_Year, FF.TSN)
FFM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, FF.TSN)
FFM13 <- mblm(Mar_RO_mm~ Water_Year_Year, FF.TSN)
FFM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, FF.TSN)
FFM15 <- mblm(Apl_RO_mm~ Water_Year_Year, FF.TSN)
FFM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, FF.TSN)
FFM17 <- mblm(May_RO_mm~ Water_Year_Year, FF.TSN)
FFM18 <- mblm(May_PCP_mm~ Water_Year_Year, FF.TSN)
FFM19 <- mblm(Jun_RO_mm~ Water_Year_Year, FF.TSN)
FFM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, FF.TSN)
FFM21 <- mblm(Jul_RO_mm~ Water_Year_Year, FF.TSN)
FFM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, FF.TSN)
FFM23 <- mblm(Aug_RO_mm~ Water_Year_Year, FF.TSN)
FFM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, FF.TSN)
FFM25 <- mblm(Sep_RO_mm~ Water_Year_Year, FF.TSN)
FFM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, FF.TSN)
FFM27 <- mblm(AN_RR~ Water_Year_Year, FF.TSN)
FFM28 <- mblm(OCT_RR~ Water_Year_Year, FF.TSN)
FFM29 <- mblm(NOV_RR~ Water_Year_Year, FF.TSN)
FFM30 <- mblm(DEC_RR~ Water_Year_Year, FF.TSN)
FFM31 <- mblm(JAN_RR~ Water_Year_Year, FF.TSN)
FFM32 <- mblm(FEB_RR~ Water_Year_Year, FF.TSN)
FFM33 <- mblm(MAR_RR~ Water_Year_Year, FF.TSN)
FFM34 <- mblm(APL_RR~ Water_Year_Year, FF.TSN)
FFM35 <- mblm(MAY_RR~ Water_Year_Year, FF.TSN)
FFM36 <- mblm(JUN_RR~ Water_Year_Year, FF.TSN)
FFM37 <- mblm(JUL_RR~ Water_Year_Year, FF.TSN)
FFM38 <- mblm(AUG_RR~ Water_Year_Year, FF.TSN)
FFM39 <- mblm(SEP_RR~ Water_Year_Year, FF.TSN)
```
####################################
```{r}
TSR<- cbind(FFM1$coefficients, FFM2$coefficients, FFM3$coefficients, FFM4$coefficients, FFM5$coefficients, FFM6$coefficients,FFM7$coefficients, FFM8$coefficients, FFM9$coefficients,FFM10$coefficients, FFM11$coefficients, FFM12$coefficients,FFM13$coefficients, FFM14$coefficients, FFM15$coefficients,FFM16$coefficients, FFM17$coefficients, FFM18$coefficients,FFM19$coefficients, FFM20$coefficients, FFM21$coefficients,FFM22$coefficients, FFM23$coefficients, FFM4$coefficients,FFM25$coefficients, FFM26$coefficients, FFM27$coefficients,FFM28$coefficients, FFM29$coefficients, FFM30$coefficients,FFM31$coefficients, FFM32$coefficients, FFM33$coefficients,FFM34$coefficients, FFM35$coefficients, FFM36$coefficients,FFM37$coefficients, FFM38$coefficients, FFM39$coefficients)
RES <- cbind(FFM1$residuals, FFM2$residuals, FFM3$residuals, FFM4$residuals, FFM5$residuals, FFM6$residuals,FFM7$residuals, FFM8$residuals, FFM9$residuals,FFM10$residuals, FFM11$residuals, FFM12$residuals,FFM13$residuals, FFM14$residuals, FFM15$residuals,FFM16$residuals, FFM17$residuals, FFM18$residuals,FFM19$residuals, FFM20$residuals, FFM21$residuals,FFM22$residuals, FFM23$residuals, FFM4$residuals,FFM25$residuals, FFM26$residuals, FFM27$residuals,FFM28$residuals, FFM29$residuals, FFM30$residuals,FFM31$residuals, FFM32$residuals, FFM33$residuals,FFM34$residuals, FFM35$residuals, FFM36$residuals,FFM37$residuals, FFM38$residuals, FFM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
FF.ALL[nrow(FF.ALL)+ 1,] = MKTR
FF.ALL[nrow(FF.ALL)+ 1,] = MKPR
FF.ALL[nrow(FF.ALL)+ 1,] = TSRR
FF.ALL[nrow(FF.ALL)+ 1,] = BTDF
FF.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- FF.ALL[1:44,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
FF.ALL[nrow(FF.ALL)+ 1,] = MMKPR
FF.ALL[nrow(FF.ALL)+ 1,] = MMKTR
FF.ALL[nrow(FF.ALL)+ 1,] = MMKSR
FF.ALL
```

```{r}
FF.NUM <- as.data.frame(apply(FF.ALL[1:53,2:40], 2, as.numeric))
str(FF.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(FF.NUM[50,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(FF.NUM[49,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(FF.NUM[53,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(FF.NUM[48,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(FF.NUM[51,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
FF.ALL[nrow(FF.ALL)+ 1,] = FSR1
FF.ALL[nrow(FF.ALL)+ 1,] = FSR2
FF.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
FFFM <-FF.ALL[c(54,55),-1]
FFF <- as.matrix(apply(FFFM, 2, as.numeric))
FFF
```
###########################################################
```{r}
### Water Year 19 = 1990 onwards
```

```{r}
42-17
```

###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(FF.ALL[21:44,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
FF.TS2 <-FF.ALL[21:44,1:40] ## 1990 Subset
FF.TSN2 <- as.data.frame(apply(FF.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(FF.TSN2, class)   
FF.TSN2
```
############################################
```{r}
FFM1 <- mblm(AN_RO_mm~ Water_Year_Year, FF.TSN2)
FFM2 <- mblm(AN_PCP_mm~ Water_Year_Year, FF.TSN2)
FFM3 <- mblm(Oct_RO_mm~ Water_Year_Year, FF.TSN2)
FFM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, FF.TSN2)
FFM5 <- mblm(Nov_RO_mm~ Water_Year_Year, FF.TSN2)
FFM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, FF.TSN2)
FFM7 <- mblm(Dec_RO_mm~ Water_Year_Year, FF.TSN2)
FFM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, FF.TSN2)
FFM9 <- mblm(Jan_RO_mm~ Water_Year_Year, FF.TSN2)
FFM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, FF.TSN2)
FFM11 <- mblm(Feb_RO_mm~ Water_Year_Year, FF.TSN2)
FFM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, FF.TSN2)
FFM13 <- mblm(Mar_RO_mm~ Water_Year_Year, FF.TSN2)
FFM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, FF.TSN2)
FFM15 <- mblm(Apl_RO_mm~ Water_Year_Year, FF.TSN2)
FFM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, FF.TSN2)
FFM17 <- mblm(May_RO_mm~ Water_Year_Year, FF.TSN2)
FFM18 <- mblm(May_PCP_mm~ Water_Year_Year, FF.TSN2)
FFM19 <- mblm(Jun_RO_mm~ Water_Year_Year, FF.TSN2)
FFM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, FF.TSN2)
FFM21 <- mblm(Jul_RO_mm~ Water_Year_Year, FF.TSN2)
FFM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, FF.TSN2)
FFM23 <- mblm(Aug_RO_mm~ Water_Year_Year, FF.TSN2)
FFM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, FF.TSN2)
FFM25 <- mblm(Sep_RO_mm~ Water_Year_Year, FF.TSN2)
FFM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, FF.TSN2)
FFM27 <- mblm(AN_RR~ Water_Year_Year, FF.TSN2)
FFM28 <- mblm(OCT_RR~ Water_Year_Year, FF.TSN2)
FFM29 <- mblm(NOV_RR~ Water_Year_Year, FF.TSN2)
FFM30 <- mblm(DEC_RR~ Water_Year_Year, FF.TSN2)
FFM31 <- mblm(JAN_RR~ Water_Year_Year, FF.TSN2)
FFM32 <- mblm(FEB_RR~ Water_Year_Year, FF.TSN2)
FFM33 <- mblm(MAR_RR~ Water_Year_Year, FF.TSN2)
FFM34 <- mblm(APL_RR~ Water_Year_Year, FF.TSN2)
FFM35 <- mblm(MAY_RR~ Water_Year_Year, FF.TSN2)
FFM36 <- mblm(JUN_RR~ Water_Year_Year, FF.TSN2)
FFM37 <- mblm(JUL_RR~ Water_Year_Year, FF.TSN2)
FFM38 <- mblm(AUG_RR~ Water_Year_Year, FF.TSN2)
FFM39 <- mblm(SEP_RR~ Water_Year_Year, FF.TSN2)
```
####################################
```{r}
TSR2<- cbind(FFM1$coefficients, FFM2$coefficients, FFM3$coefficients, FFM4$coefficients, FFM5$coefficients, FFM6$coefficients,FFM7$coefficients, FFM8$coefficients, FFM9$coefficients,FFM10$coefficients, FFM11$coefficients, FFM12$coefficients,FFM13$coefficients, FFM14$coefficients, FFM15$coefficients,FFM16$coefficients, FFM17$coefficients, FFM18$coefficients,FFM19$coefficients, FFM20$coefficients, FFM21$coefficients,FFM22$coefficients, FFM23$coefficients, FFM4$coefficients,FFM25$coefficients, FFM26$coefficients, FFM27$coefficients,FFM28$coefficients, FFM29$coefficients, FFM30$coefficients,FFM31$coefficients, FFM32$coefficients, FFM33$coefficients,FFM34$coefficients, FFM35$coefficients, FFM36$coefficients,FFM37$coefficients, FFM38$coefficients, FFM39$coefficients)
RES2 <- cbind(FFM1$residuals, FFM2$residuals, FFM3$residuals, FFM4$residuals, FFM5$residuals, FFM6$residuals,FFM7$residuals, FFM8$residuals, FFM9$residuals,FFM10$residuals, FFM11$residuals, FFM12$residuals,FFM13$residuals, FFM14$residuals, FFM15$residuals,FFM16$residuals, FFM17$residuals, FFM18$residuals,FFM19$residuals, FFM20$residuals, FFM21$residuals,FFM22$residuals, FFM23$residuals, FFM4$residuals,FFM25$residuals, FFM26$residuals, FFM27$residuals,FFM28$residuals, FFM29$residuals, FFM30$residuals,FFM31$residuals, FFM32$residuals, FFM33$residuals,FFM34$residuals, FFM35$residuals, FFM36$residuals,FFM37$residuals, FFM38$residuals, FFM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
FF.ALL[nrow(FF.ALL)+ 1,] = MKTR2
FF.ALL[nrow(FF.ALL)+ 1,] = MKPR2
FF.ALL[nrow(FF.ALL)+ 1,] = TSRR2
FF.ALL[nrow(FF.ALL)+ 1,] = BTDF2
FF.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- FF.ALL[21:44,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
FF.ALL[nrow(FF.ALL)+ 1,] = MMKPR2
FF.ALL[nrow(FF.ALL)+ 1,] = MMKTR2
FF.ALL[nrow(FF.ALL)+ 1,] = MMKSR2
FF.ALL
```

```{r}
FF.ALL
```

```{r}
FF.NUM2 <- as.data.frame(apply(FF.ALL[1:62,2:40], 2, as.numeric))
str(FF.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(FF.NUM2[59,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(FF.NUM2[58,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(FF.NUM2[62,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(FF.NUM2[57,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(FF.NUM2[60,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
FF.ALL[nrow(FF.ALL)+ 1,] = FSR12
FF.ALL[nrow(FF.ALL)+ 1,] = FSR22
FF.ALL
```

```{r}
FF.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
FFFM2 <-FF.ALL[c(63,64),-1]
FFF2 <- as.matrix(apply(FFFM2, 2, as.numeric))
FFF2
```


###Groetsjoen Results, csv 'K' ID 17
```{r}
### Summarise by Month
K$StreamflowDay_m3<- K$Streamflow*(60*60*24)
K.MON <- K %>%
   group_by(Year, Month) %>%
   summarise(Month_Streamflow_m3 = sum(StreamflowDay_m3), Month_Precip_mm = sum(Precip))
K.MON$Streamflow_Km<-K.MON$Month_Streamflow_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
K.MON$Streamflow_mm<-(K.MON$Streamflow_Km/565)*1000000 ## monthly runoff depth mm
K.MON2 <- subset(K.MON, Year >= 1969)
#K.MON2

#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
K.MONT<- K.MON2[-c(1,2,3,4,5,6,7,8,9),]
K.MONT
```


```{r}
KT<-GMP2[[946:1509]] #Groetsjoen
KE<-extent(12,12.5,61,61.5) #Groetsjoen Extent
KPC<-crop(KT,KE) #Groetsjoen Crop
K.Mon.Precip.<-extract(KPC,KE, method="bilinear", fun = mean)
KMP<-as.data.frame(colMeans(K.Mon.Precip.)) #Groetsgoen
KSub<-DateTemp[DateTemp$Date >= as.Date("1969-10-01") & DateTemp$Date <=
                    as.Date("2016-09-01"), ] ##Groetsjeon
KPp<- cbind(KMP,KSub) ## Groetsjoen
```

```{r}
## Unique data trimming here. 2016 stops in October starts   
K.MONT$GriddedPrecip_mm<- KMP$`colMeans(K.Mon.Precip.)`
K.MONT
```

```{r}
## Gap filling process
KO <- subset(K.MONT, Month == 10)
KN <- subset(K.MONT, Month == 11)
KD <- subset(K.MONT, Month == 12)
KJN <- subset(K.MONT, Month == 1)
KF <- subset(K.MONT, Month == 2)
KM <- subset(K.MONT, Month == 3)
KA <- subset(K.MONT, Month == 4)
KMY <- subset(K.MONT, Month == 5)
K.10 <- mean(KO$Streamflow_mm, na.rm = TRUE)
K.11 <- mean(KN$Streamflow_mm, na.rm = TRUE)
K.12 <- mean(KD$Streamflow_mm, na.rm = TRUE)
K.1 <-mean(KJN$Streamflow_mm, na.rm = TRUE)
K.2 <- mean(KF$Streamflow_mm, na.rm = TRUE)
K.3 <- mean(KM$Streamflow_mm, na.rm = TRUE)
K.4 <- mean(KA$Streamflow_mm, na.rm = TRUE)
K.5 <-mean(KMY$Streamflow_mm, na.rm = TRUE)
K.MONT[385,6] <- K.10
K.MONT[386,6] <- K.11
K.MONT[387,6] <- K.12
K.MONT[388,6] <- K.1
K.MONT[389,6] <- K.2
K.MONT[390,6] <- K.3
K.MONT[391,6] <- K.4
K.MONT[392,6] <- K.5
K.MONT
```




##############
```{r}
## Water Year Sequencing
K.MT<- K.MONT
K.MT$Water_Year_Month <- rep(seq(1:12),47) #1975 to 2016 is 43 years
K.MT$Water_Year_Year <- rep(1:47, each =12)
K.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 K.WY <- K.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
K.WY
```
##############
```{r}
## Monthly Columns
## Oct
 K.OCT <- K.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 K.NOV <- K.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 K.DEC <- K.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 K.JAN <- K.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 K.FEB <- K.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 K.MAR <- K.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 K.APL <- K.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 K.MAY <- K.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 K.JUN <- K.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 K.JUL <- K.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 K.AUG <- K.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 K.SEP <- K.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
K.ALL <- cbind(K.WY, K.OCT[,-1], K.NOV[,-1], K.DEC[,-1], K.JAN[,-1], K.FEB[,-1], K.MAR[,-1], K.APL[,-1],K.MAY[,-1], K.JUN[,-1], K.JUL[,-1], K.AUG[,-1], K.SEP[,-1])
```
####################
```{r}
K.ALL$AN_RR <- K.ALL$AN_RO_mm/K.ALL$AN_PCP_mm
K.ALL$OCT_RR <- K.ALL$Oct_RO_mm/K.ALL$Oct_PCP_mm
K.ALL$NOV_RR <- K.ALL$Nov_RO_mm/K.ALL$Nov_PCP_mm
K.ALL$DEC_RR <- K.ALL$Dec_RO_mm/K.ALL$Dec_PCP_mm
K.ALL$JAN_RR <- K.ALL$Jan_RO_mm/K.ALL$Jan_PCP_mm
K.ALL$FEB_RR <- K.ALL$Feb_RO_mm/K.ALL$Feb_PCP_mm
K.ALL$MAR_RR <- K.ALL$Mar_RO_mm/K.ALL$Mar_PCP_mm
K.ALL$APL_RR <- K.ALL$Apl_RO_mm/K.ALL$Apl_PCP_mm
K.ALL$MAY_RR <- K.ALL$May_RO_mm/K.ALL$May_PCP_mm
K.ALL$JUN_RR <- K.ALL$Jun_RO_mm/K.ALL$Jun_PCP_mm
K.ALL$JUL_RR <- K.ALL$Jul_RO_mm/K.ALL$Jul_PCP_mm
K.ALL$AUG_RR <- K.ALL$Aug_RO_mm/K.ALL$Aug_PCP_mm
K.ALL$SEP_RR <- K.ALL$Sep_RO_mm/K.ALL$Sep_PCP_mm
K.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(K.ALL[,-1],2, mean))
CSD <- rbind(apply(K.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
K.ALL[nrow(K.ALL)+ 1,] = CML
K.ALL[nrow(K.ALL)+ 1,] = CSDL
K.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(K.ALL[1:47,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
K.TS <-K.ALL[1:47,1:40]
K.TSN <- as.data.frame(apply(K.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(K.TSN, class)   
K.TSN
```
############################################
```{r}
KM1 <- mblm(AN_RO_mm~ Water_Year_Year, K.TSN)
KM2 <- mblm(AN_PCP_mm~ Water_Year_Year, K.TSN)
KM3 <- mblm(Oct_RO_mm~ Water_Year_Year, K.TSN)
KM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, K.TSN)
KM5 <- mblm(Nov_RO_mm~ Water_Year_Year, K.TSN)
KM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, K.TSN)
KM7 <- mblm(Dec_RO_mm~ Water_Year_Year, K.TSN)
KM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, K.TSN)
KM9 <- mblm(Jan_RO_mm~ Water_Year_Year, K.TSN)
KM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, K.TSN)
KM11 <- mblm(Feb_RO_mm~ Water_Year_Year, K.TSN)
KM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, K.TSN)
KM13 <- mblm(Mar_RO_mm~ Water_Year_Year, K.TSN)
KM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, K.TSN)
KM15 <- mblm(Apl_RO_mm~ Water_Year_Year, K.TSN)
KM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, K.TSN)
KM17 <- mblm(May_RO_mm~ Water_Year_Year, K.TSN)
KM18 <- mblm(May_PCP_mm~ Water_Year_Year, K.TSN)
KM19 <- mblm(Jun_RO_mm~ Water_Year_Year, K.TSN)
KM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, K.TSN)
KM21 <- mblm(Jul_RO_mm~ Water_Year_Year, K.TSN)
KM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, K.TSN)
KM23 <- mblm(Aug_RO_mm~ Water_Year_Year, K.TSN)
KM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, K.TSN)
KM25 <- mblm(Sep_RO_mm~ Water_Year_Year, K.TSN)
KM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, K.TSN)
KM27 <- mblm(AN_RR~ Water_Year_Year, K.TSN)
KM28 <- mblm(OCT_RR~ Water_Year_Year, K.TSN)
KM29 <- mblm(NOV_RR~ Water_Year_Year, K.TSN)
KM30 <- mblm(DEC_RR~ Water_Year_Year, K.TSN)
KM31 <- mblm(JAN_RR~ Water_Year_Year, K.TSN)
KM32 <- mblm(FEB_RR~ Water_Year_Year, K.TSN)
KM33 <- mblm(MAR_RR~ Water_Year_Year, K.TSN)
KM34 <- mblm(APL_RR~ Water_Year_Year, K.TSN)
KM35 <- mblm(MAY_RR~ Water_Year_Year, K.TSN)
KM36 <- mblm(JUN_RR~ Water_Year_Year, K.TSN)
KM37 <- mblm(JUL_RR~ Water_Year_Year, K.TSN)
KM38 <- mblm(AUG_RR~ Water_Year_Year, K.TSN)
KM39 <- mblm(SEP_RR~ Water_Year_Year, K.TSN)
```
####################################
```{r}
TSR<- cbind(KM1$coefficients, KM2$coefficients, KM3$coefficients, KM4$coefficients, KM5$coefficients, KM6$coefficients,KM7$coefficients, KM8$coefficients, KM9$coefficients,KM10$coefficients, KM11$coefficients, KM12$coefficients,KM13$coefficients, KM14$coefficients, KM15$coefficients,KM16$coefficients, KM17$coefficients, KM18$coefficients,KM19$coefficients, KM20$coefficients, KM21$coefficients,KM22$coefficients, KM23$coefficients, KM4$coefficients,KM25$coefficients, KM26$coefficients, KM27$coefficients,KM28$coefficients, KM29$coefficients, KM30$coefficients,KM31$coefficients, KM32$coefficients, KM33$coefficients,KM34$coefficients, KM35$coefficients, KM36$coefficients,KM37$coefficients, KM38$coefficients, KM39$coefficients)
RES <- cbind(KM1$residuals, KM2$residuals, KM3$residuals, KM4$residuals, KM5$residuals, KM6$residuals,KM7$residuals, KM8$residuals, KM9$residuals,KM10$residuals, KM11$residuals, KM12$residuals,KM13$residuals, KM14$residuals, KM15$residuals,KM16$residuals, KM17$residuals, KM18$residuals,KM19$residuals, KM20$residuals, KM21$residuals,KM22$residuals, KM23$residuals, KM4$residuals,KM25$residuals, KM26$residuals, KM27$residuals,KM28$residuals, KM29$residuals, KM30$residuals,KM31$residuals, KM32$residuals, KM33$residuals,KM34$residuals, KM35$residuals, KM36$residuals,KM37$residuals, KM38$residuals, KM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
K.ALL[nrow(K.ALL)+ 1,] = MKTR
K.ALL[nrow(K.ALL)+ 1,] = MKPR
K.ALL[nrow(K.ALL)+ 1,] = TSRR
K.ALL[nrow(K.ALL)+ 1,] = BTDF
K.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- K.ALL[1:47,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
K.ALL[nrow(K.ALL)+ 1,] = MMKPR
K.ALL[nrow(K.ALL)+ 1,] = MMKTR
K.ALL[nrow(K.ALL)+ 1,] = MMKSR
K.ALL
```

```{r}
K.NUM <- as.data.frame(apply(K.ALL[1:56,2:40], 2, as.numeric))
str(K.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(K.NUM[53,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(K.NUM[52,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(K.NUM[56,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(K.NUM[51,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(K.NUM[54,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
K.ALL[nrow(K.ALL)+ 1,] = FSR1
K.ALL[nrow(K.ALL)+ 1,] = FSR2
K.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
KFM <-K.ALL[c(57,58),-1]
KF <- as.matrix(apply(KFM, 2, as.numeric))
KF
```
###########################################################
```{r}
### Water Year 19 = 1990 onwards
```

```{r}
42-17
```

###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(K.ALL[21:47,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
K.TS2 <-K.ALL[21:47,1:40] ## 1990 Subset
K.TSN2 <- as.data.frame(apply(K.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(K.TSN2, class)   
K.TSN2
```
############################################
```{r}
KM1 <- mblm(AN_RO_mm~ Water_Year_Year, K.TSN2)
KM2 <- mblm(AN_PCP_mm~ Water_Year_Year, K.TSN2)
KM3 <- mblm(Oct_RO_mm~ Water_Year_Year, K.TSN2)
KM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, K.TSN2)
KM5 <- mblm(Nov_RO_mm~ Water_Year_Year, K.TSN2)
KM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, K.TSN2)
KM7 <- mblm(Dec_RO_mm~ Water_Year_Year, K.TSN2)
KM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, K.TSN2)
KM9 <- mblm(Jan_RO_mm~ Water_Year_Year, K.TSN2)
KM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, K.TSN2)
KM11 <- mblm(Feb_RO_mm~ Water_Year_Year, K.TSN2)
KM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, K.TSN2)
KM13 <- mblm(Mar_RO_mm~ Water_Year_Year, K.TSN2)
KM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, K.TSN2)
KM15 <- mblm(Apl_RO_mm~ Water_Year_Year, K.TSN2)
KM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, K.TSN2)
KM17 <- mblm(May_RO_mm~ Water_Year_Year, K.TSN2)
KM18 <- mblm(May_PCP_mm~ Water_Year_Year, K.TSN2)
KM19 <- mblm(Jun_RO_mm~ Water_Year_Year, K.TSN2)
KM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, K.TSN2)
KM21 <- mblm(Jul_RO_mm~ Water_Year_Year, K.TSN2)
KM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, K.TSN2)
KM23 <- mblm(Aug_RO_mm~ Water_Year_Year, K.TSN2)
KM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, K.TSN2)
KM25 <- mblm(Sep_RO_mm~ Water_Year_Year, K.TSN2)
KM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, K.TSN2)
KM27 <- mblm(AN_RR~ Water_Year_Year, K.TSN2)
KM28 <- mblm(OCT_RR~ Water_Year_Year, K.TSN2)
KM29 <- mblm(NOV_RR~ Water_Year_Year, K.TSN2)
KM30 <- mblm(DEC_RR~ Water_Year_Year, K.TSN2)
KM31 <- mblm(JAN_RR~ Water_Year_Year, K.TSN2)
KM32 <- mblm(FEB_RR~ Water_Year_Year, K.TSN2)
KM33 <- mblm(MAR_RR~ Water_Year_Year, K.TSN2)
KM34 <- mblm(APL_RR~ Water_Year_Year, K.TSN2)
KM35 <- mblm(MAY_RR~ Water_Year_Year, K.TSN2)
KM36 <- mblm(JUN_RR~ Water_Year_Year, K.TSN2)
KM37 <- mblm(JUL_RR~ Water_Year_Year, K.TSN2)
KM38 <- mblm(AUG_RR~ Water_Year_Year, K.TSN2)
KM39 <- mblm(SEP_RR~ Water_Year_Year, K.TSN2)
```
####################################
```{r}
TSR2<- cbind(KM1$coefficients, KM2$coefficients, KM3$coefficients, KM4$coefficients, KM5$coefficients, KM6$coefficients,KM7$coefficients, KM8$coefficients, KM9$coefficients,KM10$coefficients, KM11$coefficients, KM12$coefficients,KM13$coefficients, KM14$coefficients, KM15$coefficients,KM16$coefficients, KM17$coefficients, KM18$coefficients,KM19$coefficients, KM20$coefficients, KM21$coefficients,KM22$coefficients, KM23$coefficients, KM4$coefficients,KM25$coefficients, KM26$coefficients, KM27$coefficients,KM28$coefficients, KM29$coefficients, KM30$coefficients,KM31$coefficients, KM32$coefficients, KM33$coefficients,KM34$coefficients, KM35$coefficients, KM36$coefficients,KM37$coefficients, KM38$coefficients, KM39$coefficients)
RES2 <- cbind(KM1$residuals, KM2$residuals, KM3$residuals, KM4$residuals, KM5$residuals, KM6$residuals,KM7$residuals, KM8$residuals, KM9$residuals,KM10$residuals, KM11$residuals, KM12$residuals,KM13$residuals, KM14$residuals, KM15$residuals,KM16$residuals, KM17$residuals, KM18$residuals,KM19$residuals, KM20$residuals, KM21$residuals,KM22$residuals, KM23$residuals, KM4$residuals,KM25$residuals, KM26$residuals, KM27$residuals,KM28$residuals, KM29$residuals, KM30$residuals,KM31$residuals, KM32$residuals, KM33$residuals,KM34$residuals, KM35$residuals, KM36$residuals,KM37$residuals, KM38$residuals, KM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
K.ALL[nrow(K.ALL)+ 1,] = MKTR2
K.ALL[nrow(K.ALL)+ 1,] = MKPR2
K.ALL[nrow(K.ALL)+ 1,] = TSRR2
K.ALL[nrow(K.ALL)+ 1,] = BTDF2
K.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- K.ALL[21:47,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
K.ALL[nrow(K.ALL)+ 1,] = MMKPR2
K.ALL[nrow(K.ALL)+ 1,] = MMKTR2
K.ALL[nrow(K.ALL)+ 1,] = MMKSR2
K.ALL
```

```{r}
K.ALL
```

```{r}
K.NUM2 <- as.data.frame(apply(K.ALL[1:65,2:40], 2, as.numeric))
str(K.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(K.NUM2[62,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(K.NUM2[61,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(K.NUM2[65,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(K.NUM2[60,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(K.NUM2[63,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
K.ALL[nrow(K.ALL)+ 1,] = FSR12
K.ALL[nrow(K.ALL)+ 1,] = FSR22
K.ALL
```

```{r}
K.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
KFM2 <-K.ALL[c(66,67),-1]
KF2 <- as.matrix(apply(KFM2, 2, as.numeric))
KF2
```

### Landbru Results, csv 'S' ID 18
```{r}
### Summarise by Month
S$StreamflowDay_m3<- S$Streamflow*(60*60*24)
S.MON <- S %>%
   group_by(Year, Month) %>%
   summarise(Month_Streamflow_m3 = sum(StreamflowDay_m3), Month_Precip_mm = sum(Precip))
S.MON$Streamflow_Km<-S.MON$Month_Streamflow_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
S.MON$Streamflow_mm<-(S.MON$Streamflow_Km/150)*1000000 ## monthly runoff depth mm
S.MON2 <- subset(S.MON, Year >= 1969)
#S.MON2
#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
S.MONT<- S.MON2[-c(1,2,3,4,5,6,7,8,9,550,551,552),]
S.MONT
```

```{r}
ST<-GMP2[[946:1485]] #Landbru
SE<-extent(13.5,14,64.5,65) #Landbru Extent
SPC<-crop(ST,SE) #Landbru Crop
S.Mon.Precip.<-extract(SPC,SE, method="bilinear", fun = mean)
SMP<-as.data.frame(colMeans(S.Mon.Precip.)) #Landbru
SSub<-DateTemp[DateTemp$Date >= as.Date("1969-10-01") & DateTemp$Date <=
                    as.Date("2014-09-01"), ] ##Landbru
SPp<- cbind(SMP,SSub) ## Landbru
```

```{r}
S.MONT$GriddedPrecip_mm<- SMP$`colMeans(S.Mon.Precip.)`
S.MONT
```

##############
```{r}
## Water Year Sequencing
S.MT<- S.MONT
S.MT$Water_Year_Month <- rep(seq(1:12),45) #1975 to 2016 is 43 years
S.MT$Water_Year_Year <- rep(1:45, each =12)
S.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 S.WY <- S.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
S.WY
```
##############
```{r}
## Monthly Columns
## Oct
 S.OCT <- S.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 S.NOV <- S.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 S.DEC <- S.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 S.JAN <- S.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 S.FEB <- S.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 S.MAR <- S.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 S.APL <- S.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 S.MAY <- S.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 S.JUN <- S.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 S.JUL <- S.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 S.AUG <- S.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 S.SEP <- S.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
S.ALL <- cbind(S.WY, S.OCT[,-1], S.NOV[,-1], S.DEC[,-1], S.JAN[,-1], S.FEB[,-1], S.MAR[,-1], S.APL[,-1],S.MAY[,-1], S.JUN[,-1], S.JUL[,-1], S.AUG[,-1], S.SEP[,-1])
```
####################
```{r}
S.ALL$AN_RR <- S.ALL$AN_RO_mm/S.ALL$AN_PCP_mm
S.ALL$OCT_RR <- S.ALL$Oct_RO_mm/S.ALL$Oct_PCP_mm
S.ALL$NOV_RR <- S.ALL$Nov_RO_mm/S.ALL$Nov_PCP_mm
S.ALL$DEC_RR <- S.ALL$Dec_RO_mm/S.ALL$Dec_PCP_mm
S.ALL$JAN_RR <- S.ALL$Jan_RO_mm/S.ALL$Jan_PCP_mm
S.ALL$FEB_RR <- S.ALL$Feb_RO_mm/S.ALL$Feb_PCP_mm
S.ALL$MAR_RR <- S.ALL$Mar_RO_mm/S.ALL$Mar_PCP_mm
S.ALL$APL_RR <- S.ALL$Apl_RO_mm/S.ALL$Apl_PCP_mm
S.ALL$MAY_RR <- S.ALL$May_RO_mm/S.ALL$May_PCP_mm
S.ALL$JUN_RR <- S.ALL$Jun_RO_mm/S.ALL$Jun_PCP_mm
S.ALL$JUL_RR <- S.ALL$Jul_RO_mm/S.ALL$Jul_PCP_mm
S.ALL$AUG_RR <- S.ALL$Aug_RO_mm/S.ALL$Aug_PCP_mm
S.ALL$SEP_RR <- S.ALL$Sep_RO_mm/S.ALL$Sep_PCP_mm
S.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(S.ALL[,-1],2, mean))
CSD <- rbind(apply(S.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
S.ALL[nrow(S.ALL)+ 1,] = CML
S.ALL[nrow(S.ALL)+ 1,] = CSDL
S.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(S.ALL[1:45,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
S.TS <-S.ALL[1:45,1:40]
S.TSN <- as.data.frame(apply(S.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(S.TSN, class)   
S.TSN
```
############################################
```{r}
SM1 <- mblm(AN_RO_mm~ Water_Year_Year, S.TSN)
SM2 <- mblm(AN_PCP_mm~ Water_Year_Year, S.TSN)
SM3 <- mblm(Oct_RO_mm~ Water_Year_Year, S.TSN)
SM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, S.TSN)
SM5 <- mblm(Nov_RO_mm~ Water_Year_Year, S.TSN)
SM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, S.TSN)
SM7 <- mblm(Dec_RO_mm~ Water_Year_Year, S.TSN)
SM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, S.TSN)
SM9 <- mblm(Jan_RO_mm~ Water_Year_Year, S.TSN)
SM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, S.TSN)
SM11 <- mblm(Feb_RO_mm~ Water_Year_Year, S.TSN)
SM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, S.TSN)
SM13 <- mblm(Mar_RO_mm~ Water_Year_Year, S.TSN)
SM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, S.TSN)
SM15 <- mblm(Apl_RO_mm~ Water_Year_Year, S.TSN)
SM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, S.TSN)
SM17 <- mblm(May_RO_mm~ Water_Year_Year, S.TSN)
SM18 <- mblm(May_PCP_mm~ Water_Year_Year, S.TSN)
SM19 <- mblm(Jun_RO_mm~ Water_Year_Year, S.TSN)
SM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, S.TSN)
SM21 <- mblm(Jul_RO_mm~ Water_Year_Year, S.TSN)
SM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, S.TSN)
SM23 <- mblm(Aug_RO_mm~ Water_Year_Year, S.TSN)
SM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, S.TSN)
SM25 <- mblm(Sep_RO_mm~ Water_Year_Year, S.TSN)
SM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, S.TSN)
SM27 <- mblm(AN_RR~ Water_Year_Year, S.TSN)
SM28 <- mblm(OCT_RR~ Water_Year_Year, S.TSN)
SM29 <- mblm(NOV_RR~ Water_Year_Year, S.TSN)
SM30 <- mblm(DEC_RR~ Water_Year_Year, S.TSN)
SM31 <- mblm(JAN_RR~ Water_Year_Year, S.TSN)
SM32 <- mblm(FEB_RR~ Water_Year_Year, S.TSN)
SM33 <- mblm(MAR_RR~ Water_Year_Year, S.TSN)
SM34 <- mblm(APL_RR~ Water_Year_Year, S.TSN)
SM35 <- mblm(MAY_RR~ Water_Year_Year, S.TSN)
SM36 <- mblm(JUN_RR~ Water_Year_Year, S.TSN)
SM37 <- mblm(JUL_RR~ Water_Year_Year, S.TSN)
SM38 <- mblm(AUG_RR~ Water_Year_Year, S.TSN)
SM39 <- mblm(SEP_RR~ Water_Year_Year, S.TSN)
```
####################################
```{r}
TSR<- cbind(SM1$coefficients, SM2$coefficients, SM3$coefficients, SM4$coefficients, SM5$coefficients, SM6$coefficients,SM7$coefficients, SM8$coefficients, SM9$coefficients,SM10$coefficients, SM11$coefficients, SM12$coefficients,SM13$coefficients, SM14$coefficients, SM15$coefficients,SM16$coefficients, SM17$coefficients, SM18$coefficients,SM19$coefficients, SM20$coefficients, SM21$coefficients,SM22$coefficients, SM23$coefficients, SM4$coefficients,SM25$coefficients, SM26$coefficients, SM27$coefficients,SM28$coefficients, SM29$coefficients, SM30$coefficients,SM31$coefficients, SM32$coefficients, SM33$coefficients,SM34$coefficients, SM35$coefficients, SM36$coefficients,SM37$coefficients, SM38$coefficients, SM39$coefficients)
RES <- cbind(SM1$residuals, SM2$residuals, SM3$residuals, SM4$residuals, SM5$residuals, SM6$residuals,SM7$residuals, SM8$residuals, SM9$residuals,SM10$residuals, SM11$residuals, SM12$residuals,SM13$residuals, SM14$residuals, SM15$residuals,SM16$residuals, SM17$residuals, SM18$residuals,SM19$residuals, SM20$residuals, SM21$residuals,SM22$residuals, SM23$residuals, SM4$residuals,SM25$residuals, SM26$residuals, SM27$residuals,SM28$residuals, SM29$residuals, SM30$residuals,SM31$residuals, SM32$residuals, SM33$residuals,SM34$residuals, SM35$residuals, SM36$residuals,SM37$residuals, SM38$residuals, SM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
S.ALL[nrow(S.ALL)+ 1,] = MKTR
S.ALL[nrow(S.ALL)+ 1,] = MKPR
S.ALL[nrow(S.ALL)+ 1,] = TSRR
S.ALL[nrow(S.ALL)+ 1,] = BTDF
S.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- S.ALL[1:45,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
S.ALL[nrow(S.ALL)+ 1,] = MMKPR
S.ALL[nrow(S.ALL)+ 1,] = MMKTR
S.ALL[nrow(S.ALL)+ 1,] = MMKSR
S.ALL
```

```{r}
S.NUM <- as.data.frame(apply(S.ALL[1:54,2:40], 2, as.numeric))
str(S.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(S.NUM[51,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(S.NUM[50,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(S.NUM[54,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(S.NUM[49,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(S.NUM[52,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
S.ALL[nrow(S.ALL)+ 1,] = FSR1
S.ALL[nrow(S.ALL)+ 1,] = FSR2
S.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
SFM <-S.ALL[c(55,56),-1]
SF <- as.matrix(apply(SFM, 2, as.numeric))
SF
```
###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(S.ALL[21:45,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
S.TS2 <-S.ALL[21:45,1:40] ## 1990 Subset
S.TSN2 <- as.data.frame(apply(S.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(S.TSN2, class)   
S.TSN2
```
############################################
```{r}
SM1 <- mblm(AN_RO_mm~ Water_Year_Year, S.TSN2)
SM2 <- mblm(AN_PCP_mm~ Water_Year_Year, S.TSN2)
SM3 <- mblm(Oct_RO_mm~ Water_Year_Year, S.TSN2)
SM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, S.TSN2)
SM5 <- mblm(Nov_RO_mm~ Water_Year_Year, S.TSN2)
SM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, S.TSN2)
SM7 <- mblm(Dec_RO_mm~ Water_Year_Year, S.TSN2)
SM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, S.TSN2)
SM9 <- mblm(Jan_RO_mm~ Water_Year_Year, S.TSN2)
SM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, S.TSN2)
SM11 <- mblm(Feb_RO_mm~ Water_Year_Year, S.TSN2)
SM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, S.TSN2)
SM13 <- mblm(Mar_RO_mm~ Water_Year_Year, S.TSN2)
SM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, S.TSN2)
SM15 <- mblm(Apl_RO_mm~ Water_Year_Year, S.TSN2)
SM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, S.TSN2)
SM17 <- mblm(May_RO_mm~ Water_Year_Year, S.TSN2)
SM18 <- mblm(May_PCP_mm~ Water_Year_Year, S.TSN2)
SM19 <- mblm(Jun_RO_mm~ Water_Year_Year, S.TSN2)
SM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, S.TSN2)
SM21 <- mblm(Jul_RO_mm~ Water_Year_Year, S.TSN2)
SM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, S.TSN2)
SM23 <- mblm(Aug_RO_mm~ Water_Year_Year, S.TSN2)
SM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, S.TSN2)
SM25 <- mblm(Sep_RO_mm~ Water_Year_Year, S.TSN2)
SM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, S.TSN2)
SM27 <- mblm(AN_RR~ Water_Year_Year, S.TSN2)
SM28 <- mblm(OCT_RR~ Water_Year_Year, S.TSN2)
SM29 <- mblm(NOV_RR~ Water_Year_Year, S.TSN2)
SM30 <- mblm(DEC_RR~ Water_Year_Year, S.TSN2)
SM31 <- mblm(JAN_RR~ Water_Year_Year, S.TSN2)
SM32 <- mblm(FEB_RR~ Water_Year_Year, S.TSN2)
SM33 <- mblm(MAR_RR~ Water_Year_Year, S.TSN2)
SM34 <- mblm(APL_RR~ Water_Year_Year, S.TSN2)
SM35 <- mblm(MAY_RR~ Water_Year_Year, S.TSN2)
SM36 <- mblm(JUN_RR~ Water_Year_Year, S.TSN2)
SM37 <- mblm(JUL_RR~ Water_Year_Year, S.TSN2)
SM38 <- mblm(AUG_RR~ Water_Year_Year, S.TSN2)
SM39 <- mblm(SEP_RR~ Water_Year_Year, S.TSN2)
```
####################################
```{r}
TSR2<- cbind(SM1$coefficients, SM2$coefficients, SM3$coefficients, SM4$coefficients, SM5$coefficients, SM6$coefficients,SM7$coefficients, SM8$coefficients, SM9$coefficients,SM10$coefficients, SM11$coefficients, SM12$coefficients,SM13$coefficients, SM14$coefficients, SM15$coefficients,SM16$coefficients, SM17$coefficients, SM18$coefficients,SM19$coefficients, SM20$coefficients, SM21$coefficients,SM22$coefficients, SM23$coefficients, SM4$coefficients,SM25$coefficients, SM26$coefficients, SM27$coefficients,SM28$coefficients, SM29$coefficients, SM30$coefficients,SM31$coefficients, SM32$coefficients, SM33$coefficients,SM34$coefficients, SM35$coefficients, SM36$coefficients,SM37$coefficients, SM38$coefficients, SM39$coefficients)
RES2 <- cbind(SM1$residuals, SM2$residuals, SM3$residuals, SM4$residuals, SM5$residuals, SM6$residuals,SM7$residuals, SM8$residuals, SM9$residuals,SM10$residuals, SM11$residuals, SM12$residuals,SM13$residuals, SM14$residuals, SM15$residuals,SM16$residuals, SM17$residuals, SM18$residuals,SM19$residuals, SM20$residuals, SM21$residuals,SM22$residuals, SM23$residuals, SM4$residuals,SM25$residuals, SM26$residuals, SM27$residuals,SM28$residuals, SM29$residuals, SM30$residuals,SM31$residuals, SM32$residuals, SM33$residuals,SM34$residuals, SM35$residuals, SM36$residuals,SM37$residuals, SM38$residuals, SM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
S.ALL[nrow(S.ALL)+ 1,] = MKTR2
S.ALL[nrow(S.ALL)+ 1,] = MKPR2
S.ALL[nrow(S.ALL)+ 1,] = TSRR2
S.ALL[nrow(S.ALL)+ 1,] = BTDF2
S.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- S.ALL[21:45,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
S.ALL[nrow(S.ALL)+ 1,] = MMKPR2
S.ALL[nrow(S.ALL)+ 1,] = MMKTR2
S.ALL[nrow(S.ALL)+ 1,] = MMKSR2
S.ALL
```

```{r}
S.ALL
```

```{r}
S.NUM2 <- as.data.frame(apply(S.ALL[1:63,2:40], 2, as.numeric))
str(S.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(S.NUM2[60,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(S.NUM2[59,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(S.NUM2[63,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(S.NUM2[58,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(S.NUM2[61,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
S.ALL[nrow(S.ALL)+ 1,] = FSR12
S.ALL[nrow(S.ALL)+ 1,] = FSR22
S.ALL
```

```{r}
S.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
SFM2 <-S.ALL[c(64,65),-1]
SF2 <- as.matrix(apply(SFM2, 2, as.numeric))
SF2
```


### Stuorraluoppal Results, csv 'BN' ID 19
```{r}
### Summarise by Month
BN$StreamflowDay_m3<- BN$Streamflow*(60*60*24)
BN.MON <- BN %>%
   group_by(Year, Month) %>%
   summarise(Month_Streamflow_m3 = sum(StreamflowDay_m3))
BN.MON$Streamflow_Km<-BN.MON$Month_Streamflow_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
BN.MON$Streamflow_mm<-(BN.MON$Streamflow_Km/1520)*1000000 ## monthly runoff depth mm
BN.MON2 <- subset(BN.MON, Year >= 1969)
#BN.MON2
#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
BN.MONT<- BN.MON2[-c(1,2,3,4,5,6,7,8,9,574,575,576),]
BN.MONT
```

```{r}
BNT <-  GMP2[[946:1509]] ## Tana (Utsjoki)
BNE <- extent(26,28.8,69.5,70) ## Tana (Utsjoki) 
BNPC <- crop(BNT, BNE) ## Utsjoki
BN.Mon.Precip.<-extract(BNPC,BNE, method="bilinear", fun = mean)
BNMP<-as.data.frame(colMeans(BN.Mon.Precip.)) # Utsjoki
BNSub<-DateTemp[DateTemp$Date >= as.Date("1969-10-01") & DateTemp$Date <=
                    as.Date("2016-09-01"), ] ##Utsjoki
BNPp<- cbind(BNMP,BNSub) ## Utsjoki

```

```{r}
BN.6 <- subset(BN.MONT, Month == 6)
BN.7 <- subset(BN.MONT, Month == 7)
BN.8 <- subset(BN.MONT, Month == 8)
BN.MONT[c(561),5] <- mean(BN.6$Streamflow_mm, na.rm = TRUE) 
BN.MONT[c(562),5] <- mean(BN.7$Streamflow_mm, na.rm = TRUE) 
BN.MONT[c(563),5] <- mean(BN.8$Streamflow_mm, na.rm = TRUE) 
```

```{r}
BN.MONT$GriddedPrecip_mm<- BNMP$`colMeans(BN.Mon.Precip.)`
BN.MONT
```

##############
```{r}
## Water Year Sequencing
BN.MT<- BN.MONT
BN.MT$Water_Year_Month <- rep(seq(1:12),47) #1975 to 2016 is 43 years
BN.MT$Water_Year_Year <- rep(1:47, each =12)
BN.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 BN.WY <- BN.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
BN.WY
```
##############
```{r}
## Monthly Columns
## Oct
 BN.OCT <- BN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 BN.NOV <- BN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 BN.DEC <- BN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 BN.JAN <- BN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 BN.FEB <- BN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 BN.MAR <- BN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 BN.APL <- BN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 BN.MAY <- BN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 BN.JUN <- BN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 BN.JUL <- BN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 BN.AUG <- BN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 BN.SEP <- BN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
BN.ALL <- cbind(BN.WY, BN.OCT[,-1], BN.NOV[,-1], BN.DEC[,-1], BN.JAN[,-1], BN.FEB[,-1], BN.MAR[,-1], BN.APL[,-1],BN.MAY[,-1], BN.JUN[,-1], BN.JUL[,-1], BN.AUG[,-1], BN.SEP[,-1])
```
####################
```{r}
BN.ALL$AN_RR <- BN.ALL$AN_RO_mm/BN.ALL$AN_PCP_mm
BN.ALL$OCT_RR <- BN.ALL$Oct_RO_mm/BN.ALL$Oct_PCP_mm
BN.ALL$NOV_RR <- BN.ALL$Nov_RO_mm/BN.ALL$Nov_PCP_mm
BN.ALL$DEC_RR <- BN.ALL$Dec_RO_mm/BN.ALL$Dec_PCP_mm
BN.ALL$JAN_RR <- BN.ALL$Jan_RO_mm/BN.ALL$Jan_PCP_mm
BN.ALL$FEB_RR <- BN.ALL$Feb_RO_mm/BN.ALL$Feb_PCP_mm
BN.ALL$MAR_RR <- BN.ALL$Mar_RO_mm/BN.ALL$Mar_PCP_mm
BN.ALL$APL_RR <- BN.ALL$Apl_RO_mm/BN.ALL$Apl_PCP_mm
BN.ALL$MAY_RR <- BN.ALL$May_RO_mm/BN.ALL$May_PCP_mm
BN.ALL$JUN_RR <- BN.ALL$Jun_RO_mm/BN.ALL$Jun_PCP_mm
BN.ALL$JUL_RR <- BN.ALL$Jul_RO_mm/BN.ALL$Jul_PCP_mm
BN.ALL$AUG_RR <- BN.ALL$Aug_RO_mm/BN.ALL$Aug_PCP_mm
BN.ALL$SEP_RR <- BN.ALL$Sep_RO_mm/BN.ALL$Sep_PCP_mm
BN.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(BN.ALL[,-1],2, mean))
CSD <- rbind(apply(BN.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
BN.ALL[nrow(BN.ALL)+ 1,] = CML
BN.ALL[nrow(BN.ALL)+ 1,] = CSDL
BN.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(BN.ALL[1:47,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
BN.TS <-BN.ALL[1:47,1:40]
BN.TSN <- as.data.frame(apply(BN.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(BN.TSN, class)   
BN.TSN
```
############################################
```{r}
BNM1 <- mblm(AN_RO_mm~ Water_Year_Year, BN.TSN)
BNM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BN.TSN)
BNM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BN.TSN)
BNM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BN.TSN)
BNM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BN.TSN)
BNM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BN.TSN)
BNM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BN.TSN)
BNM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BN.TSN)
BNM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BN.TSN)
BNM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BN.TSN)
BNM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BN.TSN)
BNM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BN.TSN)
BNM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BN.TSN)
BNM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BN.TSN)
BNM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BN.TSN)
BNM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BN.TSN)
BNM17 <- mblm(May_RO_mm~ Water_Year_Year, BN.TSN)
BNM18 <- mblm(May_PCP_mm~ Water_Year_Year, BN.TSN)
BNM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BN.TSN)
BNM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BN.TSN)
BNM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BN.TSN)
BNM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BN.TSN)
BNM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BN.TSN)
BNM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BN.TSN)
BNM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BN.TSN)
BNM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BN.TSN)
BNM27 <- mblm(AN_RR~ Water_Year_Year, BN.TSN)
BNM28 <- mblm(OCT_RR~ Water_Year_Year, BN.TSN)
BNM29 <- mblm(NOV_RR~ Water_Year_Year, BN.TSN)
BNM30 <- mblm(DEC_RR~ Water_Year_Year, BN.TSN)
BNM31 <- mblm(JAN_RR~ Water_Year_Year, BN.TSN)
BNM32 <- mblm(FEB_RR~ Water_Year_Year, BN.TSN)
BNM33 <- mblm(MAR_RR~ Water_Year_Year, BN.TSN)
BNM34 <- mblm(APL_RR~ Water_Year_Year, BN.TSN)
BNM35 <- mblm(MAY_RR~ Water_Year_Year, BN.TSN)
BNM36 <- mblm(JUN_RR~ Water_Year_Year, BN.TSN)
BNM37 <- mblm(JUL_RR~ Water_Year_Year, BN.TSN)
BNM38 <- mblm(AUG_RR~ Water_Year_Year, BN.TSN)
BNM39 <- mblm(SEP_RR~ Water_Year_Year, BN.TSN)
```
####################################
```{r}
TSR<- cbind(BNM1$coefficients, BNM2$coefficients, BNM3$coefficients, BNM4$coefficients, BNM5$coefficients, BNM6$coefficients,BNM7$coefficients, BNM8$coefficients, BNM9$coefficients,BNM10$coefficients, BNM11$coefficients, BNM12$coefficients,BNM13$coefficients, BNM14$coefficients, BNM15$coefficients,BNM16$coefficients, BNM17$coefficients, BNM18$coefficients,BNM19$coefficients, BNM20$coefficients, BNM21$coefficients,BNM22$coefficients, BNM23$coefficients, BNM4$coefficients,BNM25$coefficients, BNM26$coefficients, BNM27$coefficients,BNM28$coefficients, BNM29$coefficients, BNM30$coefficients,BNM31$coefficients, BNM32$coefficients, BNM33$coefficients,BNM34$coefficients, BNM35$coefficients, BNM36$coefficients,BNM37$coefficients, BNM38$coefficients, BNM39$coefficients)
RES <- cbind(BNM1$residuals, BNM2$residuals, BNM3$residuals, BNM4$residuals, BNM5$residuals, BNM6$residuals,BNM7$residuals, BNM8$residuals, BNM9$residuals,BNM10$residuals, BNM11$residuals, BNM12$residuals,BNM13$residuals, BNM14$residuals, BNM15$residuals,BNM16$residuals, BNM17$residuals, BNM18$residuals,BNM19$residuals, BNM20$residuals, BNM21$residuals,BNM22$residuals, BNM23$residuals, BNM4$residuals,BNM25$residuals, BNM26$residuals, BNM27$residuals,BNM28$residuals, BNM29$residuals, BNM30$residuals,BNM31$residuals, BNM32$residuals, BNM33$residuals,BNM34$residuals, BNM35$residuals, BNM36$residuals,BNM37$residuals, BNM38$residuals, BNM39$residuals)
```
####################################
```{r}
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BN.ALL[nrow(BN.ALL)+ 1,] = MKTR
BN.ALL[nrow(BN.ALL)+ 1,] = MKPR
BN.ALL[nrow(BN.ALL)+ 1,] = TSRR
BN.ALL[nrow(BN.ALL)+ 1,] = BTDF
BN.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- BN.ALL[1:47,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
BN.ALL[nrow(BN.ALL)+ 1,] = MMKPR
BN.ALL[nrow(BN.ALL)+ 1,] = MMKTR
BN.ALL[nrow(BN.ALL)+ 1,] = MMKSR
BN.ALL
```

```{r}
BN.NUM <- as.data.frame(apply(BN.ALL[1:56,2:40], 2, as.numeric))
str(BN.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(BN.NUM[53,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(BN.NUM[52,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(BN.NUM[56,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(BN.NUM[51,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(BN.NUM[54,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
BN.ALL[nrow(BN.ALL)+ 1,] = FSR1
BN.ALL[nrow(BN.ALL)+ 1,] = FSR2
BN.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
BNFM <-BN.ALL[c(57,58),-1]
BNF <- as.matrix(apply(BNFM, 2, as.numeric))
BNF
```
###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(BN.ALL[21:47,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
BN.TS2 <-BN.ALL[21:47,1:40] ## 1990 Subset
BN.TSN2 <- as.data.frame(apply(BN.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(BN.TSN2, class)   
BN.TSN2
```
############################################
```{r}
BNM1 <- mblm(AN_RO_mm~ Water_Year_Year, BN.TSN2)
BNM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BN.TSN2)
BNM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BN.TSN2)
BNM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BN.TSN2)
BNM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BN.TSN2)
BNM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BN.TSN2)
BNM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BN.TSN2)
BNM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BN.TSN2)
BNM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BN.TSN2)
BNM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BN.TSN2)
BNM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BN.TSN2)
BNM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BN.TSN2)
BNM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BN.TSN2)
BNM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BN.TSN2)
BNM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BN.TSN2)
BNM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BN.TSN2)
BNM17 <- mblm(May_RO_mm~ Water_Year_Year, BN.TSN2)
BNM18 <- mblm(May_PCP_mm~ Water_Year_Year, BN.TSN2)
BNM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BN.TSN2)
BNM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BN.TSN2)
BNM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BN.TSN2)
BNM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BN.TSN2)
BNM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BN.TSN2)
BNM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BN.TSN2)
BNM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BN.TSN2)
BNM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BN.TSN2)
BNM27 <- mblm(AN_RR~ Water_Year_Year, BN.TSN2)
BNM28 <- mblm(OCT_RR~ Water_Year_Year, BN.TSN2)
BNM29 <- mblm(NOV_RR~ Water_Year_Year, BN.TSN2)
BNM30 <- mblm(DEC_RR~ Water_Year_Year, BN.TSN2)
BNM31 <- mblm(JAN_RR~ Water_Year_Year, BN.TSN2)
BNM32 <- mblm(FEB_RR~ Water_Year_Year, BN.TSN2)
BNM33 <- mblm(MAR_RR~ Water_Year_Year, BN.TSN2)
BNM34 <- mblm(APL_RR~ Water_Year_Year, BN.TSN2)
BNM35 <- mblm(MAY_RR~ Water_Year_Year, BN.TSN2)
BNM36 <- mblm(JUN_RR~ Water_Year_Year, BN.TSN2)
BNM37 <- mblm(JUL_RR~ Water_Year_Year, BN.TSN2)
BNM38 <- mblm(AUG_RR~ Water_Year_Year, BN.TSN2)
BNM39 <- mblm(SEP_RR~ Water_Year_Year, BN.TSN2)
```
####################################
```{r}
TSR2<- cbind(BNM1$coefficients, BNM2$coefficients, BNM3$coefficients, BNM4$coefficients, BNM5$coefficients, BNM6$coefficients,BNM7$coefficients, BNM8$coefficients, BNM9$coefficients,BNM10$coefficients, BNM11$coefficients, BNM12$coefficients,BNM13$coefficients, BNM14$coefficients, BNM15$coefficients,BNM16$coefficients, BNM17$coefficients, BNM18$coefficients,BNM19$coefficients, BNM20$coefficients, BNM21$coefficients,BNM22$coefficients, BNM23$coefficients, BNM4$coefficients,BNM25$coefficients, BNM26$coefficients, BNM27$coefficients,BNM28$coefficients, BNM29$coefficients, BNM30$coefficients,BNM31$coefficients, BNM32$coefficients, BNM33$coefficients,BNM34$coefficients, BNM35$coefficients, BNM36$coefficients,BNM37$coefficients, BNM38$coefficients, BNM39$coefficients)
RES2 <- cbind(BNM1$residuals, BNM2$residuals, BNM3$residuals, BNM4$residuals, BNM5$residuals, BNM6$residuals,BNM7$residuals, BNM8$residuals, BNM9$residuals,BNM10$residuals, BNM11$residuals, BNM12$residuals,BNM13$residuals, BNM14$residuals, BNM15$residuals,BNM16$residuals, BNM17$residuals, BNM18$residuals,BNM19$residuals, BNM20$residuals, BNM21$residuals,BNM22$residuals, BNM23$residuals, BNM4$residuals,BNM25$residuals, BNM26$residuals, BNM27$residuals,BNM28$residuals, BNM29$residuals, BNM30$residuals,BNM31$residuals, BNM32$residuals, BNM33$residuals,BNM34$residuals, BNM35$residuals, BNM36$residuals,BNM37$residuals, BNM38$residuals, BNM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BN.ALL[nrow(BN.ALL)+ 1,] = MKTR2
BN.ALL[nrow(BN.ALL)+ 1,] = MKPR2
BN.ALL[nrow(BN.ALL)+ 1,] = TSRR2
BN.ALL[nrow(BN.ALL)+ 1,] = BTDF2
BN.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- BN.ALL[21:47,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
BN.ALL[nrow(BN.ALL)+ 1,] = MMKPR2
BN.ALL[nrow(BN.ALL)+ 1,] = MMKTR2
BN.ALL[nrow(BN.ALL)+ 1,] = MMKSR2
BN.ALL
```

```{r}
BN.ALL
```

```{r}
BN.NUM2 <- as.data.frame(apply(BN.ALL[1:65,2:40], 2, as.numeric))
str(BN.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(BN.NUM2[62,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(BN.NUM2[61,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(BN.NUM2[65,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(BN.NUM2[60,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(BN.NUM2[63,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
BN.ALL[nrow(BN.ALL)+ 1,] = FSR12
BN.ALL[nrow(BN.ALL)+ 1,] = FSR22
BN.ALL
```

```{r}
BN.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
BNFM2 <-BN.ALL[c(66,67),-1]
BNF2 <- as.matrix(apply(BNFM2, 2, as.numeric))
BNF2
```

### Vaehaeaskanjoki Results, csv 'AJ' ID 20
```{r}
### Summarise by Month
AJ$StreamflowDay_m3<- AJ$Streamflow*(60*60*24)
AJ.MON <- AJ %>%
   group_by(Year, Month) %>%
   summarise(Month_Streamflow_m3 = sum(StreamflowDay_m3), Month_Precip_mm = sum(Precip))
AJ.MON$Streamflow_Km<-AJ.MON$Month_Streamflow_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
AJ.MON$Streamflow_mm<-(AJ.MON$Streamflow_Km/16.4)*1000000 ## monthly runoff depth mm
AJ.MON2<- subset(AJ.MON, Year >=1969)
AJ.MON2
```

```{r}
AJ.MONT <- AJ.MON2[-c(1,2,3,4,5,6,7,8,9,562,563,564),]
AJ.MONT
```


```{r}
## Gap filling process
AJA <- subset(AJ.MONT, Month == 4)
AJM <- subset(AJ.MONT, Month == 5)
AJJ <- subset(AJ.MONT, Month == 6)
AJY <- subset(AJ.MONT, Month == 7)
AJO <- subset(AJ.MONT, Month == 10)
AJN <- subset(AJ.MONT, Month == 11)
AJD <- subset(AJ.MONT, Month == 12)
AJ.4 <- mean(AJA$Streamflow_mm, na.rm = TRUE)
AJ.5 <- mean(AJM$Streamflow_mm, na.rm = TRUE)
AJ.6 <- mean(AJJ$Streamflow_mm, na.rm = TRUE)
AJ.10 <-mean(AJO$Streamflow_mm, na.rm = TRUE)
AJ.7 <- mean(AJY$Streamflow_mm, na.rm = TRUE)
AJ.8 <- mean(AJN$Streamflow_mm, na.rm = TRUE)
AJ.9 <- mean(AJD$Streamflow_mm, na.rm = TRUE)
AJ.MONT[295,6] <- AJ.4
AJ.MONT[296,6] <- AJ.5
AJ.MONT[297,6] <- AJ.6
AJ.MONT[61,6] <- AJ.7
AJ.MONT[62,6] <- AJ.8
AJ.MONT[63,6] <- AJ.9
AJ.MONT[298,6] <- AJ.10
AJ.MONT
```


```{r}
AJT<-GMP2[[946:1497]] #Vaehaeaskanjoki
AJE<-extent(28,28.5,66,66.5) #Vaehaeaskanjoki Extent
AJPC<-crop(AJT,AJE) #Vaehaeaskanjoki Crop
AJ.Mon.Precip.<-extract(AJPC,AJE, method="bilinear", fun = mean)
AJMP<-as.data.frame(colMeans(AJ.Mon.Precip.)) #Vaehaeaskanjoki
AJSub<-DateTemp[DateTemp$Date >= as.Date("1969-10-01") & DateTemp$Date <=
                    as.Date("2015-09-01"), ] ##Vaehaeaskanjoki
AJPp<- cbind(AJMP,AJSub) ## Vaehaeaskanjoki
```

```{r}
AJ.MONT$GriddedPrecip_mm<- AJMP$`colMeans(AJ.Mon.Precip.)`
AJ.MONT
```

##############
```{r}
## Water Year Sequencing
AJ.MT<- AJ.MONT
AJ.MT$Water_Year_Month <- rep(seq(1:12),46) #1975 to 2016 is 43 years
AJ.MT$Water_Year_Year <- rep(1:46, each =12)
AJ.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 AJ.WY <- AJ.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
AJ.WY
```
##############
```{r}
## Monthly Columns
## Oct
 AJ.OCT <- AJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 AJ.NOV <- AJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 AJ.DEC <- AJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 AJ.JAN <- AJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 AJ.FEB <- AJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 AJ.MAR <- AJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 AJ.APL <- AJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 AJ.MAY <- AJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 AJ.JUN <- AJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 AJ.JUL <- AJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 AJ.AUG <- AJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 AJ.SEP <- AJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
AJ.ALL <- cbind(AJ.WY, AJ.OCT[,-1], AJ.NOV[,-1], AJ.DEC[,-1], AJ.JAN[,-1], AJ.FEB[,-1], AJ.MAR[,-1], AJ.APL[,-1],AJ.MAY[,-1], AJ.JUN[,-1], AJ.JUL[,-1], AJ.AUG[,-1], AJ.SEP[,-1])
```
####################
```{r}
AJ.ALL$AN_RR <- AJ.ALL$AN_RO_mm/AJ.ALL$AN_PCP_mm
AJ.ALL$OCT_RR <- AJ.ALL$Oct_RO_mm/AJ.ALL$Oct_PCP_mm
AJ.ALL$NOV_RR <- AJ.ALL$Nov_RO_mm/AJ.ALL$Nov_PCP_mm
AJ.ALL$DEC_RR <- AJ.ALL$Dec_RO_mm/AJ.ALL$Dec_PCP_mm
AJ.ALL$JAN_RR <- AJ.ALL$Jan_RO_mm/AJ.ALL$Jan_PCP_mm
AJ.ALL$FEB_RR <- AJ.ALL$Feb_RO_mm/AJ.ALL$Feb_PCP_mm
AJ.ALL$MAR_RR <- AJ.ALL$Mar_RO_mm/AJ.ALL$Mar_PCP_mm
AJ.ALL$APL_RR <- AJ.ALL$Apl_RO_mm/AJ.ALL$Apl_PCP_mm
AJ.ALL$MAY_RR <- AJ.ALL$May_RO_mm/AJ.ALL$May_PCP_mm
AJ.ALL$JUN_RR <- AJ.ALL$Jun_RO_mm/AJ.ALL$Jun_PCP_mm
AJ.ALL$JUL_RR <- AJ.ALL$Jul_RO_mm/AJ.ALL$Jul_PCP_mm
AJ.ALL$AUG_RR <- AJ.ALL$Aug_RO_mm/AJ.ALL$Aug_PCP_mm
AJ.ALL$SEP_RR <- AJ.ALL$Sep_RO_mm/AJ.ALL$Sep_PCP_mm
AJ.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(AJ.ALL[,-1],2, mean))
CSD <- rbind(apply(AJ.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
AJ.ALL[nrow(AJ.ALL)+ 1,] = CML
AJ.ALL[nrow(AJ.ALL)+ 1,] = CSDL
AJ.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(AJ.ALL[1:46,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
AJ.TS <-AJ.ALL[1:46,1:40]
AJ.TSN <- as.data.frame(apply(AJ.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(AJ.TSN, class)   
AJ.TSN
```
############################################
```{r}
AJM1 <- mblm(AN_RO_mm~ Water_Year_Year, AJ.TSN)
AJM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AJ.TSN)
AJM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AJ.TSN)
AJM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AJ.TSN)
AJM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AJ.TSN)
AJM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AJ.TSN)
AJM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AJ.TSN)
AJM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AJ.TSN)
AJM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AJ.TSN)
AJM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AJ.TSN)
AJM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AJ.TSN)
AJM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AJ.TSN)
AJM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AJ.TSN)
AJM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AJ.TSN)
AJM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AJ.TSN)
AJM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AJ.TSN)
AJM17 <- mblm(May_RO_mm~ Water_Year_Year, AJ.TSN)
AJM18 <- mblm(May_PCP_mm~ Water_Year_Year, AJ.TSN)
AJM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AJ.TSN)
AJM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AJ.TSN)
AJM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AJ.TSN)
AJM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AJ.TSN)
AJM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AJ.TSN)
AJM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AJ.TSN)
AJM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AJ.TSN)
AJM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AJ.TSN)
AJM27 <- mblm(AN_RR~ Water_Year_Year, AJ.TSN)
AJM28 <- mblm(OCT_RR~ Water_Year_Year, AJ.TSN)
AJM29 <- mblm(NOV_RR~ Water_Year_Year, AJ.TSN)
AJM30 <- mblm(DEC_RR~ Water_Year_Year, AJ.TSN)
AJM31 <- mblm(JAN_RR~ Water_Year_Year, AJ.TSN)
AJM32 <- mblm(FEB_RR~ Water_Year_Year, AJ.TSN)
AJM33 <- mblm(MAR_RR~ Water_Year_Year, AJ.TSN)
AJM34 <- mblm(APL_RR~ Water_Year_Year, AJ.TSN)
AJM35 <- mblm(MAY_RR~ Water_Year_Year, AJ.TSN)
AJM36 <- mblm(JUN_RR~ Water_Year_Year, AJ.TSN)
AJM37 <- mblm(JUL_RR~ Water_Year_Year, AJ.TSN)
AJM38 <- mblm(AUG_RR~ Water_Year_Year, AJ.TSN)
AJM39 <- mblm(SEP_RR~ Water_Year_Year, AJ.TSN)
```
####################################
```{r}
TSR<- cbind(AJM1$coefficients, AJM2$coefficients, AJM3$coefficients, AJM4$coefficients, AJM5$coefficients, AJM6$coefficients,AJM7$coefficients, AJM8$coefficients, AJM9$coefficients,AJM10$coefficients, AJM11$coefficients, AJM12$coefficients,AJM13$coefficients, AJM14$coefficients, AJM15$coefficients,AJM16$coefficients, AJM17$coefficients, AJM18$coefficients,AJM19$coefficients, AJM20$coefficients, AJM21$coefficients,AJM22$coefficients, AJM23$coefficients, AJM4$coefficients,AJM25$coefficients, AJM26$coefficients, AJM27$coefficients,AJM28$coefficients, AJM29$coefficients, AJM30$coefficients,AJM31$coefficients, AJM32$coefficients, AJM33$coefficients,AJM34$coefficients, AJM35$coefficients, AJM36$coefficients,AJM37$coefficients, AJM38$coefficients, AJM39$coefficients)
RES <- cbind(AJM1$residuals, AJM2$residuals, AJM3$residuals, AJM4$residuals, AJM5$residuals, AJM6$residuals,AJM7$residuals, AJM8$residuals, AJM9$residuals,AJM10$residuals, AJM11$residuals, AJM12$residuals,AJM13$residuals, AJM14$residuals, AJM15$residuals,AJM16$residuals, AJM17$residuals, AJM18$residuals,AJM19$residuals, AJM20$residuals, AJM21$residuals,AJM22$residuals, AJM23$residuals, AJM4$residuals,AJM25$residuals, AJM26$residuals, AJM27$residuals,AJM28$residuals, AJM29$residuals, AJM30$residuals,AJM31$residuals, AJM32$residuals, AJM33$residuals,AJM34$residuals, AJM35$residuals, AJM36$residuals,AJM37$residuals, AJM38$residuals, AJM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AJ.ALL[nrow(AJ.ALL)+ 1,] = MKTR
AJ.ALL[nrow(AJ.ALL)+ 1,] = MKPR
AJ.ALL[nrow(AJ.ALL)+ 1,] = TSRR
AJ.ALL[nrow(AJ.ALL)+ 1,] = BTDF
AJ.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- AJ.ALL[1:46,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
AJ.ALL[nrow(AJ.ALL)+ 1,] = MMKPR
AJ.ALL[nrow(AJ.ALL)+ 1,] = MMKTR
AJ.ALL[nrow(AJ.ALL)+ 1,] = MMKSR
AJ.ALL
```

```{r}
AJ.NUM <- as.data.frame(apply(AJ.ALL[1:55,2:40], 2, as.numeric))
str(AJ.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(AJ.NUM[52,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(AJ.NUM[51,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(AJ.NUM[55,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(AJ.NUM[50,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(AJ.NUM[53,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
AJ.ALL[nrow(AJ.ALL)+ 1,] = FSR1
AJ.ALL[nrow(AJ.ALL)+ 1,] = FSR2
AJ.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
AJFM <-AJ.ALL[c(56,57),-1]
AJF <- as.matrix(apply(AJFM, 2, as.numeric))
AJF
```
###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(AJ.ALL[21:46,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
AJ.TS2 <-AJ.ALL[21:46,1:40] ## 1990 Subset
AJ.TSN2 <- as.data.frame(apply(AJ.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(AJ.TSN2, class)   
AJ.TSN2
```
############################################
```{r}
AJM1 <- mblm(AN_RO_mm~ Water_Year_Year, AJ.TSN2)
AJM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AJ.TSN2)
AJM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AJ.TSN2)
AJM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AJ.TSN2)
AJM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AJ.TSN2)
AJM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AJ.TSN2)
AJM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AJ.TSN2)
AJM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AJ.TSN2)
AJM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AJ.TSN2)
AJM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AJ.TSN2)
AJM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AJ.TSN2)
AJM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AJ.TSN2)
AJM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AJ.TSN2)
AJM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AJ.TSN2)
AJM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AJ.TSN2)
AJM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AJ.TSN2)
AJM17 <- mblm(May_RO_mm~ Water_Year_Year, AJ.TSN2)
AJM18 <- mblm(May_PCP_mm~ Water_Year_Year, AJ.TSN2)
AJM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AJ.TSN2)
AJM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AJ.TSN2)
AJM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AJ.TSN2)
AJM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AJ.TSN2)
AJM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AJ.TSN2)
AJM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AJ.TSN2)
AJM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AJ.TSN2)
AJM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AJ.TSN2)
AJM27 <- mblm(AN_RR~ Water_Year_Year, AJ.TSN2)
AJM28 <- mblm(OCT_RR~ Water_Year_Year, AJ.TSN2)
AJM29 <- mblm(NOV_RR~ Water_Year_Year, AJ.TSN2)
AJM30 <- mblm(DEC_RR~ Water_Year_Year, AJ.TSN2)
AJM31 <- mblm(JAN_RR~ Water_Year_Year, AJ.TSN2)
AJM32 <- mblm(FEB_RR~ Water_Year_Year, AJ.TSN2)
AJM33 <- mblm(MAR_RR~ Water_Year_Year, AJ.TSN2)
AJM34 <- mblm(APL_RR~ Water_Year_Year, AJ.TSN2)
AJM35 <- mblm(MAY_RR~ Water_Year_Year, AJ.TSN2)
AJM36 <- mblm(JUN_RR~ Water_Year_Year, AJ.TSN2)
AJM37 <- mblm(JUL_RR~ Water_Year_Year, AJ.TSN2)
AJM38 <- mblm(AUG_RR~ Water_Year_Year, AJ.TSN2)
AJM39 <- mblm(SEP_RR~ Water_Year_Year, AJ.TSN2)
```
####################################
```{r}
TSR2<- cbind(AJM1$coefficients, AJM2$coefficients, AJM3$coefficients, AJM4$coefficients, AJM5$coefficients, AJM6$coefficients,AJM7$coefficients, AJM8$coefficients, AJM9$coefficients,AJM10$coefficients, AJM11$coefficients, AJM12$coefficients,AJM13$coefficients, AJM14$coefficients, AJM15$coefficients,AJM16$coefficients, AJM17$coefficients, AJM18$coefficients,AJM19$coefficients, AJM20$coefficients, AJM21$coefficients,AJM22$coefficients, AJM23$coefficients, AJM4$coefficients,AJM25$coefficients, AJM26$coefficients, AJM27$coefficients,AJM28$coefficients, AJM29$coefficients, AJM30$coefficients,AJM31$coefficients, AJM32$coefficients, AJM33$coefficients,AJM34$coefficients, AJM35$coefficients, AJM36$coefficients,AJM37$coefficients, AJM38$coefficients, AJM39$coefficients)
RES2 <- cbind(AJM1$residuals, AJM2$residuals, AJM3$residuals, AJM4$residuals, AJM5$residuals, AJM6$residuals,AJM7$residuals, AJM8$residuals, AJM9$residuals,AJM10$residuals, AJM11$residuals, AJM12$residuals,AJM13$residuals, AJM14$residuals, AJM15$residuals,AJM16$residuals, AJM17$residuals, AJM18$residuals,AJM19$residuals, AJM20$residuals, AJM21$residuals,AJM22$residuals, AJM23$residuals, AJM4$residuals,AJM25$residuals, AJM26$residuals, AJM27$residuals,AJM28$residuals, AJM29$residuals, AJM30$residuals,AJM31$residuals, AJM32$residuals, AJM33$residuals,AJM34$residuals, AJM35$residuals, AJM36$residuals,AJM37$residuals, AJM38$residuals, AJM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AJ.ALL[nrow(AJ.ALL)+ 1,] = MKTR2
AJ.ALL[nrow(AJ.ALL)+ 1,] = MKPR2
AJ.ALL[nrow(AJ.ALL)+ 1,] = TSRR2
AJ.ALL[nrow(AJ.ALL)+ 1,] = BTDF2
AJ.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- AJ.ALL[21:46,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
AJ.ALL[nrow(AJ.ALL)+ 1,] = MMKPR2
AJ.ALL[nrow(AJ.ALL)+ 1,] = MMKTR2
AJ.ALL[nrow(AJ.ALL)+ 1,] = MMKSR2
AJ.ALL
```

```{r}
AJ.ALL
```

```{r}
AJ.NUM2 <- as.data.frame(apply(AJ.ALL[1:64,2:40], 2, as.numeric))
str(AJ.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(AJ.NUM2[61,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(AJ.NUM2[60,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(AJ.NUM2[64,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(AJ.NUM2[59,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(AJ.NUM2[62,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
AJ.ALL[nrow(AJ.ALL)+ 1,] = FSR12
AJ.ALL[nrow(AJ.ALL)+ 1,] = FSR22
AJ.ALL
```

```{r}
AJ.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
AJFM2 <-AJ.ALL[c(65,66),-1]
AJF2 <- as.matrix(apply(AJFM2, 2, as.numeric))
AJF2
```



###Amnya Results, csv 'BK' ID 21 
```{r}
### Summarise by Month
BK$Days <- days_in_month(as.Date(BK$Date, "%Y-%m-%d"))
BK[233,2] <- NA ## -999 FOUND IN DATASET
BK$StreamflowMon_m3<- BK$Streamflow*(60*60*24)*BK$Days
BK.MON <- BK 
BK.MON$Streamflow_Km<-BK.MON$StreamflowMon_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
BK.MON$Streamflow_mm<-(BK.MON$Streamflow_Km/7100)*1000000 ## monthly runoff depth mm
BK.MON2 <- subset(BK.MON, Year >= 1969)
#BK.MON2

#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
BK.MONT<- BK.MON2[-c(1,2,3,4,5,6,7,8,9,574,575,576),]
BK.MONT
```

```{r}
BKT <- GMP2[[946:1509]] ## Amnya
BKE <- extent(67,69,63,63.5) ## Amnya
BKPC <- crop(BKT, BKE) ## Amnya
BK.Mon.Precip.<-extract(BKPC,BKE, method="bilinear", fun = mean)
BKMP<-as.data.frame(colMeans(BK.Mon.Precip.)) # Amnya
BKSub<-DateTemp[DateTemp$Date >= as.Date("1969-10-01") & DateTemp$Date <=
                    as.Date("2016-09-01"), ] ##Amny
BKPp<- cbind(BKMP,BKSub) ## Amnya
```

```{r}
BK.MONT$GriddedPrecip_mm<- BKMP$`colMeans(BK.Mon.Precip.)`
BK.MONT
```

```{r}
## Gap filling process
BK.M1 <- subset(BK.MONT, Month == 1)
BK.M2 <- subset(BK.MONT, Month == 2)
BK.M3 <- subset(BK.MONT, Month == 3)
BK.M4 <- subset(BK.MONT, Month == 4)
BK.M5 <- subset(BK.MONT, Month == 5)
BK.M6 <- subset(BK.MONT, Month == 6)
BK.M7 <- subset(BK.MONT, Month == 7)
BK.M8 <- subset(BK.MONT, Month == 8)
BK.M9 <- subset(BK.MONT, Month == 9)
BK.M10 <- subset(BK.MONT, Month == 10)
BK.M11 <- subset(BK.MONT, Month == 11)
BK.M12 <- subset(BK.MONT, Month == 12)


BK.1 <-mean(BK.M1$Streamflow_mm, na.rm = TRUE)
BK.2 <- mean(BK.M2$Streamflow_mm, na.rm = TRUE)
BK.3 <- mean(BK.M3$Streamflow_mm, na.rm = TRUE)
BK.4 <- mean(BK.M4$Streamflow_mm, na.rm = TRUE)
BK.5 <-mean(BK.M5$Streamflow_mm, na.rm = TRUE)
BK.6 <- mean(BK.M6$Streamflow_mm, na.rm = TRUE)
BK.7 <- mean(BK.M7$Streamflow_mm, na.rm = TRUE)
BK.8 <- mean(BK.M8$Streamflow_mm, na.rm = TRUE)
BK.9 <- mean(BK.M9$Streamflow_mm, na.rm = TRUE)
BK.10 <- mean(BK.M10$Streamflow_mm, na.rm = TRUE)
BK.11 <- mean(BK.M11$Streamflow_mm, na.rm = TRUE)
BK.12 <- mean(BK.M12$Streamflow_mm, na.rm = TRUE)

BK.MONT[c(256,340,460),9] <- BK.1
BK.MONT[c(257,341,461),9] <- BK.2
BK.MONT[c(258,342,462),9] <- BK.3
BK.MONT[c(343,463),9] <- BK.4
BK.MONT[c(140,344,416,464),9] <- BK.5
BK.MONT[c(345,417,465),9] <- BK.6
BK.MONT[c(346,466),9] <- BK.7
BK.MONT[c(347,467),9] <- BK.8
BK.MONT[c(348,468),9] <- BK.9
BK.MONT[c(301,349,469),9] <- BK.10
BK.MONT[c(302,338,350,470),9] <- BK.11
BK.MONT[c(303,339,351,471),9] <- BK.12

BK.MONT
```

##############
```{r}
## Water Year Sequencing
BK.MT<- BK.MONT
BK.MT$Water_Year_Month <- rep(seq(1:12),47) #1975 to 2016 is 43 years
BK.MT$Water_Year_Year <- rep(1:47, each =12)
BK.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 BK.WY <- BK.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
BK.WY
```
##############
```{r}
## Monthly Columns
## Oct
 BK.OCT <- BK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 BK.NOV <- BK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 BK.DEC <- BK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 BK.JAN <- BK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 BK.FEB <- BK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 BK.MAR <- BK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 BK.APL <- BK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 BK.MAY <- BK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 BK.JUN <- BK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 BK.JUL <- BK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 BK.AUG <- BK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 BK.SEP <- BK.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
BK.ALL <- cbind(BK.WY, BK.OCT[,-1], BK.NOV[,-1], BK.DEC[,-1], BK.JAN[,-1], BK.FEB[,-1], BK.MAR[,-1], BK.APL[,-1],BK.MAY[,-1], BK.JUN[,-1], BK.JUL[,-1], BK.AUG[,-1], BK.SEP[,-1])
```
####################
```{r}
BK.ALL$AN_RR <- BK.ALL$AN_RO_mm/BK.ALL$AN_PCP_mm
BK.ALL$OCT_RR <- BK.ALL$Oct_RO_mm/BK.ALL$Oct_PCP_mm
BK.ALL$NOV_RR <- BK.ALL$Nov_RO_mm/BK.ALL$Nov_PCP_mm
BK.ALL$DEC_RR <- BK.ALL$Dec_RO_mm/BK.ALL$Dec_PCP_mm
BK.ALL$JAN_RR <- BK.ALL$Jan_RO_mm/BK.ALL$Jan_PCP_mm
BK.ALL$FEB_RR <- BK.ALL$Feb_RO_mm/BK.ALL$Feb_PCP_mm
BK.ALL$MAR_RR <- BK.ALL$Mar_RO_mm/BK.ALL$Mar_PCP_mm
BK.ALL$APL_RR <- BK.ALL$Apl_RO_mm/BK.ALL$Apl_PCP_mm
BK.ALL$MAY_RR <- BK.ALL$May_RO_mm/BK.ALL$May_PCP_mm
BK.ALL$JUN_RR <- BK.ALL$Jun_RO_mm/BK.ALL$Jun_PCP_mm
BK.ALL$JUL_RR <- BK.ALL$Jul_RO_mm/BK.ALL$Jul_PCP_mm
BK.ALL$AUG_RR <- BK.ALL$Aug_RO_mm/BK.ALL$Aug_PCP_mm
BK.ALL$SEP_RR <- BK.ALL$Sep_RO_mm/BK.ALL$Sep_PCP_mm
BK.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(BK.ALL[,-1],2, mean))
CSD <- rbind(apply(BK.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
BK.ALL[nrow(BK.ALL)+ 1,] = CML
BK.ALL[nrow(BK.ALL)+ 1,] = CSDL
BK.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(BK.ALL[1:47,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
BK.TS <-BK.ALL[1:47,1:40]
BK.TSN <- as.data.frame(apply(BK.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(BK.TSN, class)   
BK.TSN
```
############################################
```{r}
BKM1 <- mblm(AN_RO_mm~ Water_Year_Year, BK.TSN)
BKM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BK.TSN)
BKM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BK.TSN)
BKM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BK.TSN)
BKM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BK.TSN)
BKM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BK.TSN)
BKM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BK.TSN)
BKM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BK.TSN)
BKM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BK.TSN)
BKM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BK.TSN)
BKM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BK.TSN)
BKM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BK.TSN)
BKM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BK.TSN)
BKM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BK.TSN)
BKM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BK.TSN)
BKM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BK.TSN)
BKM17 <- mblm(May_RO_mm~ Water_Year_Year, BK.TSN)
BKM18 <- mblm(May_PCP_mm~ Water_Year_Year, BK.TSN)
BKM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BK.TSN)
BKM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BK.TSN)
BKM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BK.TSN)
BKM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BK.TSN)
BKM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BK.TSN)
BKM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BK.TSN)
BKM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BK.TSN)
BKM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BK.TSN)
BKM27 <- mblm(AN_RR~ Water_Year_Year, BK.TSN)
BKM28 <- mblm(OCT_RR~ Water_Year_Year, BK.TSN)
BKM29 <- mblm(NOV_RR~ Water_Year_Year, BK.TSN)
BKM30 <- mblm(DEC_RR~ Water_Year_Year, BK.TSN)
BKM31 <- mblm(JAN_RR~ Water_Year_Year, BK.TSN)
BKM32 <- mblm(FEB_RR~ Water_Year_Year, BK.TSN)
BKM33 <- mblm(MAR_RR~ Water_Year_Year, BK.TSN)
BKM34 <- mblm(APL_RR~ Water_Year_Year, BK.TSN)
BKM35 <- mblm(MAY_RR~ Water_Year_Year, BK.TSN)
BKM36 <- mblm(JUN_RR~ Water_Year_Year, BK.TSN)
BKM37 <- mblm(JUL_RR~ Water_Year_Year, BK.TSN)
BKM38 <- mblm(AUG_RR~ Water_Year_Year, BK.TSN)
BKM39 <- mblm(SEP_RR~ Water_Year_Year, BK.TSN)
```
####################################
```{r}
TSR<- cbind(BKM1$coefficients, BKM2$coefficients, BKM3$coefficients, BKM4$coefficients, BKM5$coefficients, BKM6$coefficients,BKM7$coefficients, BKM8$coefficients, BKM9$coefficients,BKM10$coefficients, BKM11$coefficients, BKM12$coefficients,BKM13$coefficients, BKM14$coefficients, BKM15$coefficients,BKM16$coefficients, BKM17$coefficients, BKM18$coefficients,BKM19$coefficients, BKM20$coefficients, BKM21$coefficients,BKM22$coefficients, BKM23$coefficients, BKM4$coefficients,BKM25$coefficients, BKM26$coefficients, BKM27$coefficients,BKM28$coefficients, BKM29$coefficients, BKM30$coefficients,BKM31$coefficients, BKM32$coefficients, BKM33$coefficients,BKM34$coefficients, BKM35$coefficients, BKM36$coefficients,BKM37$coefficients, BKM38$coefficients, BKM39$coefficients)
RES <- cbind(BKM1$residuals, BKM2$residuals, BKM3$residuals, BKM4$residuals, BKM5$residuals, BKM6$residuals,BKM7$residuals, BKM8$residuals, BKM9$residuals,BKM10$residuals, BKM11$residuals, BKM12$residuals,BKM13$residuals, BKM14$residuals, BKM15$residuals,BKM16$residuals, BKM17$residuals, BKM18$residuals,BKM19$residuals, BKM20$residuals, BKM21$residuals,BKM22$residuals, BKM23$residuals, BKM4$residuals,BKM25$residuals, BKM26$residuals, BKM27$residuals,BKM28$residuals, BKM29$residuals, BKM30$residuals,BKM31$residuals, BKM32$residuals, BKM33$residuals,BKM34$residuals, BKM35$residuals, BKM36$residuals,BKM37$residuals, BKM38$residuals, BKM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BK.ALL[nrow(BK.ALL)+ 1,] = MKTR
BK.ALL[nrow(BK.ALL)+ 1,] = MKPR
BK.ALL[nrow(BK.ALL)+ 1,] = TSRR
BK.ALL[nrow(BK.ALL)+ 1,] = BTDF
BK.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- BK.ALL[1:47,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
BK.ALL[nrow(BK.ALL)+ 1,] = MMKPR
BK.ALL[nrow(BK.ALL)+ 1,] = MMKTR
BK.ALL[nrow(BK.ALL)+ 1,] = MMKSR
BK.ALL
```

```{r}
BK.NUM <- as.data.frame(apply(BK.ALL[1:56,2:40], 2, as.numeric))
str(BK.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(BK.NUM[53,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(BK.NUM[52,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(BK.NUM[56,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(BK.NUM[51,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(BK.NUM[54,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
BK.ALL[nrow(BK.ALL)+ 1,] = FSR1
BK.ALL[nrow(BK.ALL)+ 1,] = FSR2
BK.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
BKFM <-BK.ALL[c(57,58),-1]
BKF <- as.matrix(apply(BKFM, 2, as.numeric))
BKF
```
###########################################################

```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(BK.ALL[21:47,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
BK.TS2 <-BK.ALL[21:47,1:40] ## 1990 Subset
BK.TSN2 <- as.data.frame(apply(BK.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(BK.TSN2, class)   
BK.TSN2
```
############################################
```{r}
BKM1 <- mblm(AN_RO_mm~ Water_Year_Year, BK.TSN2)
BKM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BK.TSN2)
BKM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BK.TSN2)
BKM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BK.TSN2)
BKM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BK.TSN2)
BKM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BK.TSN2)
BKM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BK.TSN2)
BKM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BK.TSN2)
BKM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BK.TSN2)
BKM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BK.TSN2)
BKM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BK.TSN2)
BKM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BK.TSN2)
BKM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BK.TSN2)
BKM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BK.TSN2)
BKM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BK.TSN2)
BKM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BK.TSN2)
BKM17 <- mblm(May_RO_mm~ Water_Year_Year, BK.TSN2)
BKM18 <- mblm(May_PCP_mm~ Water_Year_Year, BK.TSN2)
BKM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BK.TSN2)
BKM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BK.TSN2)
BKM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BK.TSN2)
BKM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BK.TSN2)
BKM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BK.TSN2)
BKM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BK.TSN2)
BKM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BK.TSN2)
BKM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BK.TSN2)
BKM27 <- mblm(AN_RR~ Water_Year_Year, BK.TSN2)
BKM28 <- mblm(OCT_RR~ Water_Year_Year, BK.TSN2)
BKM29 <- mblm(NOV_RR~ Water_Year_Year, BK.TSN2)
BKM30 <- mblm(DEC_RR~ Water_Year_Year, BK.TSN2)
BKM31 <- mblm(JAN_RR~ Water_Year_Year, BK.TSN2)
BKM32 <- mblm(FEB_RR~ Water_Year_Year, BK.TSN2)
BKM33 <- mblm(MAR_RR~ Water_Year_Year, BK.TSN2)
BKM34 <- mblm(APL_RR~ Water_Year_Year, BK.TSN2)
BKM35 <- mblm(MAY_RR~ Water_Year_Year, BK.TSN2)
BKM36 <- mblm(JUN_RR~ Water_Year_Year, BK.TSN2)
BKM37 <- mblm(JUL_RR~ Water_Year_Year, BK.TSN2)
BKM38 <- mblm(AUG_RR~ Water_Year_Year, BK.TSN2)
BKM39 <- mblm(SEP_RR~ Water_Year_Year, BK.TSN2)
```
####################################
```{r}
TSR2<- cbind(BKM1$coefficients, BKM2$coefficients, BKM3$coefficients, BKM4$coefficients, BKM5$coefficients, BKM6$coefficients,BKM7$coefficients, BKM8$coefficients, BKM9$coefficients,BKM10$coefficients, BKM11$coefficients, BKM12$coefficients,BKM13$coefficients, BKM14$coefficients, BKM15$coefficients,BKM16$coefficients, BKM17$coefficients, BKM18$coefficients,BKM19$coefficients, BKM20$coefficients, BKM21$coefficients,BKM22$coefficients, BKM23$coefficients, BKM4$coefficients,BKM25$coefficients, BKM26$coefficients, BKM27$coefficients,BKM28$coefficients, BKM29$coefficients, BKM30$coefficients,BKM31$coefficients, BKM32$coefficients, BKM33$coefficients,BKM34$coefficients, BKM35$coefficients, BKM36$coefficients,BKM37$coefficients, BKM38$coefficients, BKM39$coefficients)
RES2 <- cbind(BKM1$residuals, BKM2$residuals, BKM3$residuals, BKM4$residuals, BKM5$residuals, BKM6$residuals,BKM7$residuals, BKM8$residuals, BKM9$residuals,BKM10$residuals, BKM11$residuals, BKM12$residuals,BKM13$residuals, BKM14$residuals, BKM15$residuals,BKM16$residuals, BKM17$residuals, BKM18$residuals,BKM19$residuals, BKM20$residuals, BKM21$residuals,BKM22$residuals, BKM23$residuals, BKM4$residuals,BKM25$residuals, BKM26$residuals, BKM27$residuals,BKM28$residuals, BKM29$residuals, BKM30$residuals,BKM31$residuals, BKM32$residuals, BKM33$residuals,BKM34$residuals, BKM35$residuals, BKM36$residuals,BKM37$residuals, BKM38$residuals, BKM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BK.ALL[nrow(BK.ALL)+ 1,] = MKTR2
BK.ALL[nrow(BK.ALL)+ 1,] = MKPR2
BK.ALL[nrow(BK.ALL)+ 1,] = TSRR2
BK.ALL[nrow(BK.ALL)+ 1,] = BTDF2
BK.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- BK.ALL[21:47,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
BK.ALL[nrow(BK.ALL)+ 1,] = MMKPR2
BK.ALL[nrow(BK.ALL)+ 1,] = MMKTR2
BK.ALL[nrow(BK.ALL)+ 1,] = MMKSR2
BK.ALL
```

```{r}
BK.ALL
```

```{r}
BK.NUM2 <- as.data.frame(apply(BK.ALL[1:65,2:40], 2, as.numeric))
str(BK.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(BK.NUM2[62,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(BK.NUM2[61,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(BK.NUM2[65,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(BK.NUM2[60,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(BK.NUM2[63,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
BK.ALL[nrow(BK.ALL)+ 1,] = FSR12
BK.ALL[nrow(BK.ALL)+ 1,] = FSR22
BK.ALL
```

```{r}
BK.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
BKFM2 <-BK.ALL[c(66,67),-1]
BKF2 <- as.matrix(apply(BKFM2, 2, as.numeric))
BKF2
```


###Bol'shol Yugan Results, csv 'AL' ID 22
```{r}
### Summarise by Month
AL$Days <- days_in_month(as.Date(AL$Date, "%d/%m/%Y"))
AL$StreamflowMon_m3<- AL$Streamflow*(60*60*24)*AL$Days
AL.MON <- AL 
AL.MON$Streamflow_Km<-AL.MON$StreamflowMon_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
AL.MON$Streamflow_mm<-(AL.MON$Streamflow_Km/18300)*1000000 ## monthly runoff depth mm
AL.MON2<- subset(AL.MON, Year >= 1969)
AL.MON2
```


```{r}
AL.MONT <- AL.MON2[10:321,c(1,2,3,4,5,14,15,16,17)]
AL.MONT
```



```{r}
ALT<-GMP2[[946:1257]] #Riskini
ALE<-extent(73,74,60,60.5) #Riskini Extent
ALPC<-crop(ALT,ALE) #Riskini Crop
AL.Mon.Precip.<-extract(ALPC,ALE, method="bilinear", fun = mean)
ALMP<-as.data.frame(colMeans(AL.Mon.Precip.)) #Riskini
ALSub<-DateTemp[DateTemp$Date >= as.Date("1969-10-01") & DateTemp$Date <=
                    as.Date("1995-09-01"), ] ## Riskini
ALPp<- cbind(ALMP,ALSub) ## Riskini
```

```{r}
## Unique data trimming here. 2016 stops in October starts   
AL.MONT$GriddedPrecip_mm<- ALMP$`colMeans(AL.Mon.Precip.)`
AL.MONT
```


##############
```{r}
## Water Year Sequencing
AL.MT<- AL.MONT
AL.MT$Water_Year_Month <- rep(seq(1:12),26) #1975 to 2016 is 43 years
AL.MT$Water_Year_Year <- rep(1:26, each =12)
AL.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 AL.WY <- AL.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
AL.WY
```
##############
```{r}
## Monthly Columns
## Oct
 AL.OCT <- AL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 AL.NOV <- AL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 AL.DEC <- AL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 AL.JAN <- AL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 AL.FEB <- AL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 AL.MAR <- AL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 AL.APL <- AL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 AL.MAY <- AL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 AL.JUN <- AL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 AL.JUL <- AL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 AL.AUG <- AL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 AL.SEP <- AL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
AL.ALL <- cbind(AL.WY, AL.OCT[,-1], AL.NOV[,-1], AL.DEC[,-1], AL.JAN[,-1], AL.FEB[,-1], AL.MAR[,-1], AL.APL[,-1],AL.MAY[,-1], AL.JUN[,-1], AL.JUL[,-1], AL.AUG[,-1], AL.SEP[,-1])
```
####################
```{r}
AL.ALL$AN_RR <- AL.ALL$AN_RO_mm/AL.ALL$AN_PCP_mm
AL.ALL$OCT_RR <- AL.ALL$Oct_RO_mm/AL.ALL$Oct_PCP_mm
AL.ALL$NOV_RR <- AL.ALL$Nov_RO_mm/AL.ALL$Nov_PCP_mm
AL.ALL$DEC_RR <- AL.ALL$Dec_RO_mm/AL.ALL$Dec_PCP_mm
AL.ALL$JAN_RR <- AL.ALL$Jan_RO_mm/AL.ALL$Jan_PCP_mm
AL.ALL$FEB_RR <- AL.ALL$Feb_RO_mm/AL.ALL$Feb_PCP_mm
AL.ALL$MAR_RR <- AL.ALL$Mar_RO_mm/AL.ALL$Mar_PCP_mm
AL.ALL$APL_RR <- AL.ALL$Apl_RO_mm/AL.ALL$Apl_PCP_mm
AL.ALL$MAY_RR <- AL.ALL$May_RO_mm/AL.ALL$May_PCP_mm
AL.ALL$JUN_RR <- AL.ALL$Jun_RO_mm/AL.ALL$Jun_PCP_mm
AL.ALL$JUL_RR <- AL.ALL$Jul_RO_mm/AL.ALL$Jul_PCP_mm
AL.ALL$AUG_RR <- AL.ALL$Aug_RO_mm/AL.ALL$Aug_PCP_mm
AL.ALL$SEP_RR <- AL.ALL$Sep_RO_mm/AL.ALL$Sep_PCP_mm
AL.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(AL.ALL[,-1],2, mean))
CSD <- rbind(apply(AL.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
AL.ALL[nrow(AL.ALL)+ 1,] = CML
AL.ALL[nrow(AL.ALL)+ 1,] = CSDL
AL.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(AL.ALL[1:26,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
AL.TS <-AL.ALL[1:26,1:40]
AL.TSN <- as.data.frame(apply(AL.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(AL.TSN, class)   
AL.TSN
```
############################################
```{r}
ALM1 <- mblm(AN_RO_mm~ Water_Year_Year, AL.TSN)
ALM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AL.TSN)
ALM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AL.TSN)
ALM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AL.TSN)
ALM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AL.TSN)
ALM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AL.TSN)
ALM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AL.TSN)
ALM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AL.TSN)
ALM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AL.TSN)
ALM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AL.TSN)
ALM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AL.TSN)
ALM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AL.TSN)
ALM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AL.TSN)
ALM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AL.TSN)
ALM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AL.TSN)
ALM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AL.TSN)
ALM17 <- mblm(May_RO_mm~ Water_Year_Year, AL.TSN)
ALM18 <- mblm(May_PCP_mm~ Water_Year_Year, AL.TSN)
ALM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AL.TSN)
ALM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AL.TSN)
ALM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AL.TSN)
ALM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AL.TSN)
ALM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AL.TSN)
ALM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AL.TSN)
ALM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AL.TSN)
ALM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AL.TSN)
ALM27 <- mblm(AN_RR~ Water_Year_Year, AL.TSN)
ALM28 <- mblm(OCT_RR~ Water_Year_Year, AL.TSN)
ALM29 <- mblm(NOV_RR~ Water_Year_Year, AL.TSN)
ALM30 <- mblm(DEC_RR~ Water_Year_Year, AL.TSN)
ALM31 <- mblm(JAN_RR~ Water_Year_Year, AL.TSN)
ALM32 <- mblm(FEB_RR~ Water_Year_Year, AL.TSN)
ALM33 <- mblm(MAR_RR~ Water_Year_Year, AL.TSN)
ALM34 <- mblm(APL_RR~ Water_Year_Year, AL.TSN)
ALM35 <- mblm(MAY_RR~ Water_Year_Year, AL.TSN)
ALM36 <- mblm(JUN_RR~ Water_Year_Year, AL.TSN)
ALM37 <- mblm(JUL_RR~ Water_Year_Year, AL.TSN)
ALM38 <- mblm(AUG_RR~ Water_Year_Year, AL.TSN)
ALM39 <- mblm(SEP_RR~ Water_Year_Year, AL.TSN)
```
####################################
```{r}
TSR<- cbind(ALM1$coefficients, ALM2$coefficients, ALM3$coefficients, ALM4$coefficients, ALM5$coefficients, ALM6$coefficients,ALM7$coefficients, ALM8$coefficients, ALM9$coefficients,ALM10$coefficients, ALM11$coefficients, ALM12$coefficients,ALM13$coefficients, ALM14$coefficients, ALM15$coefficients,ALM16$coefficients, ALM17$coefficients, ALM18$coefficients,ALM19$coefficients, ALM20$coefficients, ALM21$coefficients,ALM22$coefficients, ALM23$coefficients, ALM4$coefficients,ALM25$coefficients, ALM26$coefficients, ALM27$coefficients,ALM28$coefficients, ALM29$coefficients, ALM30$coefficients,ALM31$coefficients, ALM32$coefficients, ALM33$coefficients,ALM34$coefficients, ALM35$coefficients, ALM36$coefficients,ALM37$coefficients, ALM38$coefficients, ALM39$coefficients)
RES <- cbind(ALM1$residuals, ALM2$residuals, ALM3$residuals, ALM4$residuals, ALM5$residuals, ALM6$residuals,ALM7$residuals, ALM8$residuals, ALM9$residuals,ALM10$residuals, ALM11$residuals, ALM12$residuals,ALM13$residuals, ALM14$residuals, ALM15$residuals,ALM16$residuals, ALM17$residuals, ALM18$residuals,ALM19$residuals, ALM20$residuals, ALM21$residuals,ALM22$residuals, ALM23$residuals, ALM4$residuals,ALM25$residuals, ALM26$residuals, ALM27$residuals,ALM28$residuals, ALM29$residuals, ALM30$residuals,ALM31$residuals, ALM32$residuals, ALM33$residuals,ALM34$residuals, ALM35$residuals, ALM36$residuals,ALM37$residuals, ALM38$residuals, ALM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AL.ALL[nrow(AL.ALL)+ 1,] = MKTR
AL.ALL[nrow(AL.ALL)+ 1,] = MKPR
AL.ALL[nrow(AL.ALL)+ 1,] = TSRR
AL.ALL[nrow(AL.ALL)+ 1,] = BTDF
AL.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- AL.ALL[1:26,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
AL.ALL[nrow(AL.ALL)+ 1,] = MMKPR
AL.ALL[nrow(AL.ALL)+ 1,] = MMKTR
AL.ALL[nrow(AL.ALL)+ 1,] = MMKSR
AL.ALL
```

```{r}
AL.NUM <- as.data.frame(apply(AL.ALL[1:35,2:40], 2, as.numeric))
str(AL.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(AL.NUM[32,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(AL.NUM[31,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(AL.NUM[35,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(AL.NUM[30,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(AL.NUM[33,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
AL.ALL[nrow(AL.ALL)+ 1,] = FSR1
AL.ALL[nrow(AL.ALL)+ 1,] = FSR2
AL.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
ALFM <-AL.ALL[c(36,37),-1]
ALF <- as.matrix(apply(ALFM, 2, as.numeric))
ALF
```
###########################################################

###Kazym Results, csv 'AP' ID 23
```{r}
### Summarise by Month
AP2 <-AP[1:15859,1:5]
AP2$Days <- days_in_month(as.Date(AP2$Date, "%d/%m/%Y"))
AP2$StreamflowMon_m3<- AP2$Streamflow*(60*60*24)*AP2$Days
AP.MON <- AP2 
AP.MON$Streamflow_Km<-AP.MON$StreamflowMon_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
AP.MON$Streamflow_mm<-(AP.MON$Streamflow_Km/7540)*1000000 ## monthly runoff depth mm
AP.MON2 <- subset(AP.MON, Year >= 1969)
#AP.MON2


#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
AP.MONT <- AP.MON2[-c(1,2,3,4,5,6,7,8,9,358,359,360,361,362,363,364),]
AP.MONT
```

```{r}
APT<-GMP2[[946:1293]] #Yuilsk
APE<-extent(69,69.5,63,63.5) #Yuilsk Extent
APPC<-crop(APT,APE) #Yuilsk Crop
AP.Mon.Precip.<-extract(APPC,APE, method="bilinear", fun = mean)
APMP<-as.data.frame(colMeans(AP.Mon.Precip.)) #Yuilsk
APSub<-DateTemp[DateTemp$Date >= as.Date("1969-10-01") & DateTemp$Date <=
                    as.Date("1998-09-01"), ] ##Yuilsk
APPp<- cbind(APMP,APSub) ## Yuilsk
```

```{r}
AP.MONT$GriddedPrecip_mm<- APMP$`colMeans(AP.Mon.Precip.)`
AP.MONT
```


##############
```{r}
## Water Year Sequencing
AP.MT<- AP.MONT
AP.MT$Water_Year_Month <- rep(seq(1:12),29) #1975 to 2016 is 43 years
AP.MT$Water_Year_Year <- rep(1:29, each =12)
AP.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 AP.WY <- AP.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
AP.WY
```
##############
```{r}
## Monthly Columns
## Oct
 AP.OCT <- AP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 AP.NOV <- AP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 AP.DEC <- AP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 AP.JAN <- AP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 AP.FEB <- AP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 AP.MAR <- AP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 AP.APL <- AP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 AP.MAY <- AP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 AP.JUN <- AP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 AP.JUL <- AP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 AP.AUG <- AP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 AP.SEP <- AP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
AP.ALL <- cbind(AP.WY, AP.OCT[,-1], AP.NOV[,-1], AP.DEC[,-1], AP.JAN[,-1], AP.FEB[,-1], AP.MAR[,-1], AP.APL[,-1],AP.MAY[,-1], AP.JUN[,-1], AP.JUL[,-1], AP.AUG[,-1], AP.SEP[,-1])
```
####################
```{r}
AP.ALL$AN_RR <- AP.ALL$AN_RO_mm/AP.ALL$AN_PCP_mm
AP.ALL$OCT_RR <- AP.ALL$Oct_RO_mm/AP.ALL$Oct_PCP_mm
AP.ALL$NOV_RR <- AP.ALL$Nov_RO_mm/AP.ALL$Nov_PCP_mm
AP.ALL$DEC_RR <- AP.ALL$Dec_RO_mm/AP.ALL$Dec_PCP_mm
AP.ALL$JAN_RR <- AP.ALL$Jan_RO_mm/AP.ALL$Jan_PCP_mm
AP.ALL$FEB_RR <- AP.ALL$Feb_RO_mm/AP.ALL$Feb_PCP_mm
AP.ALL$MAR_RR <- AP.ALL$Mar_RO_mm/AP.ALL$Mar_PCP_mm
AP.ALL$APL_RR <- AP.ALL$Apl_RO_mm/AP.ALL$Apl_PCP_mm
AP.ALL$MAY_RR <- AP.ALL$May_RO_mm/AP.ALL$May_PCP_mm
AP.ALL$JUN_RR <- AP.ALL$Jun_RO_mm/AP.ALL$Jun_PCP_mm
AP.ALL$JUL_RR <- AP.ALL$Jul_RO_mm/AP.ALL$Jul_PCP_mm
AP.ALL$AUG_RR <- AP.ALL$Aug_RO_mm/AP.ALL$Aug_PCP_mm
AP.ALL$SEP_RR <- AP.ALL$Sep_RO_mm/AP.ALL$Sep_PCP_mm
AP.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(AP.ALL[,-1],2, mean))
CSD <- rbind(apply(AP.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
AP.ALL[nrow(AP.ALL)+ 1,] = CML
AP.ALL[nrow(AP.ALL)+ 1,] = CSDL
AP.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(AP.ALL[1:29,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
AP.TS <-AP.ALL[1:29,1:40]
AP.TSN <- as.data.frame(apply(AP.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(AP.TSN, class)   
AP.TSN
```
############################################
```{r}
APM1 <- mblm(AN_RO_mm~ Water_Year_Year, AP.TSN)
APM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AP.TSN)
APM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AP.TSN)
APM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AP.TSN)
APM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AP.TSN)
APM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AP.TSN)
APM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AP.TSN)
APM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AP.TSN)
APM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AP.TSN)
APM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AP.TSN)
APM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AP.TSN)
APM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AP.TSN)
APM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AP.TSN)
APM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AP.TSN)
APM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AP.TSN)
APM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AP.TSN)
APM17 <- mblm(May_RO_mm~ Water_Year_Year, AP.TSN)
APM18 <- mblm(May_PCP_mm~ Water_Year_Year, AP.TSN)
APM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AP.TSN)
APM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AP.TSN)
APM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AP.TSN)
APM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AP.TSN)
APM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AP.TSN)
APM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AP.TSN)
APM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AP.TSN)
APM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AP.TSN)
APM27 <- mblm(AN_RR~ Water_Year_Year, AP.TSN)
APM28 <- mblm(OCT_RR~ Water_Year_Year, AP.TSN)
APM29 <- mblm(NOV_RR~ Water_Year_Year, AP.TSN)
APM30 <- mblm(DEC_RR~ Water_Year_Year, AP.TSN)
APM31 <- mblm(JAN_RR~ Water_Year_Year, AP.TSN)
APM32 <- mblm(FEB_RR~ Water_Year_Year, AP.TSN)
APM33 <- mblm(MAR_RR~ Water_Year_Year, AP.TSN)
APM34 <- mblm(APL_RR~ Water_Year_Year, AP.TSN)
APM35 <- mblm(MAY_RR~ Water_Year_Year, AP.TSN)
APM36 <- mblm(JUN_RR~ Water_Year_Year, AP.TSN)
APM37 <- mblm(JUL_RR~ Water_Year_Year, AP.TSN)
APM38 <- mblm(AUG_RR~ Water_Year_Year, AP.TSN)
APM39 <- mblm(SEP_RR~ Water_Year_Year, AP.TSN)
```
####################################
```{r}
TSR<- cbind(APM1$coefficients, APM2$coefficients, APM3$coefficients, APM4$coefficients, APM5$coefficients, APM6$coefficients,APM7$coefficients, APM8$coefficients, APM9$coefficients,APM10$coefficients, APM11$coefficients, APM12$coefficients,APM13$coefficients, APM14$coefficients, APM15$coefficients,APM16$coefficients, APM17$coefficients, APM18$coefficients,APM19$coefficients, APM20$coefficients, APM21$coefficients,APM22$coefficients, APM23$coefficients, APM4$coefficients,APM25$coefficients, APM26$coefficients, APM27$coefficients,APM28$coefficients, APM29$coefficients, APM30$coefficients,APM31$coefficients, APM32$coefficients, APM33$coefficients,APM34$coefficients, APM35$coefficients, APM36$coefficients,APM37$coefficients, APM38$coefficients, APM39$coefficients)
RES <- cbind(APM1$residuals, APM2$residuals, APM3$residuals, APM4$residuals, APM5$residuals, APM6$residuals,APM7$residuals, APM8$residuals, APM9$residuals,APM10$residuals, APM11$residuals, APM12$residuals,APM13$residuals, APM14$residuals, APM15$residuals,APM16$residuals, APM17$residuals, APM18$residuals,APM19$residuals, APM20$residuals, APM21$residuals,APM22$residuals, APM23$residuals, APM4$residuals,APM25$residuals, APM26$residuals, APM27$residuals,APM28$residuals, APM29$residuals, APM30$residuals,APM31$residuals, APM32$residuals, APM33$residuals,APM34$residuals, APM35$residuals, APM36$residuals,APM37$residuals, APM38$residuals, APM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AP.ALL[nrow(AP.ALL)+ 1,] = MKTR
AP.ALL[nrow(AP.ALL)+ 1,] = MKPR
AP.ALL[nrow(AP.ALL)+ 1,] = TSRR
AP.ALL[nrow(AP.ALL)+ 1,] = BTDF
AP.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- AP.ALL[1:29,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
AP.ALL[nrow(AP.ALL)+ 1,] = MMKPR
AP.ALL[nrow(AP.ALL)+ 1,] = MMKTR
AP.ALL[nrow(AP.ALL)+ 1,] = MMKSR
AP.ALL
```

```{r}
AP.NUM <- as.data.frame(apply(AP.ALL[1:38,2:40], 2, as.numeric))
str(AP.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(AP.NUM[35,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(AP.NUM[34,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(AP.NUM[38,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(AP.NUM[33,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(AP.NUM[36,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
AP.ALL[nrow(AP.ALL)+ 1,] = FSR1
AP.ALL[nrow(AP.ALL)+ 1,] = FSR2
AP.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
APFM <-AP.ALL[c(39,40),-1]
APF <- as.matrix(apply(APFM, 2, as.numeric))
APF
```
###########################################################

```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(AP.ALL[21:29,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
AP.TS2 <-AP.ALL[21:29,1:40] ## 1990 Subset
AP.TSN2 <- as.data.frame(apply(AP.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(AP.TSN2, class)   
AP.TSN2
```
############################################
```{r}
APM1 <- mblm(AN_RO_mm~ Water_Year_Year, AP.TSN2)
APM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AP.TSN2)
APM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AP.TSN2)
APM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AP.TSN2)
APM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AP.TSN2)
APM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AP.TSN2)
APM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AP.TSN2)
APM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AP.TSN2)
APM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AP.TSN2)
APM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AP.TSN2)
APM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AP.TSN2)
APM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AP.TSN2)
APM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AP.TSN2)
APM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AP.TSN2)
APM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AP.TSN2)
APM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AP.TSN2)
APM17 <- mblm(May_RO_mm~ Water_Year_Year, AP.TSN2)
APM18 <- mblm(May_PCP_mm~ Water_Year_Year, AP.TSN2)
APM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AP.TSN2)
APM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AP.TSN2)
APM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AP.TSN2)
APM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AP.TSN2)
APM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AP.TSN2)
APM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AP.TSN2)
APM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AP.TSN2)
APM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AP.TSN2)
APM27 <- mblm(AN_RR~ Water_Year_Year, AP.TSN2)
APM28 <- mblm(OCT_RR~ Water_Year_Year, AP.TSN2)
APM29 <- mblm(NOV_RR~ Water_Year_Year, AP.TSN2)
APM30 <- mblm(DEC_RR~ Water_Year_Year, AP.TSN2)
APM31 <- mblm(JAN_RR~ Water_Year_Year, AP.TSN2)
APM32 <- mblm(FEB_RR~ Water_Year_Year, AP.TSN2)
APM33 <- mblm(MAR_RR~ Water_Year_Year, AP.TSN2)
APM34 <- mblm(APL_RR~ Water_Year_Year, AP.TSN2)
APM35 <- mblm(MAY_RR~ Water_Year_Year, AP.TSN2)
APM36 <- mblm(JUN_RR~ Water_Year_Year, AP.TSN2)
APM37 <- mblm(JUL_RR~ Water_Year_Year, AP.TSN2)
APM38 <- mblm(AUG_RR~ Water_Year_Year, AP.TSN2)
APM39 <- mblm(SEP_RR~ Water_Year_Year, AP.TSN2)
```
####################################
```{r}
TSR2<- cbind(APM1$coefficients, APM2$coefficients, APM3$coefficients, APM4$coefficients, APM5$coefficients, APM6$coefficients,APM7$coefficients, APM8$coefficients, APM9$coefficients,APM10$coefficients, APM11$coefficients, APM12$coefficients,APM13$coefficients, APM14$coefficients, APM15$coefficients,APM16$coefficients, APM17$coefficients, APM18$coefficients,APM19$coefficients, APM20$coefficients, APM21$coefficients,APM22$coefficients, APM23$coefficients, APM4$coefficients,APM25$coefficients, APM26$coefficients, APM27$coefficients,APM28$coefficients, APM29$coefficients, APM30$coefficients,APM31$coefficients, APM32$coefficients, APM33$coefficients,APM34$coefficients, APM35$coefficients, APM36$coefficients,APM37$coefficients, APM38$coefficients, APM39$coefficients)
RES2 <- cbind(APM1$residuals, APM2$residuals, APM3$residuals, APM4$residuals, APM5$residuals, APM6$residuals,APM7$residuals, APM8$residuals, APM9$residuals,APM10$residuals, APM11$residuals, APM12$residuals,APM13$residuals, APM14$residuals, APM15$residuals,APM16$residuals, APM17$residuals, APM18$residuals,APM19$residuals, APM20$residuals, APM21$residuals,APM22$residuals, APM23$residuals, APM4$residuals,APM25$residuals, APM26$residuals, APM27$residuals,APM28$residuals, APM29$residuals, APM30$residuals,APM31$residuals, APM32$residuals, APM33$residuals,APM34$residuals, APM35$residuals, APM36$residuals,APM37$residuals, APM38$residuals, APM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AP.ALL[nrow(AP.ALL)+ 1,] = MKTR2
AP.ALL[nrow(AP.ALL)+ 1,] = MKPR2
AP.ALL[nrow(AP.ALL)+ 1,] = TSRR2
AP.ALL[nrow(AP.ALL)+ 1,] = BTDF2
AP.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- AP.ALL[21:29,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
AP.ALL[nrow(AP.ALL)+ 1,] = MMKPR2
AP.ALL[nrow(AP.ALL)+ 1,] = MMKTR2
AP.ALL[nrow(AP.ALL)+ 1,] = MMKSR2
AP.ALL
```

```{r}
AP.ALL
```

```{r}
AP.NUM2 <- as.data.frame(apply(AP.ALL[1:47,2:40], 2, as.numeric))
str(AP.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(AP.NUM2[44,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(AP.NUM2[43,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(AP.NUM2[47,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(AP.NUM2[42,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(AP.NUM2[45,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
AP.ALL[nrow(AP.ALL)+ 1,] = FSR12
AP.ALL[nrow(AP.ALL)+ 1,] = FSR22
AP.ALL
```

```{r}
AP.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
APFM2 <-AP.ALL[c(48,49),-1]
APF2 <- as.matrix(apply(APFM2, 2, as.numeric))
APF2
```

###Konda Results, csv 'AM' ID 24
```{r}
### Summarise by Month
AM$Days <- days_in_month(as.Date(AM$Date, "%d/%m/%Y"))
AM$StreamflowMon_m3<- AM$Streamflow*(60*60*24)*AM$Days
AM.MON <- AM 
AM.MON$Streamflow_Km<-AM.MON$StreamflowMon_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
AM.MON$Streamflow_mm<-(AM.MON$Streamflow_Km/65400)*1000000 ## monthly runoff depth mm
AM.MON2 <- subset(AM.MON, Year >= 1969)
#AM.MON2

#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
AM.MON3 <- AM.MON2[-c(1,2,3,4,5,6,7,8,9,562,563,564),]
AM.MONT <-AM.MON3[1:552,c(1,2,3,4,5,14,15,16,17)]
AM.MONT
```



```{r}
AMT<-GMP2[[946:1497]] #Bolcharry
AME<-extent(64,69,59.5,60) #Bolcharry Extent
AMPC<-crop(AMT,AME) #Bolcharry Crop
AM.Mon.Precip.<-extract(AMPC,AME, method="bilinear", fun = mean)
AMMP<-as.data.frame(colMeans(AM.Mon.Precip.)) #Bolcharry
AMSub<-DateTemp[DateTemp$Date >= as.Date("1969-10-01") & DateTemp$Date <=
                    as.Date("2015-09-01"), ] ##Bolchary
AMPp<- cbind(AMMP,AMSub) ## Bolcharry
```

```{r}
AM.MONT$GriddedPrecip_mm<- AMMP$`colMeans(AM.Mon.Precip.)`
AM.MONT
```

##############
```{r}
## Water Year Sequencing
AM.MT<- AM.MONT
AM.MT$Water_Year_Month <- rep(seq(1:12),46) #1975 to 2016 is 43 years
AM.MT$Water_Year_Year <- rep(1:46, each =12)
AM.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 AM.WY <- AM.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
AM.WY
```
##############
```{r}
## Monthly Columns
## Oct
 AM.OCT <- AM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 AM.NOV <- AM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 AM.DEC <- AM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 AM.JAN <- AM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 AM.FEB <- AM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 AM.MAR <- AM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 AM.APL <- AM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 AM.MAY <- AM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 AM.JUN <- AM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 AM.JUL <- AM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 AM.AUG <- AM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 AM.SEP <- AM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
AM.ALL <- cbind(AM.WY, AM.OCT[,-1], AM.NOV[,-1], AM.DEC[,-1], AM.JAN[,-1], AM.FEB[,-1], AM.MAR[,-1], AM.APL[,-1],AM.MAY[,-1], AM.JUN[,-1], AM.JUL[,-1], AM.AUG[,-1], AM.SEP[,-1])
```
####################
```{r}
AM.ALL$AN_RR <- AM.ALL$AN_RO_mm/AM.ALL$AN_PCP_mm
AM.ALL$OCT_RR <- AM.ALL$Oct_RO_mm/AM.ALL$Oct_PCP_mm
AM.ALL$NOV_RR <- AM.ALL$Nov_RO_mm/AM.ALL$Nov_PCP_mm
AM.ALL$DEC_RR <- AM.ALL$Dec_RO_mm/AM.ALL$Dec_PCP_mm
AM.ALL$JAN_RR <- AM.ALL$Jan_RO_mm/AM.ALL$Jan_PCP_mm
AM.ALL$FEB_RR <- AM.ALL$Feb_RO_mm/AM.ALL$Feb_PCP_mm
AM.ALL$MAR_RR <- AM.ALL$Mar_RO_mm/AM.ALL$Mar_PCP_mm
AM.ALL$APL_RR <- AM.ALL$Apl_RO_mm/AM.ALL$Apl_PCP_mm
AM.ALL$MAY_RR <- AM.ALL$May_RO_mm/AM.ALL$May_PCP_mm
AM.ALL$JUN_RR <- AM.ALL$Jun_RO_mm/AM.ALL$Jun_PCP_mm
AM.ALL$JUL_RR <- AM.ALL$Jul_RO_mm/AM.ALL$Jul_PCP_mm
AM.ALL$AUG_RR <- AM.ALL$Aug_RO_mm/AM.ALL$Aug_PCP_mm
AM.ALL$SEP_RR <- AM.ALL$Sep_RO_mm/AM.ALL$Sep_PCP_mm
AM.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(AM.ALL[,-1],2, mean))
CSD <- rbind(apply(AM.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
AM.ALL[nrow(AM.ALL)+ 1,] = CML
AM.ALL[nrow(AM.ALL)+ 1,] = CSDL
AM.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(AM.ALL[1:46,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
AM.TS <-AM.ALL[1:46,1:40]
AM.TSN <- as.data.frame(apply(AM.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(AM.TSN, class)   
AM.TSN
```
############################################
```{r}
AMM1 <- mblm(AN_RO_mm~ Water_Year_Year, AM.TSN)
AMM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AM.TSN)
AMM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AM.TSN)
AMM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AM.TSN)
AMM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AM.TSN)
AMM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AM.TSN)
AMM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AM.TSN)
AMM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AM.TSN)
AMM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AM.TSN)
AMM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AM.TSN)
AMM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AM.TSN)
AMM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AM.TSN)
AMM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AM.TSN)
AMM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AM.TSN)
AMM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AM.TSN)
AMM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AM.TSN)
AMM17 <- mblm(May_RO_mm~ Water_Year_Year, AM.TSN)
AMM18 <- mblm(May_PCP_mm~ Water_Year_Year, AM.TSN)
AMM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AM.TSN)
AMM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AM.TSN)
AMM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AM.TSN)
AMM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AM.TSN)
AMM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AM.TSN)
AMM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AM.TSN)
AMM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AM.TSN)
AMM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AM.TSN)
AMM27 <- mblm(AN_RR~ Water_Year_Year, AM.TSN)
AMM28 <- mblm(OCT_RR~ Water_Year_Year, AM.TSN)
AMM29 <- mblm(NOV_RR~ Water_Year_Year, AM.TSN)
AMM30 <- mblm(DEC_RR~ Water_Year_Year, AM.TSN)
AMM31 <- mblm(JAN_RR~ Water_Year_Year, AM.TSN)
AMM32 <- mblm(FEB_RR~ Water_Year_Year, AM.TSN)
AMM33 <- mblm(MAR_RR~ Water_Year_Year, AM.TSN)
AMM34 <- mblm(APL_RR~ Water_Year_Year, AM.TSN)
AMM35 <- mblm(MAY_RR~ Water_Year_Year, AM.TSN)
AMM36 <- mblm(JUN_RR~ Water_Year_Year, AM.TSN)
AMM37 <- mblm(JUL_RR~ Water_Year_Year, AM.TSN)
AMM38 <- mblm(AUG_RR~ Water_Year_Year, AM.TSN)
AMM39 <- mblm(SEP_RR~ Water_Year_Year, AM.TSN)
```
####################################
```{r}
TSR<- cbind(AMM1$coefficients, AMM2$coefficients, AMM3$coefficients, AMM4$coefficients, AMM5$coefficients, AMM6$coefficients,AMM7$coefficients, AMM8$coefficients, AMM9$coefficients,AMM10$coefficients, AMM11$coefficients, AMM12$coefficients,AMM13$coefficients, AMM14$coefficients, AMM15$coefficients,AMM16$coefficients, AMM17$coefficients, AMM18$coefficients,AMM19$coefficients, AMM20$coefficients, AMM21$coefficients,AMM22$coefficients, AMM23$coefficients, AMM4$coefficients,AMM25$coefficients, AMM26$coefficients, AMM27$coefficients,AMM28$coefficients, AMM29$coefficients, AMM30$coefficients,AMM31$coefficients, AMM32$coefficients, AMM33$coefficients,AMM34$coefficients, AMM35$coefficients, AMM36$coefficients,AMM37$coefficients, AMM38$coefficients, AMM39$coefficients)
RES <- cbind(AMM1$residuals, AMM2$residuals, AMM3$residuals, AMM4$residuals, AMM5$residuals, AMM6$residuals,AMM7$residuals, AMM8$residuals, AMM9$residuals,AMM10$residuals, AMM11$residuals, AMM12$residuals,AMM13$residuals, AMM14$residuals, AMM15$residuals,AMM16$residuals, AMM17$residuals, AMM18$residuals,AMM19$residuals, AMM20$residuals, AMM21$residuals,AMM22$residuals, AMM23$residuals, AMM4$residuals,AMM25$residuals, AMM26$residuals, AMM27$residuals,AMM28$residuals, AMM29$residuals, AMM30$residuals,AMM31$residuals, AMM32$residuals, AMM33$residuals,AMM34$residuals, AMM35$residuals, AMM36$residuals,AMM37$residuals, AMM38$residuals, AMM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AM.ALL[nrow(AM.ALL)+ 1,] = MKTR
AM.ALL[nrow(AM.ALL)+ 1,] = MKPR
AM.ALL[nrow(AM.ALL)+ 1,] = TSRR
AM.ALL[nrow(AM.ALL)+ 1,] = BTDF
AM.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- AM.ALL[1:46,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
AM.ALL[nrow(AM.ALL)+ 1,] = MMKPR
AM.ALL[nrow(AM.ALL)+ 1,] = MMKTR
AM.ALL[nrow(AM.ALL)+ 1,] = MMKSR
AM.ALL
```

```{r}
AM.NUM <- as.data.frame(apply(AM.ALL[1:55,2:40], 2, as.numeric))
str(AM.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(AM.NUM[52,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(AM.NUM[51,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(AM.NUM[55,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(AM.NUM[50,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(AM.NUM[53,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
AM.ALL[nrow(AM.ALL)+ 1,] = FSR1
AM.ALL[nrow(AM.ALL)+ 1,] = FSR2
AM.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
AMFM <-AM.ALL[c(56,57),-1]
AMF <- as.matrix(apply(AMFM, 2, as.numeric))
AMF
```
###########################################################

###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(AM.ALL[21:46,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
AM.TS2 <-AM.ALL[21:46,1:40] ## 1990 Subset
AM.TSN2 <- as.data.frame(apply(AM.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(AM.TSN2, class)   
AM.TSN2
```
############################################
```{r}
AMM1 <- mblm(AN_RO_mm~ Water_Year_Year, AM.TSN2)
AMM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AM.TSN2)
AMM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AM.TSN2)
AMM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AM.TSN2)
AMM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AM.TSN2)
AMM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AM.TSN2)
AMM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AM.TSN2)
AMM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AM.TSN2)
AMM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AM.TSN2)
AMM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AM.TSN2)
AMM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AM.TSN2)
AMM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AM.TSN2)
AMM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AM.TSN2)
AMM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AM.TSN2)
AMM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AM.TSN2)
AMM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AM.TSN2)
AMM17 <- mblm(May_RO_mm~ Water_Year_Year, AM.TSN2)
AMM18 <- mblm(May_PCP_mm~ Water_Year_Year, AM.TSN2)
AMM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AM.TSN2)
AMM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AM.TSN2)
AMM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AM.TSN2)
AMM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AM.TSN2)
AMM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AM.TSN2)
AMM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AM.TSN2)
AMM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AM.TSN2)
AMM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AM.TSN2)
AMM27 <- mblm(AN_RR~ Water_Year_Year, AM.TSN2)
AMM28 <- mblm(OCT_RR~ Water_Year_Year, AM.TSN2)
AMM29 <- mblm(NOV_RR~ Water_Year_Year, AM.TSN2)
AMM30 <- mblm(DEC_RR~ Water_Year_Year, AM.TSN2)
AMM31 <- mblm(JAN_RR~ Water_Year_Year, AM.TSN2)
AMM32 <- mblm(FEB_RR~ Water_Year_Year, AM.TSN2)
AMM33 <- mblm(MAR_RR~ Water_Year_Year, AM.TSN2)
AMM34 <- mblm(APL_RR~ Water_Year_Year, AM.TSN2)
AMM35 <- mblm(MAY_RR~ Water_Year_Year, AM.TSN2)
AMM36 <- mblm(JUN_RR~ Water_Year_Year, AM.TSN2)
AMM37 <- mblm(JUL_RR~ Water_Year_Year, AM.TSN2)
AMM38 <- mblm(AUG_RR~ Water_Year_Year, AM.TSN2)
AMM39 <- mblm(SEP_RR~ Water_Year_Year, AM.TSN2)
```
####################################
```{r}
TSR2<- cbind(AMM1$coefficients, AMM2$coefficients, AMM3$coefficients, AMM4$coefficients, AMM5$coefficients, AMM6$coefficients,AMM7$coefficients, AMM8$coefficients, AMM9$coefficients,AMM10$coefficients, AMM11$coefficients, AMM12$coefficients,AMM13$coefficients, AMM14$coefficients, AMM15$coefficients,AMM16$coefficients, AMM17$coefficients, AMM18$coefficients,AMM19$coefficients, AMM20$coefficients, AMM21$coefficients,AMM22$coefficients, AMM23$coefficients, AMM4$coefficients,AMM25$coefficients, AMM26$coefficients, AMM27$coefficients,AMM28$coefficients, AMM29$coefficients, AMM30$coefficients,AMM31$coefficients, AMM32$coefficients, AMM33$coefficients,AMM34$coefficients, AMM35$coefficients, AMM36$coefficients,AMM37$coefficients, AMM38$coefficients, AMM39$coefficients)
RES2 <- cbind(AMM1$residuals, AMM2$residuals, AMM3$residuals, AMM4$residuals, AMM5$residuals, AMM6$residuals,AMM7$residuals, AMM8$residuals, AMM9$residuals,AMM10$residuals, AMM11$residuals, AMM12$residuals,AMM13$residuals, AMM14$residuals, AMM15$residuals,AMM16$residuals, AMM17$residuals, AMM18$residuals,AMM19$residuals, AMM20$residuals, AMM21$residuals,AMM22$residuals, AMM23$residuals, AMM4$residuals,AMM25$residuals, AMM26$residuals, AMM27$residuals,AMM28$residuals, AMM29$residuals, AMM30$residuals,AMM31$residuals, AMM32$residuals, AMM33$residuals,AMM34$residuals, AMM35$residuals, AMM36$residuals,AMM37$residuals, AMM38$residuals, AMM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AM.ALL[nrow(AM.ALL)+ 1,] = MKTR2
AM.ALL[nrow(AM.ALL)+ 1,] = MKPR2
AM.ALL[nrow(AM.ALL)+ 1,] = TSRR2
AM.ALL[nrow(AM.ALL)+ 1,] = BTDF2
AM.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- AM.ALL[21:46,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
AM.ALL[nrow(AM.ALL)+ 1,] = MMKPR2
AM.ALL[nrow(AM.ALL)+ 1,] = MMKTR2
AM.ALL[nrow(AM.ALL)+ 1,] = MMKSR2
AM.ALL
```

```{r}
AM.ALL
```

```{r}
AM.NUM2 <- as.data.frame(apply(AM.ALL[1:64,2:40], 2, as.numeric))
str(AM.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(AM.NUM2[61,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(AM.NUM2[60,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(AM.NUM2[64,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(AM.NUM2[59,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(AM.NUM2[62,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
AM.ALL[nrow(AM.ALL)+ 1,] = FSR12
AM.ALL[nrow(AM.ALL)+ 1,] = FSR22
AM.ALL
```

```{r}
AM.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
AMFM2 <-AM.ALL[c(65,66),-1]
AMF2 <- as.matrix(apply(AMFM2, 2, as.numeric))
AMF2
```



###Malyy Yugan Results, csv ''BG  ID 25
```{r}
### Summarise by Month
BG$Days <- days_in_month(as.Date(BG$Date, "%Y-%m-%d"))
BG$StreamflowMon_m3<- BG$Streamflow*(60*60*24)*BG$Days
BG.MON <- BG 
BG.MON$Streamflow_Km<-BG.MON$StreamflowMon_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
BG.MON$Streamflow_mm<-(BG.MON$Streamflow_Km/8130)*1000000 ## monthly runoff depth mm
BG.MON2 <- subset(BG.MON, Year >= 1969)
##BG.MON2

#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
BG.MONT<- BG.MON2[-c(1,2,3,4,5,6,7,8,9,574,575,576),]
BG.MONT
```

```{r}
BGT <- GMP2[[946:1509]] ## Malyy Yugan
BGE <- extent(74,76.5,59.5,60.5) ## Malyy Yugan
BGPC <- crop(BGT, BGE) ## Malyy Yugan
BG.Mon.Precip.<-extract(BGPC,BGE, method="bilinear", fun = mean)
BGMP<-as.data.frame(colMeans(BG.Mon.Precip.)) # Malyy Yugan
BGSub<-DateTemp[DateTemp$Date >= as.Date("1969-10-01") & DateTemp$Date <=
                    as.Date("2016-09-01"), ] ## Malyy Yugan
BGPp<- cbind(BGMP,BGSub) ## Malyy Yugan
```

```{r}
BG.MONT$GriddedPrecip_mm<- BGMP$`colMeans(BG.Mon.Precip.)`
BG.MONT

```

```{r}
## Gap filling process

BG.M1 <- subset(BG.MONT, Month == 1)
BG.M2 <- subset(BG.MONT, Month == 2)
BG.M3 <- subset(BG.MONT, Month == 3)
BG.M4 <- subset(BG.MONT, Month == 4)
BG.M5 <- subset(BG.MONT, Month == 5)
BG.M6 <- subset(BG.MONT, Month == 6)
BG.M7 <- subset(BG.MONT, Month == 7)
BG.M8 <- subset(BG.MONT, Month == 8)
BG.M9 <- subset(BG.MONT, Month == 9)
BG.M10 <- subset(BG.MONT, Month == 10)
BG.M11 <- subset(BG.MONT, Month == 11)
BG.M12 <- subset(BG.MONT, Month == 12)


BG.1 <-mean(BG.M1$Streamflow_mm, na.rm = TRUE)
BG.2 <- mean(BG.M2$Streamflow_mm, na.rm = TRUE)
BG.3 <- mean(BG.M3$Streamflow_mm, na.rm = TRUE)
BG.4 <- mean(BG.M4$Streamflow_mm, na.rm = TRUE)
BG.5 <-mean(BG.M5$Streamflow_mm, na.rm = TRUE)
BG.6 <- mean(BG.M6$Streamflow_mm, na.rm = TRUE)
BG.7 <- mean(BG.M7$Streamflow_mm, na.rm = TRUE)
BG.8 <- mean(BG.M8$Streamflow_mm, na.rm = TRUE)
BG.9 <- mean(BG.M9$Streamflow_mm, na.rm = TRUE)
BG.10 <- mean(BG.M10$Streamflow_mm, na.rm = TRUE)
BG.11 <- mean(BG.M11$Streamflow_mm, na.rm = TRUE)
BG.12 <- mean(BG.M12$Streamflow_mm, na.rm = TRUE)

BG.MONT[c(328,340,352,376,388,400,412,424,436,448,472,484,496,508,520,532,544,556),9] <- BG.1
BG.MONT[c(293,329,341,353,377,389,401,413,425,437,449,473,485,497,509,521,533,545,557),9] <- BG.2
BG.MONT[c(294,330,342,354,378,390,402,414,426,438,450,474,486,498,510,522,534,546,558),9] <- BG.3
BG.MONT[c(295,331,343,355,367,379,391,403,415,427,439,451,475,487,499,511,523,535,547,559),9] <- BG.4
BG.MONT[c(296,332,356,368,380,392,404,416,428,452,476,488,500,512,524,536,548,560),9] <- BG.5
BG.MONT[c(297,333,345,357,369,381,393,405,417,429,453,477,489,501,513,525,537,549,561),9] <- BG.6
BG.MONT[c(298,322,334,346,358,370,382,394,406,418,454,478,490,502,514,526,538,550,562),9] <- BG.7
BG.MONT[c(299,323,335,347,359,371,383,395,407,419,455,479,491,503,515,527,539,551,563),9] <- BG.8
BG.MONT[c(300,324,336,348,372,384,396,408,420,456,480,492,504,516,528,540,552),9] <- BG.9
BG.MONT[c(301,325,337,349,373,385,397,409,421,445,457,481,493,505,517,529,541,553),9] <- BG.10
BG.MONT[c(302,326,338,350,374,386,398,410,422,446,458,482,494,506,518,530,542,554),9] <- BG.11
BG.MONT[c(303,327,339,351,375,387,399,411,423,447,459,483,495,507,519,531,543,555),9] <- BG.12

BG.MONT
```


##############
```{r}
## Water Year Sequencing
BG.MT<- BG.MONT
BG.MT$Water_Year_Month <- rep(seq(1:12),47) #1975 to 2016 is 43 years
BG.MT$Water_Year_Year <- rep(1:47, each =12)
BG.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 BG.WY <- BG.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
BG.WY
```
##############
```{r}
## Monthly Columns
## Oct
 BG.OCT <- BG.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 BG.NOV <- BG.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 BG.DEC <- BG.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 BG.JAN <- BG.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 BG.FEB <- BG.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 BG.MAR <- BG.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 BG.APL <- BG.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 BG.MAY <- BG.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 BG.JUN <- BG.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 BG.JUL <- BG.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 BG.AUG <- BG.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 BG.SEP <- BG.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
BG.ALL <- cbind(BG.WY, BG.OCT[,-1], BG.NOV[,-1], BG.DEC[,-1], BG.JAN[,-1], BG.FEB[,-1], BG.MAR[,-1], BG.APL[,-1],BG.MAY[,-1], BG.JUN[,-1], BG.JUL[,-1], BG.AUG[,-1], BG.SEP[,-1])
```
####################
```{r}
BG.ALL$AN_RR <- BG.ALL$AN_RO_mm/BG.ALL$AN_PCP_mm
BG.ALL$OCT_RR <- BG.ALL$Oct_RO_mm/BG.ALL$Oct_PCP_mm
BG.ALL$NOV_RR <- BG.ALL$Nov_RO_mm/BG.ALL$Nov_PCP_mm
BG.ALL$DEC_RR <- BG.ALL$Dec_RO_mm/BG.ALL$Dec_PCP_mm
BG.ALL$JAN_RR <- BG.ALL$Jan_RO_mm/BG.ALL$Jan_PCP_mm
BG.ALL$FEB_RR <- BG.ALL$Feb_RO_mm/BG.ALL$Feb_PCP_mm
BG.ALL$MAR_RR <- BG.ALL$Mar_RO_mm/BG.ALL$Mar_PCP_mm
BG.ALL$APL_RR <- BG.ALL$Apl_RO_mm/BG.ALL$Apl_PCP_mm
BG.ALL$MAY_RR <- BG.ALL$May_RO_mm/BG.ALL$May_PCP_mm
BG.ALL$JUN_RR <- BG.ALL$Jun_RO_mm/BG.ALL$Jun_PCP_mm
BG.ALL$JUL_RR <- BG.ALL$Jul_RO_mm/BG.ALL$Jul_PCP_mm
BG.ALL$AUG_RR <- BG.ALL$Aug_RO_mm/BG.ALL$Aug_PCP_mm
BG.ALL$SEP_RR <- BG.ALL$Sep_RO_mm/BG.ALL$Sep_PCP_mm
BG.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(BG.ALL[,-1],2, mean))
CSD <- rbind(apply(BG.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
BG.ALL[nrow(BG.ALL)+ 1,] = CML
BG.ALL[nrow(BG.ALL)+ 1,] = CSDL
BG.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(BG.ALL[1:47,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
BG.TS <-BG.ALL[1:47,1:40]
BG.TSN <- as.data.frame(apply(BG.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(BG.TSN, class)   
BG.TSN
```
############################################
```{r}
BGM1 <- mblm(AN_RO_mm~ Water_Year_Year, BG.TSN)
BGM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BG.TSN)
BGM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BG.TSN)
BGM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BG.TSN)
BGM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BG.TSN)
BGM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BG.TSN)
BGM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BG.TSN)
BGM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BG.TSN)
BGM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BG.TSN)
BGM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BG.TSN)
BGM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BG.TSN)
BGM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BG.TSN)
BGM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BG.TSN)
BGM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BG.TSN)
BGM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BG.TSN)
BGM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BG.TSN)
BGM17 <- mblm(May_RO_mm~ Water_Year_Year, BG.TSN)
BGM18 <- mblm(May_PCP_mm~ Water_Year_Year, BG.TSN)
BGM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BG.TSN)
BGM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BG.TSN)
BGM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BG.TSN)
BGM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BG.TSN)
BGM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BG.TSN)
BGM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BG.TSN)
BGM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BG.TSN)
BGM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BG.TSN)
BGM27 <- mblm(AN_RR~ Water_Year_Year, BG.TSN)
BGM28 <- mblm(OCT_RR~ Water_Year_Year, BG.TSN)
BGM29 <- mblm(NOV_RR~ Water_Year_Year, BG.TSN)
BGM30 <- mblm(DEC_RR~ Water_Year_Year, BG.TSN)
BGM31 <- mblm(JAN_RR~ Water_Year_Year, BG.TSN)
BGM32 <- mblm(FEB_RR~ Water_Year_Year, BG.TSN)
BGM33 <- mblm(MAR_RR~ Water_Year_Year, BG.TSN)
BGM34 <- mblm(APL_RR~ Water_Year_Year, BG.TSN)
BGM35 <- mblm(MAY_RR~ Water_Year_Year, BG.TSN)
BGM36 <- mblm(JUN_RR~ Water_Year_Year, BG.TSN)
BGM37 <- mblm(JUL_RR~ Water_Year_Year, BG.TSN)
BGM38 <- mblm(AUG_RR~ Water_Year_Year, BG.TSN)
BGM39 <- mblm(SEP_RR~ Water_Year_Year, BG.TSN)
```
####################################
```{r}
TSR<- cbind(BGM1$coefficients, BGM2$coefficients, BGM3$coefficients, BGM4$coefficients, BGM5$coefficients, BGM6$coefficients,BGM7$coefficients, BGM8$coefficients, BGM9$coefficients,BGM10$coefficients, BGM11$coefficients, BGM12$coefficients,BGM13$coefficients, BGM14$coefficients, BGM15$coefficients,BGM16$coefficients, BGM17$coefficients, BGM18$coefficients,BGM19$coefficients, BGM20$coefficients, BGM21$coefficients,BGM22$coefficients, BGM23$coefficients, BGM4$coefficients,BGM25$coefficients, BGM26$coefficients, BGM27$coefficients,BGM28$coefficients, BGM29$coefficients, BGM30$coefficients,BGM31$coefficients, BGM32$coefficients, BGM33$coefficients,BGM34$coefficients, BGM35$coefficients, BGM36$coefficients,BGM37$coefficients, BGM38$coefficients, BGM39$coefficients)
RES <- cbind(BGM1$residuals, BGM2$residuals, BGM3$residuals, BGM4$residuals, BGM5$residuals, BGM6$residuals,BGM7$residuals, BGM8$residuals, BGM9$residuals,BGM10$residuals, BGM11$residuals, BGM12$residuals,BGM13$residuals, BGM14$residuals, BGM15$residuals,BGM16$residuals, BGM17$residuals, BGM18$residuals,BGM19$residuals, BGM20$residuals, BGM21$residuals,BGM22$residuals, BGM23$residuals, BGM4$residuals,BGM25$residuals, BGM26$residuals, BGM27$residuals,BGM28$residuals, BGM29$residuals, BGM30$residuals,BGM31$residuals, BGM32$residuals, BGM33$residuals,BGM34$residuals, BGM35$residuals, BGM36$residuals,BGM37$residuals, BGM38$residuals, BGM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BG.ALL[nrow(BG.ALL)+ 1,] = MKTR
BG.ALL[nrow(BG.ALL)+ 1,] = MKPR
BG.ALL[nrow(BG.ALL)+ 1,] = TSRR
BG.ALL[nrow(BG.ALL)+ 1,] = BTDF
BG.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- BG.ALL[1:47,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
BG.ALL[nrow(BG.ALL)+ 1,] = MMKPR
BG.ALL[nrow(BG.ALL)+ 1,] = MMKTR
BG.ALL[nrow(BG.ALL)+ 1,] = MMKSR
BG.ALL
```

```{r}
BG.NUM <- as.data.frame(apply(BG.ALL[1:56,2:40], 2, as.numeric))
str(BG.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(BG.NUM[53,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(BG.NUM[52,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(BG.NUM[56,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(BG.NUM[51,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(BG.NUM[54,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
BG.ALL[nrow(BG.ALL)+ 1,] = FSR1
BG.ALL[nrow(BG.ALL)+ 1,] = FSR2
BG.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
BGFM <-BG.ALL[c(57,58),-1]
BGF <- as.matrix(apply(BGFM, 2, as.numeric))
BGF
```

###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(BG.ALL[21:47,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
BG.TS2 <-BG.ALL[21:47,1:40] ## 1990 Subset
BG.TSN2 <- as.data.frame(apply(BG.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(BG.TSN2, class)   
BG.TSN2
```
############################################
```{r}
BGM1 <- mblm(AN_RO_mm~ Water_Year_Year, BG.TSN2)
BGM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BG.TSN2)
BGM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BG.TSN2)
BGM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BG.TSN2)
BGM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BG.TSN2)
BGM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BG.TSN2)
BGM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BG.TSN2)
BGM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BG.TSN2)
BGM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BG.TSN2)
BGM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BG.TSN2)
BGM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BG.TSN2)
BGM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BG.TSN2)
BGM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BG.TSN2)
BGM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BG.TSN2)
BGM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BG.TSN2)
BGM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BG.TSN2)
BGM17 <- mblm(May_RO_mm~ Water_Year_Year, BG.TSN2)
BGM18 <- mblm(May_PCP_mm~ Water_Year_Year, BG.TSN2)
BGM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BG.TSN2)
BGM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BG.TSN2)
BGM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BG.TSN2)
BGM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BG.TSN2)
BGM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BG.TSN2)
BGM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BG.TSN2)
BGM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BG.TSN2)
BGM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BG.TSN2)
BGM27 <- mblm(AN_RR~ Water_Year_Year, BG.TSN2)
BGM28 <- mblm(OCT_RR~ Water_Year_Year, BG.TSN2)
BGM29 <- mblm(NOV_RR~ Water_Year_Year, BG.TSN2)
BGM30 <- mblm(DEC_RR~ Water_Year_Year, BG.TSN2)
BGM31 <- mblm(JAN_RR~ Water_Year_Year, BG.TSN2)
BGM32 <- mblm(FEB_RR~ Water_Year_Year, BG.TSN2)
BGM33 <- mblm(MAR_RR~ Water_Year_Year, BG.TSN2)
BGM34 <- mblm(APL_RR~ Water_Year_Year, BG.TSN2)
BGM35 <- mblm(MAY_RR~ Water_Year_Year, BG.TSN2)
BGM36 <- mblm(JUN_RR~ Water_Year_Year, BG.TSN2)
BGM37 <- mblm(JUL_RR~ Water_Year_Year, BG.TSN2)
BGM38 <- mblm(AUG_RR~ Water_Year_Year, BG.TSN2)
BGM39 <- mblm(SEP_RR~ Water_Year_Year, BG.TSN2)
```
####################################
```{r}
TSR2<- cbind(BGM1$coefficients, BGM2$coefficients, BGM3$coefficients, BGM4$coefficients, BGM5$coefficients, BGM6$coefficients,BGM7$coefficients, BGM8$coefficients, BGM9$coefficients,BGM10$coefficients, BGM11$coefficients, BGM12$coefficients,BGM13$coefficients, BGM14$coefficients, BGM15$coefficients,BGM16$coefficients, BGM17$coefficients, BGM18$coefficients,BGM19$coefficients, BGM20$coefficients, BGM21$coefficients,BGM22$coefficients, BGM23$coefficients, BGM4$coefficients,BGM25$coefficients, BGM26$coefficients, BGM27$coefficients,BGM28$coefficients, BGM29$coefficients, BGM30$coefficients,BGM31$coefficients, BGM32$coefficients, BGM33$coefficients,BGM34$coefficients, BGM35$coefficients, BGM36$coefficients,BGM37$coefficients, BGM38$coefficients, BGM39$coefficients)
RES2 <- cbind(BGM1$residuals, BGM2$residuals, BGM3$residuals, BGM4$residuals, BGM5$residuals, BGM6$residuals,BGM7$residuals, BGM8$residuals, BGM9$residuals,BGM10$residuals, BGM11$residuals, BGM12$residuals,BGM13$residuals, BGM14$residuals, BGM15$residuals,BGM16$residuals, BGM17$residuals, BGM18$residuals,BGM19$residuals, BGM20$residuals, BGM21$residuals,BGM22$residuals, BGM23$residuals, BGM4$residuals,BGM25$residuals, BGM26$residuals, BGM27$residuals,BGM28$residuals, BGM29$residuals, BGM30$residuals,BGM31$residuals, BGM32$residuals, BGM33$residuals,BGM34$residuals, BGM35$residuals, BGM36$residuals,BGM37$residuals, BGM38$residuals, BGM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BG.ALL[nrow(BG.ALL)+ 1,] = MKTR2
BG.ALL[nrow(BG.ALL)+ 1,] = MKPR2
BG.ALL[nrow(BG.ALL)+ 1,] = TSRR2
BG.ALL[nrow(BG.ALL)+ 1,] = BTDF2
BG.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- BG.ALL[21:47,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
BG.ALL[nrow(BG.ALL)+ 1,] = MMKPR2
BG.ALL[nrow(BG.ALL)+ 1,] = MMKTR2
BG.ALL[nrow(BG.ALL)+ 1,] = MMKSR2
BG.ALL
```

```{r}
BG.ALL
```

```{r}
BG.NUM2 <- as.data.frame(apply(BG.ALL[1:65,2:40], 2, as.numeric))
str(BG.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(BG.NUM2[62,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(BG.NUM2[61,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(BG.NUM2[65,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(BG.NUM2[60,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(BG.NUM2[63,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
BG.ALL[nrow(BG.ALL)+ 1,] = FSR12
BG.ALL[nrow(BG.ALL)+ 1,] = FSR22
BG.ALL
```

```{r}
BG.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
BGFM2 <-BG.ALL[c(66,67),-1]
BGF2 <- as.matrix(apply(BGFM2, 2, as.numeric))
BGF2
```

###Nazyma Results, csv 'BH' ID 26
```{r}
### Summarise by Month
BH$Days <- days_in_month(as.Date(BH$Date, "%Y-%m-%d"))
BH[c(126,127,128),2] <- NA
BH$StreamflowMon_m3<- BH$Streamflow*(60*60*24)*BH$Days
BH.MON <- BH 
BH.MON$Streamflow_Km<-BH.MON$StreamflowMon_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
BH.MON$Streamflow_mm<-(BH.MON$Streamflow_Km/11500)*1000000 ## monthly runoff depth mm
BH.MONT<- BH.MON[-c(1,2,3,4,5,6,7,8,9,574,575,576,577,578,579,580,581,582,583,584,585,586,587,588),]
BH.MONT
```

```{r}
BHT <- GMP2[[946:1509]] ## Nazym
BHE <- extent(67,69,61.5,63) ## Nazym
BHPC <- crop(BHT, BHE) ## Nazym
BH.Mon.Precip.<-extract(BHPC,BHE, method="bilinear", fun = mean)
BHMP<-as.data.frame(colMeans(BH.Mon.Precip.)) # Nazym
BHSub<-DateTemp[DateTemp$Date >= as.Date("1969-10-01") & DateTemp$Date <=
                    as.Date("2016-09-01"), ] ##Nazyma
BHPp<- cbind(BHMP,BHSub) ## Nazyma
```

```{r}
BH.MONT$GriddedPrecip_mm<- BHMP$`colMeans(BH.Mon.Precip.)`
BH.MONT
```

```{r}
#Gap filling process

BH.M1 <- subset(BH.MONT, Month == 1)
BH.M2 <- subset(BH.MONT, Month == 2)
BH.M3 <- subset(BH.MONT, Month == 3)
BH.M4 <- subset(BH.MONT, Month == 4)
BH.M5 <- subset(BH.MONT, Month == 5)
BH.M6 <- subset(BH.MONT, Month == 6)
BH.M7 <- subset(BH.MONT, Month == 7)
BH.M8 <- subset(BH.MONT, Month == 8)
BH.M9 <- subset(BH.MONT, Month == 9)
BH.M10 <- subset(BH.MONT, Month == 10)
BH.M11 <- subset(BH.MONT, Month == 11)
BH.M12 <- subset(BH.MONT, Month == 12)


BH.1 <-mean(BH.M1$Streamflow_mm, na.rm = TRUE)
BH.2 <- mean(BH.M2$Streamflow_mm, na.rm = TRUE)
BH.3 <- mean(BH.M3$Streamflow_mm, na.rm = TRUE)
BH.4 <- mean(BH.M4$Streamflow_mm, na.rm = TRUE)
BH.5 <-mean(BH.M5$Streamflow_mm, na.rm = TRUE)
BH.6 <- mean(BH.M6$Streamflow_mm, na.rm = TRUE)
BH.7 <- mean(BH.M7$Streamflow_mm, na.rm = TRUE)
BH.8 <- mean(BH.M8$Streamflow_mm, na.rm = TRUE)
BH.9 <- mean(BH.M9$Streamflow_mm, na.rm = TRUE)
BH.10 <- mean(BH.M10$Streamflow_mm, na.rm = TRUE)
BH.11 <- mean(BH.M11$Streamflow_mm, na.rm = TRUE)
BH.12 <- mean(BH.M12$Streamflow_mm, na.rm = TRUE)

BH.MONT[c(256,376,388),9] <- BH.1
BH.MONT[c(257,377),9] <- BH.2
BH.MONT[c(258,378),9] <- BH.3
BH.MONT[c(259,355,379),9] <- BH.4
BH.MONT[c(260,356,368,380),9] <- BH.5
BH.MONT[c(117,261,369,381),9] <- BH.6
BH.MONT[c(118,262,346,370,382),9] <- BH.7
BH.MONT[c(119,263,371,383),9] <- BH.8
BH.MONT[c(264,372,384),9] <- BH.9
BH.MONT[c(265,373,385),9] <- BH.10
BH.MONT[c(266,350,374,386,458),9] <- BH.11
BH.MONT[c(267,375,387,459),9] <- BH.12


BH.MONT
```

```{r}
ggplot(BH.MONT, aes(x= as.Date(Date), y = Streamflow_mm)) + geom_line()+ theme_bw()
```

##############
```{r}
## Water Year Sequencing
BH.MT<- BH.MONT
BH.MT$Water_Year_Month <- rep(seq(1:12),47) #1975 to 2016 is 43 years
BH.MT$Water_Year_Year <- rep(1:47, each =12)
BH.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 BH.WY <- BH.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
BH.WY
```
##############
```{r}
## Monthly Columns
## Oct
 BH.OCT <- BH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 BH.NOV <- BH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 BH.DEC <- BH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 BH.JAN <- BH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 BH.FEB <- BH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 BH.MAR <- BH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 BH.APL <- BH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 BH.MAY <- BH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 BH.JUN <- BH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 BH.JUL <- BH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 BH.AUG <- BH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 BH.SEP <- BH.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
BH.ALL <- cbind(BH.WY, BH.OCT[,-1], BH.NOV[,-1], BH.DEC[,-1], BH.JAN[,-1], BH.FEB[,-1], BH.MAR[,-1], BH.APL[,-1],BH.MAY[,-1], BH.JUN[,-1], BH.JUL[,-1], BH.AUG[,-1], BH.SEP[,-1])
```
####################
```{r}
BH.ALL$AN_RR <- BH.ALL$AN_RO_mm/BH.ALL$AN_PCP_mm
BH.ALL$OCT_RR <- BH.ALL$Oct_RO_mm/BH.ALL$Oct_PCP_mm
BH.ALL$NOV_RR <- BH.ALL$Nov_RO_mm/BH.ALL$Nov_PCP_mm
BH.ALL$DEC_RR <- BH.ALL$Dec_RO_mm/BH.ALL$Dec_PCP_mm
BH.ALL$JAN_RR <- BH.ALL$Jan_RO_mm/BH.ALL$Jan_PCP_mm
BH.ALL$FEB_RR <- BH.ALL$Feb_RO_mm/BH.ALL$Feb_PCP_mm
BH.ALL$MAR_RR <- BH.ALL$Mar_RO_mm/BH.ALL$Mar_PCP_mm
BH.ALL$APL_RR <- BH.ALL$Apl_RO_mm/BH.ALL$Apl_PCP_mm
BH.ALL$MAY_RR <- BH.ALL$May_RO_mm/BH.ALL$May_PCP_mm
BH.ALL$JUN_RR <- BH.ALL$Jun_RO_mm/BH.ALL$Jun_PCP_mm
BH.ALL$JUL_RR <- BH.ALL$Jul_RO_mm/BH.ALL$Jul_PCP_mm
BH.ALL$AUG_RR <- BH.ALL$Aug_RO_mm/BH.ALL$Aug_PCP_mm
BH.ALL$SEP_RR <- BH.ALL$Sep_RO_mm/BH.ALL$Sep_PCP_mm
BH.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(BH.ALL[,-1],2, mean))
CSD <- rbind(apply(BH.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
BH.ALL[nrow(BH.ALL)+ 1,] = CML
BH.ALL[nrow(BH.ALL)+ 1,] = CSDL
BH.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(BH.ALL[1:47,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
BH.TS <-BH.ALL[1:47,1:40]
BH.TSN <- as.data.frame(apply(BH.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(BH.TSN, class)   
BH.TSN
```
############################################
```{r}
BLM1 <- mblm(AN_RO_mm~ Water_Year_Year, BH.TSN)
BLM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BH.TSN)
BLM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BH.TSN)
BLM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BH.TSN)
BLM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BH.TSN)
BLM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BH.TSN)
BLM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BH.TSN)
BLM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BH.TSN)
BLM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BH.TSN)
BLM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BH.TSN)
BLM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BH.TSN)
BLM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BH.TSN)
BLM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BH.TSN)
BLM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BH.TSN)
BLM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BH.TSN)
BLM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BH.TSN)
BLM17 <- mblm(May_RO_mm~ Water_Year_Year, BH.TSN)
BLM18 <- mblm(May_PCP_mm~ Water_Year_Year, BH.TSN)
BLM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BH.TSN)
BLM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BH.TSN)
BLM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BH.TSN)
BLM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BH.TSN)
BLM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BH.TSN)
BLM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BH.TSN)
BLM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BH.TSN)
BLM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BH.TSN)
BLM27 <- mblm(AN_RR~ Water_Year_Year, BH.TSN)
BLM28 <- mblm(OCT_RR~ Water_Year_Year, BH.TSN)
BLM29 <- mblm(NOV_RR~ Water_Year_Year, BH.TSN)
BLM30 <- mblm(DEC_RR~ Water_Year_Year, BH.TSN)
BLM31 <- mblm(JAN_RR~ Water_Year_Year, BH.TSN)
BLM32 <- mblm(FEB_RR~ Water_Year_Year, BH.TSN)
BLM33 <- mblm(MAR_RR~ Water_Year_Year, BH.TSN)
BLM34 <- mblm(APL_RR~ Water_Year_Year, BH.TSN)
BLM35 <- mblm(MAY_RR~ Water_Year_Year, BH.TSN)
BLM36 <- mblm(JUN_RR~ Water_Year_Year, BH.TSN)
BLM37 <- mblm(JUL_RR~ Water_Year_Year, BH.TSN)
BLM38 <- mblm(AUG_RR~ Water_Year_Year, BH.TSN)
BLM39 <- mblm(SEP_RR~ Water_Year_Year, BH.TSN)
```
####################################
```{r}
TSR<- cbind(BLM1$coefficients, BLM2$coefficients, BLM3$coefficients, BLM4$coefficients, BLM5$coefficients, BLM6$coefficients,BLM7$coefficients, BLM8$coefficients, BLM9$coefficients,BLM10$coefficients, BLM11$coefficients, BLM12$coefficients,BLM13$coefficients, BLM14$coefficients, BLM15$coefficients,BLM16$coefficients, BLM17$coefficients, BLM18$coefficients,BLM19$coefficients, BLM20$coefficients, BLM21$coefficients,BLM22$coefficients, BLM23$coefficients, BLM4$coefficients,BLM25$coefficients, BLM26$coefficients, BLM27$coefficients,BLM28$coefficients, BLM29$coefficients, BLM30$coefficients,BLM31$coefficients, BLM32$coefficients, BLM33$coefficients,BLM34$coefficients, BLM35$coefficients, BLM36$coefficients,BLM37$coefficients, BLM38$coefficients, BLM39$coefficients)
RES <- cbind(BLM1$residuals, BLM2$residuals, BLM3$residuals, BLM4$residuals, BLM5$residuals, BLM6$residuals,BLM7$residuals, BLM8$residuals, BLM9$residuals,BLM10$residuals, BLM11$residuals, BLM12$residuals,BLM13$residuals, BLM14$residuals, BLM15$residuals,BLM16$residuals, BLM17$residuals, BLM18$residuals,BLM19$residuals, BLM20$residuals, BLM21$residuals,BLM22$residuals, BLM23$residuals, BLM4$residuals,BLM25$residuals, BLM26$residuals, BLM27$residuals,BLM28$residuals, BLM29$residuals, BLM30$residuals,BLM31$residuals, BLM32$residuals, BLM33$residuals,BLM34$residuals, BLM35$residuals, BLM36$residuals,BLM37$residuals, BLM38$residuals, BLM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BH.ALL[nrow(BH.ALL)+ 1,] = MKTR
BH.ALL[nrow(BH.ALL)+ 1,] = MKPR
BH.ALL[nrow(BH.ALL)+ 1,] = TSRR
BH.ALL[nrow(BH.ALL)+ 1,] = BTDF
BH.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- BH.ALL[1:47,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
BH.ALL[nrow(BH.ALL)+ 1,] = MMKPR
BH.ALL[nrow(BH.ALL)+ 1,] = MMKTR
BH.ALL[nrow(BH.ALL)+ 1,] = MMKSR
BH.ALL
```

```{r}
BH.NUM <- as.data.frame(apply(BH.ALL[1:56,2:40], 2, as.numeric))
str(BH.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(BH.NUM[53,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(BH.NUM[52,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(BH.NUM[56,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(BH.NUM[51,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(BH.NUM[54,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
BH.ALL[nrow(BH.ALL)+ 1,] = FSR1
BH.ALL[nrow(BH.ALL)+ 1,] = FSR2
BH.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
BHFM <-BH.ALL[c(57,58),-1]
BHF <- as.matrix(apply(BHFM, 2, as.numeric))
BHF
```

###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(BH.ALL[21:47,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
BH.TS2 <-BH.ALL[21:47,1:40] ## 1990 Subset
BH.TSN2 <- as.data.frame(apply(BH.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(BH.TSN2, class)   
BH.TSN2
```
############################################
```{r}
BLM1 <- mblm(AN_RO_mm~ Water_Year_Year, BH.TSN2)
BLM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BH.TSN2)
BLM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BH.TSN2)
BLM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BH.TSN2)
BLM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BH.TSN2)
BLM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BH.TSN2)
BLM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BH.TSN2)
BLM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BH.TSN2)
BLM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BH.TSN2)
BLM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BH.TSN2)
BLM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BH.TSN2)
BLM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BH.TSN2)
BLM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BH.TSN2)
BLM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BH.TSN2)
BLM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BH.TSN2)
BLM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BH.TSN2)
BLM17 <- mblm(May_RO_mm~ Water_Year_Year, BH.TSN2)
BLM18 <- mblm(May_PCP_mm~ Water_Year_Year, BH.TSN2)
BLM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BH.TSN2)
BLM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BH.TSN2)
BLM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BH.TSN2)
BLM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BH.TSN2)
BLM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BH.TSN2)
BLM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BH.TSN2)
BLM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BH.TSN2)
BLM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BH.TSN2)
BLM27 <- mblm(AN_RR~ Water_Year_Year, BH.TSN2)
BLM28 <- mblm(OCT_RR~ Water_Year_Year, BH.TSN2)
BLM29 <- mblm(NOV_RR~ Water_Year_Year, BH.TSN2)
BLM30 <- mblm(DEC_RR~ Water_Year_Year, BH.TSN2)
BLM31 <- mblm(JAN_RR~ Water_Year_Year, BH.TSN2)
BLM32 <- mblm(FEB_RR~ Water_Year_Year, BH.TSN2)
BLM33 <- mblm(MAR_RR~ Water_Year_Year, BH.TSN2)
BLM34 <- mblm(APL_RR~ Water_Year_Year, BH.TSN2)
BLM35 <- mblm(MAY_RR~ Water_Year_Year, BH.TSN2)
BLM36 <- mblm(JUN_RR~ Water_Year_Year, BH.TSN2)
BLM37 <- mblm(JUL_RR~ Water_Year_Year, BH.TSN2)
BLM38 <- mblm(AUG_RR~ Water_Year_Year, BH.TSN2)
BLM39 <- mblm(SEP_RR~ Water_Year_Year, BH.TSN2)
```
####################################
```{r}
TSR2<- cbind(BLM1$coefficients, BLM2$coefficients, BLM3$coefficients, BLM4$coefficients, BLM5$coefficients, BLM6$coefficients,BLM7$coefficients, BLM8$coefficients, BLM9$coefficients,BLM10$coefficients, BLM11$coefficients, BLM12$coefficients,BLM13$coefficients, BLM14$coefficients, BLM15$coefficients,BLM16$coefficients, BLM17$coefficients, BLM18$coefficients,BLM19$coefficients, BLM20$coefficients, BLM21$coefficients,BLM22$coefficients, BLM23$coefficients, BLM4$coefficients,BLM25$coefficients, BLM26$coefficients, BLM27$coefficients,BLM28$coefficients, BLM29$coefficients, BLM30$coefficients,BLM31$coefficients, BLM32$coefficients, BLM33$coefficients,BLM34$coefficients, BLM35$coefficients, BLM36$coefficients,BLM37$coefficients, BLM38$coefficients, BLM39$coefficients)
RES2 <- cbind(BLM1$residuals, BLM2$residuals, BLM3$residuals, BLM4$residuals, BLM5$residuals, BLM6$residuals,BLM7$residuals, BLM8$residuals, BLM9$residuals,BLM10$residuals, BLM11$residuals, BLM12$residuals,BLM13$residuals, BLM14$residuals, BLM15$residuals,BLM16$residuals, BLM17$residuals, BLM18$residuals,BLM19$residuals, BLM20$residuals, BLM21$residuals,BLM22$residuals, BLM23$residuals, BLM4$residuals,BLM25$residuals, BLM26$residuals, BLM27$residuals,BLM28$residuals, BLM29$residuals, BLM30$residuals,BLM31$residuals, BLM32$residuals, BLM33$residuals,BLM34$residuals, BLM35$residuals, BLM36$residuals,BLM37$residuals, BLM38$residuals, BLM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BH.ALL[nrow(BH.ALL)+ 1,] = MKTR2
BH.ALL[nrow(BH.ALL)+ 1,] = MKPR2
BH.ALL[nrow(BH.ALL)+ 1,] = TSRR2
BH.ALL[nrow(BH.ALL)+ 1,] = BTDF2
BH.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- BH.ALL[21:47,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
BH.ALL[nrow(BH.ALL)+ 1,] = MMKPR2
BH.ALL[nrow(BH.ALL)+ 1,] = MMKTR2
BH.ALL[nrow(BH.ALL)+ 1,] = MMKSR2
BH.ALL
```

```{r}
BH.ALL
```

```{r}
BH.NUM2 <- as.data.frame(apply(BH.ALL[1:65,2:40], 2, as.numeric))
str(BH.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(BH.NUM2[62,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(BH.NUM2[61,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(BH.NUM2[65,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(BH.NUM2[60,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(BH.NUM2[63,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
BH.ALL[nrow(BH.ALL)+ 1,] = FSR12
BH.ALL[nrow(BH.ALL)+ 1,] = FSR22
BH.ALL
```

```{r}
BH.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
BHFM2 <-BH.ALL[c(66,67),-1]
BHF2 <- as.matrix(apply(BHFM2, 2, as.numeric))
BHF2
```


###Paydungina Results, BF' ID 27
```{r}
### Summarise by Month
BQ$Days <- days_in_month(as.Date(BQ$Date, "%Y-%m-%d"))
BQ[c(22,23:26),2]<- NA
BQ$StreamflowMon_m3<- BQ$Streamflow*(60*60*24)*BQ$Days
BF.MON <- BQ 
BF.MON$Streamflow_Km<-BF.MON$StreamflowMon_m3/1000000000 # monthly runoff volume km^3
#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
BF.MON$Streamflow_mm<-(BF.MON$Streamflow_Km/6500)*1000000 ## monthly runoff depth mm
BF.MON2<- subset(BF.MON,Year >= 1969)
#BF.MON2

#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
BF.MONT<- BF.MON2[-c(1,2,3,4,5,6,7,8,9,574,575,576),]
BF.MONT
``` 

```{r}
## Gap filling process

BF.M1 <- subset(BF.MONT, Month == 1)
BF.M2 <- subset(BF.MONT, Month == 2)
BF.M3 <- subset(BF.MONT, Month == 3)
BF.M4 <- subset(BF.MONT, Month == 4)
BF.M5 <- subset(BF.MONT, Month == 5)
BF.M6 <- subset(BF.MONT, Month == 6)
BF.M7 <- subset(BF.MONT, Month == 7)
BF.M8 <- subset(BF.MONT, Month == 8)
BF.M9 <- subset(BF.MONT, Month == 9)
BF.M10 <- subset(BF.MONT, Month == 10)
BF.M11 <- subset(BF.MONT, Month == 11)
BF.M12 <- subset(BF.MONT, Month == 12)


BF.1 <-mean(BF.M1$Streamflow_mm, na.rm = TRUE)
BF.2 <- mean(BF.M2$Streamflow_mm, na.rm = TRUE)
BF.3 <- mean(BF.M3$Streamflow_mm, na.rm = TRUE)
BF.4 <- mean(BF.M4$Streamflow_mm, na.rm = TRUE)
BF.5 <-mean(BF.M5$Streamflow_mm, na.rm = TRUE)
BF.6 <- mean(BF.M6$Streamflow_mm, na.rm = TRUE)
BF.7 <- mean(BF.M7$Streamflow_mm, na.rm = TRUE)
BF.8 <- mean(BF.M8$Streamflow_mm, na.rm = TRUE)
BF.9 <- mean(BF.M9$Streamflow_mm, na.rm = TRUE)
BF.10 <- mean(BF.M10$Streamflow_mm, na.rm = TRUE)
BF.11 <- mean(BF.M11$Streamflow_mm, na.rm = TRUE)
BF.12 <- mean(BF.M12$Streamflow_mm, na.rm = TRUE)

BF.MONT[c(304,316,376,412,424,436,448),9] <- BF.1
BF.MONT[c(305,317,377,413,425,437,449),9] <- BF.2
BF.MONT[c(306,318,378,414,426,438,450),9] <- BF.3
BF.MONT[c(307,319,379,415,427,439,451),9] <- BF.4
BF.MONT[c(308,320,380,416,428,440,452),9] <- BF.5
BF.MONT[c(309,321,381,417,429,441,453),9] <- BF.6
BF.MONT[c(310,322,382,418,430,442,454),9] <- BF.7
BF.MONT[c(311,323,383,419,431,443,455),9] <- BF.8
BF.MONT[c(312,324,384,420,432,444,456),9] <- BF.9
BF.MONT[c(313,325,385,421,433,445,457),9] <- BF.10
BF.MONT[c(314,326,386,422,434,446,458),9] <- BF.11
BF.MONT[c(315,327,387,423,435,447,459),9] <- BF.12


BF.MONT
```

```{r}
ggplot(BF.MONT, aes(x= as.Date(Date), y = Streamflow_mm)) + geom_line()+ theme_bw()
```

```{r}
BFT <- GMP2[[946:1509]] ## Berezovka
BFE <- extent(82.5,85,59,60) ## Berezovka
BFPC <- crop(BFT, BFE) ## Berezovka
BF.Mon.Precip.<-extract(BFPC,BFE, method="bilinear", fun = mean)
BFMP<-as.data.frame(colMeans(BF.Mon.Precip.)) # Berezovka
BFSub<-DateTemp[DateTemp$Date >= as.Date("1969-10-01") & DateTemp$Date <=
                    as.Date("2016-09-01"), ] ##Berezovka
BFPp<- cbind(BFMP,BFSub) ## Berezovka
```

```{r}
BF.MONT$GriddedPrecip_mm<- BFMP$`colMeans(BF.Mon.Precip.)`
BF.MONT
```

##############
```{r}
## Water Year Sequencing
BF.MT<- BF.MONT
BF.MT$Water_Year_Month <- rep(seq(1:12),47) #1975 to 2016 is 43 years
BF.MT$Water_Year_Year <- rep(1:47, each =12)
BF.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 BF.WY <- BF.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
BF.WY
```
##############
```{r}
## Monthly Columns
## Oct
 BF.OCT <- BF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 BF.NOV <- BF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 BF.DEC <- BF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 BF.JAN <- BF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 BF.FEB <- BF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 BF.MAR <- BF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 BF.APL <- BF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 BF.MAY <- BF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 BF.JUN <- BF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 BF.JUL <- BF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 BF.AUG <- BF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 BF.SEP <- BF.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
BF.ALL <- cbind(BF.WY, BF.OCT[,-1], BF.NOV[,-1], BF.DEC[,-1], BF.JAN[,-1], BF.FEB[,-1], BF.MAR[,-1], BF.APL[,-1],BF.MAY[,-1], BF.JUN[,-1], BF.JUL[,-1], BF.AUG[,-1], BF.SEP[,-1])
```
####################
```{r}
BF.ALL$AN_RR <- BF.ALL$AN_RO_mm/BF.ALL$AN_PCP_mm
BF.ALL$OCT_RR <- BF.ALL$Oct_RO_mm/BF.ALL$Oct_PCP_mm
BF.ALL$NOV_RR <- BF.ALL$Nov_RO_mm/BF.ALL$Nov_PCP_mm
BF.ALL$DEC_RR <- BF.ALL$Dec_RO_mm/BF.ALL$Dec_PCP_mm
BF.ALL$JAN_RR <- BF.ALL$Jan_RO_mm/BF.ALL$Jan_PCP_mm
BF.ALL$FEB_RR <- BF.ALL$Feb_RO_mm/BF.ALL$Feb_PCP_mm
BF.ALL$MAR_RR <- BF.ALL$Mar_RO_mm/BF.ALL$Mar_PCP_mm
BF.ALL$APL_RR <- BF.ALL$Apl_RO_mm/BF.ALL$Apl_PCP_mm
BF.ALL$MAY_RR <- BF.ALL$May_RO_mm/BF.ALL$May_PCP_mm
BF.ALL$JUN_RR <- BF.ALL$Jun_RO_mm/BF.ALL$Jun_PCP_mm
BF.ALL$JUL_RR <- BF.ALL$Jul_RO_mm/BF.ALL$Jul_PCP_mm
BF.ALL$AUG_RR <- BF.ALL$Aug_RO_mm/BF.ALL$Aug_PCP_mm
BF.ALL$SEP_RR <- BF.ALL$Sep_RO_mm/BF.ALL$Sep_PCP_mm
BF.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(BF.ALL[,-1],2, mean))
CSD <- rbind(apply(BF.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
BF.ALL[nrow(BF.ALL)+ 1,] = CML
BF.ALL[nrow(BF.ALL)+ 1,] = CSDL
BF.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(BF.ALL[1:47,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
BF.TS <-BF.ALL[1:47,1:40]
BF.TSN <- as.data.frame(apply(BF.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(BF.TSN, class)   
BF.TSN
```
############################################
```{r}
BFM1 <- mblm(AN_RO_mm~ Water_Year_Year, BF.TSN)
BFM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BF.TSN)
BFM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BF.TSN)
BFM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BF.TSN)
BFM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BF.TSN)
BFM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BF.TSN)
BFM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BF.TSN)
BFM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BF.TSN)
BFM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BF.TSN)
BFM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BF.TSN)
BFM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BF.TSN)
BFM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BF.TSN)
BFM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BF.TSN)
BFM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BF.TSN)
BFM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BF.TSN)
BFM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BF.TSN)
BFM17 <- mblm(May_RO_mm~ Water_Year_Year, BF.TSN)
BFM18 <- mblm(May_PCP_mm~ Water_Year_Year, BF.TSN)
BFM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BF.TSN)
BFM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BF.TSN)
BFM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BF.TSN)
BFM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BF.TSN)
BFM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BF.TSN)
BFM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BF.TSN)
BFM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BF.TSN)
BFM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BF.TSN)
BFM27 <- mblm(AN_RR~ Water_Year_Year, BF.TSN)
BFM28 <- mblm(OCT_RR~ Water_Year_Year, BF.TSN)
BFM29 <- mblm(NOV_RR~ Water_Year_Year, BF.TSN)
BFM30 <- mblm(DEC_RR~ Water_Year_Year, BF.TSN)
BFM31 <- mblm(JAN_RR~ Water_Year_Year, BF.TSN)
BFM32 <- mblm(FEB_RR~ Water_Year_Year, BF.TSN)
BFM33 <- mblm(MAR_RR~ Water_Year_Year, BF.TSN)
BFM34 <- mblm(APL_RR~ Water_Year_Year, BF.TSN)
BFM35 <- mblm(MAY_RR~ Water_Year_Year, BF.TSN)
BFM36 <- mblm(JUN_RR~ Water_Year_Year, BF.TSN)
BFM37 <- mblm(JUL_RR~ Water_Year_Year, BF.TSN)
BFM38 <- mblm(AUG_RR~ Water_Year_Year, BF.TSN)
BFM39 <- mblm(SEP_RR~ Water_Year_Year, BF.TSN)
```
####################################
```{r}
TSR<- cbind(BFM1$coefficients, BFM2$coefficients, BFM3$coefficients, BFM4$coefficients, BFM5$coefficients, BFM6$coefficients,BFM7$coefficients, BFM8$coefficients, BFM9$coefficients,BFM10$coefficients, BFM11$coefficients, BFM12$coefficients,BFM13$coefficients, BFM14$coefficients, BFM15$coefficients,BFM16$coefficients, BFM17$coefficients, BFM18$coefficients,BFM19$coefficients, BFM20$coefficients, BFM21$coefficients,BFM22$coefficients, BFM23$coefficients, BFM4$coefficients,BFM25$coefficients, BFM26$coefficients, BFM27$coefficients,BFM28$coefficients, BFM29$coefficients, BFM30$coefficients,BFM31$coefficients, BFM32$coefficients, BFM33$coefficients,BFM34$coefficients, BFM35$coefficients, BFM36$coefficients,BFM37$coefficients, BFM38$coefficients, BFM39$coefficients)
RES <- cbind(BFM1$residuals, BFM2$residuals, BFM3$residuals, BFM4$residuals, BFM5$residuals, BFM6$residuals,BFM7$residuals, BFM8$residuals, BFM9$residuals,BFM10$residuals, BFM11$residuals, BFM12$residuals,BFM13$residuals, BFM14$residuals, BFM15$residuals,BFM16$residuals, BFM17$residuals, BFM18$residuals,BFM19$residuals, BFM20$residuals, BFM21$residuals,BFM22$residuals, BFM23$residuals, BFM4$residuals,BFM25$residuals, BFM26$residuals, BFM27$residuals,BFM28$residuals, BFM29$residuals, BFM30$residuals,BFM31$residuals, BFM32$residuals, BFM33$residuals,BFM34$residuals, BFM35$residuals, BFM36$residuals,BFM37$residuals, BFM38$residuals, BFM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BF.ALL[nrow(BF.ALL)+ 1,] = MKTR
BF.ALL[nrow(BF.ALL)+ 1,] = MKPR
BF.ALL[nrow(BF.ALL)+ 1,] = TSRR
BF.ALL[nrow(BF.ALL)+ 1,] = BTDF
BF.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- BF.ALL[1:46,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
BF.ALL[nrow(BF.ALL)+ 1,] = MMKPR
BF.ALL[nrow(BF.ALL)+ 1,] = MMKTR
BF.ALL[nrow(BF.ALL)+ 1,] = MMKSR
BF.ALL
```

```{r}
BF.NUM <- as.data.frame(apply(BF.ALL[1:56,2:40], 2, as.numeric))
str(BF.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(BF.NUM[53,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(BF.NUM[52,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(BF.NUM[56,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(BF.NUM[51,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(BF.NUM[54,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
BF.ALL[nrow(BF.ALL)+ 1,] = FSR1
BF.ALL[nrow(BF.ALL)+ 1,] = FSR2
BF.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
BFFM <-BF.ALL[c(57,58),-1]
BFF <- as.matrix(apply(BFFM, 2, as.numeric))
BFF
```

###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(BF.ALL[21:47,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
BF.TS2 <-BF.ALL[21:47,1:40] ## 1990 Subset
BF.TSN2 <- as.data.frame(apply(BF.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(BF.TSN2, class)   
BF.TSN2
```
############################################
```{r}
BFM1 <- mblm(AN_RO_mm~ Water_Year_Year, BF.TSN2)
BFM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BF.TSN2)
BFM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BF.TSN2)
BFM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BF.TSN2)
BFM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BF.TSN2)
BFM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BF.TSN2)
BFM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BF.TSN2)
BFM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BF.TSN2)
BFM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BF.TSN2)
BFM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BF.TSN2)
BFM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BF.TSN2)
BFM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BF.TSN2)
BFM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BF.TSN2)
BFM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BF.TSN2)
BFM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BF.TSN2)
BFM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BF.TSN2)
BFM17 <- mblm(May_RO_mm~ Water_Year_Year, BF.TSN2)
BFM18 <- mblm(May_PCP_mm~ Water_Year_Year, BF.TSN2)
BFM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BF.TSN2)
BFM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BF.TSN2)
BFM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BF.TSN2)
BFM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BF.TSN2)
BFM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BF.TSN2)
BFM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BF.TSN2)
BFM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BF.TSN2)
BFM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BF.TSN2)
BFM27 <- mblm(AN_RR~ Water_Year_Year, BF.TSN2)
BFM28 <- mblm(OCT_RR~ Water_Year_Year, BF.TSN2)
BFM29 <- mblm(NOV_RR~ Water_Year_Year, BF.TSN2)
BFM30 <- mblm(DEC_RR~ Water_Year_Year, BF.TSN2)
BFM31 <- mblm(JAN_RR~ Water_Year_Year, BF.TSN2)
BFM32 <- mblm(FEB_RR~ Water_Year_Year, BF.TSN2)
BFM33 <- mblm(MAR_RR~ Water_Year_Year, BF.TSN2)
BFM34 <- mblm(APL_RR~ Water_Year_Year, BF.TSN2)
BFM35 <- mblm(MAY_RR~ Water_Year_Year, BF.TSN2)
BFM36 <- mblm(JUN_RR~ Water_Year_Year, BF.TSN2)
BFM37 <- mblm(JUL_RR~ Water_Year_Year, BF.TSN2)
BFM38 <- mblm(AUG_RR~ Water_Year_Year, BF.TSN2)
BFM39 <- mblm(SEP_RR~ Water_Year_Year, BF.TSN2)
```
####################################
```{r}
TSR2<- cbind(BFM1$coefficients, BFM2$coefficients, BFM3$coefficients, BFM4$coefficients, BFM5$coefficients, BFM6$coefficients,BFM7$coefficients, BFM8$coefficients, BFM9$coefficients,BFM10$coefficients, BFM11$coefficients, BFM12$coefficients,BFM13$coefficients, BFM14$coefficients, BFM15$coefficients,BFM16$coefficients, BFM17$coefficients, BFM18$coefficients,BFM19$coefficients, BFM20$coefficients, BFM21$coefficients,BFM22$coefficients, BFM23$coefficients, BFM4$coefficients,BFM25$coefficients, BFM26$coefficients, BFM27$coefficients,BFM28$coefficients, BFM29$coefficients, BFM30$coefficients,BFM31$coefficients, BFM32$coefficients, BFM33$coefficients,BFM34$coefficients, BFM35$coefficients, BFM36$coefficients,BFM37$coefficients, BFM38$coefficients, BFM39$coefficients)
RES2 <- cbind(BFM1$residuals, BFM2$residuals, BFM3$residuals, BFM4$residuals, BFM5$residuals, BFM6$residuals,BFM7$residuals, BFM8$residuals, BFM9$residuals,BFM10$residuals, BFM11$residuals, BFM12$residuals,BFM13$residuals, BFM14$residuals, BFM15$residuals,BFM16$residuals, BFM17$residuals, BFM18$residuals,BFM19$residuals, BFM20$residuals, BFM21$residuals,BFM22$residuals, BFM23$residuals, BFM4$residuals,BFM25$residuals, BFM26$residuals, BFM27$residuals,BFM28$residuals, BFM29$residuals, BFM30$residuals,BFM31$residuals, BFM32$residuals, BFM33$residuals,BFM34$residuals, BFM35$residuals, BFM36$residuals,BFM37$residuals, BFM38$residuals, BFM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BF.ALL[nrow(BF.ALL)+ 1,] = MKTR2
BF.ALL[nrow(BF.ALL)+ 1,] = MKPR2
BF.ALL[nrow(BF.ALL)+ 1,] = TSRR2
BF.ALL[nrow(BF.ALL)+ 1,] = BTDF2
BF.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- BF.ALL[21:47,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
BF.ALL[nrow(BF.ALL)+ 1,] = MMKPR2
BF.ALL[nrow(BF.ALL)+ 1,] = MMKTR2
BF.ALL[nrow(BF.ALL)+ 1,] = MMKSR2
BF.ALL
```

```{r}
BF.ALL
```

```{r}
BF.NUM2 <- as.data.frame(apply(BF.ALL[1:65,2:40], 2, as.numeric))
str(BF.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(BF.NUM2[62,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(BF.NUM2[61,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(BF.NUM2[65,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(BF.NUM2[60,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(BF.NUM2[63,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
BF.ALL[nrow(BF.ALL)+ 1,] = FSR12
BF.ALL[nrow(BF.ALL)+ 1,] = FSR22
BF.ALL
```

```{r}
BF.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
BFFM2 <-BF.ALL[c(66,67),-1]
BFF2 <- as.matrix(apply(BFFM2, 2, as.numeric))
BFF2
```


###Poluy Results, csv 'BE' ID 28 
```{r}
### Summarise by Month
BED$Days <- days_in_month(as.Date(BED$Date, "%Y-%m-%d"))
BED$StreamflowMon_m3<- BED$Streamflow*(60*60*24)*BED$Days
BE.MON <- BED 
BE.MON$Streamflow_Km<-BE.MON$StreamflowMon_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
BE.MON$Streamflow_mm<-(BE.MON$Streamflow_Km/15100)*1000000 ## monthly runoff depth mm
BE.MON2 <- subset(BE.MON, Year >= 1969)
#BE.MON2
#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
BE.MONT<- BE.MON2[-c(1,2,3,4,5,6,7,8,9,574,575,576),]
BE.MONT
```



```{r}
BET <- GMP2[[946:1509]] ## Poluy
BEE <- extent(68,70.5,65,66.5) ## Poluy
BEPC <- crop(BET, BEE) ## Poluy
BE.Mon.Precip.<-extract(BEPC,BEE, method="bilinear", fun = mean)
BEMP<-as.data.frame(colMeans(BE.Mon.Precip.)) # Poluy
BESub<-DateTemp[DateTemp$Date >= as.Date("1969-10-01") & DateTemp$Date <=
                    as.Date("2016-09-01"), ] ## Poluy
BEPp<- cbind(BEMP,BESub) ## Poluy
```

```{r}
BE.MONT$GriddedPrecip_mm<- BEMP$`colMeans(BE.Mon.Precip.)`
BE.MONT
```

```{r}
BE.MONT[77,10]
```

```{r}
# Gap filling process
BE.M1 <- subset(BE.MONT, Month == 1)
BE.M2 <- subset(BE.MONT, Month == 2)
BE.M3 <- subset(BE.MONT, Month == 3)
BE.M4 <- subset(BE.MONT, Month == 4)
BE.M5 <- subset(BE.MONT, Month == 5)
BE.M6 <- subset(BE.MONT, Month == 6)
BE.M7 <- subset(BE.MONT, Month == 7)
BE.M8 <- subset(BE.MONT, Month == 8)
BE.M9 <- subset(BE.MONT, Month == 9)
BE.M10 <- subset(BE.MONT, Month == 10)
BE.M11 <- subset(BE.MONT, Month == 11)
BE.M12 <- subset(BE.MONT, Month == 12)

BE.1 <-mean(BE.M1$Streamflow_mm, na.rm = TRUE)
BE.2 <- mean(BE.M2$Streamflow_mm, na.rm = TRUE)
BE.3 <- mean(BE.M3$Streamflow_mm, na.rm = TRUE)
BE.4 <- mean(BE.M4$Streamflow_mm, na.rm = TRUE)
BE.5 <-mean(BE.M5$Streamflow_mm, na.rm = TRUE)
BE.6 <- mean(BE.M6$Streamflow_mm, na.rm = TRUE)
BE.7 <- mean(BE.M7$Streamflow_mm, na.rm = TRUE)
BE.8 <- mean(BE.M8$Streamflow_mm, na.rm = TRUE)
BE.9 <- mean(BE.M9$Streamflow_mm, na.rm = TRUE)
BE.10 <- mean(BE.M10$Streamflow_mm, na.rm = TRUE)
BE.11 <- mean(BE.M11$Streamflow_mm, na.rm = TRUE)
BE.12 <- mean(BE.M12$Streamflow_mm, na.rm = TRUE)

BE.MONT[c(352,364,376,388,400,412,424,436,448),9] <- BE.1
BE.MONT[c(353,365,377,389,401,413,425,437,449),9] <- BE.2
BE.MONT[c(354,366,378,390,402,414,426,438,450),9] <- BE.3
BE.MONT[c(355,367,379,391,403,415,427,439,451),9] <- BE.4
BE.MONT[c(356,368,380,392,404,416,428,440,452),9] <- BE.5
BE.MONT[c(357,369,381,393,405,417,429,441,453),9] <- BE.6
BE.MONT[c(358,370,382,394,406,418,430,442,454),9] <- BE.7
BE.MONT[c(359,371,383,395,407,419,431,443,455),9] <- BE.8
BE.MONT[c(360,372,384,396,408,420,432,444,456),9] <- BE.9
BE.MONT[c(361,373,385,397,409,421,433,445,457),9] <- BE.10
BE.MONT[c(362,374,386,398,410,422,434,446,458),9] <- BE.11
BE.MONT[c(363,375,387,399,411,423,435,447,459),9] <- BE.12

BE.MONT[76,9] <- BE.1
BE.MONT[77,9] <- BE.2
BE.MONT[78,9] <- BE.3
BE.MONT[80,9] <- BE.5

BE.MONT
```

##############
```{r}
## Water Year Sequencing
BE.MT<- BE.MONT
BE.MT$Water_Year_Month <- rep(seq(1:12),47) #1975 to 2016 is 43 years
BE.MT$Water_Year_Year <- rep(1:47, each =12)
BE.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 BE.WY <- BE.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
BE.WY
```
##############
```{r}
## Monthly Columns
## Oct
 BE.OCT <- BE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 BE.NOV <- BE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 BE.DEC <- BE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 BE.JAN <- BE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 BE.FEB <- BE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 BE.MAR <- BE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 BE.APL <- BE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 BE.MAY <- BE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 BE.JUN <- BE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 BE.JUL <- BE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 BE.AUG <- BE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 BE.SEP <- BE.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
BE.ALL <- cbind(BE.WY, BE.OCT[,-1], BE.NOV[,-1], BE.DEC[,-1], BE.JAN[,-1], BE.FEB[,-1], BE.MAR[,-1], BE.APL[,-1],BE.MAY[,-1], BE.JUN[,-1], BE.JUL[,-1], BE.AUG[,-1], BE.SEP[,-1])
```
####################
```{r}
BE.ALL$AN_RR <- BE.ALL$AN_RO_mm/BE.ALL$AN_PCP_mm
BE.ALL$OCT_RR <- BE.ALL$Oct_RO_mm/BE.ALL$Oct_PCP_mm
BE.ALL$NOV_RR <- BE.ALL$Nov_RO_mm/BE.ALL$Nov_PCP_mm
BE.ALL$DEC_RR <- BE.ALL$Dec_RO_mm/BE.ALL$Dec_PCP_mm
BE.ALL$JAN_RR <- BE.ALL$Jan_RO_mm/BE.ALL$Jan_PCP_mm
BE.ALL$FEB_RR <- BE.ALL$Feb_RO_mm/BE.ALL$Feb_PCP_mm
BE.ALL$MAR_RR <- BE.ALL$Mar_RO_mm/BE.ALL$Mar_PCP_mm
BE.ALL$APL_RR <- BE.ALL$Apl_RO_mm/BE.ALL$Apl_PCP_mm
BE.ALL$MAY_RR <- BE.ALL$May_RO_mm/BE.ALL$May_PCP_mm
BE.ALL$JUN_RR <- BE.ALL$Jun_RO_mm/BE.ALL$Jun_PCP_mm
BE.ALL$JUL_RR <- BE.ALL$Jul_RO_mm/BE.ALL$Jul_PCP_mm
BE.ALL$AUG_RR <- BE.ALL$Aug_RO_mm/BE.ALL$Aug_PCP_mm
BE.ALL$SEP_RR <- BE.ALL$Sep_RO_mm/BE.ALL$Sep_PCP_mm
BE.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(BE.ALL[,-1],2, mean))
CSD <- rbind(apply(BE.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
BE.ALL[nrow(BE.ALL)+ 1,] = CML
BE.ALL[nrow(BE.ALL)+ 1,] = CSDL
BE.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(BE.ALL[1:47,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
BE.TS <-BE.ALL[1:47,1:40]
BE.TSN <- as.data.frame(apply(BE.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(BE.TSN, class)   
BE.TSN
```
############################################
```{r}
BEM1 <- mblm(AN_RO_mm~ Water_Year_Year, BE.TSN)
BEM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BE.TSN)
BEM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BE.TSN)
BEM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BE.TSN)
BEM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BE.TSN)
BEM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BE.TSN)
BEM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BE.TSN)
BEM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BE.TSN)
BEM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BE.TSN)
BEM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BE.TSN)
BEM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BE.TSN)
BEM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BE.TSN)
BEM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BE.TSN)
BEM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BE.TSN)
BEM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BE.TSN)
BEM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BE.TSN)
BEM17 <- mblm(May_RO_mm~ Water_Year_Year, BE.TSN)
BEM18 <- mblm(May_PCP_mm~ Water_Year_Year, BE.TSN)
BEM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BE.TSN)
BEM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BE.TSN)
BEM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BE.TSN)
BEM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BE.TSN)
BEM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BE.TSN)
BEM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BE.TSN)
BEM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BE.TSN)
BEM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BE.TSN)
BEM27 <- mblm(AN_RR~ Water_Year_Year, BE.TSN)
BEM28 <- mblm(OCT_RR~ Water_Year_Year, BE.TSN)
BEM29 <- mblm(NOV_RR~ Water_Year_Year, BE.TSN)
BEM30 <- mblm(DEC_RR~ Water_Year_Year, BE.TSN)
BEM31 <- mblm(JAN_RR~ Water_Year_Year, BE.TSN)
BEM32 <- mblm(FEB_RR~ Water_Year_Year, BE.TSN)
BEM33 <- mblm(MAR_RR~ Water_Year_Year, BE.TSN)
BEM34 <- mblm(APL_RR~ Water_Year_Year, BE.TSN)
BEM35 <- mblm(MAY_RR~ Water_Year_Year, BE.TSN)
BEM36 <- mblm(JUN_RR~ Water_Year_Year, BE.TSN)
BEM37 <- mblm(JUL_RR~ Water_Year_Year, BE.TSN)
BEM38 <- mblm(AUG_RR~ Water_Year_Year, BE.TSN)
BEM39 <- mblm(SEP_RR~ Water_Year_Year, BE.TSN)
```
####################################
```{r}
TSR<- cbind(BEM1$coefficients, BEM2$coefficients, BEM3$coefficients, BEM4$coefficients, BEM5$coefficients, BEM6$coefficients,BEM7$coefficients, BEM8$coefficients, BEM9$coefficients,BEM10$coefficients, BEM11$coefficients, BEM12$coefficients,BEM13$coefficients, BEM14$coefficients, BEM15$coefficients,BEM16$coefficients, BEM17$coefficients, BEM18$coefficients,BEM19$coefficients, BEM20$coefficients, BEM21$coefficients,BEM22$coefficients, BEM23$coefficients, BEM4$coefficients,BEM25$coefficients, BEM26$coefficients, BEM27$coefficients,BEM28$coefficients, BEM29$coefficients, BEM30$coefficients,BEM31$coefficients, BEM32$coefficients, BEM33$coefficients,BEM34$coefficients, BEM35$coefficients, BEM36$coefficients,BEM37$coefficients, BEM38$coefficients, BEM39$coefficients)
RES <- cbind(BEM1$residuals, BEM2$residuals, BEM3$residuals, BEM4$residuals, BEM5$residuals, BEM6$residuals,BEM7$residuals, BEM8$residuals, BEM9$residuals,BEM10$residuals, BEM11$residuals, BEM12$residuals,BEM13$residuals, BEM14$residuals, BEM15$residuals,BEM16$residuals, BEM17$residuals, BEM18$residuals,BEM19$residuals, BEM20$residuals, BEM21$residuals,BEM22$residuals, BEM23$residuals, BEM4$residuals,BEM25$residuals, BEM26$residuals, BEM27$residuals,BEM28$residuals, BEM29$residuals, BEM30$residuals,BEM31$residuals, BEM32$residuals, BEM33$residuals,BEM34$residuals, BEM35$residuals, BEM36$residuals,BEM37$residuals, BEM38$residuals, BEM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BE.ALL[nrow(BE.ALL)+ 1,] = MKTR
BE.ALL[nrow(BE.ALL)+ 1,] = MKPR
BE.ALL[nrow(BE.ALL)+ 1,] = TSRR
BE.ALL[nrow(BE.ALL)+ 1,] = BTDF
BE.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- BE.ALL[1:47,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
BE.ALL[nrow(BE.ALL)+ 1,] = MMKPR
BE.ALL[nrow(BE.ALL)+ 1,] = MMKTR
BE.ALL[nrow(BE.ALL)+ 1,] = MMKSR
BE.ALL
```

```{r}
BE.NUM <- as.data.frame(apply(BE.ALL[1:56,2:40], 2, as.numeric))
str(BE.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(BE.NUM[53,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(BE.NUM[52,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(BE.NUM[56,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(BE.NUM[51,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(BE.NUM[54,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
BE.ALL[nrow(BE.ALL)+ 1,] = FSR1
BE.ALL[nrow(BE.ALL)+ 1,] = FSR2
BE.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
BEFM <-BE.ALL[c(57,58),-1]
BEF <- as.matrix(apply(BEFM, 2, as.numeric))
BEF
```
###########################################################

```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(BE.ALL[21:47,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
BE.TS2 <-BE.ALL[21:47,1:40] ## 1990 Subset
BE.TSN2 <- as.data.frame(apply(BE.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(BE.TSN2, class)   
BE.TSN2
```
############################################
```{r}
BEM1 <- mblm(AN_RO_mm~ Water_Year_Year, BE.TSN2)
BEM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BE.TSN2)
BEM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BE.TSN2)
BEM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BE.TSN2)
BEM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BE.TSN2)
BEM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BE.TSN2)
BEM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BE.TSN2)
BEM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BE.TSN2)
BEM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BE.TSN2)
BEM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BE.TSN2)
BEM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BE.TSN2)
BEM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BE.TSN2)
BEM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BE.TSN2)
BEM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BE.TSN2)
BEM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BE.TSN2)
BEM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BE.TSN2)
BEM17 <- mblm(May_RO_mm~ Water_Year_Year, BE.TSN2)
BEM18 <- mblm(May_PCP_mm~ Water_Year_Year, BE.TSN2)
BEM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BE.TSN2)
BEM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BE.TSN2)
BEM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BE.TSN2)
BEM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BE.TSN2)
BEM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BE.TSN2)
BEM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BE.TSN2)
BEM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BE.TSN2)
BEM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BE.TSN2)
BEM27 <- mblm(AN_RR~ Water_Year_Year, BE.TSN2)
BEM28 <- mblm(OCT_RR~ Water_Year_Year, BE.TSN2)
BEM29 <- mblm(NOV_RR~ Water_Year_Year, BE.TSN2)
BEM30 <- mblm(DEC_RR~ Water_Year_Year, BE.TSN2)
BEM31 <- mblm(JAN_RR~ Water_Year_Year, BE.TSN2)
BEM32 <- mblm(FEB_RR~ Water_Year_Year, BE.TSN2)
BEM33 <- mblm(MAR_RR~ Water_Year_Year, BE.TSN2)
BEM34 <- mblm(APL_RR~ Water_Year_Year, BE.TSN2)
BEM35 <- mblm(MAY_RR~ Water_Year_Year, BE.TSN2)
BEM36 <- mblm(JUN_RR~ Water_Year_Year, BE.TSN2)
BEM37 <- mblm(JUL_RR~ Water_Year_Year, BE.TSN2)
BEM38 <- mblm(AUG_RR~ Water_Year_Year, BE.TSN2)
BEM39 <- mblm(SEP_RR~ Water_Year_Year, BE.TSN2)
```
####################################
```{r}
TSR2<- cbind(BEM1$coefficients, BEM2$coefficients, BEM3$coefficients, BEM4$coefficients, BEM5$coefficients, BEM6$coefficients,BEM7$coefficients, BEM8$coefficients, BEM9$coefficients,BEM10$coefficients, BEM11$coefficients, BEM12$coefficients,BEM13$coefficients, BEM14$coefficients, BEM15$coefficients,BEM16$coefficients, BEM17$coefficients, BEM18$coefficients,BEM19$coefficients, BEM20$coefficients, BEM21$coefficients,BEM22$coefficients, BEM23$coefficients, BEM4$coefficients,BEM25$coefficients, BEM26$coefficients, BEM27$coefficients,BEM28$coefficients, BEM29$coefficients, BEM30$coefficients,BEM31$coefficients, BEM32$coefficients, BEM33$coefficients,BEM34$coefficients, BEM35$coefficients, BEM36$coefficients,BEM37$coefficients, BEM38$coefficients, BEM39$coefficients)
RES2 <- cbind(BEM1$residuals, BEM2$residuals, BEM3$residuals, BEM4$residuals, BEM5$residuals, BEM6$residuals,BEM7$residuals, BEM8$residuals, BEM9$residuals,BEM10$residuals, BEM11$residuals, BEM12$residuals,BEM13$residuals, BEM14$residuals, BEM15$residuals,BEM16$residuals, BEM17$residuals, BEM18$residuals,BEM19$residuals, BEM20$residuals, BEM21$residuals,BEM22$residuals, BEM23$residuals, BEM4$residuals,BEM25$residuals, BEM26$residuals, BEM27$residuals,BEM28$residuals, BEM29$residuals, BEM30$residuals,BEM31$residuals, BEM32$residuals, BEM33$residuals,BEM34$residuals, BEM35$residuals, BEM36$residuals,BEM37$residuals, BEM38$residuals, BEM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BE.ALL[nrow(BE.ALL)+ 1,] = MKTR2
BE.ALL[nrow(BE.ALL)+ 1,] = MKPR2
BE.ALL[nrow(BE.ALL)+ 1,] = TSRR2
BE.ALL[nrow(BE.ALL)+ 1,] = BTDF2
BE.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- BE.ALL[21:47,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
BE.ALL[nrow(BE.ALL)+ 1,] = MMKPR2
BE.ALL[nrow(BE.ALL)+ 1,] = MMKTR2
BE.ALL[nrow(BE.ALL)+ 1,] = MMKSR2
BE.ALL
```

```{r}
BE.ALL
```

```{r}
BE.NUM2 <- as.data.frame(apply(BE.ALL[1:65,2:40], 2, as.numeric))
str(BE.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(BE.NUM2[62,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(BE.NUM2[61,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(BE.NUM2[65,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(BE.NUM2[60,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(BE.NUM2[63,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
BE.ALL[nrow(BE.ALL)+ 1,] = FSR12
BE.ALL[nrow(BE.ALL)+ 1,] = FSR22
BE.ALL
```

```{r}
BE.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
BEFM2 <-BE.ALL[c(66,67),-1]
BEF2 <- as.matrix(apply(BEFM2, 2, as.numeric))
BEF2
```

### Pur Results, csv 'AN' ID 29
```{r}
### Summarise by Month
AN$Days <- days_in_month(as.Date(AN$Date, "%d/%m/%Y"))
AN$StreamflowMon_m3<- AN$Streamflow*(60*60*24)*AN$Days
AN.MON <- AN 
AN.MON$Streamflow_Km<-AN.MON$StreamflowMon_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
AN.MON$Streamflow_mm<-(AN.MON$Streamflow_Km/80400)*1000000 ## monthly runoff depth mm
AN.MON2 <- subset(AN.MON, Year >= 1969)
#AN.MON2

#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
AN.MONT<- AN.MON2[-c(1,2,3,4,5,6,7,8,9,562,563,564),]
AN.MONT
```


```{r}
ANT<-GMP2[[946:1497]] #Urengoy
ANE<-extent(74,80.5,63,66) #Urengoy Extent
ANPC<-crop(ANT,ANE) #Urengoy Crop
AN.Mon.Precip.<-extract(ANPC,ANE, method="bilinear", fun = mean)
ANMP<-as.data.frame(colMeans(AN.Mon.Precip.)) #Urengoy
ANSub<-DateTemp[DateTemp$Date >= as.Date("1969-10-01") & DateTemp$Date <=
                    as.Date("2015-09-01"), ] ##Urengoy
ANPp<- cbind(ANMP,ANSub) ## Urengoy
```

```{r}
AN.MONT$GriddedPrecip_mm<- ANMP$`colMeans(AN.Mon.Precip.)`
AN.MONT
```

##############
```{r}
## Water Year Sequencing
AN.MT<- AN.MONT
AN.MT$Water_Year_Month <- rep(seq(1:12),46) #1975 to 2016 is 43 years
AN.MT$Water_Year_Year <- rep(1:46, each =12)
AN.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 AN.WY <- AN.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
AN.WY
```
##############
```{r}
## Monthly Columns
## Oct
 AN.OCT <- AN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 AN.NOV <- AN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 AN.DEC <- AN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 AN.JAN <- AN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 AN.FEB <- AN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 AN.MAR <- AN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 AN.APL <- AN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 AN.MAY <- AN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 AN.JUN <- AN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 AN.JUL <- AN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 AN.AUG <- AN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 AN.SEP <- AN.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
AN.ALL <- cbind(AN.WY, AN.OCT[,-1], AN.NOV[,-1], AN.DEC[,-1], AN.JAN[,-1], AN.FEB[,-1], AN.MAR[,-1], AN.APL[,-1],AN.MAY[,-1], AN.JUN[,-1], AN.JUL[,-1], AN.AUG[,-1], AN.SEP[,-1])
```
####################
```{r}
AN.ALL$AN_RR <- AN.ALL$AN_RO_mm/AN.ALL$AN_PCP_mm
AN.ALL$OCT_RR <- AN.ALL$Oct_RO_mm/AN.ALL$Oct_PCP_mm
AN.ALL$NOV_RR <- AN.ALL$Nov_RO_mm/AN.ALL$Nov_PCP_mm
AN.ALL$DEC_RR <- AN.ALL$Dec_RO_mm/AN.ALL$Dec_PCP_mm
AN.ALL$JAN_RR <- AN.ALL$Jan_RO_mm/AN.ALL$Jan_PCP_mm
AN.ALL$FEB_RR <- AN.ALL$Feb_RO_mm/AN.ALL$Feb_PCP_mm
AN.ALL$MAR_RR <- AN.ALL$Mar_RO_mm/AN.ALL$Mar_PCP_mm
AN.ALL$APL_RR <- AN.ALL$Apl_RO_mm/AN.ALL$Apl_PCP_mm
AN.ALL$MAY_RR <- AN.ALL$May_RO_mm/AN.ALL$May_PCP_mm
AN.ALL$JUN_RR <- AN.ALL$Jun_RO_mm/AN.ALL$Jun_PCP_mm
AN.ALL$JUL_RR <- AN.ALL$Jul_RO_mm/AN.ALL$Jul_PCP_mm
AN.ALL$AUG_RR <- AN.ALL$Aug_RO_mm/AN.ALL$Aug_PCP_mm
AN.ALL$SEP_RR <- AN.ALL$Sep_RO_mm/AN.ALL$Sep_PCP_mm
AN.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(AN.ALL[,-1],2, mean))
CSD <- rbind(apply(AN.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
AN.ALL[nrow(AN.ALL)+ 1,] = CML
AN.ALL[nrow(AN.ALL)+ 1,] = CSDL
AN.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(AN.ALL[1:46,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
AN.TS <-AN.ALL[1:46,1:40]
AN.TSN <- as.data.frame(apply(AN.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(AN.TSN, class)   
AN.TSN
```
############################################
```{r}
ANM1 <- mblm(AN_RO_mm~ Water_Year_Year, AN.TSN)
ANM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AN.TSN)
ANM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AN.TSN)
ANM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AN.TSN)
ANM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AN.TSN)
ANM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AN.TSN)
ANM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AN.TSN)
ANM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AN.TSN)
ANM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AN.TSN)
ANM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AN.TSN)
ANM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AN.TSN)
ANM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AN.TSN)
ANM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AN.TSN)
ANM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AN.TSN)
ANM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AN.TSN)
ANM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AN.TSN)
ANM17 <- mblm(May_RO_mm~ Water_Year_Year, AN.TSN)
ANM18 <- mblm(May_PCP_mm~ Water_Year_Year, AN.TSN)
ANM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AN.TSN)
ANM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AN.TSN)
ANM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AN.TSN)
ANM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AN.TSN)
ANM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AN.TSN)
ANM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AN.TSN)
ANM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AN.TSN)
ANM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AN.TSN)
ANM27 <- mblm(AN_RR~ Water_Year_Year, AN.TSN)
ANM28 <- mblm(OCT_RR~ Water_Year_Year, AN.TSN)
ANM29 <- mblm(NOV_RR~ Water_Year_Year, AN.TSN)
ANM30 <- mblm(DEC_RR~ Water_Year_Year, AN.TSN)
ANM31 <- mblm(JAN_RR~ Water_Year_Year, AN.TSN)
ANM32 <- mblm(FEB_RR~ Water_Year_Year, AN.TSN)
ANM33 <- mblm(MAR_RR~ Water_Year_Year, AN.TSN)
ANM34 <- mblm(APL_RR~ Water_Year_Year, AN.TSN)
ANM35 <- mblm(MAY_RR~ Water_Year_Year, AN.TSN)
ANM36 <- mblm(JUN_RR~ Water_Year_Year, AN.TSN)
ANM37 <- mblm(JUL_RR~ Water_Year_Year, AN.TSN)
ANM38 <- mblm(AUG_RR~ Water_Year_Year, AN.TSN)
ANM39 <- mblm(SEP_RR~ Water_Year_Year, AN.TSN)
```
####################################
```{r}
TSR<- cbind(ANM1$coefficients, ANM2$coefficients, ANM3$coefficients, ANM4$coefficients, ANM5$coefficients, ANM6$coefficients,ANM7$coefficients, ANM8$coefficients, ANM9$coefficients,ANM10$coefficients, ANM11$coefficients, ANM12$coefficients,ANM13$coefficients, ANM14$coefficients, ANM15$coefficients,ANM16$coefficients, ANM17$coefficients, ANM18$coefficients,ANM19$coefficients, ANM20$coefficients, ANM21$coefficients,ANM22$coefficients, ANM23$coefficients, ANM4$coefficients,ANM25$coefficients, ANM26$coefficients, ANM27$coefficients,ANM28$coefficients, ANM29$coefficients, ANM30$coefficients,ANM31$coefficients, ANM32$coefficients, ANM33$coefficients,ANM34$coefficients, ANM35$coefficients, ANM36$coefficients,ANM37$coefficients, ANM38$coefficients, ANM39$coefficients)
RES <- cbind(ANM1$residuals, ANM2$residuals, ANM3$residuals, ANM4$residuals, ANM5$residuals, ANM6$residuals,ANM7$residuals, ANM8$residuals, ANM9$residuals,ANM10$residuals, ANM11$residuals, ANM12$residuals,ANM13$residuals, ANM14$residuals, ANM15$residuals,ANM16$residuals, ANM17$residuals, ANM18$residuals,ANM19$residuals, ANM20$residuals, ANM21$residuals,ANM22$residuals, ANM23$residuals, ANM4$residuals,ANM25$residuals, ANM26$residuals, ANM27$residuals,ANM28$residuals, ANM29$residuals, ANM30$residuals,ANM31$residuals, ANM32$residuals, ANM33$residuals,ANM34$residuals, ANM35$residuals, ANM36$residuals,ANM37$residuals, ANM38$residuals, ANM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AN.ALL[nrow(AN.ALL)+ 1,] = MKTR
AN.ALL[nrow(AN.ALL)+ 1,] = MKPR
AN.ALL[nrow(AN.ALL)+ 1,] = TSRR
AN.ALL[nrow(AN.ALL)+ 1,] = BTDF
AN.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- AN.ALL[1:46,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
AN.ALL[nrow(AN.ALL)+ 1,] = MMKPR
AN.ALL[nrow(AN.ALL)+ 1,] = MMKTR
AN.ALL[nrow(AN.ALL)+ 1,] = MMKSR
AN.ALL
```

```{r}
AN.NUM <- as.data.frame(apply(AN.ALL[1:55,2:40], 2, as.numeric))
str(AN.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(AN.NUM[52,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(AN.NUM[51,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(AN.NUM[55,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(AN.NUM[50,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(AN.NUM[53,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
AN.ALL[nrow(AN.ALL)+ 1,] = FSR1
AN.ALL[nrow(AN.ALL)+ 1,] = FSR2
AN.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
ANFM <-AN.ALL[c(56,57),-1]
ANF <- as.matrix(apply(ANFM, 2, as.numeric))
ANF
```


###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(AN.ALL[21:46,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
AN.TS2 <-AN.ALL[21:46,1:40] ## 1990 Subset
AN.TSN2 <- as.data.frame(apply(AN.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(AN.TSN2, class)   
AN.TSN2
```
############################################
```{r}
ANM1 <- mblm(AN_RO_mm~ Water_Year_Year, AN.TSN2)
ANM2 <- mblm(AN_PCP_mm~ Water_Year_Year, AN.TSN2)
ANM3 <- mblm(Oct_RO_mm~ Water_Year_Year, AN.TSN2)
ANM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, AN.TSN2)
ANM5 <- mblm(Nov_RO_mm~ Water_Year_Year, AN.TSN2)
ANM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, AN.TSN2)
ANM7 <- mblm(Dec_RO_mm~ Water_Year_Year, AN.TSN2)
ANM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, AN.TSN2)
ANM9 <- mblm(Jan_RO_mm~ Water_Year_Year, AN.TSN2)
ANM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, AN.TSN2)
ANM11 <- mblm(Feb_RO_mm~ Water_Year_Year, AN.TSN2)
ANM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, AN.TSN2)
ANM13 <- mblm(Mar_RO_mm~ Water_Year_Year, AN.TSN2)
ANM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, AN.TSN2)
ANM15 <- mblm(Apl_RO_mm~ Water_Year_Year, AN.TSN2)
ANM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, AN.TSN2)
ANM17 <- mblm(May_RO_mm~ Water_Year_Year, AN.TSN2)
ANM18 <- mblm(May_PCP_mm~ Water_Year_Year, AN.TSN2)
ANM19 <- mblm(Jun_RO_mm~ Water_Year_Year, AN.TSN2)
ANM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, AN.TSN2)
ANM21 <- mblm(Jul_RO_mm~ Water_Year_Year, AN.TSN2)
ANM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, AN.TSN2)
ANM23 <- mblm(Aug_RO_mm~ Water_Year_Year, AN.TSN2)
ANM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, AN.TSN2)
ANM25 <- mblm(Sep_RO_mm~ Water_Year_Year, AN.TSN2)
ANM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, AN.TSN2)
ANM27 <- mblm(AN_RR~ Water_Year_Year, AN.TSN2)
ANM28 <- mblm(OCT_RR~ Water_Year_Year, AN.TSN2)
ANM29 <- mblm(NOV_RR~ Water_Year_Year, AN.TSN2)
ANM30 <- mblm(DEC_RR~ Water_Year_Year, AN.TSN2)
ANM31 <- mblm(JAN_RR~ Water_Year_Year, AN.TSN2)
ANM32 <- mblm(FEB_RR~ Water_Year_Year, AN.TSN2)
ANM33 <- mblm(MAR_RR~ Water_Year_Year, AN.TSN2)
ANM34 <- mblm(APL_RR~ Water_Year_Year, AN.TSN2)
ANM35 <- mblm(MAY_RR~ Water_Year_Year, AN.TSN2)
ANM36 <- mblm(JUN_RR~ Water_Year_Year, AN.TSN2)
ANM37 <- mblm(JUL_RR~ Water_Year_Year, AN.TSN2)
ANM38 <- mblm(AUG_RR~ Water_Year_Year, AN.TSN2)
ANM39 <- mblm(SEP_RR~ Water_Year_Year, AN.TSN2)
```
####################################
```{r}
TSR2<- cbind(ANM1$coefficients, ANM2$coefficients, ANM3$coefficients, ANM4$coefficients, ANM5$coefficients, ANM6$coefficients,ANM7$coefficients, ANM8$coefficients, ANM9$coefficients,ANM10$coefficients, ANM11$coefficients, ANM12$coefficients,ANM13$coefficients, ANM14$coefficients, ANM15$coefficients,ANM16$coefficients, ANM17$coefficients, ANM18$coefficients,ANM19$coefficients, ANM20$coefficients, ANM21$coefficients,ANM22$coefficients, ANM23$coefficients, ANM4$coefficients,ANM25$coefficients, ANM26$coefficients, ANM27$coefficients,ANM28$coefficients, ANM29$coefficients, ANM30$coefficients,ANM31$coefficients, ANM32$coefficients, ANM33$coefficients,ANM34$coefficients, ANM35$coefficients, ANM36$coefficients,ANM37$coefficients, ANM38$coefficients, ANM39$coefficients)
RES2 <- cbind(ANM1$residuals, ANM2$residuals, ANM3$residuals, ANM4$residuals, ANM5$residuals, ANM6$residuals,ANM7$residuals, ANM8$residuals, ANM9$residuals,ANM10$residuals, ANM11$residuals, ANM12$residuals,ANM13$residuals, ANM14$residuals, ANM15$residuals,ANM16$residuals, ANM17$residuals, ANM18$residuals,ANM19$residuals, ANM20$residuals, ANM21$residuals,ANM22$residuals, ANM23$residuals, ANM4$residuals,ANM25$residuals, ANM26$residuals, ANM27$residuals,ANM28$residuals, ANM29$residuals, ANM30$residuals,ANM31$residuals, ANM32$residuals, ANM33$residuals,ANM34$residuals, ANM35$residuals, ANM36$residuals,ANM37$residuals, ANM38$residuals, ANM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
AN.ALL[nrow(AN.ALL)+ 1,] = MKTR2
AN.ALL[nrow(AN.ALL)+ 1,] = MKPR2
AN.ALL[nrow(AN.ALL)+ 1,] = TSRR2
AN.ALL[nrow(AN.ALL)+ 1,] = BTDF2
AN.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- AN.ALL[21:46,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
AN.ALL[nrow(AN.ALL)+ 1,] = MMKPR2
AN.ALL[nrow(AN.ALL)+ 1,] = MMKTR2
AN.ALL[nrow(AN.ALL)+ 1,] = MMKSR2
AN.ALL
```

```{r}
AN.ALL
```

```{r}
AN.NUM2 <- as.data.frame(apply(AN.ALL[1:64,2:40], 2, as.numeric))
str(AN.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(AN.NUM2[61,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(AN.NUM2[60,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(AN.NUM2[64,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(AN.NUM2[59,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(AN.NUM2[62,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
AN.ALL[nrow(AN.ALL)+ 1,] = FSR12
AN.ALL[nrow(AN.ALL)+ 1,] = FSR22
AN.ALL
```

```{r}
AN.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
ANFM2 <-AN.ALL[c(65,66),-1]
ANF2 <- as.matrix(apply(ANFM2, 2, as.numeric))
ANF2
```

###Severnya Sos'va Results, csv 'BL' ID 30
```{r}
### Summarise by Month
BL$Days <- days_in_month(as.Date(BL$Date, "%Y-%m-%d"))
BL$StreamflowMon_m3<- BL$Streamflow*(60*60*24)*BL$Days
BL.MON <- BL 
BL.MON$Streamflow_Km<-BL.MON$StreamflowMon_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
BL.MON$Streamflow_mm<-(BL.MON$Streamflow_Km/9850)*1000000 ## monthly runoff depth mm
BL.MON2<- subset(BL.MON, Year >= 1969)
#BL.MON2
BL.MONT <- BL.MON2[-c(1,2,3,4,5,6,7,8,9,574,575,576),]
BL.MONT
```

```{r}
BLT <- GMP2[[946:1509]] ## Severnaya
BLE <- extent(59.5,61,62,63.5) ## Severnaya
BLPC <- crop(BLT, BLE) ## Severnaya
BL.Mon.Precip.<-extract(BLPC,BLE, method="bilinear", fun = mean)
BLMP<-as.data.frame(colMeans(BL.Mon.Precip.)) # Severnya
BLSub<-DateTemp[DateTemp$Date >= as.Date("1969-10-01") & DateTemp$Date <=
                    as.Date("2016-09-01"), ] ##Severnya
BLPp<- cbind(BLMP,BLSub) ## Severnya
```

```{r}
BL.MONT$GriddedPrecip_mm<- BLMP$`colMeans(BL.Mon.Precip.)`
BL.MONT
```

```{r}
#Gap filling process

BL.M1 <- subset(BL.MONT, Month == 1)
BL.M2 <- subset(BL.MONT, Month == 2)
BL.M3 <- subset(BL.MONT, Month == 3)
BL.M4 <- subset(BL.MONT, Month == 4)
BL.M5 <- subset(BL.MONT, Month == 5)
BL.M6 <- subset(BL.MONT, Month == 6)
BL.M7 <- subset(BL.MONT, Month == 7)
BL.M8 <- subset(BL.MONT, Month == 8)
BL.M9 <- subset(BL.MONT, Month == 9)
BL.M10 <- subset(BL.MONT, Month == 10)
BL.M11 <- subset(BL.MONT, Month == 11)
BL.M12 <- subset(BL.MONT, Month == 12)


BL.1 <-mean(BL.M1$Streamflow_mm, na.rm = TRUE)
BL.2 <- mean(BL.M2$Streamflow_mm, na.rm = TRUE)
BL.3 <- mean(BL.M3$Streamflow_mm, na.rm = TRUE)
BL.4 <- mean(BL.M4$Streamflow_mm, na.rm = TRUE)
BL.5 <-mean(BL.M5$Streamflow_mm, na.rm = TRUE)
BL.6 <- mean(BL.M6$Streamflow_mm, na.rm = TRUE)
BL.7 <- mean(BL.M7$Streamflow_mm, na.rm = TRUE)
BL.8 <- mean(BL.M8$Streamflow_mm, na.rm = TRUE)
BL.9 <- mean(BL.M9$Streamflow_mm, na.rm = TRUE)
BL.10 <- mean(BL.M10$Streamflow_mm, na.rm = TRUE)
BL.11 <- mean(BL.M11$Streamflow_mm, na.rm = TRUE)
BL.12 <- mean(BL.M12$Streamflow_mm, na.rm = TRUE)

BL.MONT[c(388,400),9] <- BL.1
BL.MONT[c(389,401),9] <- BL.2
BL.MONT[c(402),9] <- BL.3
#BL.MONT[c(),9] <- BL.4
#BL.MONT[c(),9] <- BL.5
#BL.MONT[c(),9] <- BL.6
#BL.MONT[c(),9] <- BL.7
BL.MONT[c(395),9] <- BL.8
BL.MONT[c(396),9] <- BL.9
BL.MONT[c(397),9] <- BL.10
BL.MONT[c(386,398),9] <- BL.11
BL.MONT[c(387,399),9] <- BL.12


BL.MONT

```

##############
```{r}
## Water Year Sequencing
BL.MT<- BL.MONT
BL.MT$Water_Year_Month <- rep(seq(1:12),47) #1975 to 2016 is 43 years
BL.MT$Water_Year_Year <- rep(1:47, each =12)
BL.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 BL.WY <- BL.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
BL.WY
```
##############
```{r}
## Monthly Columns
## Oct
 BL.OCT <- BL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 BL.NOV <- BL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 BL.DEC <- BL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 BL.JAN <- BL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 BL.FEB <- BL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 BL.MAR <- BL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 BL.APL <- BL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 BL.MAY <- BL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 BL.JUN <- BL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 BL.JUL <- BL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 BL.AUG <- BL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 BL.SEP <- BL.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
BL.ALL <- cbind(BL.WY, BL.OCT[,-1], BL.NOV[,-1], BL.DEC[,-1], BL.JAN[,-1], BL.FEB[,-1], BL.MAR[,-1], BL.APL[,-1],BL.MAY[,-1], BL.JUN[,-1], BL.JUL[,-1], BL.AUG[,-1], BL.SEP[,-1])
```
####################
```{r}
BL.ALL$AN_RR <- BL.ALL$AN_RO_mm/BL.ALL$AN_PCP_mm
BL.ALL$OCT_RR <- BL.ALL$Oct_RO_mm/BL.ALL$Oct_PCP_mm
BL.ALL$NOV_RR <- BL.ALL$Nov_RO_mm/BL.ALL$Nov_PCP_mm
BL.ALL$DEC_RR <- BL.ALL$Dec_RO_mm/BL.ALL$Dec_PCP_mm
BL.ALL$JAN_RR <- BL.ALL$Jan_RO_mm/BL.ALL$Jan_PCP_mm
BL.ALL$FEB_RR <- BL.ALL$Feb_RO_mm/BL.ALL$Feb_PCP_mm
BL.ALL$MAR_RR <- BL.ALL$Mar_RO_mm/BL.ALL$Mar_PCP_mm
BL.ALL$APL_RR <- BL.ALL$Apl_RO_mm/BL.ALL$Apl_PCP_mm
BL.ALL$MAY_RR <- BL.ALL$May_RO_mm/BL.ALL$May_PCP_mm
BL.ALL$JUN_RR <- BL.ALL$Jun_RO_mm/BL.ALL$Jun_PCP_mm
BL.ALL$JUL_RR <- BL.ALL$Jul_RO_mm/BL.ALL$Jul_PCP_mm
BL.ALL$AUG_RR <- BL.ALL$Aug_RO_mm/BL.ALL$Aug_PCP_mm
BL.ALL$SEP_RR <- BL.ALL$Sep_RO_mm/BL.ALL$Sep_PCP_mm
BL.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(BL.ALL[,-1],2, mean))
CSD <- rbind(apply(BL.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
BL.ALL[nrow(BL.ALL)+ 1,] = CML
BL.ALL[nrow(BL.ALL)+ 1,] = CSDL
BL.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(BL.ALL[1:47,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
BL.TS <-BL.ALL[1:47,1:40]
BL.TSN <- as.data.frame(apply(BL.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(BL.TSN, class)   
BL.TSN
```
############################################
```{r}
BLM1 <- mblm(AN_RO_mm~ Water_Year_Year, BL.TSN)
BLM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BL.TSN)
BLM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BL.TSN)
BLM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BL.TSN)
BLM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BL.TSN)
BLM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BL.TSN)
BLM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BL.TSN)
BLM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BL.TSN)
BLM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BL.TSN)
BLM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BL.TSN)
BLM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BL.TSN)
BLM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BL.TSN)
BLM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BL.TSN)
BLM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BL.TSN)
BLM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BL.TSN)
BLM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BL.TSN)
BLM17 <- mblm(May_RO_mm~ Water_Year_Year, BL.TSN)
BLM18 <- mblm(May_PCP_mm~ Water_Year_Year, BL.TSN)
BLM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BL.TSN)
BLM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BL.TSN)
BLM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BL.TSN)
BLM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BL.TSN)
BLM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BL.TSN)
BLM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BL.TSN)
BLM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BL.TSN)
BLM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BL.TSN)
BLM27 <- mblm(AN_RR~ Water_Year_Year, BL.TSN)
BLM28 <- mblm(OCT_RR~ Water_Year_Year, BL.TSN)
BLM29 <- mblm(NOV_RR~ Water_Year_Year, BL.TSN)
BLM30 <- mblm(DEC_RR~ Water_Year_Year, BL.TSN)
BLM31 <- mblm(JAN_RR~ Water_Year_Year, BL.TSN)
BLM32 <- mblm(FEB_RR~ Water_Year_Year, BL.TSN)
BLM33 <- mblm(MAR_RR~ Water_Year_Year, BL.TSN)
BLM34 <- mblm(APL_RR~ Water_Year_Year, BL.TSN)
BLM35 <- mblm(MAY_RR~ Water_Year_Year, BL.TSN)
BLM36 <- mblm(JUN_RR~ Water_Year_Year, BL.TSN)
BLM37 <- mblm(JUL_RR~ Water_Year_Year, BL.TSN)
BLM38 <- mblm(AUG_RR~ Water_Year_Year, BL.TSN)
BLM39 <- mblm(SEP_RR~ Water_Year_Year, BL.TSN)
```
####################################
```{r}
TSR<- cbind(BLM1$coefficients, BLM2$coefficients, BLM3$coefficients, BLM4$coefficients, BLM5$coefficients, BLM6$coefficients,BLM7$coefficients, BLM8$coefficients, BLM9$coefficients,BLM10$coefficients, BLM11$coefficients, BLM12$coefficients,BLM13$coefficients, BLM14$coefficients, BLM15$coefficients,BLM16$coefficients, BLM17$coefficients, BLM18$coefficients,BLM19$coefficients, BLM20$coefficients, BLM21$coefficients,BLM22$coefficients, BLM23$coefficients, BLM4$coefficients,BLM25$coefficients, BLM26$coefficients, BLM27$coefficients,BLM28$coefficients, BLM29$coefficients, BLM30$coefficients,BLM31$coefficients, BLM32$coefficients, BLM33$coefficients,BLM34$coefficients, BLM35$coefficients, BLM36$coefficients,BLM37$coefficients, BLM38$coefficients, BLM39$coefficients)
RES <- cbind(BLM1$residuals, BLM2$residuals, BLM3$residuals, BLM4$residuals, BLM5$residuals, BLM6$residuals,BLM7$residuals, BLM8$residuals, BLM9$residuals,BLM10$residuals, BLM11$residuals, BLM12$residuals,BLM13$residuals, BLM14$residuals, BLM15$residuals,BLM16$residuals, BLM17$residuals, BLM18$residuals,BLM19$residuals, BLM20$residuals, BLM21$residuals,BLM22$residuals, BLM23$residuals, BLM4$residuals,BLM25$residuals, BLM26$residuals, BLM27$residuals,BLM28$residuals, BLM29$residuals, BLM30$residuals,BLM31$residuals, BLM32$residuals, BLM33$residuals,BLM34$residuals, BLM35$residuals, BLM36$residuals,BLM37$residuals, BLM38$residuals, BLM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BL.ALL[nrow(BL.ALL)+ 1,] = MKTR
BL.ALL[nrow(BL.ALL)+ 1,] = MKPR
BL.ALL[nrow(BL.ALL)+ 1,] = TSRR
BL.ALL[nrow(BL.ALL)+ 1,] = BTDF
BL.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- BL.ALL[1:47,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
BL.ALL[nrow(BL.ALL)+ 1,] = MMKPR
BL.ALL[nrow(BL.ALL)+ 1,] = MMKTR
BL.ALL[nrow(BL.ALL)+ 1,] = MMKSR
BL.ALL
```

```{r}
BL.NUM <- as.data.frame(apply(BL.ALL[1:56,2:40], 2, as.numeric))
str(BL.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(BL.NUM[53,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(BL.NUM[52,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(BL.NUM[56,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(BL.NUM[51,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(BL.NUM[54,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
BL.ALL[nrow(BL.ALL)+ 1,] = FSR1
BL.ALL[nrow(BL.ALL)+ 1,] = FSR2
BL.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
BLFM <-BL.ALL[c(57,58),-1]
BLF <- as.matrix(apply(BLFM, 2, as.numeric))
BLF
```
###########################################################
```{r}
### Water Year 19 = 1990 onwards
```


###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(BL.ALL[21:47,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
BL.TS2 <-BL.ALL[21:47,1:40] ## 1990 Subset
BL.TSN2 <- as.data.frame(apply(BL.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(BL.TSN2, class)   
BL.TSN2
```
############################################
```{r}
BLM1 <- mblm(AN_RO_mm~ Water_Year_Year, BL.TSN2)
BLM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BL.TSN2)
BLM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BL.TSN2)
BLM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BL.TSN2)
BLM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BL.TSN2)
BLM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BL.TSN2)
BLM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BL.TSN2)
BLM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BL.TSN2)
BLM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BL.TSN2)
BLM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BL.TSN2)
BLM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BL.TSN2)
BLM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BL.TSN2)
BLM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BL.TSN2)
BLM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BL.TSN2)
BLM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BL.TSN2)
BLM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BL.TSN2)
BLM17 <- mblm(May_RO_mm~ Water_Year_Year, BL.TSN2)
BLM18 <- mblm(May_PCP_mm~ Water_Year_Year, BL.TSN2)
BLM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BL.TSN2)
BLM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BL.TSN2)
BLM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BL.TSN2)
BLM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BL.TSN2)
BLM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BL.TSN2)
BLM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BL.TSN2)
BLM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BL.TSN2)
BLM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BL.TSN2)
BLM27 <- mblm(AN_RR~ Water_Year_Year, BL.TSN2)
BLM28 <- mblm(OCT_RR~ Water_Year_Year, BL.TSN2)
BLM29 <- mblm(NOV_RR~ Water_Year_Year, BL.TSN2)
BLM30 <- mblm(DEC_RR~ Water_Year_Year, BL.TSN2)
BLM31 <- mblm(JAN_RR~ Water_Year_Year, BL.TSN2)
BLM32 <- mblm(FEB_RR~ Water_Year_Year, BL.TSN2)
BLM33 <- mblm(MAR_RR~ Water_Year_Year, BL.TSN2)
BLM34 <- mblm(APL_RR~ Water_Year_Year, BL.TSN2)
BLM35 <- mblm(MAY_RR~ Water_Year_Year, BL.TSN2)
BLM36 <- mblm(JUN_RR~ Water_Year_Year, BL.TSN2)
BLM37 <- mblm(JUL_RR~ Water_Year_Year, BL.TSN2)
BLM38 <- mblm(AUG_RR~ Water_Year_Year, BL.TSN2)
BLM39 <- mblm(SEP_RR~ Water_Year_Year, BL.TSN2)
```
####################################
```{r}
TSR2<- cbind(BLM1$coefficients, BLM2$coefficients, BLM3$coefficients, BLM4$coefficients, BLM5$coefficients, BLM6$coefficients,BLM7$coefficients, BLM8$coefficients, BLM9$coefficients,BLM10$coefficients, BLM11$coefficients, BLM12$coefficients,BLM13$coefficients, BLM14$coefficients, BLM15$coefficients,BLM16$coefficients, BLM17$coefficients, BLM18$coefficients,BLM19$coefficients, BLM20$coefficients, BLM21$coefficients,BLM22$coefficients, BLM23$coefficients, BLM4$coefficients,BLM25$coefficients, BLM26$coefficients, BLM27$coefficients,BLM28$coefficients, BLM29$coefficients, BLM30$coefficients,BLM31$coefficients, BLM32$coefficients, BLM33$coefficients,BLM34$coefficients, BLM35$coefficients, BLM36$coefficients,BLM37$coefficients, BLM38$coefficients, BLM39$coefficients)
RES2 <- cbind(BLM1$residuals, BLM2$residuals, BLM3$residuals, BLM4$residuals, BLM5$residuals, BLM6$residuals,BLM7$residuals, BLM8$residuals, BLM9$residuals,BLM10$residuals, BLM11$residuals, BLM12$residuals,BLM13$residuals, BLM14$residuals, BLM15$residuals,BLM16$residuals, BLM17$residuals, BLM18$residuals,BLM19$residuals, BLM20$residuals, BLM21$residuals,BLM22$residuals, BLM23$residuals, BLM4$residuals,BLM25$residuals, BLM26$residuals, BLM27$residuals,BLM28$residuals, BLM29$residuals, BLM30$residuals,BLM31$residuals, BLM32$residuals, BLM33$residuals,BLM34$residuals, BLM35$residuals, BLM36$residuals,BLM37$residuals, BLM38$residuals, BLM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BL.ALL[nrow(BL.ALL)+ 1,] = MKTR2
BL.ALL[nrow(BL.ALL)+ 1,] = MKPR2
BL.ALL[nrow(BL.ALL)+ 1,] = TSRR2
BL.ALL[nrow(BL.ALL)+ 1,] = BTDF2
BL.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- BL.ALL[21:47,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
BL.ALL[nrow(BL.ALL)+ 1,] = MMKPR2
BL.ALL[nrow(BL.ALL)+ 1,] = MMKTR2
BL.ALL[nrow(BL.ALL)+ 1,] = MMKSR2
BL.ALL
```

```{r}
BL.ALL
```

```{r}
BL.NUM2 <- as.data.frame(apply(BL.ALL[1:65,2:40], 2, as.numeric))
str(BL.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(BL.NUM2[62,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(BL.NUM2[61,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(BL.NUM2[65,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(BL.NUM2[60,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(BL.NUM2[63,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
BL.ALL[nrow(BL.ALL)+ 1,] = FSR12
BL.ALL[nrow(BL.ALL)+ 1,] = FSR22
BL.ALL
```

```{r}
BL.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
BLFM2 <-BL.ALL[c(66,67),-1]
BLF2 <- as.matrix(apply(BLFM2, 2, as.numeric))
BLF2
```


### Shoma Ya Results, csv 'BM' ID 31 
```{r}
### Summarise by Month
BM$Days <- days_in_month(as.Date(BM$Date, "%Y-%m-%d"))
BM$StreamflowMon_m3<- BM$Streamflow*(60*60*24)*BM$Days
BM.MON <- BM 
BM.MON$Streamflow_Km<-BM.MON$StreamflowMon_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
BM.MON$Streamflow_mm<-(BM.MON$Streamflow_Km/468)*1000000 ## monthly runoff depth mm
BM.MON
```

```{r}
BM.MONT <-BM.MON[-c(1,2,3,4,5,6,7,8,9,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564),]
BM.MONT
```



```{r}
BMT <- GMP2[[970:1509]] ## Shoma Ya
BME <- extent(62,62.5,63.5,64) ## Shoma Ya
BMPC <- crop(BMT, BME) ## Shoma Ya
BM.Mon.Precip.<-extract(BMPC,BME, method="bilinear", fun = mean)
BMMP<-as.data.frame(colMeans(BM.Mon.Precip.)) # Shoma Ya
BMSub<-DateTemp[DateTemp$Date >= as.Date("1971-10-01") & DateTemp$Date <=
                    as.Date("2016-09-01"), ] ##Shoma Ya
BMPp<- cbind(BMMP,BMSub) ## Shoma Ya

```

```{r}
BM.MONT$GriddedPrecip_mm<- BMMP$`colMeans(BM.Mon.Precip.)`
BM.MONT
```

```{r}
## Gap filling process
BM.M1 <- subset(BM.MONT, Month == 1)
BM.M2 <- subset(BM.MONT, Month == 2)
BM.M3 <- subset(BM.MONT, Month == 3)
BM.M4 <- subset(BM.MONT, Month == 4)
BM.M5 <- subset(BM.MONT, Month == 5)
BM.M6 <- subset(BM.MONT, Month == 6)
BM.M7 <- subset(BM.MONT, Month == 7)
BM.M8 <- subset(BM.MONT, Month == 8)
BM.M9 <- subset(BM.MONT, Month == 9)
BM.M10 <- subset(BM.MONT, Month == 10)
BM.M11 <- subset(BM.MONT, Month == 11)
BM.M12 <- subset(BM.MONT, Month == 12)


BM.1 <-mean(BM.M1$Streamflow_mm, na.rm = TRUE)
BM.2 <- mean(BM.M2$Streamflow_mm, na.rm = TRUE)
BM.3 <- mean(BM.M3$Streamflow_mm, na.rm = TRUE)
BM.4 <- mean(BM.M4$Streamflow_mm, na.rm = TRUE)
BM.5 <-mean(BM.M5$Streamflow_mm, na.rm = TRUE)
BM.6 <- mean(BM.M6$Streamflow_mm, na.rm = TRUE)
BM.7 <- mean(BM.M7$Streamflow_mm, na.rm = TRUE)
BM.8 <- mean(BM.M8$Streamflow_mm, na.rm = TRUE)
BM.9 <- mean(BM.M9$Streamflow_mm, na.rm = TRUE)
BM.10 <- mean(BM.M10$Streamflow_mm, na.rm = TRUE)
BM.11 <- mean(BM.M11$Streamflow_mm, na.rm = TRUE)
BM.12 <- mean(BM.M12$Streamflow_mm, na.rm = TRUE)

BM.MONT[c(88,448,460),9] <- BM.1
BM.MONT[c(89,461),9] <- BM.2
BM.MONT[c(90,462),9] <- BM.3
BM.MONT[c(91,343,463,475),9] <- BM.4
BM.MONT[c(344),9] <- BM.5
BM.MONT[c(297,345),9] <- BM.6
BM.MONT[c(274,298),9] <- BM.7
BM.MONT[c(275,440),9] <- BM.8
BM.MONT[c(276),9] <- BM.9
BM.MONT[c(277),9] <- BM.10
BM.MONT[c(278,446),9] <- BM.11
BM.MONT[c(459),9] <- BM.12


BM.MONT
```


##############
```{r}
## Water Year Sequencing
BM.MT<- BM.MONT
BM.MT$Water_Year_Month <- rep(seq(1:12),45) #1975 to 2016 is 43 years
BM.MT$Water_Year_Year <- rep(1:45, each =12)
BM.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 BM.WY <- BM.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
BM.WY
```
##############
```{r}
## Monthly Columns
## Oct
 BM.OCT <- BM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 BM.NOV <- BM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 BM.DEC <- BM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 BM.JAN <- BM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 BM.FEB <- BM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 BM.MAR <- BM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 BM.APL <- BM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 BM.MAY <- BM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 BM.JUN <- BM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 BM.JUL <- BM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 BM.AUG <- BM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 BM.SEP <- BM.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
BM.ALL <- cbind(BM.WY, BM.OCT[,-1], BM.NOV[,-1], BM.DEC[,-1], BM.JAN[,-1], BM.FEB[,-1], BM.MAR[,-1], BM.APL[,-1],BM.MAY[,-1], BM.JUN[,-1], BM.JUL[,-1], BM.AUG[,-1], BM.SEP[,-1])
```
####################
```{r}
BM.ALL$AN_RR <- BM.ALL$AN_RO_mm/BM.ALL$AN_PCP_mm
BM.ALL$OCT_RR <- BM.ALL$Oct_RO_mm/BM.ALL$Oct_PCP_mm
BM.ALL$NOV_RR <- BM.ALL$Nov_RO_mm/BM.ALL$Nov_PCP_mm
BM.ALL$DEC_RR <- BM.ALL$Dec_RO_mm/BM.ALL$Dec_PCP_mm
BM.ALL$JAN_RR <- BM.ALL$Jan_RO_mm/BM.ALL$Jan_PCP_mm
BM.ALL$FEB_RR <- BM.ALL$Feb_RO_mm/BM.ALL$Feb_PCP_mm
BM.ALL$MAR_RR <- BM.ALL$Mar_RO_mm/BM.ALL$Mar_PCP_mm
BM.ALL$APL_RR <- BM.ALL$Apl_RO_mm/BM.ALL$Apl_PCP_mm
BM.ALL$MAY_RR <- BM.ALL$May_RO_mm/BM.ALL$May_PCP_mm
BM.ALL$JUN_RR <- BM.ALL$Jun_RO_mm/BM.ALL$Jun_PCP_mm
BM.ALL$JUL_RR <- BM.ALL$Jul_RO_mm/BM.ALL$Jul_PCP_mm
BM.ALL$AUG_RR <- BM.ALL$Aug_RO_mm/BM.ALL$Aug_PCP_mm
BM.ALL$SEP_RR <- BM.ALL$Sep_RO_mm/BM.ALL$Sep_PCP_mm
BM.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(BM.ALL[,-1],2, mean))
CSD <- rbind(apply(BM.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
BM.ALL[nrow(BM.ALL)+ 1,] = CML
BM.ALL[nrow(BM.ALL)+ 1,] = CSDL
BM.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(BM.ALL[1:45,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
BM.TS <-BM.ALL[1:45,1:40]
BM.TSN <- as.data.frame(apply(BM.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(BM.TSN, class)   
BM.TSN
```
############################################
```{r}
BMM1 <- mblm(AN_RO_mm~ Water_Year_Year, BM.TSN)
BMM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BM.TSN)
BMM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BM.TSN)
BMM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BM.TSN)
BMM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BM.TSN)
BMM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BM.TSN)
BMM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BM.TSN)
BMM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BM.TSN)
BMM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BM.TSN)
BMM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BM.TSN)
BMM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BM.TSN)
BMM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BM.TSN)
BMM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BM.TSN)
BMM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BM.TSN)
BMM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BM.TSN)
BMM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BM.TSN)
BMM17 <- mblm(May_RO_mm~ Water_Year_Year, BM.TSN)
BMM18 <- mblm(May_PCP_mm~ Water_Year_Year, BM.TSN)
BMM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BM.TSN)
BMM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BM.TSN)
BMM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BM.TSN)
BMM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BM.TSN)
BMM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BM.TSN)
BMM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BM.TSN)
BMM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BM.TSN)
BMM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BM.TSN)
BMM27 <- mblm(AN_RR~ Water_Year_Year, BM.TSN)
BMM28 <- mblm(OCT_RR~ Water_Year_Year, BM.TSN)
BMM29 <- mblm(NOV_RR~ Water_Year_Year, BM.TSN)
BMM30 <- mblm(DEC_RR~ Water_Year_Year, BM.TSN)
BMM31 <- mblm(JAN_RR~ Water_Year_Year, BM.TSN)
BMM32 <- mblm(FEB_RR~ Water_Year_Year, BM.TSN)
BMM33 <- mblm(MAR_RR~ Water_Year_Year, BM.TSN)
BMM34 <- mblm(APL_RR~ Water_Year_Year, BM.TSN)
BMM35 <- mblm(MAY_RR~ Water_Year_Year, BM.TSN)
BMM36 <- mblm(JUN_RR~ Water_Year_Year, BM.TSN)
BMM37 <- mblm(JUL_RR~ Water_Year_Year, BM.TSN)
BMM38 <- mblm(AUG_RR~ Water_Year_Year, BM.TSN)
BMM39 <- mblm(SEP_RR~ Water_Year_Year, BM.TSN)
```
####################################
```{r}
TSR<- cbind(BMM1$coefficients, BMM2$coefficients, BMM3$coefficients, BMM4$coefficients, BMM5$coefficients, BMM6$coefficients,BMM7$coefficients, BMM8$coefficients, BMM9$coefficients,BMM10$coefficients, BMM11$coefficients, BMM12$coefficients,BMM13$coefficients, BMM14$coefficients, BMM15$coefficients,BMM16$coefficients, BMM17$coefficients, BMM18$coefficients,BMM19$coefficients, BMM20$coefficients, BMM21$coefficients,BMM22$coefficients, BMM23$coefficients, BMM4$coefficients,BMM25$coefficients, BMM26$coefficients, BMM27$coefficients,BMM28$coefficients, BMM29$coefficients, BMM30$coefficients,BMM31$coefficients, BMM32$coefficients, BMM33$coefficients,BMM34$coefficients, BMM35$coefficients, BMM36$coefficients,BMM37$coefficients, BMM38$coefficients, BMM39$coefficients)
RES <- cbind(BMM1$residuals, BMM2$residuals, BMM3$residuals, BMM4$residuals, BMM5$residuals, BMM6$residuals,BMM7$residuals, BMM8$residuals, BMM9$residuals,BMM10$residuals, BMM11$residuals, BMM12$residuals,BMM13$residuals, BMM14$residuals, BMM15$residuals,BMM16$residuals, BMM17$residuals, BMM18$residuals,BMM19$residuals, BMM20$residuals, BMM21$residuals,BMM22$residuals, BMM23$residuals, BMM4$residuals,BMM25$residuals, BMM26$residuals, BMM27$residuals,BMM28$residuals, BMM29$residuals, BMM30$residuals,BMM31$residuals, BMM32$residuals, BMM33$residuals,BMM34$residuals, BMM35$residuals, BMM36$residuals,BMM37$residuals, BMM38$residuals, BMM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BM.ALL[nrow(BM.ALL)+ 1,] = MKTR
BM.ALL[nrow(BM.ALL)+ 1,] = MKPR
BM.ALL[nrow(BM.ALL)+ 1,] = TSRR
BM.ALL[nrow(BM.ALL)+ 1,] = BTDF
BM.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- BM.ALL[1:46,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
BM.ALL[nrow(BM.ALL)+ 1,] = MMKPR
BM.ALL[nrow(BM.ALL)+ 1,] = MMKTR
BM.ALL[nrow(BM.ALL)+ 1,] = MMKSR
BM.ALL
```

```{r}
BM.NUM <- as.data.frame(apply(BM.ALL[1:54,2:40], 2, as.numeric))
str(BM.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(BM.NUM[51,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(BM.NUM[50,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(BM.NUM[54,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(BM.NUM[49,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(BM.NUM[52,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
BM.ALL[nrow(BM.ALL)+ 1,] = FSR1
BM.ALL[nrow(BM.ALL)+ 1,] = FSR2
BM.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
BMFM <-BM.ALL[c(55,56),-1]
BMF <- as.matrix(apply(BMFM, 2, as.numeric))
BMF
```
###########################################################
```{r}
### Water Year 19 = 1990 onwards
```

###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(BM.ALL[19:45,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
BM.TS2 <-BM.ALL[19:45,1:40] ## 1990 Subset
BM.TSN2 <- as.data.frame(apply(BM.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(BM.TSN2, class)   
BM.TSN2
```
############################################
```{r}
BMM1 <- mblm(AN_RO_mm~ Water_Year_Year, BM.TSN2)
BMM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BM.TSN2)
BMM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BM.TSN2)
BMM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BM.TSN2)
BMM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BM.TSN2)
BMM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BM.TSN2)
BMM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BM.TSN2)
BMM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BM.TSN2)
BMM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BM.TSN2)
BMM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BM.TSN2)
BMM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BM.TSN2)
BMM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BM.TSN2)
BMM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BM.TSN2)
BMM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BM.TSN2)
BMM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BM.TSN2)
BMM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BM.TSN2)
BMM17 <- mblm(May_RO_mm~ Water_Year_Year, BM.TSN2)
BMM18 <- mblm(May_PCP_mm~ Water_Year_Year, BM.TSN2)
BMM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BM.TSN2)
BMM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BM.TSN2)
BMM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BM.TSN2)
BMM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BM.TSN2)
BMM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BM.TSN2)
BMM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BM.TSN2)
BMM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BM.TSN2)
BMM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BM.TSN2)
BMM27 <- mblm(AN_RR~ Water_Year_Year, BM.TSN2)
BMM28 <- mblm(OCT_RR~ Water_Year_Year, BM.TSN2)
BMM29 <- mblm(NOV_RR~ Water_Year_Year, BM.TSN2)
BMM30 <- mblm(DEC_RR~ Water_Year_Year, BM.TSN2)
BMM31 <- mblm(JAN_RR~ Water_Year_Year, BM.TSN2)
BMM32 <- mblm(FEB_RR~ Water_Year_Year, BM.TSN2)
BMM33 <- mblm(MAR_RR~ Water_Year_Year, BM.TSN2)
BMM34 <- mblm(APL_RR~ Water_Year_Year, BM.TSN2)
BMM35 <- mblm(MAY_RR~ Water_Year_Year, BM.TSN2)
BMM36 <- mblm(JUN_RR~ Water_Year_Year, BM.TSN2)
BMM37 <- mblm(JUL_RR~ Water_Year_Year, BM.TSN2)
BMM38 <- mblm(AUG_RR~ Water_Year_Year, BM.TSN2)
BMM39 <- mblm(SEP_RR~ Water_Year_Year, BM.TSN2)
```
####################################
```{r}
TSR2<- cbind(BMM1$coefficients, BMM2$coefficients, BMM3$coefficients, BMM4$coefficients, BMM5$coefficients, BMM6$coefficients,BMM7$coefficients, BMM8$coefficients, BMM9$coefficients,BMM10$coefficients, BMM11$coefficients, BMM12$coefficients,BMM13$coefficients, BMM14$coefficients, BMM15$coefficients,BMM16$coefficients, BMM17$coefficients, BMM18$coefficients,BMM19$coefficients, BMM20$coefficients, BMM21$coefficients,BMM22$coefficients, BMM23$coefficients, BMM4$coefficients,BMM25$coefficients, BMM26$coefficients, BMM27$coefficients,BMM28$coefficients, BMM29$coefficients, BMM30$coefficients,BMM31$coefficients, BMM32$coefficients, BMM33$coefficients,BMM34$coefficients, BMM35$coefficients, BMM36$coefficients,BMM37$coefficients, BMM38$coefficients, BMM39$coefficients)
RES2 <- cbind(BMM1$residuals, BMM2$residuals, BMM3$residuals, BMM4$residuals, BMM5$residuals, BMM6$residuals,BMM7$residuals, BMM8$residuals, BMM9$residuals,BMM10$residuals, BMM11$residuals, BMM12$residuals,BMM13$residuals, BMM14$residuals, BMM15$residuals,BMM16$residuals, BMM17$residuals, BMM18$residuals,BMM19$residuals, BMM20$residuals, BMM21$residuals,BMM22$residuals, BMM23$residuals, BMM4$residuals,BMM25$residuals, BMM26$residuals, BMM27$residuals,BMM28$residuals, BMM29$residuals, BMM30$residuals,BMM31$residuals, BMM32$residuals, BMM33$residuals,BMM34$residuals, BMM35$residuals, BMM36$residuals,BMM37$residuals, BMM38$residuals, BMM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BM.ALL[nrow(BM.ALL)+ 1,] = MKTR2
BM.ALL[nrow(BM.ALL)+ 1,] = MKPR2
BM.ALL[nrow(BM.ALL)+ 1,] = TSRR2
BM.ALL[nrow(BM.ALL)+ 1,] = BTDF2
BM.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- BM.ALL[19:45,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
BM.ALL[nrow(BM.ALL)+ 1,] = MMKPR2
BM.ALL[nrow(BM.ALL)+ 1,] = MMKTR2
BM.ALL[nrow(BM.ALL)+ 1,] = MMKSR2
BM.ALL
```

```{r}
BM.ALL
```

```{r}
BM.NUM2 <- as.data.frame(apply(BM.ALL[1:63,2:40], 2, as.numeric))
str(BM.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(BM.NUM2[60,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(BM.NUM2[59,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(BM.NUM2[63,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(BM.NUM2[58,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(BM.NUM2[61,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
BM.ALL[nrow(BM.ALL)+ 1,] = FSR12
BM.ALL[nrow(BM.ALL)+ 1,] = FSR22
BM.ALL
```

```{r}
BM.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
BMFM2 <-BM.ALL[c(64,65),-1]
BMF2 <- as.matrix(apply(BMFM2, 2, as.numeric))
BMF2
```

### Sovetskaya, Result ID 'BP' 32
```{r}
### Summarise by Month
names(BP)[names(BP) == "..Date"] <- "Date"
BP$StreamflowDay_m3<-BP$Streamflow*(60*60*24)
BP.MON <- BP %>%
   group_by(Year, Month) %>%
   summarise(Month_Streamflow_m3 = sum(StreamflowDay_m3))
BP.MON$Streamflow_Km<-BP.MON$Month_Streamflow_m3/1000000000 # monthly runoff volume km^3
BP.MON$Streamflow_mm<-(BP.MON$Streamflow_Km/1430)*1000000 ## monthly runoff depth mm
BP.MON

#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
BP.MONT<- BP.MON[-c(1,2,3,4,5,6,7,8,9,574,575,576),]
BP.MONT
```


```{r}
BPT <- GMP2[[946:1509]] ##Sovetskaya
BPE <- extent(83,83.5,66.5,67.5) ##Sovetskaya
BPPC <- crop(BPT, BPE) ##Sovetskaya
BP.Mon.Precip.<-extract(BPPC,BPE, method="bilinear", fun = mean)
BPMP<-as.data.frame(colMeans(BP.Mon.Precip.)) # Sovetskaya
BPSub<-DateTemp[DateTemp$Date >= as.Date("1969-10-01") & DateTemp$Date <=
                    as.Date("2016-09-01"), ] ##Sovetskaya
BPPp<- cbind(BPMP,BPSub) ## Sovetskaya
```

```{r}
BP.MONT$GriddedPrecip_mm<- BPMP$`colMeans(BP.Mon.Precip.)`
BP.MONT
```

```{r}
## Gab filling process

BP.M1 <- subset(BP.MONT, Month == 1)
BP.M2 <- subset(BP.MONT, Month == 2)
BP.M3 <- subset(BP.MONT, Month == 3)
BP.M4 <- subset(BP.MONT, Month == 4)
BP.M5 <- subset(BP.MONT, Month == 5)
BP.M6 <- subset(BP.MONT, Month == 6)
BP.M7 <- subset(BP.MONT, Month == 7)
BP.M8 <- subset(BP.MONT, Month == 8)
BP.M9 <- subset(BP.MONT, Month == 9)
BP.M10 <- subset(BP.MONT, Month == 10)
BP.M11 <- subset(BP.MONT, Month == 11)
BP.M12 <- subset(BP.MONT, Month == 12)


BP.1 <-mean(BP.M1$Streamflow_mm, na.rm = TRUE)
BP.2 <- mean(BP.M2$Streamflow_mm, na.rm = TRUE)
BP.3 <- mean(BP.M3$Streamflow_mm, na.rm = TRUE)
BP.4 <- mean(BP.M4$Streamflow_mm, na.rm = TRUE)
BP.5 <-mean(BP.M5$Streamflow_mm, na.rm = TRUE)
BP.6 <- mean(BP.M6$Streamflow_mm, na.rm = TRUE)
BP.7 <- mean(BP.M7$Streamflow_mm, na.rm = TRUE)
BP.8 <- mean(BP.M8$Streamflow_mm, na.rm = TRUE)
BP.9 <- mean(BP.M9$Streamflow_mm, na.rm = TRUE)
BP.10 <- mean(BP.M10$Streamflow_mm, na.rm = TRUE)
BP.11 <- mean(BP.M11$Streamflow_mm, na.rm = TRUE)
BP.12 <- mean(BP.M12$Streamflow_mm, na.rm = TRUE)

BP.MONT[c(4,16,28),5] <- BP.1
BP.MONT[c(5,17,29,377),5] <- BP.2
BP.MONT[c(6,18,30,114,378),5] <- BP.3
BP.MONT[c(7,19,31,379),5] <- BP.4
BP.MONT[c(8,20,32),5] <- BP.5
BP.MONT[c(9,21,33),5] <- BP.6
BP.MONT[c(10),5] <- BP.7
BP.MONT[c(11,527),5] <- BP.8
BP.MONT[c(12),5] <- BP.9
BP.MONT[c(1,13,25),5] <- BP.10
BP.MONT[c(2,14,26),5] <- BP.11
BP.MONT[c(3,15,27),5] <- BP.12


BP.MONT
```


##############
```{r}
## Water Year Sequencing
BP.MT<- BP.MONT
BP.MT$Water_Year_Month <- rep(seq(1:12),47) #1975 to 2016 is 43 years
BP.MT$Water_Year_Year <- rep(1:47, each =12)
BP.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 BP.WY <- BP.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
BP.WY
```
##############
```{r}
## Monthly Columns
## Oct
 BP.OCT <- BP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 BP.NOV <- BP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 BP.DEC <- BP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 BP.JAN <- BP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 BP.FEB <- BP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 BP.MAR <- BP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 BP.APL <- BP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 BP.MAY <- BP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 BP.JUN <- BP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 BP.JUL <- BP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 BP.AUG <- BP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 BP.SEP <- BP.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
BP.ALL <- cbind(BP.WY, BP.OCT[,-1], BP.NOV[,-1], BP.DEC[,-1], BP.JAN[,-1], BP.FEB[,-1], BP.MAR[,-1], BP.APL[,-1],BP.MAY[,-1], BP.JUN[,-1], BP.JUL[,-1], BP.AUG[,-1], BP.SEP[,-1])
```
####################
```{r}
BP.ALL$AN_RR <- BP.ALL$AN_RO_mm/BP.ALL$AN_PCP_mm
BP.ALL$OCT_RR <- BP.ALL$Oct_RO_mm/BP.ALL$Oct_PCP_mm
BP.ALL$NOV_RR <- BP.ALL$Nov_RO_mm/BP.ALL$Nov_PCP_mm
BP.ALL$DEC_RR <- BP.ALL$Dec_RO_mm/BP.ALL$Dec_PCP_mm
BP.ALL$JAN_RR <- BP.ALL$Jan_RO_mm/BP.ALL$Jan_PCP_mm
BP.ALL$FEB_RR <- BP.ALL$Feb_RO_mm/BP.ALL$Feb_PCP_mm
BP.ALL$MAR_RR <- BP.ALL$Mar_RO_mm/BP.ALL$Mar_PCP_mm
BP.ALL$APL_RR <- BP.ALL$Apl_RO_mm/BP.ALL$Apl_PCP_mm
BP.ALL$MAY_RR <- BP.ALL$May_RO_mm/BP.ALL$May_PCP_mm
BP.ALL$JUN_RR <- BP.ALL$Jun_RO_mm/BP.ALL$Jun_PCP_mm
BP.ALL$JUL_RR <- BP.ALL$Jul_RO_mm/BP.ALL$Jul_PCP_mm
BP.ALL$AUG_RR <- BP.ALL$Aug_RO_mm/BP.ALL$Aug_PCP_mm
BP.ALL$SEP_RR <- BP.ALL$Sep_RO_mm/BP.ALL$Sep_PCP_mm
BP.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(BP.ALL[,-1],2, mean))
CSD <- rbind(apply(BP.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
BP.ALL[nrow(BP.ALL)+ 1,] = CML
BP.ALL[nrow(BP.ALL)+ 1,] = CSDL
BP.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(BP.ALL[1:47,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
BP.TS <-BP.ALL[1:47,1:40]
BP.TSN <- as.data.frame(apply(BP.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(BP.TSN, class)   
BP.TSN
```
############################################
```{r}
BPM1 <- mblm(AN_RO_mm~ Water_Year_Year, BP.TSN)
BPM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BP.TSN)
BPM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BP.TSN)
BPM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BP.TSN)
BPM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BP.TSN)
BPM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BP.TSN)
BPM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BP.TSN)
BPM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BP.TSN)
BPM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BP.TSN)
BPM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BP.TSN)
BPM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BP.TSN)
BPM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BP.TSN)
BPM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BP.TSN)
BPM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BP.TSN)
BPM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BP.TSN)
BPM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BP.TSN)
BPM17 <- mblm(May_RO_mm~ Water_Year_Year, BP.TSN)
BPM18 <- mblm(May_PCP_mm~ Water_Year_Year, BP.TSN)
BPM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BP.TSN)
BPM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BP.TSN)
BPM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BP.TSN)
BPM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BP.TSN)
BPM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BP.TSN)
BPM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BP.TSN)
BPM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BP.TSN)
BPM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BP.TSN)
BPM27 <- mblm(AN_RR~ Water_Year_Year, BP.TSN)
BPM28 <- mblm(OCT_RR~ Water_Year_Year, BP.TSN)
BPM29 <- mblm(NOV_RR~ Water_Year_Year, BP.TSN)
BPM30 <- mblm(DEC_RR~ Water_Year_Year, BP.TSN)
BPM31 <- mblm(JAN_RR~ Water_Year_Year, BP.TSN)
BPM32 <- mblm(FEB_RR~ Water_Year_Year, BP.TSN)
BPM33 <- mblm(MAR_RR~ Water_Year_Year, BP.TSN)
BPM34 <- mblm(APL_RR~ Water_Year_Year, BP.TSN)
BPM35 <- mblm(MAY_RR~ Water_Year_Year, BP.TSN)
BPM36 <- mblm(JUN_RR~ Water_Year_Year, BP.TSN)
BPM37 <- mblm(JUL_RR~ Water_Year_Year, BP.TSN)
BPM38 <- mblm(AUG_RR~ Water_Year_Year, BP.TSN)
BPM39 <- mblm(SEP_RR~ Water_Year_Year, BP.TSN)
```
####################################
```{r}
TSR<- cbind(BPM1$coefficients, BPM2$coefficients, BPM3$coefficients, BPM4$coefficients, BPM5$coefficients, BPM6$coefficients,BPM7$coefficients, BPM8$coefficients, BPM9$coefficients,BPM10$coefficients, BPM11$coefficients, BPM12$coefficients,BPM13$coefficients, BPM14$coefficients, BPM15$coefficients,BPM16$coefficients, BPM17$coefficients, BPM18$coefficients,BPM19$coefficients, BPM20$coefficients, BPM21$coefficients,BPM22$coefficients, BPM23$coefficients, BPM4$coefficients,BPM25$coefficients, BPM26$coefficients, BPM27$coefficients,BPM28$coefficients, BPM29$coefficients, BPM30$coefficients,BPM31$coefficients, BPM32$coefficients, BPM33$coefficients,BPM34$coefficients, BPM35$coefficients, BPM36$coefficients,BPM37$coefficients, BPM38$coefficients, BPM39$coefficients)
RES <- cbind(BPM1$residuals, BPM2$residuals, BPM3$residuals, BPM4$residuals, BPM5$residuals, BPM6$residuals,BPM7$residuals, BPM8$residuals, BPM9$residuals,BPM10$residuals, BPM11$residuals, BPM12$residuals,BPM13$residuals, BPM14$residuals, BPM15$residuals,BPM16$residuals, BPM17$residuals, BPM18$residuals,BPM19$residuals, BPM20$residuals, BPM21$residuals,BPM22$residuals, BPM23$residuals, BPM4$residuals,BPM25$residuals, BPM26$residuals, BPM27$residuals,BPM28$residuals, BPM29$residuals, BPM30$residuals,BPM31$residuals, BPM32$residuals, BPM33$residuals,BPM34$residuals, BPM35$residuals, BPM36$residuals,BPM37$residuals, BPM38$residuals, BPM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BP.ALL[nrow(BP.ALL)+ 1,] = MKTR
BP.ALL[nrow(BP.ALL)+ 1,] = MKPR
BP.ALL[nrow(BP.ALL)+ 1,] = TSRR
BP.ALL[nrow(BP.ALL)+ 1,] = BTDF
BP.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- BP.ALL[1:46,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
BP.ALL[nrow(BP.ALL)+ 1,] = MMKPR
BP.ALL[nrow(BP.ALL)+ 1,] = MMKTR
BP.ALL[nrow(BP.ALL)+ 1,] = MMKSR
BP.ALL
```

```{r}
BP.NUM <- as.data.frame(apply(BP.ALL[1:56,2:40], 2, as.numeric))
str(BP.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(BP.NUM[53,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(BP.NUM[52,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(BP.NUM[56,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(BP.NUM[51,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(BP.NUM[54,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
BP.ALL[nrow(BP.ALL)+ 1,] = FSR1
BP.ALL[nrow(BP.ALL)+ 1,] = FSR2
BP.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
BPFM <-BP.ALL[c(57,58),-1]
BPF <- as.matrix(apply(BPFM, 2, as.numeric))
BPF
```
###########################################################
```{r}
### Water Year 19 = 1990 onwards
```


###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(BP.ALL[21:47,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
BP.TS2 <-BP.ALL[21:47,1:40] ## 1990 Subset
BP.TSN2 <- as.data.frame(apply(BP.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(BP.TSN2, class)   
BP.TSN2
```
############################################
```{r}
BPM1 <- mblm(AN_RO_mm~ Water_Year_Year, BP.TSN2)
BPM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BP.TSN2)
BPM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BP.TSN2)
BPM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BP.TSN2)
BPM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BP.TSN2)
BPM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BP.TSN2)
BPM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BP.TSN2)
BPM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BP.TSN2)
BPM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BP.TSN2)
BPM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BP.TSN2)
BPM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BP.TSN2)
BPM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BP.TSN2)
BPM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BP.TSN2)
BPM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BP.TSN2)
BPM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BP.TSN2)
BPM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BP.TSN2)
BPM17 <- mblm(May_RO_mm~ Water_Year_Year, BP.TSN2)
BPM18 <- mblm(May_PCP_mm~ Water_Year_Year, BP.TSN2)
BPM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BP.TSN2)
BPM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BP.TSN2)
BPM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BP.TSN2)
BPM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BP.TSN2)
BPM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BP.TSN2)
BPM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BP.TSN2)
BPM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BP.TSN2)
BPM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BP.TSN2)
BPM27 <- mblm(AN_RR~ Water_Year_Year, BP.TSN2)
BPM28 <- mblm(OCT_RR~ Water_Year_Year, BP.TSN2)
BPM29 <- mblm(NOV_RR~ Water_Year_Year, BP.TSN2)
BPM30 <- mblm(DEC_RR~ Water_Year_Year, BP.TSN2)
BPM31 <- mblm(JAN_RR~ Water_Year_Year, BP.TSN2)
BPM32 <- mblm(FEB_RR~ Water_Year_Year, BP.TSN2)
BPM33 <- mblm(MAR_RR~ Water_Year_Year, BP.TSN2)
BPM34 <- mblm(APL_RR~ Water_Year_Year, BP.TSN2)
BPM35 <- mblm(MAY_RR~ Water_Year_Year, BP.TSN2)
BPM36 <- mblm(JUN_RR~ Water_Year_Year, BP.TSN2)
BPM37 <- mblm(JUL_RR~ Water_Year_Year, BP.TSN2)
BPM38 <- mblm(AUG_RR~ Water_Year_Year, BP.TSN2)
BPM39 <- mblm(SEP_RR~ Water_Year_Year, BP.TSN2)
```
####################################
```{r}
TSR2<- cbind(BPM1$coefficients, BPM2$coefficients, BPM3$coefficients, BPM4$coefficients, BPM5$coefficients, BPM6$coefficients,BPM7$coefficients, BPM8$coefficients, BPM9$coefficients,BPM10$coefficients, BPM11$coefficients, BPM12$coefficients,BPM13$coefficients, BPM14$coefficients, BPM15$coefficients,BPM16$coefficients, BPM17$coefficients, BPM18$coefficients,BPM19$coefficients, BPM20$coefficients, BPM21$coefficients,BPM22$coefficients, BPM23$coefficients, BPM4$coefficients,BPM25$coefficients, BPM26$coefficients, BPM27$coefficients,BPM28$coefficients, BPM29$coefficients, BPM30$coefficients,BPM31$coefficients, BPM32$coefficients, BPM33$coefficients,BPM34$coefficients, BPM35$coefficients, BPM36$coefficients,BPM37$coefficients, BPM38$coefficients, BPM39$coefficients)
RES2 <- cbind(BPM1$residuals, BPM2$residuals, BPM3$residuals, BPM4$residuals, BPM5$residuals, BPM6$residuals,BPM7$residuals, BPM8$residuals, BPM9$residuals,BPM10$residuals, BPM11$residuals, BPM12$residuals,BPM13$residuals, BPM14$residuals, BPM15$residuals,BPM16$residuals, BPM17$residuals, BPM18$residuals,BPM19$residuals, BPM20$residuals, BPM21$residuals,BPM22$residuals, BPM23$residuals, BPM4$residuals,BPM25$residuals, BPM26$residuals, BPM27$residuals,BPM28$residuals, BPM29$residuals, BPM30$residuals,BPM31$residuals, BPM32$residuals, BPM33$residuals,BPM34$residuals, BPM35$residuals, BPM36$residuals,BPM37$residuals, BPM38$residuals, BPM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BP.ALL[nrow(BP.ALL)+ 1,] = MKTR2
BP.ALL[nrow(BP.ALL)+ 1,] = MKPR2
BP.ALL[nrow(BP.ALL)+ 1,] = TSRR2
BP.ALL[nrow(BP.ALL)+ 1,] = BTDF2
BP.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- BP.ALL[21:47,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
BP.ALL[nrow(BP.ALL)+ 1,] = MMKPR2
BP.ALL[nrow(BP.ALL)+ 1,] = MMKTR2

BP.ALL
```

```{r}
BP.ALL
```

```{r}
BP.NUM2 <- as.data.frame(apply(BP.ALL[1:65,2:40], 2, as.numeric))
str(BP.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(BP.NUM2[62,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(BP.NUM2[61,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(BP.NUM2[65,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(BP.NUM2[60,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(BP.NUM2[63,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
BP.ALL[nrow(BP.ALL)+ 1,] = FSR12
BP.ALL[nrow(BP.ALL)+ 1,] = FSR22
BP.ALL
```


```{r}
#SAVE 1990 Results as 2:40 matrix
BPFM2 <-BP.ALL[c(65,66),-1]
BPF2 <- as.matrix(apply(BPFM2, 2, as.numeric))
BPF2
```


### Turukhan ID 'BO' 33
```{r}
### Summarise by Month
names(BO)[names(BO) == "..Date"] <- "Date"
BO$StreamflowDay_m3<-BO$Streamflow*(60*60*24)
BO.MON <- BO %>%
   group_by(Year, Month) %>%
   summarise(Month_Streamflow_m3 = sum(StreamflowDay_m3))
BO.MON$Streamflow_Km<-BO.MON$Month_Streamflow_m3/1000000000 # monthly runoff volume km^3
BO.MON$Streamflow_mm<-(BO.MON$Streamflow_Km/10100)*1000000 ## monthly runoff depth mm
BO.MON

#### TRIM DATASET TO FULL YEARS BEFORE MOVING ON !!!!!!! ##########################################
BO.MONT<- BO.MON[-c(1,2,3,4,5,6,7,8,9,574,575,576),]
BO.MONT
``` 


```{r}
BOT <- GMP2[[946:1509]] ##Turukhan
BOE <- extent(84,84.5,65.5,67) ##Turukhan
BOPC <- crop(BOT, BOE) ##Turukhan
BO.Mon.Precip.<-extract(BOPC,BOE, method="bilinear", fun = mean)
BOMP<-as.data.frame(colMeans(BO.Mon.Precip.)) # Turukhan
BOSub<-DateTemp[DateTemp$Date >= as.Date("1969-10-01") & DateTemp$Date <=
                    as.Date("2016-09-01"), ] ##Turukhan
BOPp<- cbind(BOMP,BOSub) ## Turukhan
```

```{r}
BO.MONT$GriddedPrecip_mm<- BOMP$`colMeans(BO.Mon.Precip.)`
BO.MONT
```

```{r}
## Gap filling process

BO.M1 <- subset(BO.MONT, Month == 1)
BO.M2 <- subset(BO.MONT, Month == 2)
BO.M3 <- subset(BO.MONT, Month == 3)
BO.M4 <- subset(BO.MONT, Month == 4)
BO.M5 <- subset(BO.MONT, Month == 5)
BO.M6 <- subset(BO.MONT, Month == 6)
BO.M7 <- subset(BO.MONT, Month == 7)
BO.M8 <- subset(BO.MONT, Month == 8)
BO.M9 <- subset(BO.MONT, Month == 9)
BO.M10 <- subset(BO.MONT, Month == 10)
BO.M11 <- subset(BO.MONT, Month == 11)
BO.M12 <- subset(BO.MONT, Month == 12)


BO.1 <-mean(BO.M1$Streamflow_mm, na.rm = TRUE)
BO.2 <- mean(BO.M2$Streamflow_mm, na.rm = TRUE)
BO.3 <- mean(BO.M3$Streamflow_mm, na.rm = TRUE)
BO.4 <- mean(BO.M4$Streamflow_mm, na.rm = TRUE)
BO.5 <-mean(BO.M5$Streamflow_mm, na.rm = TRUE)
BO.6 <- mean(BO.M6$Streamflow_mm, na.rm = TRUE)
BO.7 <- mean(BO.M7$Streamflow_mm, na.rm = TRUE)
BO.8 <- mean(BO.M8$Streamflow_mm, na.rm = TRUE)
BO.9 <- mean(BO.M9$Streamflow_mm, na.rm = TRUE)
BO.10 <- mean(BO.M10$Streamflow_mm, na.rm = TRUE)
BO.11 <- mean(BO.M11$Streamflow_mm, na.rm = TRUE)
BO.12 <- mean(BO.M12$Streamflow_mm, na.rm = TRUE)

BO.MONT[c(292),5] <- BO.1
BO.MONT[c(293),5] <- BO.2
BO.MONT[c(294),5] <- BO.3
BO.MONT[c(295),5] <- BO.4
BO.MONT[c(296),5] <- BO.5
BO.MONT[c(297),5] <- BO.6
BO.MONT[c(298),5] <- BO.7
BO.MONT[c(35,299),5] <- BO.8
BO.MONT[c(300),5] <- BO.9
BO.MONT[c(301),5] <- BO.10
BO.MONT[c(302),5] <- BO.11
BO.MONT[c(303),5] <- BO.12


BO.MONT
```


##############
```{r}
## Water Year Sequencing
BO.MT<- BO.MONT
BO.MT$Water_Year_Month <- rep(seq(1:12),47) #1975 to 2016 is 43 years
BO.MT$Water_Year_Year <- rep(1:47, each =12)
BO.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 BO.WY <- BO.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
BO.WY
```
##############
```{r}
## Monthly Columns
## Oct
 BO.OCT <- BO.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 BO.NOV <- BO.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 BO.DEC <- BO.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 BO.JAN <- BO.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 BO.FEB <- BO.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 BO.MAR <- BO.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 BO.APL <- BO.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 BO.MAY <- BO.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 BO.JUN <- BO.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 BO.JUL <- BO.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 BO.AUG <- BO.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 BO.SEP <- BO.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
BO.ALL <- cbind(BO.WY, BO.OCT[,-1], BO.NOV[,-1], BO.DEC[,-1], BO.JAN[,-1], BO.FEB[,-1], BO.MAR[,-1], BO.APL[,-1],BO.MAY[,-1], BO.JUN[,-1], BO.JUL[,-1], BO.AUG[,-1], BO.SEP[,-1])
```
####################
```{r}
BO.ALL$AN_RR <- BO.ALL$AN_RO_mm/BO.ALL$AN_PCP_mm
BO.ALL$OCT_RR <- BO.ALL$Oct_RO_mm/BO.ALL$Oct_PCP_mm
BO.ALL$NOV_RR <- BO.ALL$Nov_RO_mm/BO.ALL$Nov_PCP_mm
BO.ALL$DEC_RR <- BO.ALL$Dec_RO_mm/BO.ALL$Dec_PCP_mm
BO.ALL$JAN_RR <- BO.ALL$Jan_RO_mm/BO.ALL$Jan_PCP_mm
BO.ALL$FEB_RR <- BO.ALL$Feb_RO_mm/BO.ALL$Feb_PCP_mm
BO.ALL$MAR_RR <- BO.ALL$Mar_RO_mm/BO.ALL$Mar_PCP_mm
BO.ALL$APL_RR <- BO.ALL$Apl_RO_mm/BO.ALL$Apl_PCP_mm
BO.ALL$MAY_RR <- BO.ALL$May_RO_mm/BO.ALL$May_PCP_mm
BO.ALL$JUN_RR <- BO.ALL$Jun_RO_mm/BO.ALL$Jun_PCP_mm
BO.ALL$JUL_RR <- BO.ALL$Jul_RO_mm/BO.ALL$Jul_PCP_mm
BO.ALL$AUG_RR <- BO.ALL$Aug_RO_mm/BO.ALL$Aug_PCP_mm
BO.ALL$SEP_RR <- BO.ALL$Sep_RO_mm/BO.ALL$Sep_PCP_mm
BO.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(BO.ALL[,-1],2, mean))
CSD <- rbind(apply(BO.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
BO.ALL[nrow(BO.ALL)+ 1,] = CML
BO.ALL[nrow(BO.ALL)+ 1,] = CSDL
BO.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(BO.ALL[1:47,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
BO.TS <-BO.ALL[1:47,1:40]
BO.TSN <- as.data.frame(apply(BO.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(BO.TSN, class)   
BO.TSN
```
############################################
```{r}
BOM1 <- mblm(AN_RO_mm~ Water_Year_Year, BO.TSN)
BOM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BO.TSN)
BOM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BO.TSN)
BOM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BO.TSN)
BOM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BO.TSN)
BOM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BO.TSN)
BOM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BO.TSN)
BOM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BO.TSN)
BOM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BO.TSN)
BOM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BO.TSN)
BOM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BO.TSN)
BOM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BO.TSN)
BOM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BO.TSN)
BOM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BO.TSN)
BOM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BO.TSN)
BOM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BO.TSN)
BOM17 <- mblm(May_RO_mm~ Water_Year_Year, BO.TSN)
BOM18 <- mblm(May_PCP_mm~ Water_Year_Year, BO.TSN)
BOM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BO.TSN)
BOM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BO.TSN)
BOM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BO.TSN)
BOM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BO.TSN)
BOM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BO.TSN)
BOM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BO.TSN)
BOM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BO.TSN)
BOM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BO.TSN)
BOM27 <- mblm(AN_RR~ Water_Year_Year, BO.TSN)
BOM28 <- mblm(OCT_RR~ Water_Year_Year, BO.TSN)
BOM29 <- mblm(NOV_RR~ Water_Year_Year, BO.TSN)
BOM30 <- mblm(DEC_RR~ Water_Year_Year, BO.TSN)
BOM31 <- mblm(JAN_RR~ Water_Year_Year, BO.TSN)
BOM32 <- mblm(FEB_RR~ Water_Year_Year, BO.TSN)
BOM33 <- mblm(MAR_RR~ Water_Year_Year, BO.TSN)
BOM34 <- mblm(APL_RR~ Water_Year_Year, BO.TSN)
BOM35 <- mblm(MAY_RR~ Water_Year_Year, BO.TSN)
BOM36 <- mblm(JUN_RR~ Water_Year_Year, BO.TSN)
BOM37 <- mblm(JUL_RR~ Water_Year_Year, BO.TSN)
BOM38 <- mblm(AUG_RR~ Water_Year_Year, BO.TSN)
BOM39 <- mblm(SEP_RR~ Water_Year_Year, BO.TSN)
```
####################################
```{r}
TSR<- cbind(BOM1$coefficients, BOM2$coefficients, BOM3$coefficients, BOM4$coefficients, BOM5$coefficients, BOM6$coefficients,BOM7$coefficients, BOM8$coefficients, BOM9$coefficients,BOM10$coefficients, BOM11$coefficients, BOM12$coefficients,BOM13$coefficients, BOM14$coefficients, BOM15$coefficients,BOM16$coefficients, BOM17$coefficients, BOM18$coefficients,BOM19$coefficients, BOM20$coefficients, BOM21$coefficients,BOM22$coefficients, BOM23$coefficients, BOM4$coefficients,BOM25$coefficients, BOM26$coefficients, BOM27$coefficients,BOM28$coefficients, BOM29$coefficients, BOM30$coefficients,BOM31$coefficients, BOM32$coefficients, BOM33$coefficients,BOM34$coefficients, BOM35$coefficients, BOM36$coefficients,BOM37$coefficients, BOM38$coefficients, BOM39$coefficients)
RES <- cbind(BOM1$residuals, BOM2$residuals, BOM3$residuals, BOM4$residuals, BOM5$residuals, BOM6$residuals,BOM7$residuals, BOM8$residuals, BOM9$residuals,BOM10$residuals, BOM11$residuals, BOM12$residuals,BOM13$residuals, BOM14$residuals, BOM15$residuals,BOM16$residuals, BOM17$residuals, BOM18$residuals,BOM19$residuals, BOM20$residuals, BOM21$residuals,BOM22$residuals, BOM23$residuals, BOM4$residuals,BOM25$residuals, BOM26$residuals, BOM27$residuals,BOM28$residuals, BOM29$residuals, BOM30$residuals,BOM31$residuals, BOM32$residuals, BOM33$residuals,BOM34$residuals, BOM35$residuals, BOM36$residuals,BOM37$residuals, BOM38$residuals, BOM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BO.ALL[nrow(BO.ALL)+ 1,] = MKTR
BO.ALL[nrow(BO.ALL)+ 1,] = MKPR
BO.ALL[nrow(BO.ALL)+ 1,] = TSRR
BO.ALL[nrow(BO.ALL)+ 1,] = BTDF
BO.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- BO.ALL[1:46,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
BO.ALL[nrow(BO.ALL)+ 1,] = MMKPR
BO.ALL[nrow(BO.ALL)+ 1,] = MMKTR
BO.ALL[nrow(BO.ALL)+ 1,] = MMKSR
BO.ALL
```

```{r}
BO.NUM <- as.data.frame(apply(BO.ALL[1:56,2:40], 2, as.numeric))
str(BO.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(BO.NUM[53,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(BO.NUM[52,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(BO.NUM[56,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(BO.NUM[51,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(BO.NUM[54,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
BO.ALL[nrow(BO.ALL)+ 1,] = FSR1
BO.ALL[nrow(BO.ALL)+ 1,] = FSR2
BO.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
BOFM <-BO.ALL[c(57,58),-1]
BOF <- as.matrix(apply(BOFM, 2, as.numeric))
BOF
```
###########################################################
```{r}
### Water Year 19 = 1990 onwards
```

###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(BO.ALL[21:47,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
BO.TS2 <-BO.ALL[21:47,1:40] ## 1990 Subset
BO.TSN2 <- as.data.frame(apply(BO.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(BO.TSN2, class)   
BO.TSN2
```
############################################
```{r}
BOM1 <- mblm(AN_RO_mm~ Water_Year_Year, BO.TSN2)
BOM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BO.TSN2)
BOM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BO.TSN2)
BOM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BO.TSN2)
BOM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BO.TSN2)
BOM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BO.TSN2)
BOM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BO.TSN2)
BOM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BO.TSN2)
BOM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BO.TSN2)
BOM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BO.TSN2)
BOM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BO.TSN2)
BOM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BO.TSN2)
BOM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BO.TSN2)
BOM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BO.TSN2)
BOM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BO.TSN2)
BOM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BO.TSN2)
BOM17 <- mblm(May_RO_mm~ Water_Year_Year, BO.TSN2)
BOM18 <- mblm(May_PCP_mm~ Water_Year_Year, BO.TSN2)
BOM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BO.TSN2)
BOM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BO.TSN2)
BOM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BO.TSN2)
BOM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BO.TSN2)
BOM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BO.TSN2)
BOM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BO.TSN2)
BOM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BO.TSN2)
BOM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BO.TSN2)
BOM27 <- mblm(AN_RR~ Water_Year_Year, BO.TSN2)
BOM28 <- mblm(OCT_RR~ Water_Year_Year, BO.TSN2)
BOM29 <- mblm(NOV_RR~ Water_Year_Year, BO.TSN2)
BOM30 <- mblm(DEC_RR~ Water_Year_Year, BO.TSN2)
BOM31 <- mblm(JAN_RR~ Water_Year_Year, BO.TSN2)
BOM32 <- mblm(FEB_RR~ Water_Year_Year, BO.TSN2)
BOM33 <- mblm(MAR_RR~ Water_Year_Year, BO.TSN2)
BOM34 <- mblm(APL_RR~ Water_Year_Year, BO.TSN2)
BOM35 <- mblm(MAY_RR~ Water_Year_Year, BO.TSN2)
BOM36 <- mblm(JUN_RR~ Water_Year_Year, BO.TSN2)
BOM37 <- mblm(JUL_RR~ Water_Year_Year, BO.TSN2)
BOM38 <- mblm(AUG_RR~ Water_Year_Year, BO.TSN2)
BOM39 <- mblm(SEP_RR~ Water_Year_Year, BO.TSN2)
```
####################################
```{r}
TSR2<- cbind(BOM1$coefficients, BOM2$coefficients, BOM3$coefficients, BOM4$coefficients, BOM5$coefficients, BOM6$coefficients,BOM7$coefficients, BOM8$coefficients, BOM9$coefficients,BOM10$coefficients, BOM11$coefficients, BOM12$coefficients,BOM13$coefficients, BOM14$coefficients, BOM15$coefficients,BOM16$coefficients, BOM17$coefficients, BOM18$coefficients,BOM19$coefficients, BOM20$coefficients, BOM21$coefficients,BOM22$coefficients, BOM23$coefficients, BOM4$coefficients,BOM25$coefficients, BOM26$coefficients, BOM27$coefficients,BOM28$coefficients, BOM29$coefficients, BOM30$coefficients,BOM31$coefficients, BOM32$coefficients, BOM33$coefficients,BOM34$coefficients, BOM35$coefficients, BOM36$coefficients,BOM37$coefficients, BOM38$coefficients, BOM39$coefficients)
RES2 <- cbind(BOM1$residuals, BOM2$residuals, BOM3$residuals, BOM4$residuals, BOM5$residuals, BOM6$residuals,BOM7$residuals, BOM8$residuals, BOM9$residuals,BOM10$residuals, BOM11$residuals, BOM12$residuals,BOM13$residuals, BOM14$residuals, BOM15$residuals,BOM16$residuals, BOM17$residuals, BOM18$residuals,BOM19$residuals, BOM20$residuals, BOM21$residuals,BOM22$residuals, BOM23$residuals, BOM4$residuals,BOM25$residuals, BOM26$residuals, BOM27$residuals,BOM28$residuals, BOM29$residuals, BOM30$residuals,BOM31$residuals, BOM32$residuals, BOM33$residuals,BOM34$residuals, BOM35$residuals, BOM36$residuals,BOM37$residuals, BOM38$residuals, BOM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BO.ALL[nrow(BO.ALL)+ 1,] = MKTR2
BO.ALL[nrow(BO.ALL)+ 1,] = MKPR2
BO.ALL[nrow(BO.ALL)+ 1,] = TSRR2
BO.ALL[nrow(BO.ALL)+ 1,] = BTDF2
BO.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- BO.ALL[21:47,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
BO.ALL[nrow(BO.ALL)+ 1,] = MMKPR2
BO.ALL[nrow(BO.ALL)+ 1,] = MMKTR2
BO.ALL[nrow(BO.ALL)+ 1,] = MMKSR2
BO.ALL
```

```{r}
BO.ALL
```

```{r}
BO.NUM2 <- as.data.frame(apply(BO.ALL[1:65,2:40], 2, as.numeric))
str(BO.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(BO.NUM2[62,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(BO.NUM2[61,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(BO.NUM2[65,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(BO.NUM2[60,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(BO.NUM2[63,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
BO.ALL[nrow(BO.ALL)+ 1,] = FSR12
BO.ALL[nrow(BO.ALL)+ 1,] = FSR22
BO.ALL
```


```{r}
#SAVE 1990 Results as 2:40 matrix
BOFM2 <-BO.ALL[c(66,67),-1]
BOF2 <- as.matrix(apply(BOFM2, 2, as.numeric))
BOF2
```


###Vandras Results, csv 'BJ'  ID 34 
```{r}
### Summarise by Month
BJ$Days <- days_in_month(as.Date(BJ$Date, "%Y-%m-%d"))
BJ$StreamflowMon_m3<- BJ$Streamflow*(60*60*24)*BJ$Days
BJ.MON <- BJ 
BJ.MON$Streamflow_Km<-BJ.MON$StreamflowMon_m3/1000000000 # monthly runoff volume km^3

#### FILL IN CATHCMENT AREA BEFORE MOVING ON!!!!!!!!!!!!!###########################################
BJ.MON$Streamflow_mm<-(BJ.MON$Streamflow_Km/1740)*1000000 ## monthly runoff depth mm
BJ.MONT <-BJ.MON[10:405,1:9]
BJ.MONT
```


```{r}
BJT <- GMP2[[1114:1509]] ## Vandras
BJE <- extent(71,72,59.5,60) ## Vandras
BJPC <- crop(BJT, BJE) ## Vandras
BJ.Mon.Precip.<-extract(BJPC,BJE, method="bilinear", fun = mean)
BJMP<-as.data.frame(colMeans(BJ.Mon.Precip.)) # Vandras
BJSub<-DateTemp[DateTemp$Date >= as.Date("1983-10-01") & DateTemp$Date <=
                    as.Date("2016-09-01"), ] ##Vandras
BJPp<- cbind(BJMP,BJSub) ## Vandras
```

```{r}
BJ.MONT$GriddedPrecip_mm<- BJMP$`colMeans(BJ.Mon.Precip.)`
BJ.MONT
```

```{r}
## Gap filling process
BJ.M1 <- subset(BJ.MONT, Month == 1)
BJ.M2 <- subset(BJ.MONT, Month == 2)
BJ.M3 <- subset(BJ.MONT, Month == 3)
BJ.M4 <- subset(BJ.MONT, Month == 4)
BJ.M5 <- subset(BJ.MONT, Month == 5)
BJ.M6 <- subset(BJ.MONT, Month == 6)
BJ.M7 <- subset(BJ.MONT, Month == 7)
BJ.M8 <- subset(BJ.MONT, Month == 8)
BJ.M9 <- subset(BJ.MONT, Month == 9)
BJ.M10 <- subset(BJ.MONT, Month == 10)
BJ.M11 <- subset(BJ.MONT, Month == 11)
BJ.M12 <- subset(BJ.MONT, Month == 12)


BJ.1 <-mean(BJ.M1$Streamflow_mm, na.rm = TRUE)
BJ.2 <- mean(BJ.M2$Streamflow_mm, na.rm = TRUE)
BJ.3 <- mean(BJ.M3$Streamflow_mm, na.rm = TRUE)
BJ.4 <- mean(BJ.M4$Streamflow_mm, na.rm = TRUE)
BJ.5 <-mean(BJ.M5$Streamflow_mm, na.rm = TRUE)
BJ.6 <- mean(BJ.M6$Streamflow_mm, na.rm = TRUE)
BJ.7 <- mean(BJ.M7$Streamflow_mm, na.rm = TRUE)
BJ.8 <- mean(BJ.M8$Streamflow_mm, na.rm = TRUE)
BJ.9 <- mean(BJ.M9$Streamflow_mm, na.rm = TRUE)
BJ.10 <- mean(BJ.M10$Streamflow_mm, na.rm = TRUE)
BJ.11 <- mean(BJ.M11$Streamflow_mm, na.rm = TRUE)
BJ.12 <- mean(BJ.M12$Streamflow_mm, na.rm = TRUE)

BJ.MONT[c(316,376),9] <- BJ.1
BJ.MONT[c(317,377),9] <- BJ.2
BJ.MONT[c(378),9] <- BJ.3
BJ.MONT[c(379),9] <- BJ.4
BJ.MONT[c(152,212),9] <- BJ.5
BJ.MONT[c(213),9] <- BJ.6
#BJ.MONT[c(),9] <- BJ.7
#BJ.MONT[c(),9] <- BJ.8
#BJ.MONT[c(),9] <- BJ.9
BJ.MONT[c(385),9] <- BJ.10
BJ.MONT[c(314,386),9] <- BJ.11
BJ.MONT[c(315,387),9] <- BJ.12
BJ.MONT
```


##############
```{r}
## Water Year Sequencing
BJ.MT<- BJ.MONT
BJ.MT$Water_Year_Month <- rep(seq(1:12),33) #1975 to 2016 is 43 years
BJ.MT$Water_Year_Year <- rep(1:33, each =12)
BJ.MT
```
#############
```{r}
## Subsets for MK analysis
## Water Years 
 BJ.WY <- BJ.MT %>%
   group_by(Water_Year_Year) %>%
   summarise(AN_RO_mm = sum(Streamflow_mm), AN_PCP_mm = sum(GriddedPrecip_mm))
BJ.WY
```
##############
```{r}
## Monthly Columns
## Oct
 BJ.OCT <- BJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 1) %>%
   summarise(Oct_RO_mm = sum(Streamflow_mm), Oct_PCP_mm = sum(GriddedPrecip_mm))
## Nov
 BJ.NOV <- BJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 2) %>%
   summarise(Nov_RO_mm = sum(Streamflow_mm), Nov_PCP_mm = sum(GriddedPrecip_mm))
## Dec
 BJ.DEC <- BJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 3) %>%
   summarise(Dec_RO_mm = sum(Streamflow_mm), Dec_PCP_mm = sum(GriddedPrecip_mm))
## Jan
 BJ.JAN <- BJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 4) %>%
   summarise(Jan_RO_mm = sum(Streamflow_mm), Jan_PCP_mm = sum(GriddedPrecip_mm))
## Feb
 BJ.FEB <- BJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 5) %>%
   summarise(Feb_RO_mm = sum(Streamflow_mm), Feb_PCP_mm = sum(GriddedPrecip_mm))
## Mar
 BJ.MAR <- BJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 6) %>%
   summarise(Mar_RO_mm = sum(Streamflow_mm), Mar_PCP_mm = sum(GriddedPrecip_mm))
## April
 BJ.APL <- BJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 7) %>%
   summarise(Apl_RO_mm = sum(Streamflow_mm), Apl_PCP_mm = sum(GriddedPrecip_mm))
## May
 BJ.MAY <- BJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 8) %>%
   summarise(May_RO_mm = sum(Streamflow_mm), May_PCP_mm = sum(GriddedPrecip_mm))
## June
 BJ.JUN <- BJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 9) %>%
   summarise(Jun_RO_mm = sum(Streamflow_mm), Jun_PCP_mm = sum(GriddedPrecip_mm))
## July
 BJ.JUL <- BJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 10) %>%
   summarise(Jul_RO_mm = sum(Streamflow_mm), Jul_PCP_mm = sum(GriddedPrecip_mm))
## Aug
 BJ.AUG <- BJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 11) %>%
   summarise(Aug_RO_mm = sum(Streamflow_mm), Aug_PCP_mm = sum(GriddedPrecip_mm))
## Sept
 BJ.SEP <- BJ.MT %>%
   group_by(Water_Year_Year) %>%
   filter(Water_Year_Month == 12) %>%
   summarise(Sep_RO_mm = sum(Streamflow_mm), Sep_PCP_mm = sum(GriddedPrecip_mm))
 
## Make Time Analysis Time Series 
BJ.ALL <- cbind(BJ.WY, BJ.OCT[,-1], BJ.NOV[,-1], BJ.DEC[,-1], BJ.JAN[,-1], BJ.FEB[,-1], BJ.MAR[,-1], BJ.APL[,-1],BJ.MAY[,-1], BJ.JUN[,-1], BJ.JUL[,-1], BJ.AUG[,-1], BJ.SEP[,-1])
```
####################
```{r}
BJ.ALL$AN_RR <- BJ.ALL$AN_RO_mm/BJ.ALL$AN_PCP_mm
BJ.ALL$OCT_RR <- BJ.ALL$Oct_RO_mm/BJ.ALL$Oct_PCP_mm
BJ.ALL$NOV_RR <- BJ.ALL$Nov_RO_mm/BJ.ALL$Nov_PCP_mm
BJ.ALL$DEC_RR <- BJ.ALL$Dec_RO_mm/BJ.ALL$Dec_PCP_mm
BJ.ALL$JAN_RR <- BJ.ALL$Jan_RO_mm/BJ.ALL$Jan_PCP_mm
BJ.ALL$FEB_RR <- BJ.ALL$Feb_RO_mm/BJ.ALL$Feb_PCP_mm
BJ.ALL$MAR_RR <- BJ.ALL$Mar_RO_mm/BJ.ALL$Mar_PCP_mm
BJ.ALL$APL_RR <- BJ.ALL$Apl_RO_mm/BJ.ALL$Apl_PCP_mm
BJ.ALL$MAY_RR <- BJ.ALL$May_RO_mm/BJ.ALL$May_PCP_mm
BJ.ALL$JUN_RR <- BJ.ALL$Jun_RO_mm/BJ.ALL$Jun_PCP_mm
BJ.ALL$JUL_RR <- BJ.ALL$Jul_RO_mm/BJ.ALL$Jul_PCP_mm
BJ.ALL$AUG_RR <- BJ.ALL$Aug_RO_mm/BJ.ALL$Aug_PCP_mm
BJ.ALL$SEP_RR <- BJ.ALL$Sep_RO_mm/BJ.ALL$Sep_PCP_mm
BJ.ALL
```
#####################
```{r}
## Add means and standard deviations of each column
CM <- rbind(apply(BJ.ALL[,-1],2, mean))
CSD <- rbind(apply(BJ.ALL[,-1],2, sd))
CML <- cbind("Mean", CM)
CSDL <- cbind("Stdev", CSD)
BJ.ALL[nrow(BJ.ALL)+ 1,] = CML
BJ.ALL[nrow(BJ.ALL)+ 1,] = CSDL
BJ.ALL
```
#######################################
```{r}
## 1970 Window
## Mann-Kendall Calculations
MKO <- apply(BJ.ALL[1:33,2:40],2, MannKendall)
```
##########################################
```{r}
### No Need to change anything here
MKTL <-lapply(MKO,"[[", 1) # Taus
MKPL <-lapply(MKO,"[[", 2) # p-values
MKTU <- unlist(MKTL, use.names = FALSE)
MKPU <- unlist(MKPL, use.names = FALSE)
MKTR <-rbind(c("MK Tau", MKTU))
MKPR <-rbind(c("p-value", MKPU))
```
############################################
```{r}
BJ.TS <-BJ.ALL[1:33,1:40]
BJ.TSN <- as.data.frame(apply(BJ.TS, 2, as.numeric))  # Convert all variable types to numeric
sapply(BJ.TSN, class)   
BJ.TSN
```
############################################
```{r}
BJM1 <- mblm(AN_RO_mm~ Water_Year_Year, BJ.TSN)
BJM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BJ.TSN)
BJM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BJ.TSN)
BJM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BJ.TSN)
BJM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BJ.TSN)
BJM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BJ.TSN)
BJM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BJ.TSN)
BJM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BJ.TSN)
BJM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BJ.TSN)
BJM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BJ.TSN)
BJM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BJ.TSN)
BJM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BJ.TSN)
BJM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BJ.TSN)
BJM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BJ.TSN)
BJM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BJ.TSN)
BJM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BJ.TSN)
BJM17 <- mblm(May_RO_mm~ Water_Year_Year, BJ.TSN)
BJM18 <- mblm(May_PCP_mm~ Water_Year_Year, BJ.TSN)
BJM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BJ.TSN)
BJM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BJ.TSN)
BJM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BJ.TSN)
BJM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BJ.TSN)
BJM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BJ.TSN)
BJM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BJ.TSN)
BJM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BJ.TSN)
BJM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BJ.TSN)
BJM27 <- mblm(AN_RR~ Water_Year_Year, BJ.TSN)
BJM28 <- mblm(OCT_RR~ Water_Year_Year, BJ.TSN)
BJM29 <- mblm(NOV_RR~ Water_Year_Year, BJ.TSN)
BJM30 <- mblm(DEC_RR~ Water_Year_Year, BJ.TSN)
BJM31 <- mblm(JAN_RR~ Water_Year_Year, BJ.TSN)
BJM32 <- mblm(FEB_RR~ Water_Year_Year, BJ.TSN)
BJM33 <- mblm(MAR_RR~ Water_Year_Year, BJ.TSN)
BJM34 <- mblm(APL_RR~ Water_Year_Year, BJ.TSN)
BJM35 <- mblm(MAY_RR~ Water_Year_Year, BJ.TSN)
BJM36 <- mblm(JUN_RR~ Water_Year_Year, BJ.TSN)
BJM37 <- mblm(JUL_RR~ Water_Year_Year, BJ.TSN)
BJM38 <- mblm(AUG_RR~ Water_Year_Year, BJ.TSN)
BJM39 <- mblm(SEP_RR~ Water_Year_Year, BJ.TSN)
```
####################################
```{r}
TSR<- cbind(BJM1$coefficients, BJM2$coefficients, BJM3$coefficients, BJM4$coefficients, BJM5$coefficients, BJM6$coefficients,BJM7$coefficients, BJM8$coefficients, BJM9$coefficients,BJM10$coefficients, BJM11$coefficients, BJM12$coefficients,BJM13$coefficients, BJM14$coefficients, BJM15$coefficients,BJM16$coefficients, BJM17$coefficients, BJM18$coefficients,BJM19$coefficients, BJM20$coefficients, BJM21$coefficients,BJM22$coefficients, BJM23$coefficients, BJM4$coefficients,BJM25$coefficients, BJM26$coefficients, BJM27$coefficients,BJM28$coefficients, BJM29$coefficients, BJM30$coefficients,BJM31$coefficients, BJM32$coefficients, BJM33$coefficients,BJM34$coefficients, BJM35$coefficients, BJM36$coefficients,BJM37$coefficients, BJM38$coefficients, BJM39$coefficients)
RES <- cbind(BJM1$residuals, BJM2$residuals, BJM3$residuals, BJM4$residuals, BJM5$residuals, BJM6$residuals,BJM7$residuals, BJM8$residuals, BJM9$residuals,BJM10$residuals, BJM11$residuals, BJM12$residuals,BJM13$residuals, BJM14$residuals, BJM15$residuals,BJM16$residuals, BJM17$residuals, BJM18$residuals,BJM19$residuals, BJM20$residuals, BJM21$residuals,BJM22$residuals, BJM23$residuals, BJM4$residuals,BJM25$residuals, BJM26$residuals, BJM27$residuals,BJM28$residuals, BJM29$residuals, BJM30$residuals,BJM31$residuals, BJM32$residuals, BJM33$residuals,BJM34$residuals, BJM35$residuals, BJM36$residuals,BJM37$residuals, BJM38$residuals, BJM39$residuals)
```
####################################
```{r}
# Keep as is
BOXT <- as.matrix(unlist(apply(RES,2, Box.test)))
BOXTP <- rbind(BOXT[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP <-cbind(as.numeric(unlist(BOXTP, use.names = FALSE)))
```
###########################################
```{r}
BTDF <-rbind(c("Box-Text p-value", as.numeric(BTP)))
BTDF ## Box Test Row
```
#########################################
```{r}
TSRM <- rbind(as.numeric(unlist(TSR[2,], use.names = FALSE)))
TSRR <- rbind(c("Slope", as.numeric(TSRM)))
TSRR # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BJ.ALL[nrow(BJ.ALL)+ 1,] = MKTR
BJ.ALL[nrow(BJ.ALL)+ 1,] = MKPR
BJ.ALL[nrow(BJ.ALL)+ 1,] = TSRR
BJ.ALL[nrow(BJ.ALL)+ 1,] = BTDF
BJ.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC <- BJ.ALL[1:33,2:40] ## Core Time Series Array
MMKN <- as.data.frame(apply(MMKC, 2, as.numeric))
MMKA <- apply(MMKN,2, mmky)
MMKA
```
######################
```{r}
MMKP <- rbind(as.numeric(unlist(MMKA[2,1:39], use.names = FALSE)))
MMKPR <- rbind(c("MMK p-value", as.numeric(MMKP)))
MMKT <- rbind(as.numeric(unlist(MMKA[6,1:39], use.names = FALSE)))
MMKTR <- rbind(c("MMK Tau", as.numeric(MMKT)))
MMKS <- rbind(as.numeric(unlist(MMKA[7,1:39], use.names = FALSE)))
MMKSR <- rbind(c("MMK Slope", as.numeric(MMKS)))
```
#####################
```{r}
BJ.ALL[nrow(BJ.ALL)+ 1,] = MMKPR
BJ.ALL[nrow(BJ.ALL)+ 1,] = MMKTR
BJ.ALL[nrow(BJ.ALL)+ 1,] = MMKSR
BJ.ALL
```

```{r}
BJ.NUM <- as.data.frame(apply(BJ.ALL[1:42,2:40], 2, as.numeric))
str(BJ.NUM)
```
#########################################
```{r}
E1<- as.matrix(unlist(BJ.NUM[39,], use.names = FALSE)) ## Box Test Matrix, V1
T1 <- as.matrix(unlist(BJ.NUM[38,], use.names = FALSE)) ## Original MK Slope V2
T2 <- as.matrix(unlist(BJ.NUM[42,], use.names = FALSE)) ## Original MMK Slope, V3
T3 <- as.matrix(unlist(BJ.NUM[37,], use.names = FALSE)) ## Original MK p-value, V4
T4 <- as.matrix(unlist(BJ.NUM[40,], use.names = FALSE)) ## Original MMK p-vlaue, V5

FAM <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM$V6 <- if(FAM$V1 > 0.1) {FAM$V2} else{FAM$V3} ## Slopes
FAM$V7 <- if(FAM$V1 > 0.1) {FAM$V4} else{FAM$V5} ## p-values
FAM
```
####
```{r}
FA <- as.matrix(FAM)
FAR <- t(FA[,c(6,7)])
FAR
```
##############
```{r}
FSN1 <- FAR[1,]
FSR1 <- rbind(c("Final Slope", as.numeric(FSN1)))
FSN2 <- FAR[2,]
FSR2 <- rbind(c("Final p-value", as.numeric(FSN2)))
BJ.ALL[nrow(BJ.ALL)+ 1,] = FSR1
BJ.ALL[nrow(BJ.ALL)+ 1,] = FSR2
BJ.ALL
```
###########
```{r}
#SAVE 1970 Results as 2:40 matrix
BJFM <-BJ.ALL[c(43,44),-1]
BJF <- as.matrix(apply(BJFM, 2, as.numeric))
BJF
```
###########################################################
```{r}
### Water Year 19 = 1990 onwards
```

###########################################################
```{r}
## 1990 Window
## Mann-Kendall Calculations
MKO2 <- apply(BJ.ALL[21:33,2:40],2, MannKendall) ## 1990 water year
```
##########################################
```{r}
MKTL2 <-lapply(MKO2,"[[", 1) # Taus
MKPL2 <-lapply(MKO2,"[[", 2) # p-values
MKTU2 <- unlist(MKTL2, use.names = FALSE)
MKPU2 <- unlist(MKPL2, use.names = FALSE)
MKTR2 <-rbind(c("MK Tau", MKTU2))
MKPR2 <-rbind(c("p-value", MKPU2))
```
############################################
```{r}
BJ.TS2 <-BJ.ALL[21:33,1:40] ## 1990 Subset
BJ.TSN2 <- as.data.frame(apply(BJ.TS2, 2, as.numeric))  # Convert all variable types to numeric
sapply(BJ.TSN2, class)   
BJ.TSN2
```
############################################
```{r}
BJM1 <- mblm(AN_RO_mm~ Water_Year_Year, BJ.TSN2)
BJM2 <- mblm(AN_PCP_mm~ Water_Year_Year, BJ.TSN2)
BJM3 <- mblm(Oct_RO_mm~ Water_Year_Year, BJ.TSN2)
BJM4 <- mblm(Oct_PCP_mm~ Water_Year_Year, BJ.TSN2)
BJM5 <- mblm(Nov_RO_mm~ Water_Year_Year, BJ.TSN2)
BJM6 <- mblm(Nov_PCP_mm~ Water_Year_Year, BJ.TSN2)
BJM7 <- mblm(Dec_RO_mm~ Water_Year_Year, BJ.TSN2)
BJM8 <- mblm(Dec_PCP_mm~ Water_Year_Year, BJ.TSN2)
BJM9 <- mblm(Jan_RO_mm~ Water_Year_Year, BJ.TSN2)
BJM10 <- mblm(Jan_PCP_mm~ Water_Year_Year, BJ.TSN2)
BJM11 <- mblm(Feb_RO_mm~ Water_Year_Year, BJ.TSN2)
BJM12 <- mblm(Feb_PCP_mm~ Water_Year_Year, BJ.TSN2)
BJM13 <- mblm(Mar_RO_mm~ Water_Year_Year, BJ.TSN2)
BJM14 <- mblm(Mar_PCP_mm~ Water_Year_Year, BJ.TSN2)
BJM15 <- mblm(Apl_RO_mm~ Water_Year_Year, BJ.TSN2)
BJM16 <- mblm(Apl_PCP_mm~ Water_Year_Year, BJ.TSN2)
BJM17 <- mblm(May_RO_mm~ Water_Year_Year, BJ.TSN2)
BJM18 <- mblm(May_PCP_mm~ Water_Year_Year, BJ.TSN2)
BJM19 <- mblm(Jun_RO_mm~ Water_Year_Year, BJ.TSN2)
BJM20 <- mblm(Jun_PCP_mm~ Water_Year_Year, BJ.TSN2)
BJM21 <- mblm(Jul_RO_mm~ Water_Year_Year, BJ.TSN2)
BJM22 <- mblm(Jul_PCP_mm~ Water_Year_Year, BJ.TSN2)
BJM23 <- mblm(Aug_RO_mm~ Water_Year_Year, BJ.TSN2)
BJM24 <- mblm(Aug_PCP_mm~ Water_Year_Year, BJ.TSN2)
BJM25 <- mblm(Sep_RO_mm~ Water_Year_Year, BJ.TSN2)
BJM26 <- mblm(Sep_PCP_mm~ Water_Year_Year, BJ.TSN2)
BJM27 <- mblm(AN_RR~ Water_Year_Year, BJ.TSN2)
BJM28 <- mblm(OCT_RR~ Water_Year_Year, BJ.TSN2)
BJM29 <- mblm(NOV_RR~ Water_Year_Year, BJ.TSN2)
BJM30 <- mblm(DEC_RR~ Water_Year_Year, BJ.TSN2)
BJM31 <- mblm(JAN_RR~ Water_Year_Year, BJ.TSN2)
BJM32 <- mblm(FEB_RR~ Water_Year_Year, BJ.TSN2)
BJM33 <- mblm(MAR_RR~ Water_Year_Year, BJ.TSN2)
BJM34 <- mblm(APL_RR~ Water_Year_Year, BJ.TSN2)
BJM35 <- mblm(MAY_RR~ Water_Year_Year, BJ.TSN2)
BJM36 <- mblm(JUN_RR~ Water_Year_Year, BJ.TSN2)
BJM37 <- mblm(JUL_RR~ Water_Year_Year, BJ.TSN2)
BJM38 <- mblm(AUG_RR~ Water_Year_Year, BJ.TSN2)
BJM39 <- mblm(SEP_RR~ Water_Year_Year, BJ.TSN2)
```
####################################
```{r}
TSR2<- cbind(BJM1$coefficients, BJM2$coefficients, BJM3$coefficients, BJM4$coefficients, BJM5$coefficients, BJM6$coefficients,BJM7$coefficients, BJM8$coefficients, BJM9$coefficients,BJM10$coefficients, BJM11$coefficients, BJM12$coefficients,BJM13$coefficients, BJM14$coefficients, BJM15$coefficients,BJM16$coefficients, BJM17$coefficients, BJM18$coefficients,BJM19$coefficients, BJM20$coefficients, BJM21$coefficients,BJM22$coefficients, BJM23$coefficients, BJM4$coefficients,BJM25$coefficients, BJM26$coefficients, BJM27$coefficients,BJM28$coefficients, BJM29$coefficients, BJM30$coefficients,BJM31$coefficients, BJM32$coefficients, BJM33$coefficients,BJM34$coefficients, BJM35$coefficients, BJM36$coefficients,BJM37$coefficients, BJM38$coefficients, BJM39$coefficients)
RES2 <- cbind(BJM1$residuals, BJM2$residuals, BJM3$residuals, BJM4$residuals, BJM5$residuals, BJM6$residuals,BJM7$residuals, BJM8$residuals, BJM9$residuals,BJM10$residuals, BJM11$residuals, BJM12$residuals,BJM13$residuals, BJM14$residuals, BJM15$residuals,BJM16$residuals, BJM17$residuals, BJM18$residuals,BJM19$residuals, BJM20$residuals, BJM21$residuals,BJM22$residuals, BJM23$residuals, BJM4$residuals,BJM25$residuals, BJM26$residuals, BJM27$residuals,BJM28$residuals, BJM29$residuals, BJM30$residuals,BJM31$residuals, BJM32$residuals, BJM33$residuals,BJM34$residuals, BJM35$residuals, BJM36$residuals,BJM37$residuals, BJM38$residuals, BJM39$residuals)
```
####################################
```{r}
BOXT2 <- as.matrix(unlist(apply(RES2,2, Box.test)))
BOXTP2 <- rbind(BOXT2[c(3,8,13,18,23,28,33,38,43,48,53,58,63,68,73,78,83,88,93,98,103,108,113,118,123,128,133,138,143,148,153,158,163,168,173,178,183,188,193),1])
BTP2 <-cbind(as.numeric(unlist(BOXTP2, use.names = FALSE)))
```
###########################################
```{r}
BTDF2 <-rbind(c("Box-Text p-value", as.numeric(BTP2)))
BTDF2 ## Box Test Row
```
#########################################
```{r}
TSRM2 <- rbind(as.numeric(unlist(TSR2[2,], use.names = FALSE)))
TSRR2 <- rbind(c("Slope", as.numeric(TSRM2)))
TSRR2 # Initial Theil Sens Slopes Row
```
#########################################
```{r}
## Add rows of original MK and TS
BJ.ALL[nrow(BJ.ALL)+ 1,] = MKTR2
BJ.ALL[nrow(BJ.ALL)+ 1,] = MKPR2
BJ.ALL[nrow(BJ.ALL)+ 1,] = TSRR2
BJ.ALL[nrow(BJ.ALL)+ 1,] = BTDF2
BJ.ALL
```
######################
```{r}
## Calculate Modified MK Var Cor Approach for ALL
MMKC2 <- BJ.ALL[21:33,2:40] ## Core Time Series Array 1990
MMKN2 <- as.data.frame(apply(MMKC2, 2, as.numeric))
MMKA2 <- apply(MMKN2,2, mmky)
MMKA2
```
######################
```{r}
MMKP2 <- rbind(as.numeric(unlist(MMKA2[2,1:39], use.names = FALSE)))
MMKPR2 <- rbind(c("MMK p-value", as.numeric(MMKP2)))
MMKT2 <- rbind(as.numeric(unlist(MMKA2[6,1:39], use.names = FALSE)))
MMKTR2 <- rbind(c("MMK Tau", as.numeric(MMKT2)))
MMKS2 <- rbind(as.numeric(unlist(MMKA2[7,1:39], use.names = FALSE)))
MMKSR2 <- rbind(c("MMK Slope", as.numeric(MMKS2)))
```
#####################
```{r}
BJ.ALL[nrow(BJ.ALL)+ 1,] = MMKPR2
BJ.ALL[nrow(BJ.ALL)+ 1,] = MMKTR2
BJ.ALL[nrow(BJ.ALL)+ 1,] = MMKSR2
BJ.ALL
```

```{r}
BJ.ALL
```

```{r}
BJ.NUM2 <- as.data.frame(apply(BJ.ALL[1:51,2:40], 2, as.numeric))
str(BJ.NUM2)
```
#########################################3
```{r}
E1 <- as.matrix(unlist(BJ.NUM2[48,], use.names = FALSE)) ## Box Test Matrix 1990, V1
T1 <- as.matrix(unlist(BJ.NUM2[47,], use.names = FALSE)) ## Original MK Slope 1990, V2
T2 <- as.matrix(unlist(BJ.NUM2[51,], use.names = FALSE)) ## Original MMK Slope 1990, V3
T3 <- as.matrix(unlist(BJ.NUM2[46,], use.names = FALSE)) ## Original MK p-value 1990, V4
T4 <- as.matrix(unlist(BJ.NUM2[49,], use.names = FALSE)) ## Original MMK p-vlaue 1990, V5

FAM2 <- as.data.frame(cbind(E1,T1,T2,T3,T4))
FAM2$V6 <- if(FAM2$V1 > 0.1) {FAM2$V2} else{FAM2$V3} ## Slopes
FAM2$V7 <- if(FAM2$V1 > 0.1) {FAM2$V4} else{FAM2$V5} ## p-values
FAM2
```
####
```{r}
FA2 <- as.matrix(FAM2)
FAR2 <- t(FA2[,c(6,7)])
FAR2
```
##############
```{r}
FSN12 <- FAR2[1,]
FSR12 <- rbind(c("Final Slope 1990", as.numeric(FSN12)))
FSN22 <- FAR2[2,]
FSR22 <- rbind(c("Final p-value 1990", as.numeric(FSN22)))
BJ.ALL[nrow(BJ.ALL)+ 1,] = FSR12
BJ.ALL[nrow(BJ.ALL)+ 1,] = FSR22
BJ.ALL
```

```{r}
BJ.ALL
```

```{r}
#SAVE 1990 Results as 2:40 matrix
BJFM2 <-BJ.ALL[c(52,53),-1]
BJF2 <- as.matrix(apply(BJFM2, 2, as.numeric))
BJF2
```

```{r}
## Create row of NA values to replace missing trend gaps
NAR <- rbind(rep(NA,40))
str(NAR) 
```

### Complete Summary Table
```{r}
### Create Finall Dataframes and Results CSVs
ID <- c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34)

Basin_Name <- c("Birch","Blackstone","Hay","Jean Marie","Keg","Martin","Scotty","Trout","Angling","Pontax","Shamattawa","Weir","Taylor","Overflowing",
                "Slate","Etna","Grotsjoen","Landbru","Stuorraluoppal","Vaehaeskanjoki","Amnya","Bol'shol Yugan","Kazym","Konda",
                "Malyy Yugan","Nazyma","Paydungina","Puloy","Pur","Severnya Sos'va","Shoma Ya","Sovetskaya","Turukhan","Vandras")

Ecoregion <- c("TP","TP","TP","TP","TP","TP","TP","TP","HP","HP","HP","HP","BS","BP","BI","ET","ET","ET","ET","ET","WSP","WSP",
               "WSP","WSP","WSP","WSP","WSP","WSP","WSP","WSP","WSP","WSP","WSP","WSP")

Latitude <- c(61.34,61.06,59.97,61.45,57.74,61.89,61.42,61.14,56.67,51.53,54.28,57.03,55.49,53.15,67.25,60.93,61.81,64.89,
              69.78,66.55,63.72,60.27,63.68,59.82,60.49,61.45,59.36,66.03,65.97,62.43,63.66,66.81,65.97,60.06)

Longitude <- c(-122.09,-122.89,-117.63,-121.24,-117.62,-121.61,-121.46,-119.84,-93.64,-78.1,-85.65,-93.45,-98.19,-101.11,-150.18,
               9.63,12.44,13.92,26.99,27.69,67.23,73.82,69.65,68.8,74.46,68.92,82.82,68.73,78.35,60.87,62.14,83.71,84.34,71.47)

Basins_Area <- c(542,1910,36900,1310,649,2050,152,9270,1560,4710,883,2280,8133,3350,189,557,565,61,1520,16,7100,18300,7540,
                 65400,8130,11500,6500,15100,80400,9850,468,1430,10100,1740)

Per_Peat <- c(0.37,0.36,0.36,0.46,0.09,0.28,0.37,0.37,0.75,0.57,0.96,0.96,0.33,0.50,0.12,0.10,0.41,0.16,0.15,
              0.13,0.18,0.43,0.48,0.41,0.41,0.35,0.33,0.36,0.50,0.30,0.33,0.30,0.40,0.50)

Permafrost_Zone <-c("DPZ","DPZ","SPZ","DPZ","SPZ","DPZ","DPZ","DPZ","DPZ","SPZ","DPZ","DPZ","SPZ","SFZ","DPZ","SPZ","SFZ","DPZ",
                    "DPZ","SFZ","SPZ","SPZ","SPZ","SFZ","SPZ","SPZ","SPZ","DPZ","DPZ","DPZ","SPZ","DPZ","DPZ","SFZ")

MAGT<- c(-0.1,-0.1,-0.2,-0.1,NA,-0.1,-0.2,-0.2,-4.7,NA,NA,-4.7,NA,NA,-1.1,-0.2,NA,NA,-0.2,NA,-0.2,-0.2,-0.2,NA,-0.2,
         -0.2,NA,-0.2,-0.7,-0.7,-0.2,-0.7,-0.7,NA)

Start_Year <- c(1974,1991,1975,1972,1971,1972,1995,1969,1979,1969,1970,1977,1975,1969,1997,1969,1696,1969,1969,1969,
                1969,1969,1969,1969,1969,1969,1969,1969,1969,1969,1971,1969,1969,1983)

End_Year <- c(2016,2016,2016,2015,2015,2016,2015,2016,2016,2016,2014,2016,2012,2016,2016,2013,2016,2014,2016,2015,
              2016,1995,1998,2015,2016,2016,2016,2016,2015,2016,2016,2016,2016,2016)

Total-Years <- c(42,25,41,43,44,44,21,47,37,47,44,39,37,47,19,44,47,45,47,46,47,26,29,46,47,47,47,47,46,47,45,47,47,34)


MetaDF <- data.frame(ID,Basin_Name,Ecoregion,Latitude,Longitude,Basin_Area,Per_Peat,Permafrost_Zone,Start_Year,End_Year,Total_Years)
```



```{r}
Sens_Slope_1970 <- rbind(BF[1,],NAR,BDF[1,],OF[1,],BCF[1,],VF[1,],NAR,AIF[1,],AF[1,],ABF[1,],AEEF[1,],AKF[1,],AHF[1,],YF[1,],NAR,
FFF[1,],KF[1,],SF[1,],BNF[1,],AJF[1,],BKF[1,],ALF[1,],APF[1,],AMF[1,],BGF[1,],BHF[1,],BFF[1,],BEF[1,],ANF[1,],BLF[1,],BMF[1,],BPF[1,],BOF[1,],BJF[1,])

Sens_Slope_1990 <- rbind(BF2[1,],DF[1,],BDF2[1,],OF2[1,],BCF2[1,],VF2[1,],ADF[1,],AIF2[1,],AF2[1,],ABF2[1,],AEEF2[1,],AKF2[1,],AHF2[1,],
YF2[1,],AQF[1,],FFF2[1,],KF2[1,],SF2[1,],BNF2[1,],AJF2[1,],BKF2[1,],NAR,APF2[1,],AMF2[1,],NAR,BHF2[1,],BFF2[1,],NAR, ANF2[1,],BLF2[1,],BMF2[1,],BPF2[1,],BOF2[1,],BJF2[1,])

p_value_1970 <- rbind(BF[2,],NAR,BDF[2,],OF[2,],BCF[2,],VF[2,],NAR,AIF[2,],AF[2,],ABF[2,],AEEF[2,],AKF[2,],AHF[2,],YF[2,],NAR,FFF[2,],
KF[2,],SF[2,],BNF[2,],AJF[2,],BKF[2,],ALF[2,],APF[2,],AMF[2,],BGF[2,],BHF[2,],BFF[2,],BEF[2,],ANF[2,],BLF[2,],BMF[2,],BPF[2,],BOF[2,],BJF[2,])

p_value_1990 <- rbind(BF2[2,],DF[2,],BDF2[2,],OF2[2,],BCF2[2,],VF2[2,],ADF[2,],AIF2[2,],AF2[2,],ABF2[2,],AEEF2[2,],AKF2[2,],AHF2[2,],YF2[2,],
AQF[2,],FFF2[2,],KF2[2,],SF2[2,],BNF2[2,],AJF2[2,],BKF2[2,],NAR,APF2[2,],AMF2[2,],NAR,BHF2[2,],BFF2[2,],NAR,ANF2[2,],BLF2[2,],BMF2[2,],BPF2[2,],BOF2[2,],BJF2[2,])


#Sens_Slope_1970
#Sens_Slope_1990
#p_value_1970
#p_value_1970

### Analyses results dataframes
Sens70DF <- cbind(MetaDF,Sens_Slope_1970)
Sens90DF <- cbind(MetaDF,Sens_Slope_1990) 
Pvls70DF <- cbind(MetaDF,p_value_1970) 
Pvls90DF <- cbind(MetaDF,p_value_1990)

### Analyses results CSV outputs (toggle on or off)
#write.csv(Sens70DF,  file= "MKR_WY_Sens70_F7.csv")
#write.csv(Sens90DF,  file= "MKR_WY_Sens90_F7.csv")
#write.csv(Pvls70DF,  file= "MKR_WY_Pvls70_F7.csv")
#write.csv(Pvls90DF,  file= "MKR_WY_Pvls90_F7.csv")

``` 




